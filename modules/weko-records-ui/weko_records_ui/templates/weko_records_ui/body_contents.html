{# -*- coding: utf-8 -*-
#
# This file is part of WEKO3.
# Copyright (C) 2017 National Institute of Informatics.
#
# WEKO3 is free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 2 of the
# License, or (at your option) any later version.
#
# WEKO3 is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with WEKO3; if not, write to the
# Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston,
# MA 02111-1307, USA.
#}


{% from "weko_records_ui/box/preview_carousel.html" import preview_carousel %}
{% from "weko_theme/macros/modal_page.html" import all_modal %}
{{ all_modal() }}
{% from "weko_records_ui/output_detail_data.html" import output_detail_data, output_attribute_value %}
<div class="panel-group">
  <div class="panel panel-default">
    <div class="panel-heading clearfix">
      <h3 class="panel-title">{{_('Item')}}</h3>
    </div>
    <div class="panel-body">
      {%- include "weko_records_ui/box/head.html" %}
    </div>
    <div class="panel-body" style="padding-top: 10px;">
      <div class="row">
        <div id="detail-item" class="col-sm-9 col-md-9 col-left">
          <div id="record_id" class="hide">{{ record.id }}</div>
          {%- block record_author %}
          {%- set files = record.files -%}
          {%- set ignore_meta = ('_buckets', '_deposit', '_oai', 'path', 'filemeta', 'item_title', 'item_type_id') -%}
          {%- if files | selectattr('is_thumbnail', 'equalto', False)| list | length > 0-%}

          <!-- Preview Carousel -->
          {{ preview_carousel(record=record, files=files, pid=pid) }}

          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th>{{_('Name')}} / {{_('File')}}</th>
                <th class="license">{{_('License')}}</th>
              </tr>
            </thead>
            <tbody>
              {%- for file in files|sort(attribute='key') -%}
              {%- if file.filename -%}
              {%- set img = file.mimetype | get_image_src -%}
              {%- set file_url = url_for('invenio_records_ui.recid_files', pid_value=pid.pid_value,
                  filename=file.key) %}
              {%- set is_billing_file = False -%}
              {%- set billing_file_data = "" -%}
              {%- set billing_file_url = "" -%}
              {%- set billing_file_class = "" -%}
              {%- set billing_file_access_permission = True -%}
              {%- if billing_files_permission -%}
              {%- set billing_file_permission = billing_files_permission.get(file.filename) -%}
              {%- set is_billing_file = True -%}
              {%- set billing_file_class = " billing-file" -%}
              {%- set file_url = "JavaScript:void(0);" -%}
              {%- endif %}
              {%- set access_permission = record | check_file_permission(file.info()) -%}
              {%- set file_details_url = url_for('invenio_records_ui.recid_file_details', pid_value=pid.pid_value,
                  filename=file.key) %}
              <tr>
                <td>{{file.filename}}
                  <a href="{{file_details_url}}{%- if community -%}?community={{ community.id }}{%- endif -%}"><i
                      class="fa fa-info-circle fa-lg"></i></a>
                  <a href="#preview_carousel" data-slide-to="{{ loop.index0 }}"><i
                      class="fa fa-play-circle fa-lg"></i></a>
                  <a
                    href="{{ config.WEKO_JUPYTERHUB_URL }}/{{ record._buckets.deposit }}/{{ file.filename }}"><img
                      height="16px" src="/static/images/custom/jupyter.svg" /></a>
                </td>
                <td rowspan="2">
                  {%- if not 'simple' in file.displaytype -%}
                  {%- if 'license_free' == file.licensetype -%}
                  <span class="break-word">{{ file.licensefree }}</span>
                  {%- else %}
                  {% set lst = file.licensetype | get_license_icon %}
                  <a target="_blank" href="{{lst[2]}}" alt="Creative Commons Licenses">
                    <img src="{{lst[0]}}" alt="license.icon" /></a><br>
                  {{ lst[1] }}
                  {%- endif %}
                  {%- endif -%}
                </td>
              </tr>
              <tr>
                <td>
                  <span class="filename">
                    <img src="{{img}}" alt={{ file.filename }} />
                    {%- if not file.groupsprice and not access_permission and file.accessrole == 'open_login' -%}
                    {%- set file_url = url_for_security('login', next=request.path) -%}
                    {%- set billing_file_class = "" -%}
                    {%- elif is_billing_file or file.groupsprice -%}
                    {%- if not session['user_id'] -%}
                    {%- set file_url = url_for_security('login', next=request.path) -%}
                    {%- set billing_file_class = "" -%}
                    {%- elif billing_file_permission -%}
                    {%- set billing_file_url = "data-billing-file-url=" + url_for('invenio_records_ui.recid_files', pid_value=pid.pid_value, filename=file.key) -%}
                    {%- set billing_file_data = "data-billing-file-permission=true data-billing-file-price=" + billing_files_prices.get(file.filename)|string -%}
                    {%- else -%}
                    {%- set billing_file_data = "data-billing-file-permission=false" -%}
                    <input id="download_permission_error" type="hidden"
                      value="{{_('The file cannot be downloaded because you do not have permission to view this file.')}}" />
                    {%- set billing_file_access_permission = False -%}
                    {%- endif -%}
                    {%- endif -%}
                    <a class="forcewrap{{billing_file_class}}" {{billing_file_data}} {{billing_file_url}}
                      href="{{file_url}}">{{ file.filename }}
                      ({{ file.size|filesizeformat }})</a><br>
                    {%- if access_permission and billing_file_access_permission -%}
                    <span>{{file.checksum.split(':')[0]}}: </span>
                    <span class="break-word">{{file.checksum.split(':')[1]}}</span>
                    {%- else -%}
                    <div class="panel-body">
                      <span class="fa fa-key"
                        style="font-size:18px;font-weight:bold">&nbsp;{{_('Restricted Access')}}</span>
                    </div>
                    {%- endif -%}
                  </span>
                  {%- if 'pdf' in file.mimetype and can_download_original_pdf -%}
                  {%- set original_file_url = url_for('invenio_records_ui.recid_files', pid_value=pid.pid_value,
                        filename=file.key, original=1) %}
                  {%- if is_billing_file -%}
                  {%- set original_file_url = "javascript:void(0)" -%}
                  {%- if billing_file_permission -%}
                  {%- set billing_file_url = "data-billing-file-url=" + url_for('invenio_records_ui.recid_files', pid_value=pid.pid_value, filename=file.key, original=1) %}
                  {%- endif -%}
                  {%- endif -%}
                  <div class="text-right">
                    <a class="forcewrap{{billing_file_class}}" {{billing_file_data}} {{billing_file_url}}
                      href="{{original_file_url}}">{{_('Original')}}</a>
                  </div>
                  {%- endif -%}
                </td>
              </tr>
              <!-- demo -->
              {%- if record | check_permission -%}
              {%- if 'pdf' in file.mimetype -%}
              <tr>
                <td colspan="2">
                  <a class="btn btn-default" id="btn_check" href="/ezas/pdf-detect-weko.html" target="_blank">
                    <span class="glyphicon glyphicon-edit" aria-hidden="true"></span> {{_('Plagiarism Check')}}</a>
                </td>
              </tr>
              {%- endif -%}
              {%- endif -%}
              <!-- demo -->
              {%- endif -%}
              {%- endfor -%}
            </tbody>
          </table>
          {%- endif %}
          <div class="table-responsive">
            <table class="table table-bordered table-striped detail-table">
              {% if record.item_type_info %}
              <tr>
                <th colspan="6">{{_('item type')}}</th>
                <td>{{ record.item_type_info }}</td>
              </tr>
              {% endif %}
              {%- for lst in record.items_show_list %}
              {% if 'attribute_name_hidden' not in lst.keys() %}

              {% if lst['attribute_name'] == 'Reference' %}
              <tr>
                <th colspan="6">{{ lst['attribute_name'] }}</th>
                <td>
                  {%- for l in lst['attribute_value_mlt'] %}
                  <div>
                    {{ l[0].Authors }}.
                    ({{ l[0].Year }}).
                    <i>{{ l[0].Title }}</i>.
                    {{ l[0].Journal }}. <a href="{{ l[0].DOI }}">{{ l[0].DOI }}</a>
                  </div>
                  {%- endfor -%}
                </td>
              </tr>
              {% else %}
              {% if lst['attribute_value_mlt'] is undefined or lst['attribute_value_mlt']|length == 0 or lst['attribute_type'] == 'file' %}
              <tr>
                <th colspan="6">{{ lst['attribute_name'] }}</th>
                <td>
                  <pre class="hide">{{lst|tojson}}</pre>
                  {% if lst['attribute_value'] is string %}
                  {{ lst['attribute_value'] }}
                  {% else %}
                  {%- for key in lst['attribute_value'] %}
                  {{ key }}
                  {% endfor %}
                  {% endif %}
                  {%- for l in lst['attribute_value_mlt'] -%}
                    {{ output_attribute_value(l) }}
                  {%- endfor -%}
                </td>
              </tr>
              {% else %}
                  {{ output_detail_data(lst) }}
              {% endif %}
              {% endif %}
              {% endif %}
              {%- if 'attribute_name_hidden' in lst.keys() and files_thumbnail -%}
              <tr>
                <th colspan="6">{{lst.get('attribute_name_hidden', _('Thumbnail'))}}</th>
                <td>
                  {%- for thumb in files_thumbnail | sort(attribute='key') -%}
                  {%- set thumb_name = thumb.filename or thumb.key -%}
                  {%- set thumb_url = url_for('invenio_records_ui.recid_files', pid_value=pid.pid_value,
                        filename=thumb.key) %}
                  <p>
                    <span>{{ thumb_name }}</span><br>
                    <img src="{{thumb_url}}" alt={{thumb_name}}
                      style="max-width: {{ config.WEKO_RECORDS_UI_DEFAULT_MAX_WIDTH_THUMBNAIL }}px;" />
                  </p>
                  {% endfor %}
                </td>
              </tr>
              {% endif %}
              {% endfor %}
              {% if record.relation %}
              <tr>
                <th colspan="6">{{_('Link')}}</th>
                <td>
                  {%- for sub_record in record.relation.relation_type%}
                  <a target="_self" href="{{sub_record.item_links}}">{{ sub_record.item_title}}</a><br>
                  {% endfor %}
                </td>
              </tr>
              {% endif %}
              {% if record.pubdate %}
              <tr>
                <th colspan="6">{{_('Publish Status')}}</th>
                {%- set pubs = record.get('publish_status','1') -%}
                {% if record.editable %}
                {%- set dis = '' -%}
                {% else %}
                {%- set dis = 'disabled' -%}
                {% endif %}
                <td>
                  <div>
                    <form class="form form-inline"
                      action="{{ url_for('invenio_records_ui.recid_publish', pid_value=pid.pid_value) }}" method="POST">
                      {% if record | check_permission %}
                      {% if '0' in pubs %}
                      {{_('Public')}}
                      <button class="btn btn-default btn-xs" type="submit" name="status" value="1"
                        style="font-size:15px">
                        {{_('Change to Private')}}
                      </button>
                      {% else %}
                      {{_('Private')}}
                      <button class="btn btn-default btn-xs" type="submit" name="status" value="0"
                        style="font-size:15px">
                        {{_('Change to Public')}}
                      </button>
                      {% endif %}
                      {% else %}
                      {% if '0' in pubs %}{{_('Publish')}}{% else %}{{_('Private')}}
                      {% endif %}
                      {% endif %}
                    </form>
                  </div>
                </td>
              </tr>
              {% endif %}
            </table>
          </div>
          {%- if 'main_entry_personal_name' in record %}
          <p class="record_authors">
            <i>{{ record['main_entry_personal_name']['personal_name'] }}</i>
            {%- for author in record.get('added_entry_personal_name', []) %}
            , <i>{{ author['personal_name'] }}</i>
            {% endfor %}
          </p>
          {% endif %}
          {%- endblock %}
          <div class="text-center" ng-controller="ItemController">
            <a class="btn btn-info back-button" id="btn_back" href="#!">
              <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span> {{_('Back')}}</a>
            {% if record | check_permission %}
            <a class="btn btn-primary edit-button" href="#!" id="btn_edit" data-pid-value="{{ pid.pid_value }}"
              {%- if community -%}data-community="{{ community.id }}" {%- endif -%}>
              <span class="glyphicon glyphicon-edit" aria-hidden="true"></span> {{_('Edit')}}</a>
            <a class="btn btn-danger delete-button" id="btn_delete" ng-click="openConfirm('',
              '{{'/records/soft_delete/'+ pid.pid_value}}',
              '{{url_for('weko_search_ui.search')}}')">
              <span class="glyphicon glyphicon-trash" aria-hidden="true"></span> {{_('Delete')}}</a>
            <div class="row">
              <p class="alert alert-danger alert-dismissible text-middle collapse" role="alert"
                style="min-width: 330px;">
                <button type="button" class="close" id="btn_close_alert" aria-label="Close"><span
                    aria-hidden="true">&times;</span></button>
                {{_('The workflow is being edited.')}}
              </p>
            </div>
            <script type="text/ng-template" id="confirm-modal.html">
              <div class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h3 class="modal-title"><span class="glyphicon glyphicon-info-sign"></span>{{_('Confirm')}}</h3>
                    </div>
                    <div class="modal-body">
                      <p>{{_('Are you sure you want to delete this item?')}}</p>
                    </div>
                    <div class="modal-footer">
                      <button class="btn btn-primary ok-button" ng-click="ok()">{{_('OK')}}</button>
                      <button class="btn btn-info cancel-button" ng-click="cancel()">{{_('Cancel')}}</button>
                    </div>
                  </div>
                </div>
              </div>
            </script>
            {% endif %}
          </div>
        </div>
        <div id="invenio-csl" class="col-sm-3 col-md-3 col-right">
          <!-- start demo block -->
          {%- include "weko_records_ui/box/stats.html" %}
          {%- include "weko_records_ui/box/versions.html" %}
          {%- include "weko_records_ui/box/share.html" %}
          {%- include "weko_records_ui/box/export.html" %}
          <!-- end demo block -->
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="confirm_download" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
            aria-hidden="true">&times;</span></button>
        <h3 class="modal-title"><span class="glyphicon glyphicon-info-sign"></span>{{_('Confirm')}}</h3>
      </div>
      <div class="modal-body">
        <input id="download_confirm_message" type="hidden"
          value="{{_('This file is a Billing file. (Price: XXXXX). Do you want to download it?')}}" />
        <p id="download_confirm_content"></p>
      </div>
      <div class="modal-footer">
        <button type="button" id="confirm_download_button" class="btn btn-primary">{{_('Yes')}}</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">{{_('No')}}</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
{% block css %}
<style>
  #invenio-csl span.twitter-typeahead .tt-menu {
    overflow-y: scroll;
    max-height: 250px;
  }

  #invenio-csl span.twitter-typeahead .tt-suggestion {
    white-space: normal;
  }

  #invenio-csl span.twitter-typeahead .empty-results {
    max-width: 250px;
</style>
<style type="text/css">
  .table {
    table-layout: fixed;
    overflow-wrap: break-word;
    word-wrap: break-word;
  }

  .table tr th:nth-child(1) {
    width: 30%;
  }
</style>
{% endblock %}
