GLOB sdist-make: /code/modules/invenio-records-rest/setup.py
c1 create: /code/modules/invenio-records-rest/.tox/c1
c1 installdeps: pytest>=3, pytest-cov, -rrequirements.txt
c1 inst: /code/modules/invenio-records-rest/.tox/.tmp/package/1/invenio-records-rest-1.4.2.zip
c1 installed: alabaster==0.7.13,alembic==0.9.6,amqp==2.6.1,angular-gettext-babel==0.3,aniso8601==8.0.0,arrow==0.12.1,asn1crypto==0.23.0,attrs==17.4.0,b2handle==1.1.2,Babel==2.5.1,bagit==1.7.0,beautifulsoup4==4.9.3,bibtexparser==1.0.1,billiard==3.6.3.0,binaryornot==0.4.4,bleach==3.1.0,blinker==1.4,boto3==1.7.84,botocore==1.10.84,cachelib==0.1,cachetools==4.2.4,cchardet==2.1.1,celery==4.4.7,certifi==2017.11.5,cffi==1.11.2,chardet==3.0.4,citeproc-py==0.5.1,citeproc-py-styles==0.1.2,click==8.0.4,cookiecutter==1.6.0,counter-robots==2018.6,coverage==6.2,cryptography==2.1.4,datacite==1.0.1,DateTime==4.9,dcxml==0.1.0,decorator==4.1.2,defusedxml==0.5.0,dictdiffer==0.7.0,dnspython==2.2.1,docutils==0.18.1,dojson==1.3.2,elasticsearch==6.1.1,elasticsearch-dsl==6.4.0,elementpath==1.0.6,email-validator==1.0.5,entrypoints==0.2.3,feedgen==0.7.0,Flask==1.0.4,Flask-Admin==1.5.3,Flask-Alembic==2.0.1,Flask-Assets==0.12,Flask-BabelEx==0.9.4,Flask-Breadcrumbs==0.5.0,Flask-Caching==1.3.3,Flask-CeleryExt==0.3.4,Flask-Collect==1.2.2,Flask-Cors==3.0.3,Flask-DebugToolbar==0.11.0,Flask-IIIF==0.6.1,Flask-KVSession==0.6.2,Flask-Limiter==1.1.0,Flask-Login==0.4.1,Flask-Mail==0.9.1,flask-marshmallow==0.14.0,Flask-Menu==0.6.0,Flask-OAuthlib==0.9.5,Flask-Plugins==1.6.1,Flask-Principal==0.4.0,Flask-RESTful==0.3.8,Flask-Security==3.0.0,flask-shell-ipython==0.4.1,Flask-Sitemap==0.1.0,Flask-SQLAlchemy==2.3.2,flask-talisman==0.4.1,Flask-WTF==0.14.3,-e git+https://github.com/RCOSDP/pyfpdf.git@f9b032148283d535cabc7789858081c80de36fef#egg=fpdf,frozendict==2.3.6,fs==0.5.4,ftfy==4.4.3,future==0.16.0,github3.py==1.1.0,html5lib==1.0.1,idna==2.6,iiif-prezi==0.3.0,imagesize==1.4.1,importlib-metadata==4.8.3,importlib-resources==5.4.0,infinity==1.4,iniconfig==1.1.1,intervals==0.8.0,invenio-access==1.1.0,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_accounts&subdirectory=modules/invenio-accounts,invenio-admin==1.1.2,invenio-app==1.1.0,invenio-assets==1.0.0,invenio-base==1.0.2,invenio-cache==1.0.0,invenio-celery==1.1.3,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_communities&subdirectory=modules/invenio-communities,invenio-config==1.0.0,invenio-csl-rest==1.0.0a1,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_db&subdirectory=modules/invenio-db,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_deposit&subdirectory=modules/invenio-deposit,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_files_rest&subdirectory=modules/invenio-files-rest,invenio-formatter==1.0.0b3,invenio-i18n==1.0.0,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_iiif&subdirectory=modules/invenio-iiif,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_indexer&subdirectory=modules/invenio-indexer,invenio-jsonschemas==1.0.0,invenio-logging==1.0.0b3,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_mail&subdirectory=modules/invenio-mail,invenio-marc21==1.0.0a8,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_oaiharvester&subdirectory=modules/invenio-oaiharvester,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_oaiserver&subdirectory=modules/invenio-oaiserver,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_oauth2server&subdirectory=modules/invenio-oauth2server,invenio-oauthclient==1.0.0,invenio-pidrelations==1.0.0a4,invenio-pidstore==1.0.0,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_previewer&subdirectory=modules/invenio-previewer,invenio-query-parser==0.6.0,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_queues&subdirectory=modules/invenio-queues,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_records&subdirectory=modules/invenio-records,invenio-records-files==1.0.0a10,invenio-records-rest @ file:///code/modules/invenio-records-rest/.tox/.tmp/package/1/invenio-records-rest-1.4.2.zip,invenio-records-ui==1.0.0,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_resourcesyncclient&subdirectory=modules/invenio-resourcesyncclient,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_resourcesyncserver&subdirectory=modules/invenio-resourcesyncserver,invenio-rest==1.1.2,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_s3&subdirectory=modules/invenio-s3,invenio-search==1.1.0,invenio-search-ui==1.0.0a9,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=invenio_stats&subdirectory=modules/invenio-stats,invenio-theme==1.0.0b4,ipaddress==1.0.19,ipython==6.2.1,ipython-genutils==0.2.0,itsdangerous==0.24,jedi==0.11.0,Jinja2==2.10,jinja2-cli==0.6.0,jinja2-time==0.2.0,jmespath==0.10.0,jsmin==2.2.2,jsonpatch==1.21,jsonpath-ng==1.5.2,jsonpointer==1.14,jsonref==0.1,jsonresolver==0.2.1,jsonschema==2.6.0,jupyter-client==5.2.2,jupyter-core==4.4.0,kombu==4.6.10,limits==1.2.1,lxml==4.1.1,Mako==1.0.7,MarkupSafe==1.1.1,marshmallow==2.20.1,marshmallow-sqlalchemy==0.23.1,maxminddb==1.5.2,maxminddb-geolite2==2017.803,mistune==0.8.3,mock==3.0.5,more-itertools==8.10.0,msgpack==0.6.2,nbconvert==5.3.1,nbformat==4.4.0,netaddr==0.8.0,node-semver==0.1.1,numpy==1.16.1,oauthlib==2.1.0,ordereddict==1.1,packaging==21.3,pandocfilters==1.4.2,parso==0.1.0,passlib==1.7.1,pexpect==4.3.0,pickleshare==0.7.4,Pillow==5.4.1,pluggy==0.13.1,ply==3.11,poyo==0.4.1,prompt-toolkit==1.0.15,psycopg2==2.7.3.2,ptyprocess==0.5.2,py==1.11.0,pycparser==2.18,Pygments==2.2.0,PyJWT==1.5.3,PyLD==2.0.3,pyparsing==3.0.9,-e git+https://github.com/RCOSDP/PyPDF2.git@fefc684a3a74aff6f99e5dff24f9b4dd1c95169d#egg=PyPDF2,pyPEG2==2.15.2,pytest==6.1.2,pytest-cov==4.0.0,pytest-mock==3.6.1,python-dateutil==2.6.1,python-editor==1.0.3,python-geoip==1.2,pytz==2017.3,pyzmq==17.0.0,redis==2.10.6,requests==2.18.4,requests-oauthlib==1.1.0,resync==1.0.9,s3fs==0.1.6,s3transfer==0.1.13,Sickle==0.6.4,simplegeneric==0.8.1,simplejson==3.12.0,simplekv==0.11.2,six==1.12.0,snowballstemmer==2.2.0,soupsieve==2.3.2.post1,speaklater==1.3,Sphinx==1.8.4,sphinxcontrib-serializinghtml==1.1.5,sphinxcontrib-websupport==1.2.4,SQLAlchemy==1.2.19,SQLAlchemy-Continuum==1.3.6,SQLAlchemy-Utils==0.35.0,testpath==0.3.1,toml==0.10.2,tomli==1.2.3,tornado==4.5.3,traitlets==4.3.2,typing_extensions==4.1.1,ua-parser==0.7.3,uritemplate==4.1.1,uritools==2.1.0,urllib3==1.22,validators==0.12.0,vine==1.3.0,Wand==0.6.1,wcwidth==0.1.7,webargs==5.5.2,webassets==0.12.1,webencodings==0.5.1,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_accounts&subdirectory=modules/weko-accounts,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_admin&subdirectory=modules/weko-admin,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_authors&subdirectory=modules/weko-authors,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_bulkupdate&subdirectory=modules/weko-bulkupdate,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_deposit&subdirectory=modules/weko-deposit,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_gridlayout&subdirectory=modules/weko-gridlayout,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_groups&subdirectory=modules/weko-groups,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_handle&subdirectory=modules/weko-handle,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_index_tree&subdirectory=modules/weko-index-tree,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_indextree_journal&subdirectory=modules/weko-indextree-journal,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_items_autofill&subdirectory=modules/weko-items-autofill,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_items_ui&subdirectory=modules/weko-items-ui,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_itemtypes_ui&subdirectory=modules/weko-itemtypes-ui,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_logging&subdirectory=modules/weko-logging,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_records&subdirectory=modules/weko-records,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_records_ui&subdirectory=modules/weko-records-ui,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_redis&subdirectory=modules/weko-redis,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_schema_ui&subdirectory=modules/weko-schema-ui,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_search_ui&subdirectory=modules/weko-search-ui,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_sitemap&subdirectory=modules/weko-sitemap,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_theme&subdirectory=modules/weko-theme,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_user_profiles&subdirectory=modules/weko-user-profiles,-e git+https://github.com/RCOSDP/weko.git@76430b4c7fb0c43f0e7c651235e280a7adbcc333#egg=weko_workflow&subdirectory=modules/weko-workflow,Werkzeug==0.15.2,whichcraft==0.4.1,WTForms==2.1,WTForms-Alchemy==0.16.5,WTForms-Components==0.10.3,xmlschema==0.9.30,xmltodict==0.12.0,zipp==3.6.0,zope.interface==5.5.2
c1 run-test-pre: PYTHONHASHSEED='2239527117'
c1 run-test: commands[0] | pytest --cov=invenio_records_rest tests -v --cov-branch --cov-report=term --cov-report=xml --cov-config=tox.ini --basetemp=/code/modules/invenio-records-rest/.tox/c1/tmp
============================= test session starts ==============================
platform linux -- Python 3.6.15, pytest-6.1.2, py-1.11.0, pluggy-0.13.1 -- /code/modules/invenio-records-rest/.tox/c1/bin/python
cachedir: .tox/c1/.pytest_cache
rootdir: /code/modules/invenio-records-rest
plugins: cov-4.0.0, celery-4.4.7, mock-3.6.1
collecting ... collected 115 items

tests/test_custom_endpoints.py::test_get_record[app0] PASSED             [  0%]
tests/test_custom_endpoints.py::test_get_records_list[test_custom_endpoints_app0] FAILED [  1%]
tests/test_custom_fields.py::test_load_custom_fields PASSED              [  2%]
tests/test_custom_fields.py::test_custom_generated_fields PASSED         [  3%]
tests/test_error_handlers.py::test_custom_error_handlers[app0] PASSED    [  4%]
tests/test_examples_app.py::test_example_app ERROR                       [  5%]
tests/test_ext.py::test_version PASSED                                   [  6%]
tests/test_ext.py::test_init PASSED                                      [  6%]
tests/test_facets.py::test_terms_filter PASSED                           [  7%]
tests/test_facets.py::test_range_filter PASSED                           [  8%]
tests/test_facets.py::test_create_filter_dsl PASSED                      [  9%]
tests/test_facets.py::test_post_filter PASSED                            [ 10%]
tests/test_facets.py::test_query_filter PASSED                           [ 11%]
tests/test_facets.py::test_aggregations PASSED                           [ 12%]
tests/test_facets.py::test_default_facets_factory FAILED                 [ 13%]
tests/test_links.py::test_default_links_factory_with_additional PASSED   [ 13%]
tests/test_links.py::test_old_signature_backward_compatibility[app0] PASSED [ 14%]
tests/test_marshmallow_loader.py::test_marshmallow_load PASSED           [ 15%]
tests/test_marshmallow_loader.py::test_marshmallow_load_errors PASSED    [ 16%]
tests/test_marshmallow_loader.py::test_marshmallow_load_nested_errors PASSED [ 17%]
tests/test_marshmallow_loader.py::test_marshmallow_errors PASSED         [ 18%]
tests/test_marshmallow_loader.py::test_json_pid_checker_loader PASSED    [ 19%]
tests/test_permissions.py::test_default_permissions FAILED               [ 20%]
tests/test_pid_resolver.py::test_record_resolution FAILED                [ 20%]
tests/test_serializer_base.py::test_preprocessor_mixin_record PASSED     [ 21%]
tests/test_serializer_base.py::test_preprocessor_mixin_searchhit PASSED  [ 22%]
tests/test_serializer_citeproc.py::test_serialize PASSED                 [ 23%]
tests/test_serializer_citeproc.py::test_serializer_args PASSED           [ 24%]
tests/test_serializer_citeproc.py::test_nonexistent_style PASSED         [ 25%]
tests/test_serializer_citeproc.py::test_serializer_in_request PASSED     [ 26%]
tests/test_serializer_datacite.py::test_serialize[DataCite31Serializer] FAILED [ 26%]
tests/test_serializer_datacite.py::test_serialize[DataCite40Serializer] FAILED [ 27%]
tests/test_serializer_datacite.py::test_serialize[DataCite41Serializer] FAILED [ 28%]
tests/test_serializer_datacite.py::test_serialize_search[DataCite31Serializer] PASSED [ 29%]
tests/test_serializer_datacite.py::test_serialize_search[DataCite40Serializer] PASSED [ 30%]
tests/test_serializer_datacite.py::test_serialize_search[DataCite41Serializer] PASSED [ 31%]
tests/test_serializer_dc.py::test_serialize FAILED                       [ 32%]
tests/test_serializer_dc.py::test_serialize_search PASSED                [ 33%]
tests/test_serializer_json.py::test_serialize PASSED                     [ 33%]
tests/test_serializer_json.py::test_serialize_search PASSED              [ 34%]
tests/test_serializer_json.py::test_serialize_pretty PASSED              [ 35%]
tests/test_serializer_jsonld.py::test_serialize FAILED                   [ 36%]
tests/test_serializer_jsonld.py::test_serialize_search FAILED            [ 37%]
tests/test_serializer_jsonld.py::test_transform_jsonld PASSED            [ 38%]
tests/test_serializer_marshmallow.py::test_transform_record FAILED       [ 39%]
tests/test_serializer_marshmallow.py::test_transform_search_hit FAILED   [ 40%]
tests/test_serializer_marshmallow.py::test_transform_record_default_schema FAILED [ 40%]
tests/test_serializer_response.py::test_record_responsify PASSED         [ 41%]
tests/test_serializer_response.py::test_search_responsify FAILED         [ 42%]
tests/test_sorter.py::test_parse_sort_field PASSED                       [ 43%]
tests/test_sorter.py::test_reverse_order PASSED                          [ 44%]
tests/test_sorter.py::test_eval_field_string PASSED                      [ 45%]
tests/test_sorter.py::test_eval_field_callable PASSED                    [ 46%]
tests/test_sorter.py::test_eval_field_dict PASSED                        [ 46%]
tests/test_sorter.py::test_geolocation_sort PASSED                       [ 47%]
tests/test_sorter.py::test_default_sorter_factory FAILED                 [ 48%]
tests/test_utils.py::test_build_default_endpoint_prefixes_simple[app0] PASSED [ 49%]
tests/test_utils.py::test_build_default_endpoint_prefixes_simple_with_default[app0] PASSED [ 50%]
tests/test_utils.py::test_build_default_endpoint_prefixes_two_simple_endpoints[app0] PASSED [ 51%]
tests/test_utils.py::test_build_default_endpoint_prefixes_redundant_default[app0] PASSED [ 52%]
tests/test_utils.py::test_build_default_endpoint_prefixes_two_endpoints_with_default[app0] PASSED [ 53%]
tests/test_utils.py::test_get_default_endpoint_for_inconsistent PASSED   [ 53%]
tests/test_views_item_delete.py::test_valid_delete FAILED                [ 54%]
tests/test_views_item_delete.py::test_delete_deleted FAILED              [ 55%]
tests/test_views_item_delete.py::test_delete_notfound PASSED             [ 56%]
tests/test_views_item_delete.py::test_delete_with_sqldatabase_error FAILED [ 57%]
tests/test_views_item_get.py::test_item_get PASSED                       [ 58%]
tests/test_views_item_get.py::test_item_get_etag FAILED                  [ 59%]
tests/test_views_item_get.py::test_item_get_norecord PASSED              [ 60%]
tests/test_views_item_get.py::test_item_get_invalid_mimetype PASSED      [ 60%]
tests/test_views_item_patch.py::test_valid_patch[application/json-patch+json] FAILED [ 61%]
tests/test_views_item_patch.py::test_valid_patch[application/json-patch+json;charset=utf-8] FAILED [ 62%]
tests/test_views_item_patch.py::test_patch_deleted[application/json-patch+json] FAILED [ 63%]
tests/test_views_item_patch.py::test_patch_deleted[application/json-patch+json;charset=utf-8] FAILED [ 64%]
tests/test_views_item_patch.py::test_invalid_patch[] FAILED              [ 65%]
tests/test_views_item_patch.py::test_invalid_patch[;charset=utf-8] FAILED [ 66%]
tests/test_views_item_patch.py::test_validation_error[application/json-patch+json] PASSED [ 66%]
tests/test_views_item_patch.py::test_validation_error[application/json-patch+json;charset=utf-8] PASSED [ 67%]
tests/test_views_item_put.py::test_valid_put[application/json] FAILED    [ 68%]
tests/test_views_item_put.py::test_valid_put[application/json;charset=utf-8] FAILED [ 69%]
tests/test_views_item_put.py::test_valid_put_etag[application/json] FAILED [ 70%]
tests/test_views_item_put.py::test_valid_put_etag[application/json;charset=utf-8] FAILED [ 71%]
tests/test_views_item_put.py::test_put_on_deleted[application/json] FAILED [ 72%]
tests/test_views_item_put.py::test_put_on_deleted[application/json;charset=utf-8] FAILED [ 73%]
tests/test_views_item_put.py::test_invalid_put[] FAILED                  [ 73%]
tests/test_views_item_put.py::test_invalid_put[;charset=utf-8] FAILED    [ 74%]
tests/test_views_item_put.py::test_validation_error[application/json] FAILED [ 75%]
tests/test_views_item_put.py::test_validation_error[application/json;charset=utf-8] FAILED [ 76%]
tests/test_views_list_post.py::test_valid_create[application/json] FAILED [ 77%]
tests/test_views_list_post.py::test_valid_create[application/json;charset=utf-8] FAILED [ 78%]
tests/test_views_list_post.py::test_invalid_create[application/json] FAILED [ 79%]
tests/test_views_list_post.py::test_invalid_create[application/json;charset=utf-8] FAILED [ 80%]
tests/test_views_list_post.py::test_validation_error[application/json] PASSED [ 80%]
tests/test_views_list_post.py::test_validation_error[application/json;charset=utf-8] PASSED [ 81%]
tests/test_views_list_post.py::test_jsonschema_validation_error[application/json] PASSED [ 82%]
tests/test_views_list_post.py::test_jsonschema_validation_error[application/json;charset=utf-8] PASSED [ 83%]
tests/test_views_options.py::test_options_view PASSED                    [ 84%]
tests/test_views_options.py::test_use_options[app0] PASSED               [ 85%]
tests/test_views_search.py::test_json_result_serializer FAILED           [ 86%]
tests/test_views_search.py::test_page_size FAILED                        [ 86%]
tests/test_views_search.py::test_page_size_without_size_in_request FAILED [ 87%]
tests/test_views_search.py::test_page_size_without_size_in_request_with_five_as_default FAILED [ 88%]
tests/test_views_search.py::test_pagination FAILED                       [ 89%]
tests/test_views_search.py::test_page_links FAILED                       [ 90%]
tests/test_views_search.py::test_query FAILED                            [ 91%]
tests/test_views_search.py::test_es_query_syntax[app0] FAILED            [ 92%]
tests/test_views_search.py::test_sort FAILED                             [ 93%]
tests/test_views_search.py::test_invalid_accept FAILED                   [ 93%]
tests/test_views_search.py::test_aggregations_info FAILED                [ 94%]
tests/test_views_search.py::test_filters FAILED                          [ 95%]
tests/test_views_search.py::test_query_wrong FAILED                      [ 96%]
tests/test_views_search.py::test_elasticsearch_exception[app0] FAILED    [ 97%]
tests/test_views_search.py::test_dynamic_aggregation FAILED              [ 98%]
tests/test_views_serializers.py::test_default_serializer[app0] FAILED    [ 99%]
tests/test_views_suggesters.py::test_valid_suggest[app0] FAILED          [100%]

==================================== ERRORS ====================================
______________________ ERROR at setup of test_example_app ______________________

    @pytest.yield_fixture
    def example_app():
        """Example app fixture."""
        current_dir = os.getcwd()
    
        # Go to example directory
        project_dir = dirname(dirname(abspath(__file__)))
        exampleapp_dir = join(project_dir, 'examples')
        os.chdir(exampleapp_dir)
    
        # Setup application
>       assert subprocess.call('./app-setup.sh', shell=True) == 0
E       assert 1 == 0
E         +1
E         -0

/code/modules/invenio-records-rest/tests/test_examples_app.py:32: AssertionError
---------------------------- Captured stderr setup -----------------------------
ERROR: ../invenio-db is not a valid editable requirement. It should either be a path to a local project or a VCS URL (beginning with bzr+http, bzr+https, bzr+ssh, bzr+sftp, bzr+ftp, bzr+lp, bzr+file, git+http, git+https, git+ssh, git+git, git+file, hg+file, hg+http, hg+https, hg+ssh, hg+static-http, svn+ssh, svn+http, svn+https, svn+svn, svn+file).
=================================== FAILURES ===================================
______________ test_get_records_list[test_custom_endpoints_app0] _______________

test_custom_endpoints_app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2495eb3f28> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2495e744a8>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]

    @pytest.mark.parametrize('test_custom_endpoints_app', [dict(
        # Disable all endpoints from config. The test will create the endpoint.
        records_rest_endpoints=dict(),
    )], indirect=['test_custom_endpoints_app'])
    def test_get_records_list(test_custom_endpoints_app, indexed_records):
        """Test the creation of a custom endpoint using RecordsListResource."""
        blueprint = Blueprint(
            'test_invenio_records_rest',
            __name__,
        )
        json_v1 = JSONSerializer(RecordSchemaJSONV1)
    
        blueprint.add_url_rule(
            '/records/',
            view_func=RecordsListResource.as_view(
                'recid_list',
                minter_name='recid',
                pid_fetcher='recid',
                pid_type='recid',
                search_serializers={
                    'application/json': search_responsify(
                        json_v1, 'application/json'
                    )
                },
                search_class=RecordsSearch,
                read_permission_factory=allow_all,
                create_permission_factory=allow_all,
                search_factory=default_search_factory,
                default_media_type='application/json',
            )
        )
        test_custom_endpoints_app.register_blueprint(blueprint)
    
        with test_custom_endpoints_app.test_request_context():
            search_url = url_for('test_invenio_records_rest.recid_list')
        with test_custom_endpoints_app.test_client() as client:
            # Get a query with only one record
>           res = client.get(search_url, query_string={'q': 'year:2015'})

tests/test_custom_endpoints.py:132: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_________________________ test_default_facets_factory __________________________

app = <Flask 'testapp'>

    def test_default_facets_factory(app):
        """Test aggregations."""
        defs = dict(
            aggs=dict(
                type=dict(
                    terms=dict(field='upload_type'),
                ),
                subtype=dict(
                    terms=dict(field='subtype'),
                )
            ),
            filters=dict(
                subtype=terms_filter('subtype'),
            ),
            post_filters=dict(
                type=terms_filter('type'),
            ),
        )
        app.config['RECORDS_REST_FACETS']['testidx'] = defs
    
        with app.test_request_context('?type=a&subtype=b'):
            search = Search().query(Q(query='value'))
>           search, urlkwargs = default_facets_factory(search, 'testidx')

/code/modules/invenio-records-rest/tests/test_facets.py:160: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
___________________________ test_default_permissions ___________________________

app = <Flask 'testapp'>, default_permissions = <Flask 'testapp'>
test_data = [{'stars': 4, 'title': 'Back to the Future', 'year': 2015}, {'stars': 3, 'title': 'Back to the Past', 'year': 2042}, {...4, 'title': "The Hitchhiker's Guide to the Galaxy", 'year': 1985}, {'stars': 5, 'title': 'Unknown film', 'year': 4242}]
search_url = 'http://localhost:5000/records/'
test_records = [(<PersistentIdentifier recid:1 / rec:8dec9a63-f995-41ef-b4cc-ffbe2dfd4986 (R)>, {'year': 2015, 'stars': 4, 'title': '...stentIdentifier object at 0x7f2495532588>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
indexed_records = [(<PersistentIdentifier recid:1 / rec:8dec9a63-f995-41ef-b4cc-ffbe2dfd4986 (R)>, {'year': 2015, 'stars': 4, 'title': '...stentIdentifier object at 0x7f2495532588>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]

    def test_default_permissions(app, default_permissions, test_data, search_url,
                                 test_records, indexed_records):
        """Test default create permissions."""
        pid, record = test_records[0]
        rec_url = record_url(pid)
        data = json.dumps(test_data[0])
        h = {'Content-Type': 'application/json'}
        hp = {'Content-Type': 'application/json-patch+json'}
    
        with app.test_client() as client:
            args = dict(data=data, headers=h)
            pargs = dict(data=data, headers=hp)
            qs = {'user': '1'}
            uargs = dict(data=data, headers=h, query_string=qs)
            upargs = dict(data=data, headers=hp, query_string=qs)
    
>           assert client.get(search_url).status_code == 200

/code/modules/invenio-records-rest/tests/test_permissions.py:35: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
____________________________ test_record_resolution ____________________________

app = <Flask 'testapp'>
db = <SQLAlchemy engine=sqlite:////code/modules/invenio-records-rest/examples/test.db>

    def test_record_resolution(app, db):
        """Test resolution of PIDs to records."""
        # OK PID
        pid_ok, record = create_record({'title': 'test'})
    
        # Deleted PID
        pid_del, record = create_record({'title': 'deleted'})
        pid_del.delete()
    
        # Missing object PID
        pid_noobj = PersistentIdentifier.create(
            'recid', str(RecordIdentifier.next()), status=PIDStatus.REGISTERED)
        db.session.commit()
    
        # Redirected PID
        pid_red = PersistentIdentifier.create(
            'recid', '101', status=PIDStatus.REGISTERED)
        pid_red.redirect(pid_ok)
    
        # Redirect PID - different endpoint
        pid_doi = PersistentIdentifier.create(
            'doi', '10.1234/foo', status=PIDStatus.REGISTERED)
        pid_red_doi = PersistentIdentifier.create(
            'recid', '102', status=PIDStatus.REGISTERED)
        pid_red_doi.redirect(pid_doi)
        db.session.commit()
    
        headers = [('Accept', 'application/json')]
        with app.test_client() as client:
            # PID deleted
            res = client.get(
                url_for('invenio_records_rest.recid_item',
                        pid_value=pid_del.pid_value),
                headers=headers)
            assert res.status_code == 410
    
            # PID missing object
            res = client.get(
                url_for('invenio_records_rest.recid_item',
                        pid_value=pid_noobj.pid_value),
                headers=headers)
            assert res.status_code == 500
    
            # Redirected invalid endpoint
            res = client.get(
                url_for('invenio_records_rest.recid_item',
>                       pid_value=pid_red_doi.pid_value),
                headers=headers)

/code/modules/invenio-records-rest/tests/test_pid_resolver.py:66: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/attributes.py:275: in __get__
    return self.impl.get(instance_state(instance), dict_)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/attributes.py:669: in get
    value = state._load_expired(state, passive)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/state.py:632: in _load_expired
    self.manager.deferred_scalar_loader(self, toload)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

mapper = <Mapper at 0x7f24a56f1358; PersistentIdentifier>
state = <sqlalchemy.orm.state.InstanceState object at 0x7f24956ed6a0>
attribute_names = {'created', 'id', 'object_type', 'object_uuid', 'pid_provider', 'pid_type', ...}

    def load_scalar_attributes(mapper, state, attribute_names):
        """initiate a column-based attribute refresh operation."""
    
        # assert mapper is _state_mapper(state)
        session = state.session
        if not session:
            raise orm_exc.DetachedInstanceError(
                "Instance %s is not bound to a Session; "
>               "attribute refresh operation cannot proceed" % (state_str(state))
            )
E           sqlalchemy.orm.exc.DetachedInstanceError: Instance <PersistentIdentifier at 0x7f24956ed710> is not bound to a Session; attribute refresh operation cannot proceed (Background on this error at: http://sqlalche.me/e/bhk3)

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/loading.py:913: DetachedInstanceError
------------------------------ Captured log call -------------------------------
ERROR    flask.app:utils.py:149 No object assigned to recid.
Traceback (most recent call last):
  File "/code/modules/invenio-records-rest/invenio_records_rest/utils.py", line 139, in data
    return self.resolver.resolve(self.value)
  File "/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_pidstore/resolver.py", line 63, in resolve
    raise PIDMissingObjectError(self.pid_type, pid_value)
invenio_pidstore.errors.PIDMissingObjectError: 3
_____________________ test_serialize[DataCite31Serializer] _____________________

self = <sqlalchemy.util._collections.ScopedRegistry object at 0x7f24a5718048>

    def __call__(self):
        key = self.scopefunc()
        try:
>           return self.registry[key]
E           KeyError: 139795483457344

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/_collections.py:1005: KeyError

During handling of the above exception, another exception occurred:

serializer = <class 'invenio_records_rest.serializers.datacite.DataCite31Serializer'>

    @pytest.mark.parametrize('serializer', [DataCite31Serializer,
                                            DataCite40Serializer,
                                            DataCite41Serializer])
    def test_serialize(serializer):
        pid = PersistentIdentifier(pid_type='recid', pid_value='2')
        record = Record({'doi': '10.1234/foo'})
        s = serializer(SimpleSchema)
>       data = s.serialize(pid, record)

/code/modules/invenio-records-rest/tests/test_serializer_datacite.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/invenio_records_rest/serializers/datacite.py:42: in serialize
    self.transform_record(pid, record, links_factory))
/code/modules/invenio-records-rest/invenio_records_rest/serializers/marshmallow.py:35: in transform_record
    links_factory=links_factory, **kwargs), context)
/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:206: in preprocess_record
    mapping_key_lang = get_mapping(metadata.get('item_type_id'))
/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:160: in get_mapping
    mapping = Mapping.get_record(item_type_id)
/code/modules/weko-records/weko_records/api.py:996: in get_record
    with db.session.no_autoflush:
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/scoping.py:176: in get
    return getattr(self.registry(), name)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/_collections.py:1007: in __call__
    return self.registry.setdefault(key, self.createfunc())
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:3181: in __call__
    return self.class_(**local_kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_sqlalchemy/__init__.py:141: in __init__
    self.app = app = db.get_app()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <SQLAlchemy engine=None>, reference_app = None

    def get_app(self, reference_app=None):
        """Helper method that implements the logic to look up an
        application."""
    
        if reference_app is not None:
            return reference_app
    
        if current_app:
            return current_app._get_current_object()
    
        if self.app is not None:
            return self.app
    
        raise RuntimeError(
>           'No application found. Either work inside a view function or push'
            ' an application context. See'
            ' http://flask-sqlalchemy.pocoo.org/contexts/.'
        )
E       RuntimeError: No application found. Either work inside a view function or push an application context. See http://flask-sqlalchemy.pocoo.org/contexts/.

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_sqlalchemy/__init__.py:912: RuntimeError
_____________________ test_serialize[DataCite40Serializer] _____________________

self = <sqlalchemy.util._collections.ScopedRegistry object at 0x7f24a5718048>

    def __call__(self):
        key = self.scopefunc()
        try:
>           return self.registry[key]
E           KeyError: 139795483457344

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/_collections.py:1005: KeyError

During handling of the above exception, another exception occurred:

serializer = <class 'invenio_records_rest.serializers.datacite.DataCite40Serializer'>

    @pytest.mark.parametrize('serializer', [DataCite31Serializer,
                                            DataCite40Serializer,
                                            DataCite41Serializer])
    def test_serialize(serializer):
        pid = PersistentIdentifier(pid_type='recid', pid_value='2')
        record = Record({'doi': '10.1234/foo'})
        s = serializer(SimpleSchema)
>       data = s.serialize(pid, record)

/code/modules/invenio-records-rest/tests/test_serializer_datacite.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/invenio_records_rest/serializers/datacite.py:42: in serialize
    self.transform_record(pid, record, links_factory))
/code/modules/invenio-records-rest/invenio_records_rest/serializers/marshmallow.py:35: in transform_record
    links_factory=links_factory, **kwargs), context)
/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:206: in preprocess_record
    mapping_key_lang = get_mapping(metadata.get('item_type_id'))
/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:160: in get_mapping
    mapping = Mapping.get_record(item_type_id)
/code/modules/weko-records/weko_records/api.py:996: in get_record
    with db.session.no_autoflush:
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/scoping.py:176: in get
    return getattr(self.registry(), name)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/_collections.py:1007: in __call__
    return self.registry.setdefault(key, self.createfunc())
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:3181: in __call__
    return self.class_(**local_kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_sqlalchemy/__init__.py:141: in __init__
    self.app = app = db.get_app()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <SQLAlchemy engine=None>, reference_app = None

    def get_app(self, reference_app=None):
        """Helper method that implements the logic to look up an
        application."""
    
        if reference_app is not None:
            return reference_app
    
        if current_app:
            return current_app._get_current_object()
    
        if self.app is not None:
            return self.app
    
        raise RuntimeError(
>           'No application found. Either work inside a view function or push'
            ' an application context. See'
            ' http://flask-sqlalchemy.pocoo.org/contexts/.'
        )
E       RuntimeError: No application found. Either work inside a view function or push an application context. See http://flask-sqlalchemy.pocoo.org/contexts/.

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_sqlalchemy/__init__.py:912: RuntimeError
_____________________ test_serialize[DataCite41Serializer] _____________________

self = <sqlalchemy.util._collections.ScopedRegistry object at 0x7f24a5718048>

    def __call__(self):
        key = self.scopefunc()
        try:
>           return self.registry[key]
E           KeyError: 139795483457344

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/_collections.py:1005: KeyError

During handling of the above exception, another exception occurred:

serializer = <class 'invenio_records_rest.serializers.datacite.DataCite41Serializer'>

    @pytest.mark.parametrize('serializer', [DataCite31Serializer,
                                            DataCite40Serializer,
                                            DataCite41Serializer])
    def test_serialize(serializer):
        pid = PersistentIdentifier(pid_type='recid', pid_value='2')
        record = Record({'doi': '10.1234/foo'})
        s = serializer(SimpleSchema)
>       data = s.serialize(pid, record)

/code/modules/invenio-records-rest/tests/test_serializer_datacite.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/invenio_records_rest/serializers/datacite.py:42: in serialize
    self.transform_record(pid, record, links_factory))
/code/modules/invenio-records-rest/invenio_records_rest/serializers/marshmallow.py:35: in transform_record
    links_factory=links_factory, **kwargs), context)
/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:206: in preprocess_record
    mapping_key_lang = get_mapping(metadata.get('item_type_id'))
/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:160: in get_mapping
    mapping = Mapping.get_record(item_type_id)
/code/modules/weko-records/weko_records/api.py:996: in get_record
    with db.session.no_autoflush:
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/scoping.py:176: in get
    return getattr(self.registry(), name)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/_collections.py:1007: in __call__
    return self.registry.setdefault(key, self.createfunc())
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:3181: in __call__
    return self.class_(**local_kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_sqlalchemy/__init__.py:141: in __init__
    self.app = app = db.get_app()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <SQLAlchemy engine=None>, reference_app = None

    def get_app(self, reference_app=None):
        """Helper method that implements the logic to look up an
        application."""
    
        if reference_app is not None:
            return reference_app
    
        if current_app:
            return current_app._get_current_object()
    
        if self.app is not None:
            return self.app
    
        raise RuntimeError(
>           'No application found. Either work inside a view function or push'
            ' an application context. See'
            ' http://flask-sqlalchemy.pocoo.org/contexts/.'
        )
E       RuntimeError: No application found. Either work inside a view function or push an application context. See http://flask-sqlalchemy.pocoo.org/contexts/.

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_sqlalchemy/__init__.py:912: RuntimeError
________________________________ test_serialize ________________________________

self = <sqlalchemy.util._collections.ScopedRegistry object at 0x7f24a5718048>

    def __call__(self):
        key = self.scopefunc()
        try:
>           return self.registry[key]
E           KeyError: 139795483457344

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/_collections.py:1005: KeyError

During handling of the above exception, another exception occurred:

    def test_serialize():
        """Test JSON serialize."""
        pid = PersistentIdentifier(pid_type='recid', pid_value='2')
        record = Record({'titles': ['DC test']})
>       data = DublinCoreSerializer(SimpleSchema).serialize(pid, record)

/code/modules/invenio-records-rest/tests/test_serializer_dc.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/invenio_records_rest/serializers/dc.py:36: in serialize
    self.transform_record(pid, record, links_factory))
/code/modules/invenio-records-rest/invenio_records_rest/serializers/marshmallow.py:35: in transform_record
    links_factory=links_factory, **kwargs), context)
/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:206: in preprocess_record
    mapping_key_lang = get_mapping(metadata.get('item_type_id'))
/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:160: in get_mapping
    mapping = Mapping.get_record(item_type_id)
/code/modules/weko-records/weko_records/api.py:996: in get_record
    with db.session.no_autoflush:
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/scoping.py:176: in get
    return getattr(self.registry(), name)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/_collections.py:1007: in __call__
    return self.registry.setdefault(key, self.createfunc())
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:3181: in __call__
    return self.class_(**local_kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_sqlalchemy/__init__.py:141: in __init__
    self.app = app = db.get_app()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <SQLAlchemy engine=None>, reference_app = None

    def get_app(self, reference_app=None):
        """Helper method that implements the logic to look up an
        application."""
    
        if reference_app is not None:
            return reference_app
    
        if current_app:
            return current_app._get_current_object()
    
        if self.app is not None:
            return self.app
    
        raise RuntimeError(
>           'No application found. Either work inside a view function or push'
            ' an application context. See'
            ' http://flask-sqlalchemy.pocoo.org/contexts/.'
        )
E       RuntimeError: No application found. Either work inside a view function or push an application context. See http://flask-sqlalchemy.pocoo.org/contexts/.

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_sqlalchemy/__init__.py:912: RuntimeError
________________________________ test_serialize ________________________________

db = <SQLAlchemy engine=sqlite:////code/modules/invenio-records-rest/examples/test.db>

    def test_serialize(db):
        """Test JSON serialize."""
        data = json.loads(
            JSONLDSerializer(CONTEXT, schema_class=_TestSchema).serialize(
                PersistentIdentifier(pid_type='recid', pid_value='2'),
>               Record({'title': 'mytitle', 'recid': '2'})
            )
        )

/code/modules/invenio-records-rest/tests/test_serializer_jsonld.py:46: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/invenio_records_rest/serializers/json.py:44: in serialize
    self.transform_record(pid, record, links_factory, **kwargs),
/code/modules/invenio-records-rest/invenio_records_rest/serializers/jsonld.py:66: in transform_record
    pid, record, links_factory, **kwargs
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_records_rest.serializers.jsonld.JSONLDSerializer object at 0x7f2495c45e80>
pid = <PersistentIdentifier recid:2 (None)>
record = {'title': 'mytitle', 'recid': '2'}, links_factory = None, kwargs = {}

    def transform_record(self, pid, record, links_factory=None, **kwargs):
        """Transform record into an intermediate representation.
    
        This method should delegate the record preprocessing to the
        preprocessor mixin's preprocess_record method.
    
        :param pid: Persistent identifier instance.
        :param record: Record instance.
        :param links_factory: Factory function for record links.
        """
>       raise NotImplementedError()
E       NotImplementedError

/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:90: NotImplementedError
____________________________ test_serialize_search _____________________________

    def test_serialize_search():
        """Test JSON serialize."""
        def fetcher(obj_uuid, data):
            assert obj_uuid in ['1', '2']
            return PersistentIdentifier(pid_type='recid', pid_value=data['recid'])
    
        data = json.loads(JSONLDSerializer(
            CONTEXT, schema_class=_TestSchema, expanded=True).serialize_search(
                fetcher,
                dict(
                    hits=dict(
                        hits=[
                            {'_source': dict(title='title1', recid='1'),
                             '_id': '1', '_version': 1},
                            {'_source': dict(title='title2', recid='2'),
                             '_id': '2', '_version': 1},
                        ],
                        total=2,
                    ),
>                   aggregations={},
                )
        ))

/code/modules/invenio-records-rest/tests/test_serializer_jsonld.py:93: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/invenio_records_rest/serializers/json.py:62: in serialize_search
    ) for hit in search_result['hits']['hits']],
/code/modules/invenio-records-rest/invenio_records_rest/serializers/json.py:62: in <listcomp>
    ) for hit in search_result['hits']['hits']],
/code/modules/invenio-records-rest/invenio_records_rest/serializers/jsonld.py:74: in transform_search_hit
    pid, record_hit, links_factory, **kwargs
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_records_rest.serializers.jsonld.JSONLDSerializer object at 0x7f2495585ef0>
pid = <PersistentIdentifier recid:1 (None)>
record_hit = {'_id': '1', '_source': {'recid': '1', 'title': 'title1'}, '_version': 1}
links_factory = None, kwargs = {}

    def transform_search_hit(self, pid, record_hit, links_factory=None,
                             **kwargs):
        """Transform search result hit into an intermediate representation.
    
        This method should delegate the record preprocessing to the
        preprocessor mixin's preprocess_search_hit method.
    
        :param pid: Persistent identifier instance.
        :param pid: Persistent identifier instance.
        :param record_hit: Record metadata retrieved via search.
        :param links_factory: Factory function for record links.
        """
>       raise NotImplementedError()
E       NotImplementedError

/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:104: NotImplementedError
____________________________ test_transform_record _____________________________

self = <sqlalchemy.util._collections.ScopedRegistry object at 0x7f24a5718048>

    def __call__(self):
        key = self.scopefunc()
        try:
>           return self.registry[key]
E           KeyError: 139795483457344

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/_collections.py:1005: KeyError

During handling of the above exception, another exception occurred:

    def test_transform_record():
        """Test marshmallow serializer."""
        serializer = SimpleMarshmallowSerializer(_TestSchema)
        data = serializer.transform_record(
            PersistentIdentifier(pid_type='recid', pid_value='1'),
            Record({'title': 'test'}),
>           marshmallow_context=dict(author='test2')
        )

/code/modules/invenio-records-rest/tests/test_serializer_marshmallow.py:36: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/invenio_records_rest/serializers/marshmallow.py:35: in transform_record
    links_factory=links_factory, **kwargs), context)
/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:206: in preprocess_record
    mapping_key_lang = get_mapping(metadata.get('item_type_id'))
/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:160: in get_mapping
    mapping = Mapping.get_record(item_type_id)
/code/modules/weko-records/weko_records/api.py:996: in get_record
    with db.session.no_autoflush:
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/scoping.py:176: in get
    return getattr(self.registry(), name)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/_collections.py:1007: in __call__
    return self.registry.setdefault(key, self.createfunc())
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:3181: in __call__
    return self.class_(**local_kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_sqlalchemy/__init__.py:141: in __init__
    self.app = app = db.get_app()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <SQLAlchemy engine=None>, reference_app = None

    def get_app(self, reference_app=None):
        """Helper method that implements the logic to look up an
        application."""
    
        if reference_app is not None:
            return reference_app
    
        if current_app:
            return current_app._get_current_object()
    
        if self.app is not None:
            return self.app
    
        raise RuntimeError(
>           'No application found. Either work inside a view function or push'
            ' an application context. See'
            ' http://flask-sqlalchemy.pocoo.org/contexts/.'
        )
E       RuntimeError: No application found. Either work inside a view function or push an application context. See http://flask-sqlalchemy.pocoo.org/contexts/.

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_sqlalchemy/__init__.py:912: RuntimeError
__________________________ test_transform_search_hit ___________________________

self = <sqlalchemy.util._collections.ScopedRegistry object at 0x7f24a5718048>

    def __call__(self):
        key = self.scopefunc()
        try:
>           return self.registry[key]
E           KeyError: 139795483457344

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/_collections.py:1005: KeyError

During handling of the above exception, another exception occurred:

    def test_transform_search_hit():
        """Test marshmallow serializer."""
        serializer = SimpleMarshmallowSerializer(_TestSchema)
        data = serializer.transform_record(
            PersistentIdentifier(pid_type='recid', pid_value='1'),
            Record({'title': 'test'}),
>           marshmallow_context=dict(author='test2')
        )

/code/modules/invenio-records-rest/tests/test_serializer_marshmallow.py:47: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/invenio_records_rest/serializers/marshmallow.py:35: in transform_record
    links_factory=links_factory, **kwargs), context)
/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:206: in preprocess_record
    mapping_key_lang = get_mapping(metadata.get('item_type_id'))
/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:160: in get_mapping
    mapping = Mapping.get_record(item_type_id)
/code/modules/weko-records/weko_records/api.py:996: in get_record
    with db.session.no_autoflush:
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/scoping.py:176: in get
    return getattr(self.registry(), name)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/_collections.py:1007: in __call__
    return self.registry.setdefault(key, self.createfunc())
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:3181: in __call__
    return self.class_(**local_kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_sqlalchemy/__init__.py:141: in __init__
    self.app = app = db.get_app()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <SQLAlchemy engine=None>, reference_app = None

    def get_app(self, reference_app=None):
        """Helper method that implements the logic to look up an
        application."""
    
        if reference_app is not None:
            return reference_app
    
        if current_app:
            return current_app._get_current_object()
    
        if self.app is not None:
            return self.app
    
        raise RuntimeError(
>           'No application found. Either work inside a view function or push'
            ' an application context. See'
            ' http://flask-sqlalchemy.pocoo.org/contexts/.'
        )
E       RuntimeError: No application found. Either work inside a view function or push an application context. See http://flask-sqlalchemy.pocoo.org/contexts/.

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_sqlalchemy/__init__.py:912: RuntimeError
_____________________ test_transform_record_default_schema _____________________

self = <sqlalchemy.util._collections.ScopedRegistry object at 0x7f24a5718048>

    def __call__(self):
        key = self.scopefunc()
        try:
>           return self.registry[key]
E           KeyError: 139795483457344

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/_collections.py:1005: KeyError

During handling of the above exception, another exception occurred:

    def test_transform_record_default_schema():
        """Test marshmallow serializer without providing a schema."""
        serializer = SimpleMarshmallowSerializer()
        data = serializer.transform_record(
            PersistentIdentifier(pid_type='recid', pid_value='1'),
>           Record({'title': 'test'})
        )

/code/modules/invenio-records-rest/tests/test_serializer_marshmallow.py:57: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/invenio_records_rest/serializers/marshmallow.py:35: in transform_record
    links_factory=links_factory, **kwargs), context)
/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:206: in preprocess_record
    mapping_key_lang = get_mapping(metadata.get('item_type_id'))
/code/modules/invenio-records-rest/invenio_records_rest/serializers/base.py:160: in get_mapping
    mapping = Mapping.get_record(item_type_id)
/code/modules/weko-records/weko_records/api.py:996: in get_record
    with db.session.no_autoflush:
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/scoping.py:176: in get
    return getattr(self.registry(), name)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/_collections.py:1007: in __call__
    return self.registry.setdefault(key, self.createfunc())
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:3181: in __call__
    return self.class_(**local_kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_sqlalchemy/__init__.py:141: in __init__
    self.app = app = db.get_app()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <SQLAlchemy engine=None>, reference_app = None

    def get_app(self, reference_app=None):
        """Helper method that implements the logic to look up an
        application."""
    
        if reference_app is not None:
            return reference_app
    
        if current_app:
            return current_app._get_current_object()
    
        if self.app is not None:
            return self.app
    
        raise RuntimeError(
>           'No application found. Either work inside a view function or push'
            ' an application context. See'
            ' http://flask-sqlalchemy.pocoo.org/contexts/.'
        )
E       RuntimeError: No application found. Either work inside a view function or push an application context. See http://flask-sqlalchemy.pocoo.org/contexts/.

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_sqlalchemy/__init__.py:912: RuntimeError
____________________________ test_search_responsify ____________________________

app = <Flask 'testapp'>

    def test_search_responsify(app):
        """Test JSON serialize."""
        search_serializer = search_responsify(
            TestSerializer(), 'application/x-custom')
    
        def fetcher():
            pass
    
        result = ['a'] * 5
    
>       resp = search_serializer(fetcher, result)

/code/modules/invenio-records-rest/tests/test_serializer_response.py:59: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

pid_fetcher = <function test_search_responsify.<locals>.fetcher at 0x7f2495a97158>
search_result = ['a', 'a', 'a', 'a', 'a'], code = 200, headers = None
links = None, item_links_factory = None

    def view(pid_fetcher, search_result, code=200, headers=None, links=None,
             item_links_factory=None):
>       if search_result['hits']['hits'] and \
                len(search_result['hits']['hits']) > 0:
E               TypeError: list indices must be integers or slices, not str

/code/modules/invenio-records-rest/invenio_records_rest/serializers/response.py:126: TypeError
_________________________ test_default_sorter_factory __________________________

app = <Flask 'testapp'>

    def test_default_sorter_factory(app):
        """Test default sorter factory."""
        app.config["RECORDS_REST_SORT_OPTIONS"] = dict(
            myindex=dict(
                myfield=dict(
                    fields=['field1', '-field2'],
                )
            ),
        )
        app.config["RECORDS_REST_DEFAULT_SORT"] = dict(
            myindex=dict(
                query='-myfield',
                noquery='myfield',
            ),
        )
    
        # Sort
        with app.test_request_context("?sort=myfield"):
            query, urlargs = default_sorter_factory(Search(), 'myindex')
>           assert query.to_dict()['sort'] == \
                [{'field1': {'order': 'asc'}}, {'field2': {'order': 'desc'}}]
E           AssertionError: assert [{'field1': {...pe': 'long'}}] == [{'field1': {...er': 'desc'}}]
E             At index 0 diff: {'field1': {'order': 'asc', 'unmapped_type': 'long'}} != {'field1': {'order': 'asc'}}
E             Full diff:
E               [
E             -  {'field1': {'order': 'asc'}},
E             ?                            --
E             +  {'field1': {'order': 'asc',
E             +              'unmapped_type': 'long'}},...
E             
E             ...Full output truncated (6 lines hidden), use '-vv' to show

/code/modules/invenio-records-rest/tests/test_sorter.py:103: AssertionError
______________________________ test_valid_delete _______________________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f24956e6a58> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2495596b38>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]

    def test_valid_delete(app, indexed_records):
        """Test VALID record delete request (DELETE .../records/<record_id>)."""
        # Test with and without headers
        for i, headers in enumerate([[], [('Accept', 'video/mp4')]]):
            pid, record = indexed_records[i]
            with app.test_client() as client:
                res = client.delete(record_url(pid), headers=headers)
                assert res.status_code == 204
    
>               res = client.get(record_url(pid))

/code/modules/invenio-records-rest/tests/test_views_item_delete.py:29: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:394: in inner
    pid, record = request.view_args['pid_value'].data
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/utils.py:91: in __get__
    value = self.func(obj)
/code/modules/invenio-records-rest/invenio_records_rest/utils.py:139: in data
    return self.resolver.resolve(self.value)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_pidstore/resolver.py:53: in resolve
    obj = self.object_getter(obj_id) if obj_id else None
/code/modules/invenio-records/invenio_records/api.py:207: in get_record
    cls.__custom_record_metadata(obj.json)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cls = <class 'invenio_records.api.Record'>, record_metadata = None

    @classmethod
    def __custom_record_metadata(cls, record_metadata: dict):
        """Custom record metadata.
    
        Args:
            record_metadata (dict): Record metadata.
        """
        from weko_records.utils import replace_fqdn_of_file_metadata
>       for k, v in record_metadata.items():
E       AttributeError: 'NoneType' object has no attribute 'items'

/code/modules/invenio-records/invenio_records/api.py:218: AttributeError
_____________________________ test_delete_deleted ______________________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2495c8ec88> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2495c77198>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]

    def test_delete_deleted(app, indexed_records):
        """Test deleting a perviously deleted record."""
        pid, record = indexed_records[0]
    
        with app.test_client() as client:
            res = client.delete(record_url(pid))
            assert res.status_code == 204
    
>           res = client.delete(record_url(pid))

/code/modules/invenio-records-rest/tests/test_views_item_delete.py:41: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1054: in delete
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:394: in inner
    pid, record = request.view_args['pid_value'].data
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/utils.py:91: in __get__
    value = self.func(obj)
/code/modules/invenio-records-rest/invenio_records_rest/utils.py:139: in data
    return self.resolver.resolve(self.value)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_pidstore/resolver.py:53: in resolve
    obj = self.object_getter(obj_id) if obj_id else None
/code/modules/invenio-records/invenio_records/api.py:207: in get_record
    cls.__custom_record_metadata(obj.json)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cls = <class 'invenio_records.api.Record'>, record_metadata = None

    @classmethod
    def __custom_record_metadata(cls, record_metadata: dict):
        """Custom record metadata.
    
        Args:
            record_metadata (dict): Record metadata.
        """
        from weko_records.utils import replace_fqdn_of_file_metadata
>       for k, v in record_metadata.items():
E       AttributeError: 'NoneType' object has no attribute 'items'

/code/modules/invenio-records/invenio_records/api.py:218: AttributeError
______________________ test_delete_with_sqldatabase_error ______________________

self = <invenio_records_rest.views.RecordResource object at 0x7f249562ba90>
pid_value = <invenio_records_rest.utils.LazyPIDValue object at 0x7f249562bb38>
args = (), kwargs = {}
pid = <PersistentIdentifier recid:1 / rec:cb3e08be-0bf7-4ed5-b424-fa2a9e48e106 (R)>
record = {'year': 2015, 'stars': 4, 'title': 'Back to the Future', 'control_number': '1'}

    @wraps(f)
    def inner(self, pid_value, *args, **kwargs):
        try:
            pid, record = request.view_args['pid_value'].data
>           return f(self, pid=pid, record=record, *args, **kwargs)

/code/modules/invenio-records-rest/invenio_records_rest/views.py:395: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_records_rest.views.RecordResource object at 0x7f249562ba90>
record = {'year': 2015, 'stars': 4, 'title': 'Back to the Future', 'control_number': '1'}
args = ()
kwargs = {'pid': <PersistentIdentifier recid:1 / rec:cb3e08be-0bf7-4ed5-b424-fa2a9e48e106 (R)>}
permission_factory = None

    @wraps(f)
    def need_record_permission_decorator(self, record=None, *args,
                                         **kwargs):
        permission_factory = (
            getattr(self, factory_name)
            or getattr(current_records_rest, factory_name)
        )
    
        # FIXME use context instead
        request._methodview = self
    
        if permission_factory:
            verify_record_permission(permission_factory, record)
>       return f(self, record=record, *args, **kwargs)

/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_records_rest.views.RecordResource object at 0x7f249562ba90>
pid = <PersistentIdentifier recid:1 / rec:cb3e08be-0bf7-4ed5-b424-fa2a9e48e106 (R)>
record = {'year': 2015, 'stars': 4, 'title': 'Back to the Future', 'control_number': '1'}
kwargs = {}
all_pids = [<PersistentIdentifier recid:1 / rec:cb3e08be-0bf7-4ed5-b424-fa2a9e48e106 (R)>]
rec_pid = <PersistentIdentifier recid:1 / rec:cb3e08be-0bf7-4ed5-b424-fa2a9e48e106 (R)>

    @pass_record
    @need_record_permission('delete_permission_factory')
    def delete(self, pid, record, **kwargs):
        """Delete a record.
    
        Permissions: ``delete_permission_factory``
    
        Procedure description:
    
        #. The record is resolved reading the pid value from the url.
    
        #. The ETag is checked.
    
        #. The record is deleted.
    
        #. All PIDs are marked as DELETED.
    
        :param pid: Persistent identifier for record.
        :param record: Record object.
        """
        self.check_etag(str(record.model.version_id))
    
        record.delete()
        # mark all PIDs as DELETED
        all_pids = PersistentIdentifier.query.filter(
            PersistentIdentifier.object_type == pid.object_type,
            PersistentIdentifier.object_uuid == pid.object_uuid,
        ).all()
        for rec_pid in all_pids:
            if not rec_pid.is_deleted():
>               rec_pid.delete()

/code/modules/invenio-records-rest/invenio_records_rest/views.py:929: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

_mock_self = <MagicMock name='delete' id='139795102124296'>, args = ()
kwargs = {}

    def __call__(_mock_self, *args, **kwargs):
        # can't use self in-case a function / method we are mocking uses self
        # in the signature
        _mock_self._mock_check_sig(*args, **kwargs)
>       return _mock_self._mock_call(*args, **kwargs)

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/mock/mock.py:1092: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

_mock_self = <MagicMock name='delete' id='139795102124296'>, args = ()
kwargs = {}, self = <MagicMock name='delete' id='139795102124296'>
_call = call(), do_method_calls = False, method_call_name = 'delete'
mock_call_name = '', is_a_call = False, _new_parent = None
effect = <function test_delete_with_sqldatabase_error.<locals>.raise_error at 0x7f2495625048>

    def _mock_call(_mock_self, *args, **kwargs):
        self = _mock_self
        self.called = True
        self.call_count += 1
    
        # handle call_args
        _call = _Call((args, kwargs), two=True)
        self.call_args = _call
        self.call_args_list.append(_call)
    
        # initial stuff for method_calls:
        do_method_calls = self._mock_parent is not None
        method_call_name = self._mock_name
    
        # initial stuff for mock_calls:
        mock_call_name = self._mock_new_name
        is_a_call = mock_call_name == '()'
        self.mock_calls.append(_Call(('', args, kwargs)))
    
        # follow up the chain of mocks:
        _new_parent = self._mock_new_parent
        while _new_parent is not None:
    
            # handle method_calls:
            if do_method_calls:
                _new_parent.method_calls.append(_Call((method_call_name, args, kwargs)))
                do_method_calls = _new_parent._mock_parent is not None
                if do_method_calls:
                    method_call_name = _new_parent._mock_name + '.' + method_call_name
    
            # handle mock_calls:
            this_mock_call = _Call((mock_call_name, args, kwargs))
            _new_parent.mock_calls.append(this_mock_call)
    
            if _new_parent._mock_new_name:
                if is_a_call:
                    dot = ''
                else:
                    dot = '.'
                is_a_call = _new_parent._mock_new_name == '()'
                mock_call_name = _new_parent._mock_new_name + dot + mock_call_name
    
            # follow the parental chain:
            _new_parent = _new_parent._mock_new_parent
    
        effect = self.side_effect
        if effect is not None:
            if _is_exception(effect):
                raise effect
            elif not _callable(effect):
                result = next(effect)
                if _is_exception(result):
                    raise result
            else:
>               result = effect(*args, **kwargs)

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/mock/mock.py:1149: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    def raise_error():
>       raise SQLAlchemyError()
E       sqlalchemy.exc.SQLAlchemyError: ()

/code/modules/invenio-records-rest/tests/test_views_item_delete.py:63: SQLAlchemyError

During handling of the above exception, another exception occurred:

app = <Flask 'testapp'>
indexed_records = [(<PersistentIdentifier recid:1 / rec:cb3e08be-0bf7-4ed5-b424-fa2a9e48e106 (R)>, {'year': 2015, 'stars': 4, 'title': '...stentIdentifier object at 0x7f24956186d8>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]

    def test_delete_with_sqldatabase_error(app, indexed_records):
        """Test VALID record delete request (GET .../records/<record_id>)."""
        pid, record = indexed_records[0]
    
        with app.test_client() as client:
            def raise_error():
                raise SQLAlchemyError()
            # Force an SQLAlchemy error that will rollback the transaction.
            with patch.object(PersistentIdentifier, 'delete',
                              side_effect=raise_error):
>               res = client.delete(record_url(pid))

/code/modules/invenio-records-rest/tests/test_views_item_delete.py:67: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1054: in delete
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:397: in inner
    current_app.logger.error('sqlalchemy error: ', ex)
/usr/local/lib/python3.6/logging/__init__.py:1337: in error
    self._log(ERROR, msg, args, **kwargs)
/usr/local/lib/python3.6/logging/__init__.py:1444: in _log
    self.handle(record)
/usr/local/lib/python3.6/logging/__init__.py:1454: in handle
    self.callHandlers(record)
/usr/local/lib/python3.6/logging/__init__.py:1516: in callHandlers
    hdlr.handle(record)
/usr/local/lib/python3.6/logging/__init__.py:865: in handle
    self.emit(record)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/_pytest/logging.py:328: in emit
    super().emit(record)
/usr/local/lib/python3.6/logging/__init__.py:1000: in emit
    self.handleError(record)
/usr/local/lib/python3.6/logging/__init__.py:994: in emit
    msg = self.format(record)
/usr/local/lib/python3.6/logging/__init__.py:840: in format
    return fmt.format(record)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/_pytest/logging.py:89: in format
    return super().format(record)
/usr/local/lib/python3.6/logging/__init__.py:577: in format
    record.message = record.getMessage()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <LogRecord: flask.app, 40, /code/modules/invenio-records-rest/invenio_records_rest/views.py, 397, "sqlalchemy error: ">

    def getMessage(self):
        """
        Return the message for this LogRecord.
    
        Return the message for this LogRecord after merging any user-supplied
        arguments with the message.
        """
        msg = str(self.msg)
        if self.args:
>           msg = msg % self.args
E           TypeError: not all arguments converted during string formatting

/usr/local/lib/python3.6/logging/__init__.py:338: TypeError
______________________________ test_item_get_etag ______________________________

app = <Flask 'testapp'>
test_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2495abbb00> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2495b91a20>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]

    def test_item_get_etag(app, test_records):
        """Test VALID record get request (GET .../records/<record_id>)."""
        with app.test_client() as client:
            pid, record = test_records[0]
    
            res = client.get(record_url(pid))
            assert res.status_code == 200
            etag = res.headers['ETag']
            last_modified = res.headers['Last-Modified']
    
            # Test request via etag
            res = client.get(record_url(pid), headers={'If-None-Match': etag})
            assert res.status_code == 304
    
            # Test request via last-modified.
            res = client.get(
>               record_url(pid), headers={'If-Modified-Since': last_modified})

/code/modules/invenio-records-rest/tests/test_views_item_get.py:56: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/tests/helpers.py:74: in record_url
    if hasattr(pid, 'pid_value'):
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/attributes.py:275: in __get__
    return self.impl.get(instance_state(instance), dict_)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/attributes.py:669: in get
    value = state._load_expired(state, passive)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/state.py:632: in _load_expired
    self.manager.deferred_scalar_loader(self, toload)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

mapper = <Mapper at 0x7f24a56f1358; PersistentIdentifier>
state = <sqlalchemy.orm.state.InstanceState object at 0x7f2495de59b0>
attribute_names = {'created', 'id', 'object_type', 'object_uuid', 'pid_provider', 'pid_type', ...}

    def load_scalar_attributes(mapper, state, attribute_names):
        """initiate a column-based attribute refresh operation."""
    
        # assert mapper is _state_mapper(state)
        session = state.session
        if not session:
            raise orm_exc.DetachedInstanceError(
                "Instance %s is not bound to a Session; "
>               "attribute refresh operation cannot proceed" % (state_str(state))
            )
E           sqlalchemy.orm.exc.DetachedInstanceError: Instance <PersistentIdentifier at 0x7f2495abbb00> is not bound to a Session; attribute refresh operation cannot proceed (Background on this error at: http://sqlalche.me/e/bhk3)

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/loading.py:913: DetachedInstanceError
________________ test_valid_patch[application/json-patch+json] _________________

app = <Flask 'testapp'>, es = <tests.conftest.MockEs object at 0x7f2496245470>
test_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2495493cf8> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2495921320>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
test_patch = [{'op': 'replace', 'path': '/year', 'value': 1985}]
content_type = 'application/json-patch+json'
search_url = 'http://localhost:5000/records/'
search_class = <class 'tests.conftest.TestSearch'>

    @pytest.mark.parametrize('content_type', [
        'application/json-patch+json', 'application/json-patch+json;charset=utf-8'
    ])
    def test_valid_patch(app, es, test_records, test_patch, content_type,
                         search_url, search_class):
        """Test VALID record patch request (PATCH .../records/<record_id>)."""
        HEADERS = [
            ('Accept', 'application/json'),
            ('Content-Type', content_type)
        ]
        pid, record = test_records[0]
    
        # Check that
        assert record.patch(test_patch)
    
        with app.test_client() as client:
            # Check that patch and record is not the same value for year.
            url = record_url(pid)
            previous_year = get_json(client.get(url))['metadata']['year']
    
            # Patch record
            res = client.patch(url, data=json.dumps(test_patch), headers=HEADERS)
            assert res.status_code == 200
    
            # Check that year changed.
            new_year = get_json(client.get(url))['metadata']['year']
            assert previous_year != new_year
            IndexFlusher(search_class).flush_and_wait()
>           res = client.get(search_url, query_string={'year': new_year})

/code/modules/invenio-records-rest/tests/test_views_item_patch.py:49: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_________ test_valid_patch[application/json-patch+json;charset=utf-8] __________

app = <Flask 'testapp'>, es = <tests.conftest.MockEs object at 0x7f2495edcd68>
test_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2495fadb38> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2495403c88>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
test_patch = [{'op': 'replace', 'path': '/year', 'value': 1985}]
content_type = 'application/json-patch+json;charset=utf-8'
search_url = 'http://localhost:5000/records/'
search_class = <class 'tests.conftest.TestSearch'>

    @pytest.mark.parametrize('content_type', [
        'application/json-patch+json', 'application/json-patch+json;charset=utf-8'
    ])
    def test_valid_patch(app, es, test_records, test_patch, content_type,
                         search_url, search_class):
        """Test VALID record patch request (PATCH .../records/<record_id>)."""
        HEADERS = [
            ('Accept', 'application/json'),
            ('Content-Type', content_type)
        ]
        pid, record = test_records[0]
    
        # Check that
        assert record.patch(test_patch)
    
        with app.test_client() as client:
            # Check that patch and record is not the same value for year.
            url = record_url(pid)
            previous_year = get_json(client.get(url))['metadata']['year']
    
            # Patch record
            res = client.patch(url, data=json.dumps(test_patch), headers=HEADERS)
            assert res.status_code == 200
    
            # Check that year changed.
            new_year = get_json(client.get(url))['metadata']['year']
            assert previous_year != new_year
            IndexFlusher(search_class).flush_and_wait()
>           res = client.get(search_url, query_string={'year': new_year})

/code/modules/invenio-records-rest/tests/test_views_item_patch.py:49: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_______________ test_patch_deleted[application/json-patch+json] ________________

app = <Flask 'testapp'>
db = <SQLAlchemy engine=sqlite:////code/modules/invenio-records-rest/examples/test.db>
es = <tests.conftest.MockEs object at 0x7f2495657c88>
test_data = [{'stars': 4, 'title': 'Back to the Future', 'year': 2015}, {'stars': 3, 'title': 'Back to the Past', 'year': 2042}, {...4, 'title': "The Hitchhiker's Guide to the Galaxy", 'year': 1985}, {'stars': 5, 'title': 'Unknown film', 'year': 4242}]
test_patch = [{'op': 'replace', 'path': '/year', 'value': 1985}]
content_type = 'application/json-patch+json'
search_url = 'http://localhost:5000/records/'
search_class = <class 'tests.conftest.TestSearch'>

    @pytest.mark.parametrize('content_type', [
        'application/json-patch+json', 'application/json-patch+json;charset=utf-8'
    ])
    def test_patch_deleted(app, db, es, test_data, test_patch, content_type,
                           search_url, search_class):
        """Test patching deleted record."""
        HEADERS = [
            ('Accept', 'application/json'),
            ('Content-Type', content_type)
        ]
    
        with app.test_client() as client:
            # Create record
            res = client.post(
                search_url, data=json.dumps(test_data[0]), headers=HEADERS)
            assert res.status_code == 201
            _id = get_json(res)['id']
            # Delete record.
            url = record_url(_id)
            assert client.delete(url).status_code == 204
    
            # check patch response for deleted resource
>           res = client.patch(url, data=json.dumps(test_patch), headers=HEADERS)

/code/modules/invenio-records-rest/tests/test_views_item_patch.py:75: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1034: in patch
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/decorators.py:32: in inner
    return f(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:394: in inner
    pid, record = request.view_args['pid_value'].data
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/utils.py:91: in __get__
    value = self.func(obj)
/code/modules/invenio-records-rest/invenio_records_rest/utils.py:139: in data
    return self.resolver.resolve(self.value)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_pidstore/resolver.py:53: in resolve
    obj = self.object_getter(obj_id) if obj_id else None
/code/modules/invenio-records/invenio_records/api.py:207: in get_record
    cls.__custom_record_metadata(obj.json)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cls = <class 'invenio_records.api.Record'>, record_metadata = None

    @classmethod
    def __custom_record_metadata(cls, record_metadata: dict):
        """Custom record metadata.
    
        Args:
            record_metadata (dict): Record metadata.
        """
        from weko_records.utils import replace_fqdn_of_file_metadata
>       for k, v in record_metadata.items():
E       AttributeError: 'NoneType' object has no attribute 'items'

/code/modules/invenio-records/invenio_records/api.py:218: AttributeError
________ test_patch_deleted[application/json-patch+json;charset=utf-8] _________

app = <Flask 'testapp'>
db = <SQLAlchemy engine=sqlite:////code/modules/invenio-records-rest/examples/test.db>
es = <tests.conftest.MockEs object at 0x7f24952b5d30>
test_data = [{'stars': 4, 'title': 'Back to the Future', 'year': 2015}, {'stars': 3, 'title': 'Back to the Past', 'year': 2042}, {...4, 'title': "The Hitchhiker's Guide to the Galaxy", 'year': 1985}, {'stars': 5, 'title': 'Unknown film', 'year': 4242}]
test_patch = [{'op': 'replace', 'path': '/year', 'value': 1985}]
content_type = 'application/json-patch+json;charset=utf-8'
search_url = 'http://localhost:5000/records/'
search_class = <class 'tests.conftest.TestSearch'>

    @pytest.mark.parametrize('content_type', [
        'application/json-patch+json', 'application/json-patch+json;charset=utf-8'
    ])
    def test_patch_deleted(app, db, es, test_data, test_patch, content_type,
                           search_url, search_class):
        """Test patching deleted record."""
        HEADERS = [
            ('Accept', 'application/json'),
            ('Content-Type', content_type)
        ]
    
        with app.test_client() as client:
            # Create record
            res = client.post(
                search_url, data=json.dumps(test_data[0]), headers=HEADERS)
            assert res.status_code == 201
            _id = get_json(res)['id']
            # Delete record.
            url = record_url(_id)
            assert client.delete(url).status_code == 204
    
            # check patch response for deleted resource
>           res = client.patch(url, data=json.dumps(test_patch), headers=HEADERS)

/code/modules/invenio-records-rest/tests/test_views_item_patch.py:75: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1034: in patch
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/decorators.py:32: in inner
    return f(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:394: in inner
    pid, record = request.view_args['pid_value'].data
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/utils.py:91: in __get__
    value = self.func(obj)
/code/modules/invenio-records-rest/invenio_records_rest/utils.py:139: in data
    return self.resolver.resolve(self.value)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_pidstore/resolver.py:53: in resolve
    obj = self.object_getter(obj_id) if obj_id else None
/code/modules/invenio-records/invenio_records/api.py:207: in get_record
    cls.__custom_record_metadata(obj.json)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cls = <class 'invenio_records.api.Record'>, record_metadata = None

    @classmethod
    def __custom_record_metadata(cls, record_metadata: dict):
        """Custom record metadata.
    
        Args:
            record_metadata (dict): Record metadata.
        """
        from weko_records.utils import replace_fqdn_of_file_metadata
>       for k, v in record_metadata.items():
E       AttributeError: 'NoneType' object has no attribute 'items'

/code/modules/invenio-records/invenio_records/api.py:218: AttributeError
_____________________________ test_invalid_patch[] _____________________________

app = <Flask 'testapp'>, es = <tests.conftest.MockEs object at 0x7f2495fe0cf8>
test_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2495cb1470> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2495716860>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
test_patch = [{'op': 'replace', 'path': '/year', 'value': 1985}], charset = ''
search_url = 'http://localhost:5000/records/'
search_class = <class 'tests.conftest.TestSearch'>

    @pytest.mark.parametrize('charset', [
        '', ';charset=utf-8'
    ])
    def test_invalid_patch(app, es, test_records, test_patch, charset, search_url,
                           search_class):
        """Test INVALID record put request (PUT .../records/<record_id>)."""
        HEADERS = [
            ('Accept', 'application/json'),
            ('Content-Type',
             'application/json-patch+json{0}'.format(charset))
        ]
        pid, record = test_records[0]
    
        with app.test_client() as client:
            url = record_url(pid)
    
            # Non-existing record
            res = client.patch(
                record_url('0'), data=json.dumps(test_patch), headers=HEADERS)
            assert res.status_code == 404
            IndexFlusher(search_class).flush_and_wait()
>           res = client.get(search_url)

/code/modules/invenio-records-rest/tests/test_views_item_patch.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
______________________ test_invalid_patch[;charset=utf-8] ______________________

app = <Flask 'testapp'>, es = <tests.conftest.MockEs object at 0x7f2495a72198>
test_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f24954d1438> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f24954e3908>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
test_patch = [{'op': 'replace', 'path': '/year', 'value': 1985}]
charset = ';charset=utf-8', search_url = 'http://localhost:5000/records/'
search_class = <class 'tests.conftest.TestSearch'>

    @pytest.mark.parametrize('charset', [
        '', ';charset=utf-8'
    ])
    def test_invalid_patch(app, es, test_records, test_patch, charset, search_url,
                           search_class):
        """Test INVALID record put request (PUT .../records/<record_id>)."""
        HEADERS = [
            ('Accept', 'application/json'),
            ('Content-Type',
             'application/json-patch+json{0}'.format(charset))
        ]
        pid, record = test_records[0]
    
        with app.test_client() as client:
            url = record_url(pid)
    
            # Non-existing record
            res = client.patch(
                record_url('0'), data=json.dumps(test_patch), headers=HEADERS)
            assert res.status_code == 404
            IndexFlusher(search_class).flush_and_wait()
>           res = client.get(search_url)

/code/modules/invenio-records-rest/tests/test_views_item_patch.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_______________________ test_valid_put[application/json] _______________________

app = <Flask 'testapp'>, es = <tests.conftest.MockEs object at 0x7f2495cb66a0>
test_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f24952d2ac8> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2495501f60>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
content_type = 'application/json', search_url = 'http://localhost:5000/records/'
search_class = <class 'tests.conftest.TestSearch'>

    @pytest.mark.parametrize('content_type', [
        'application/json', 'application/json;charset=utf-8'
    ])
    def test_valid_put(app, es, test_records, content_type, search_url,
                       search_class):
        """Test VALID record patch request (PATCH .../records/<record_id>)."""
        HEADERS = [
            ('Accept', 'application/json'),
            ('Content-Type', content_type)
        ]
    
        pid, record = test_records[0]
    
        record['year'] = 1234
    
        with app.test_client() as client:
            url = record_url(pid)
            res = client.put(url, data=json.dumps(record.dumps()), headers=HEADERS)
            assert res.status_code == 200
    
            # Check that the returned record matches the given data
            assert get_json(res)['metadata']['year'] == 1234
            IndexFlusher(search_class).flush_and_wait()
>           res = client.get(search_url, query_string={"year": 1234})

/code/modules/invenio-records-rest/tests/test_views_item_put.py:44: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
________________ test_valid_put[application/json;charset=utf-8] ________________

app = <Flask 'testapp'>, es = <tests.conftest.MockEs object at 0x7f24952a1f60>
test_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f249585c438> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2495976550>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
content_type = 'application/json;charset=utf-8'
search_url = 'http://localhost:5000/records/'
search_class = <class 'tests.conftest.TestSearch'>

    @pytest.mark.parametrize('content_type', [
        'application/json', 'application/json;charset=utf-8'
    ])
    def test_valid_put(app, es, test_records, content_type, search_url,
                       search_class):
        """Test VALID record patch request (PATCH .../records/<record_id>)."""
        HEADERS = [
            ('Accept', 'application/json'),
            ('Content-Type', content_type)
        ]
    
        pid, record = test_records[0]
    
        record['year'] = 1234
    
        with app.test_client() as client:
            url = record_url(pid)
            res = client.put(url, data=json.dumps(record.dumps()), headers=HEADERS)
            assert res.status_code == 200
    
            # Check that the returned record matches the given data
            assert get_json(res)['metadata']['year'] == 1234
            IndexFlusher(search_class).flush_and_wait()
>           res = client.get(search_url, query_string={"year": 1234})

/code/modules/invenio-records-rest/tests/test_views_item_put.py:44: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
____________________ test_valid_put_etag[application/json] _____________________

app = <Flask 'testapp'>, es = <tests.conftest.MockEs object at 0x7f24952224e0>
test_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f249501fc50> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2495424cf8>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
content_type = 'application/json', search_url = 'http://localhost:5000/records/'
search_class = <class 'tests.conftest.TestSearch'>

    @pytest.mark.parametrize('content_type', [
        'application/json', 'application/json;charset=utf-8'
    ])
    def test_valid_put_etag(app, es, test_records, content_type, search_url,
                            search_class):
        """Test concurrency control with etags."""
        HEADERS = [
            ('Accept', 'application/json'),
            ('Content-Type', content_type)
        ]
    
        pid, record = test_records[0]
    
        record['year'] = 1234
    
        with app.test_client() as client:
            url = record_url(pid)
            res = client.put(
                url,
                data=json.dumps(record.dumps()),
                headers={
                    'Content-Type': 'application/json',
                    'If-Match': '"{0}"'.format(record.revision_id)
                })
            assert res.status_code == 200
            assert get_json(client.get(url))['metadata']['year'] == 1234
    
            IndexFlusher(search_class).flush_and_wait()
>           res = client.get(search_url, query_string={"year": 1234})

/code/modules/invenio-records-rest/tests/test_views_item_put.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_____________ test_valid_put_etag[application/json;charset=utf-8] ______________

app = <Flask 'testapp'>, es = <tests.conftest.MockEs object at 0x7f2495637a20>
test_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f249566db70> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f24967b1550>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
content_type = 'application/json;charset=utf-8'
search_url = 'http://localhost:5000/records/'
search_class = <class 'tests.conftest.TestSearch'>

    @pytest.mark.parametrize('content_type', [
        'application/json', 'application/json;charset=utf-8'
    ])
    def test_valid_put_etag(app, es, test_records, content_type, search_url,
                            search_class):
        """Test concurrency control with etags."""
        HEADERS = [
            ('Accept', 'application/json'),
            ('Content-Type', content_type)
        ]
    
        pid, record = test_records[0]
    
        record['year'] = 1234
    
        with app.test_client() as client:
            url = record_url(pid)
            res = client.put(
                url,
                data=json.dumps(record.dumps()),
                headers={
                    'Content-Type': 'application/json',
                    'If-Match': '"{0}"'.format(record.revision_id)
                })
            assert res.status_code == 200
            assert get_json(client.get(url))['metadata']['year'] == 1234
    
            IndexFlusher(search_class).flush_and_wait()
>           res = client.get(search_url, query_string={"year": 1234})

/code/modules/invenio-records-rest/tests/test_views_item_put.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
____________________ test_put_on_deleted[application/json] _____________________

app = <Flask 'testapp'>
db = <SQLAlchemy engine=sqlite:////code/modules/invenio-records-rest/examples/test.db>
es = <tests.conftest.MockEs object at 0x7f24958dfeb8>
test_data = [{'stars': 4, 'title': 'Back to the Future', 'year': 2015}, {'stars': 3, 'title': 'Back to the Past', 'year': 2042}, {...4, 'title': "The Hitchhiker's Guide to the Galaxy", 'year': 1985}, {'stars': 5, 'title': 'Unknown film', 'year': 4242}]
content_type = 'application/json', search_url = 'http://localhost:5000/records/'
search_class = <class 'tests.conftest.TestSearch'>

    @pytest.mark.parametrize('content_type', [
        'application/json', 'application/json;charset=utf-8'
    ])
    def test_put_on_deleted(app, db, es, test_data, content_type, search_url,
                            search_class):
        """Test putting to a deleted record."""
        with app.test_client() as client:
            HEADERS = [
                ('Accept', 'application/json'),
                ('Content-Type', content_type)
            ]
            HEADERS.append(('Content-Type', content_type))
    
            # Create record
            res = client.post(
                search_url, data=json.dumps(test_data[0]), headers=HEADERS)
            assert res.status_code == 201
    
            url = record_url(get_json(res)['id'])
            assert client.delete(url).status_code == 204
            IndexFlusher(search_class).flush_and_wait()
            res = client.get(search_url,
>                            query_string={'title': test_data[0]['title']})

/code/modules/invenio-records-rest/tests/test_views_item_put.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_____________ test_put_on_deleted[application/json;charset=utf-8] ______________

app = <Flask 'testapp'>
db = <SQLAlchemy engine=sqlite:////code/modules/invenio-records-rest/examples/test.db>
es = <tests.conftest.MockEs object at 0x7f2495397d30>
test_data = [{'stars': 4, 'title': 'Back to the Future', 'year': 2015}, {'stars': 3, 'title': 'Back to the Past', 'year': 2042}, {...4, 'title': "The Hitchhiker's Guide to the Galaxy", 'year': 1985}, {'stars': 5, 'title': 'Unknown film', 'year': 4242}]
content_type = 'application/json;charset=utf-8'
search_url = 'http://localhost:5000/records/'
search_class = <class 'tests.conftest.TestSearch'>

    @pytest.mark.parametrize('content_type', [
        'application/json', 'application/json;charset=utf-8'
    ])
    def test_put_on_deleted(app, db, es, test_data, content_type, search_url,
                            search_class):
        """Test putting to a deleted record."""
        with app.test_client() as client:
            HEADERS = [
                ('Accept', 'application/json'),
                ('Content-Type', content_type)
            ]
            HEADERS.append(('Content-Type', content_type))
    
            # Create record
            res = client.post(
                search_url, data=json.dumps(test_data[0]), headers=HEADERS)
            assert res.status_code == 201
    
            url = record_url(get_json(res)['id'])
            assert client.delete(url).status_code == 204
            IndexFlusher(search_class).flush_and_wait()
            res = client.get(search_url,
>                            query_string={'title': test_data[0]['title']})

/code/modules/invenio-records-rest/tests/test_views_item_put.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
______________________________ test_invalid_put[] ______________________________

app = <Flask 'testapp'>, es = <tests.conftest.MockEs object at 0x7f249547bf28>
test_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2495f0cc88> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f24955d4cc0>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
charset = '', search_url = 'http://localhost:5000/records/'

    @pytest.mark.parametrize('charset', [
        '', ';charset=utf-8'
    ])
    def test_invalid_put(app, es, test_records, charset, search_url):
        """Test INVALID record put request (PUT .../records/<record_id>)."""
        HEADERS = [
            ('Accept', 'application/json'),
            ('Content-Type',
             'application/json{0}'.format(charset)),
        ]
    
        pid, record = test_records[0]
    
        record['year'] = 1234
        test_data = record.dumps()
    
        with app.test_client() as client:
            url = record_url(pid)
    
            # Non-existing record
            res = client.put(
                record_url('0'), data=json.dumps(test_data), headers=HEADERS)
            assert res.status_code == 404
>           res = client.get(search_url, query_string={"year": 1234})

/code/modules/invenio-records-rest/tests/test_views_item_put.py:134: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_______________________ test_invalid_put[;charset=utf-8] _______________________

app = <Flask 'testapp'>, es = <tests.conftest.MockEs object at 0x7f2495151470>
test_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2495f69cc0> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2495f66e10>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
charset = ';charset=utf-8', search_url = 'http://localhost:5000/records/'

    @pytest.mark.parametrize('charset', [
        '', ';charset=utf-8'
    ])
    def test_invalid_put(app, es, test_records, charset, search_url):
        """Test INVALID record put request (PUT .../records/<record_id>)."""
        HEADERS = [
            ('Accept', 'application/json'),
            ('Content-Type',
             'application/json{0}'.format(charset)),
        ]
    
        pid, record = test_records[0]
    
        record['year'] = 1234
        test_data = record.dumps()
    
        with app.test_client() as client:
            url = record_url(pid)
    
            # Non-existing record
            res = client.put(
                record_url('0'), data=json.dumps(test_data), headers=HEADERS)
            assert res.status_code == 404
>           res = client.get(search_url, query_string={"year": 1234})

/code/modules/invenio-records-rest/tests/test_views_item_put.py:134: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
___________________ test_validation_error[application/json] ____________________

app = <Flask 'testapp'>
test_records = [(<PersistentIdentifier recid:1 / rec:3bb43226-2846-4cda-852a-8d65ca240dab (R)>, {'year': 1234, 'stars': 4, 'title': '...stentIdentifier object at 0x7f24954720b8>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
content_type = 'application/json'

    @mock.patch('invenio_records.api.Record.validate', _mock_validate_fail)
    @pytest.mark.parametrize('content_type', [
        'application/json', 'application/json;charset=utf-8'
    ])
    def test_validation_error(app, test_records, content_type):
        """Test when record validation fail."""
        HEADERS = [
            ('Accept', 'application/json'),
            ('Content-Type', content_type)
        ]
    
        pid, record = test_records[0]
    
        record['year'] = 1234
    
        with app.test_client() as client:
            url = record_url(pid)
            res = client.put(url, data=json.dumps(record.dumps()), headers=HEADERS)
>           assert res.status_code == 400
E           assert 200 == 400
E             +200
E             -400

/code/modules/invenio-records-rest/tests/test_views_item_put.py:181: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    flask.app:views.py:1045 Traceback (most recent call last):
  File "/code/modules/invenio-records-rest/invenio_records_rest/views.py", line 1042, in put
    record.commit()
  File "/code/modules/invenio-records/invenio_records/api.py", line 281, in commit
    self.validate(**kwargs)
  File "/code/modules/invenio-records-rest/tests/helpers.py", line 84, in _mock_validate_fail
    raise ValidationError("")
jsonschema.exceptions.ValidationError
____________ test_validation_error[application/json;charset=utf-8] _____________

app = <Flask 'testapp'>
test_records = [(<PersistentIdentifier recid:1 / rec:729d5f3a-a64b-4e84-a7ab-57f88d0b5d6a (R)>, {'year': 1234, 'stars': 4, 'title': '...stentIdentifier object at 0x7f2495989518>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
content_type = 'application/json;charset=utf-8'

    @mock.patch('invenio_records.api.Record.validate', _mock_validate_fail)
    @pytest.mark.parametrize('content_type', [
        'application/json', 'application/json;charset=utf-8'
    ])
    def test_validation_error(app, test_records, content_type):
        """Test when record validation fail."""
        HEADERS = [
            ('Accept', 'application/json'),
            ('Content-Type', content_type)
        ]
    
        pid, record = test_records[0]
    
        record['year'] = 1234
    
        with app.test_client() as client:
            url = record_url(pid)
            res = client.put(url, data=json.dumps(record.dumps()), headers=HEADERS)
>           assert res.status_code == 400
E           assert 200 == 400
E             +200
E             -400

/code/modules/invenio-records-rest/tests/test_views_item_put.py:181: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    flask.app:views.py:1045 Traceback (most recent call last):
  File "/code/modules/invenio-records-rest/invenio_records_rest/views.py", line 1042, in put
    record.commit()
  File "/code/modules/invenio-records/invenio_records/api.py", line 281, in commit
    self.validate(**kwargs)
  File "/code/modules/invenio-records-rest/tests/helpers.py", line 84, in _mock_validate_fail
    raise ValidationError("")
jsonschema.exceptions.ValidationError
_____________________ test_valid_create[application/json] ______________________

app = <Flask 'testapp'>
db = <SQLAlchemy engine=sqlite:////code/modules/invenio-records-rest/examples/test.db>
es = <tests.conftest.MockEs object at 0x7f2495daf588>
test_data = [{'stars': 4, 'title': 'Back to the Future', 'year': 2015}, {'stars': 3, 'title': 'Back to the Past', 'year': 2042}, {...4, 'title': "The Hitchhiker's Guide to the Galaxy", 'year': 1985}, {'stars': 5, 'title': 'Unknown film', 'year': 4242}]
search_url = 'http://localhost:5000/records/'
search_class = <class 'tests.conftest.TestSearch'>
content_type = 'application/json'

    @pytest.mark.parametrize('content_type', [
        'application/json', 'application/json;charset=utf-8'
    ])
    def test_valid_create(app, db, es, test_data, search_url, search_class,
                          content_type):
        """Test VALID record creation request (POST .../records/)."""
        with app.test_client() as client:
            HEADERS = [
                ('Accept', 'application/json'),
                ('Content-Type', content_type)
            ]
            HEADERS.append(('Content-Type', content_type))
    
            # Create record
            res = client.post(
                search_url, data=json.dumps(test_data[0]), headers=HEADERS)
            assert res.status_code == 201
    
            # Check that the returned record matches the given data
            data = get_json(res)
            for k in test_data[0].keys():
                assert data['metadata'][k] == test_data[0][k]
    
            # Recid has been added in control number
            assert data['metadata']['control_number']
    
            # Check location header
            assert res.headers['Location'] == data['links']['self']
    
            # Record can be retrieved.
            assert client.get(record_url(data['id'])).status_code == 200
    
            IndexFlusher(search_class).flush_and_wait()
            # Record shows up in search
            res = client.get(search_url,
                             query_string={"control_number":
>                                          data['metadata']['control_number']})

/code/modules/invenio-records-rest/tests/test_views_list_post.py:59: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
______________ test_valid_create[application/json;charset=utf-8] _______________

app = <Flask 'testapp'>
db = <SQLAlchemy engine=sqlite:////code/modules/invenio-records-rest/examples/test.db>
es = <tests.conftest.MockEs object at 0x7f2495efdcc0>
test_data = [{'stars': 4, 'title': 'Back to the Future', 'year': 2015}, {'stars': 3, 'title': 'Back to the Past', 'year': 2042}, {...4, 'title': "The Hitchhiker's Guide to the Galaxy", 'year': 1985}, {'stars': 5, 'title': 'Unknown film', 'year': 4242}]
search_url = 'http://localhost:5000/records/'
search_class = <class 'tests.conftest.TestSearch'>
content_type = 'application/json;charset=utf-8'

    @pytest.mark.parametrize('content_type', [
        'application/json', 'application/json;charset=utf-8'
    ])
    def test_valid_create(app, db, es, test_data, search_url, search_class,
                          content_type):
        """Test VALID record creation request (POST .../records/)."""
        with app.test_client() as client:
            HEADERS = [
                ('Accept', 'application/json'),
                ('Content-Type', content_type)
            ]
            HEADERS.append(('Content-Type', content_type))
    
            # Create record
            res = client.post(
                search_url, data=json.dumps(test_data[0]), headers=HEADERS)
            assert res.status_code == 201
    
            # Check that the returned record matches the given data
            data = get_json(res)
            for k in test_data[0].keys():
                assert data['metadata'][k] == test_data[0][k]
    
            # Recid has been added in control number
            assert data['metadata']['control_number']
    
            # Check location header
            assert res.headers['Location'] == data['links']['self']
    
            # Record can be retrieved.
            assert client.get(record_url(data['id'])).status_code == 200
    
            IndexFlusher(search_class).flush_and_wait()
            # Record shows up in search
            res = client.get(search_url,
                             query_string={"control_number":
>                                          data['metadata']['control_number']})

/code/modules/invenio-records-rest/tests/test_views_list_post.py:59: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
____________________ test_invalid_create[application/json] _____________________

app = <Flask 'testapp'>
db = <SQLAlchemy engine=sqlite:////code/modules/invenio-records-rest/examples/test.db>
es = <tests.conftest.MockEs object at 0x7f2495105c18>
test_data = [{'stars': 4, 'title': 'Back to the Future', 'year': 2015}, {'stars': 3, 'title': 'Back to the Past', 'year': 2042}, {...4, 'title': "The Hitchhiker's Guide to the Galaxy", 'year': 1985}, {'stars': 5, 'title': 'Unknown film', 'year': 4242}]
search_url = 'http://localhost:5000/records/', content_type = 'application/json'

    @pytest.mark.parametrize('content_type', [
        'application/json', 'application/json;charset=utf-8'
    ])
    def test_invalid_create(app, db, es, test_data, search_url, content_type):
        """Test INVALID record creation request (POST .../records/)."""
        with app.test_client() as client:
            HEADERS = [
                ('Accept', 'application/json'),
                ('Content-Type', content_type)
            ]
    
            # Invalid accept type
            headers = [('Content-Type', 'application/json'),
                       ('Accept', 'video/mp4')]
            res = client.post(
                search_url, data=json.dumps(test_data[0]), headers=headers)
            assert res.status_code == 406
            # check that nothing is indexed
>           res = client.get(search_url, query_string=dict(page=1, size=2))

/code/modules/invenio-records-rest/tests/test_views_list_post.py:81: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_____________ test_invalid_create[application/json;charset=utf-8] ______________

app = <Flask 'testapp'>
db = <SQLAlchemy engine=sqlite:////code/modules/invenio-records-rest/examples/test.db>
es = <tests.conftest.MockEs object at 0x7f2495602b38>
test_data = [{'stars': 4, 'title': 'Back to the Future', 'year': 2015}, {'stars': 3, 'title': 'Back to the Past', 'year': 2042}, {...4, 'title': "The Hitchhiker's Guide to the Galaxy", 'year': 1985}, {'stars': 5, 'title': 'Unknown film', 'year': 4242}]
search_url = 'http://localhost:5000/records/'
content_type = 'application/json;charset=utf-8'

    @pytest.mark.parametrize('content_type', [
        'application/json', 'application/json;charset=utf-8'
    ])
    def test_invalid_create(app, db, es, test_data, search_url, content_type):
        """Test INVALID record creation request (POST .../records/)."""
        with app.test_client() as client:
            HEADERS = [
                ('Accept', 'application/json'),
                ('Content-Type', content_type)
            ]
    
            # Invalid accept type
            headers = [('Content-Type', 'application/json'),
                       ('Accept', 'video/mp4')]
            res = client.post(
                search_url, data=json.dumps(test_data[0]), headers=headers)
            assert res.status_code == 406
            # check that nothing is indexed
>           res = client.get(search_url, query_string=dict(page=1, size=2))

/code/modules/invenio-records-rest/tests/test_views_list_post.py:81: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_________________________ test_json_result_serializer __________________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f24952d2f60> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f24951af7b8>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
test_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f24952d2f60> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f24951af7b8>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
search_url = 'http://localhost:5000/records/'

    def test_json_result_serializer(app, indexed_records, test_records,
                                    search_url):
        """JSON result."""
        with app.test_client() as client:
            # Get a query with only one record
>           res = client.get(search_url, query_string={'q': 'year:2015'})

/code/modules/invenio-records-rest/tests/test_views_search.py:26: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
________________________________ test_page_size ________________________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f24955fe710> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f249588d5f8>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
search_url = 'http://localhost:5000/records/'

    def test_page_size(app, indexed_records, search_url):
        """Test page and size parameters."""
        with app.test_client() as client:
            # Limit records
>           res = client.get(search_url, query_string=dict(page=1, size=2))

/code/modules/invenio-records-rest/tests/test_views_search.py:47: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
____________________ test_page_size_without_size_in_request ____________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f24951a5a58> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f24951bd400>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
search_url = 'http://localhost:5000/records/'

    def test_page_size_without_size_in_request(
            app, indexed_records, search_url):
        """Test default size parameter."""
        with app.test_client() as client:
>           res = client.get(search_url, query_string=dict(page=1))

/code/modules/invenio-records-rest/tests/test_views_search.py:64: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_________ test_page_size_without_size_in_request_with_five_as_default __________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f24951e2cc0> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2494fef470>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
search_url = 'http://localhost:5000/records/'

    def test_page_size_without_size_in_request_with_five_as_default(
            app, indexed_records, search_url):
        """Test custom default page parameter."""
        config = {
            'RECORDS_REST_DEFAULT_RESULTS_SIZE': 2
        }
        with app.test_client() as client, patch.dict(app.config, config):
>           res = client.get(search_url, query_string=dict(page=1))

/code/modules/invenio-records-rest/tests/test_views_search.py:75: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_______________________________ test_pagination ________________________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f24951d0e80> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f24959eb1d0>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
search_url = 'http://localhost:5000/records/'

    def test_pagination(app, indexed_records, search_url):
        """Test pagination."""
        with app.test_client() as client:
            # Limit records
>           res = client.get(search_url, query_string=dict(size=1, page=1))

/code/modules/invenio-records-rest/tests/test_views_search.py:83: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_______________________________ test_page_links ________________________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2495975dd8> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f24959754e0>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
search_url = 'http://localhost:5000/records/'

    def test_page_links(app, indexed_records, search_url):
        """Test Link HTTP header on multi-page searches."""
        with app.test_client() as client:
            # Limit records
>           res = client.get(search_url, query_string=dict(size=1, page=1))

/code/modules/invenio-records-rest/tests/test_views_search.py:109: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
__________________________________ test_query __________________________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2495dc9278> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2494fbf4a8>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
search_url = 'http://localhost:5000/records/'

    def test_query(app, indexed_records, search_url):
        """Test query."""
        with app.test_client() as client:
            # Valid query syntax
>           res = client.get(search_url, query_string=dict(q='back'))

/code/modules/invenio-records-rest/tests/test_views_search.py:151: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
__________________________ test_es_query_syntax[app0] __________________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2495801940> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f249553d5c0>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
search_url = 'http://localhost:5000/records/'

    @pytest.mark.parametrize('app', [dict(
        endpoint=dict(
            search_factory_imp='invenio_records_rest.query.es_search_factory'
        )
    )], indirect=['app'])
    def test_es_query_syntax(app, indexed_records, search_url):
        """Test ES query syntax."""
        with app.test_client() as client:
            # Valid ES query syntax
>           res = client.get(search_url, query_string=dict(q='+title:back'))

/code/modules/invenio-records-rest/tests/test_views_search.py:164: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
__________________________________ test_sort ___________________________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2496068ef0> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2495596748>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
search_url = 'http://localhost:5000/records/'

    def test_sort(app, indexed_records, search_url):
        """Test invalid accept header."""
        with app.test_client() as client:
>           res = client.get(search_url, query_string={'sort': '-year'})

/code/modules/invenio-records-rest/tests/test_views_search.py:171: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_____________________________ test_invalid_accept ______________________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f249569cfd0> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2495350358>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
search_url = 'http://localhost:5000/records/'

    def test_invalid_accept(app, indexed_records, search_url):
        """Test invalid accept header."""
        headers = [('Accept', 'application/does_not_exist')]
    
        with app.test_client() as client:
>           res = client.get(search_url, headers=headers)

/code/modules/invenio-records-rest/tests/test_views_search.py:187: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
____________________________ test_aggregations_info ____________________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f24953997f0> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f24959789b0>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
search_url = 'http://localhost:5000/records/'

    def test_aggregations_info(app, indexed_records, search_url):
        """Test aggregations."""
        with app.test_client() as client:
            # Facets are defined in the "app" fixture.
>           res = client.get(search_url)

/code/modules/invenio-records-rest/tests/test_views_search.py:198: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_________________________________ test_filters _________________________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2494f4ccf8> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2494f27588>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
search_url = 'http://localhost:5000/records/'

    def test_filters(app, indexed_records, search_url):
        """Test aggregations."""
        with app.test_client() as client:
>           res = client.get(search_url, query_string=dict(stars='4'))

/code/modules/invenio-records-rest/tests/test_views_search.py:211: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
_______________________________ test_query_wrong _______________________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2494e49208> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2494f1b470>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
search_url = 'http://localhost:5000/records/'

    def test_query_wrong(app, indexed_records, search_url):
        """Test invalid accept header."""
        with app.test_client() as client:
>           res = client.get(search_url, query_string={'q': 'test'})

/code/modules/invenio-records-rest/tests/test_views_search.py:218: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
______________________ test_elasticsearch_exception[app0] ______________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f249595b9b0> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f249524c7f0>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]

    @pytest.mark.parametrize('app', [dict(
        endpoint=dict(
            search_factory_imp='invenio_records_rest.query.es_search_factory'
        )
    )], indirect=['app'])
    def test_elasticsearch_exception(app, indexed_records):
        """Test elasticsearch exception."""
        with app.test_client() as client:
>           res = client.get(url_for('invenio_records_rest.recid_list', q='i/o'))

/code/modules/invenio-records-rest/tests/test_views_search.py:239: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
___________________________ test_dynamic_aggregation ___________________________

app = <Flask 'testapp'>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2495f69d68> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f2495ba0630>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
search_url = 'http://localhost:5000/records/'

    def test_dynamic_aggregation(app, indexed_records, search_url):
        """Test invalid accept header."""
        with app.test_client() as client:
            def stars_aggs():
                """Include only my deposits in the aggregation."""
                return {
                    'terms': {
                        'field': 'stars',
                        'include': [4, 5]
                    }
                }
            app.config['RECORDS_REST_FACETS'][
                'invenio-records-rest']['aggs']['test'] = stars_aggs
>           res = client.get(search_url, query_string={'q': ''})

/code/modules/invenio-records-rest/tests/test_views_search.py:258: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
________________________ test_default_serializer[app0] _________________________

app = <Flask 'testapp'>
db = <SQLAlchemy engine=sqlite:////code/modules/invenio-records-rest/examples/test.db>
es = <tests.conftest.MockEs object at 0x7f249586d160>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f2495afe320> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f24955c9cf8>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]

    @pytest.mark.parametrize('app', [dict(
        endpoint=dict(
            record_serializers={
                'application/json': 'test_views_serializers:json_record',
                'application/xml': 'test_views_serializers.xml_record',
            },
            search_serializers={
                'application/json': 'test_views_serializers:json_search',
                'application/xml': 'test_views_serializers.xml_search',
            },
            default_media_type='application/xml',
        ),
    )], indirect=['app'], scope='function')
    def test_default_serializer(app, db, es, indexed_records):
        """Test default serializer."""
        # Create records
        accept_json = [('Accept', 'application/json')]
        accept_xml = [('Accept', 'application/xml')]
    
        with app.test_client() as client:
>           res = client.get('/records/', headers=accept_json)

/code/modules/invenio-records-rest/tests/test_views_serializers.py:68: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:441: in need_record_permission_decorator
    return f(self, record=record, *args, **kwargs)
/code/modules/invenio-records-rest/invenio_records_rest/views.py:561: in get
    search, qs_kwargs = self.search_factory(search)
/code/modules/invenio-records-rest/invenio_records_rest/query.py:48: in default_search_factory
    search, urlkwargs = default_facets_factory(search, search_index)
/code/modules/invenio-records-rest/invenio_records_rest/facets.py:135: in default_facets_factory
    facets = get_facet_search_query(search_permission.can()).get(index)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:347: in can
    return self.require().can()
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:193: in can
    return self.identity.can(self.permission)
/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_principal.py:188: in identity
    return g.identity
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask.g of 'testapp'>, name = 'identity'

    def __getattr__(self, name):
        if name == "__members__":
            return dir(self._get_current_object())
>       return getattr(self._get_current_object(), name)
E       AttributeError: '_AppCtxGlobals' object has no attribute 'identity'

/code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: AttributeError
___________________________ test_valid_suggest[app0] ___________________________

app = <Flask 'testapp'>
db = <SQLAlchemy engine=sqlite:////code/modules/invenio-records-rest/examples/test.db>
es = <tests.conftest.MockEs object at 0x7f249526c438>
indexed_records = [(<[DetachedInstanceError('Instance <PersistentIdentifier at 0x7f249588d2e8> is not bound to a Session; attribute refr...stentIdentifier object at 0x7f249582fef0>, {'year': 4242, 'stars': 5, 'title': 'Unknown film', 'control_number': '4'})]
mock_es_execute = <function mock_es_execute.<locals>._dummy_response at 0x7f249554e1e0>
mocker = <pytest_mock.plugin.MockerFixture object at 0x7f24958e2828>

    @pytest.mark.parametrize('app', [dict(
        endpoint=dict(
            suggesters=dict(
                text=dict(completion=dict(
                    field='suggest_title')),
                text_byyear=dict(completion=dict(
                    field='suggest_byyear',
                    context='year')),
                text_filtered_source=dict(
                    _source=['control_number'],
                    completion=dict(
                        field='suggest_title')),
            )
        )
    )], indirect=['app'])
    def test_valid_suggest(app, db, es, indexed_records, mock_es_execute, mocker):
        """Test VALID record creation request (POST .../records/)."""
        with app.test_client() as client:
            suggest_mocker = mocker.patch("elasticsearch_dsl.Search.suggest", return_value=RecordsSearch())
            # Valid simple completion suggester
            mocker.patch("elasticsearch_dsl.Search.execute", return_value=mock_es_execute({"suggest":{"text":"test_value"}}))
            res = client.get(
                url_for('invenio_records_rest.recid_suggest'),
                query_string={'text': 'Back'}
            )
            assert res.status_code == 200
            suggest_mocker.assert_has_calls(
                [mocker.call("text","Back",completion=dict(field='suggest_title'))]
            )
            data = json.loads(res.get_data(as_text=True))
>           assert len(data['text'][0]['options']) == 2
E           TypeError: string indices must be integers

/code/modules/invenio-records-rest/tests/test_views_suggesters.py:53: TypeError
=============================== warnings summary ===============================
../invenio-indexer/invenio_indexer/cli.py:108
  /code/modules/invenio-indexer/invenio_indexer/cli.py:108: DeprecationWarning: 'resultcallback' has been renamed to 'result_callback'. The old name will be removed in Click 8.1.
    @queue.resultcallback()

tests/test_custom_endpoints.py::test_get_record[app0]
  /code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/flask_oauthlib/contrib/cache.py:3: DeprecationWarning: 'werkzeug.contrib.cache' is deprecated as of version 0.15 and will be removed in version 1.0. It has moved to https://github.com/pallets/cachelib.
    from werkzeug.contrib.cache import NullCache, SimpleCache, FileSystemCache

tests/test_custom_endpoints.py::test_get_record[app0]
  /code/modules/invenio-records-rest/.tox/c1/lib/python3.6/site-packages/past/translation/__init__.py:35: DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses
    import imp

tests/test_custom_endpoints.py::test_get_record[app0]
  /code/modules/invenio-records-rest/.tox/c1/src/pypdf2/PyPDF2/generic.py:348: DeprecationWarning: invalid escape sequence \c
    b_("c") : b_("\c"),

tests/test_custom_fields.py: 15 warnings
tests/test_marshmallow_loader.py: 3 warnings
tests/test_serializer_json.py: 3 warnings
  /code/modules/invenio-records-rest/invenio_records_rest/schemas/fields/marshmallow_contrib.py:24: DeprecationWarning: inspect.getargspec() is deprecated since Python 3.0, use inspect.signature() or inspect.getfullargspec()
    return list(inspect.getargspec(func).args)

-- Docs: https://docs.pytest.org/en/stable/warnings.html

---------- coverage: platform linux, python 3.6.15-final-0 -----------
Name                                                          Stmts   Miss Branch BrPart  Cover
-----------------------------------------------------------------------------------------------
invenio_records_rest/__init__.py                                  6      0      0      0   100%
invenio_records_rest/_compat.py                                  12      5      2      0    64%
invenio_records_rest/config.py                                   26      0      2      0   100%
invenio_records_rest/errors.py                                   73     11     34      0    90%
invenio_records_rest/ext.py                                      42      0     16      0   100%
invenio_records_rest/facets.py                                   67      5     26      2    90%
invenio_records_rest/links.py                                    14      0      2      0   100%
invenio_records_rest/loaders/__init__.py                          7      0      0      0   100%
invenio_records_rest/loaders/marshmallow.py                      46      4     16      2    87%
invenio_records_rest/proxies.py                                   6      0      2      0   100%
invenio_records_rest/query.py                                    27      8      4      0    68%
invenio_records_rest/schemas/__init__.py                          4      0      0      0   100%
invenio_records_rest/schemas/fields/__init__.py                   9      0      0      0   100%
invenio_records_rest/schemas/fields/datetime.py                  13      4      2      0    73%
invenio_records_rest/schemas/fields/generated.py                 18      0     10      0   100%
invenio_records_rest/schemas/fields/marshmallow_contrib.py       36      7     20      4    77%
invenio_records_rest/schemas/fields/persistentidentifier.py       9      0      2      0   100%
invenio_records_rest/schemas/fields/sanitizedhtml.py             12      0      2      0   100%
invenio_records_rest/schemas/fields/sanitizedunicode.py          16      0      4      0   100%
invenio_records_rest/schemas/fields/trimmedstring.py              7      0      2      0   100%
invenio_records_rest/schemas/json.py                             43      8     31      5    77%
invenio_records_rest/serializers/__init__.py                      9      0      0      0   100%
invenio_records_rest/serializers/base.py                         85      5     36      0    96%
invenio_records_rest/serializers/citeproc.py                     59      5     12      1    89%
invenio_records_rest/serializers/datacite.py                     45      0     12      0   100%
invenio_records_rest/serializers/dc.py                           17      0      4      0   100%
invenio_records_rest/serializers/json.py                         15      0      8      0   100%
invenio_records_rest/serializers/jsonld.py                       33      8     12      0    69%
invenio_records_rest/serializers/marshmallow.py                  20      0      2      0   100%
invenio_records_rest/serializers/response.py                     67     37     22      3    42%
invenio_records_rest/sorter.py                                   60      5     30      4    88%
invenio_records_rest/utils.py                                    86     16     32      1    84%
invenio_records_rest/version.py                                   3      0      0      0   100%
invenio_records_rest/views.py                                   455    181    159     23    56%
-----------------------------------------------------------------------------------------------
TOTAL                                                          1447    309    506     45    77%
Coverage XML written to file coverage.xml

=========================== short test summary info ============================
FAILED tests/test_custom_endpoints.py::test_get_records_list[test_custom_endpoints_app0]
FAILED tests/test_facets.py::test_default_facets_factory - AttributeError: '_...
FAILED tests/test_permissions.py::test_default_permissions - AttributeError: ...
FAILED tests/test_pid_resolver.py::test_record_resolution - sqlalchemy.orm.ex...
FAILED tests/test_serializer_datacite.py::test_serialize[DataCite31Serializer]
FAILED tests/test_serializer_datacite.py::test_serialize[DataCite40Serializer]
FAILED tests/test_serializer_datacite.py::test_serialize[DataCite41Serializer]
FAILED tests/test_serializer_dc.py::test_serialize - RuntimeError: No applica...
FAILED tests/test_serializer_jsonld.py::test_serialize - NotImplementedError
FAILED tests/test_serializer_jsonld.py::test_serialize_search - NotImplemente...
FAILED tests/test_serializer_marshmallow.py::test_transform_record - RuntimeE...
FAILED tests/test_serializer_marshmallow.py::test_transform_search_hit - Runt...
FAILED tests/test_serializer_marshmallow.py::test_transform_record_default_schema
FAILED tests/test_serializer_response.py::test_search_responsify - TypeError:...
FAILED tests/test_sorter.py::test_default_sorter_factory - AssertionError: as...
FAILED tests/test_views_item_delete.py::test_valid_delete - AttributeError: '...
FAILED tests/test_views_item_delete.py::test_delete_deleted - AttributeError:...
FAILED tests/test_views_item_delete.py::test_delete_with_sqldatabase_error - ...
FAILED tests/test_views_item_get.py::test_item_get_etag - sqlalchemy.orm.exc....
FAILED tests/test_views_item_patch.py::test_valid_patch[application/json-patch+json]
FAILED tests/test_views_item_patch.py::test_valid_patch[application/json-patch+json;charset=utf-8]
FAILED tests/test_views_item_patch.py::test_patch_deleted[application/json-patch+json]
FAILED tests/test_views_item_patch.py::test_patch_deleted[application/json-patch+json;charset=utf-8]
FAILED tests/test_views_item_patch.py::test_invalid_patch[] - AttributeError:...
FAILED tests/test_views_item_patch.py::test_invalid_patch[;charset=utf-8] - A...
FAILED tests/test_views_item_put.py::test_valid_put[application/json] - Attri...
FAILED tests/test_views_item_put.py::test_valid_put[application/json;charset=utf-8]
FAILED tests/test_views_item_put.py::test_valid_put_etag[application/json] - ...
FAILED tests/test_views_item_put.py::test_valid_put_etag[application/json;charset=utf-8]
FAILED tests/test_views_item_put.py::test_put_on_deleted[application/json] - ...
FAILED tests/test_views_item_put.py::test_put_on_deleted[application/json;charset=utf-8]
FAILED tests/test_views_item_put.py::test_invalid_put[] - AttributeError: '_A...
FAILED tests/test_views_item_put.py::test_invalid_put[;charset=utf-8] - Attri...
FAILED tests/test_views_item_put.py::test_validation_error[application/json]
FAILED tests/test_views_item_put.py::test_validation_error[application/json;charset=utf-8]
FAILED tests/test_views_list_post.py::test_valid_create[application/json] - A...
FAILED tests/test_views_list_post.py::test_valid_create[application/json;charset=utf-8]
FAILED tests/test_views_list_post.py::test_invalid_create[application/json]
FAILED tests/test_views_list_post.py::test_invalid_create[application/json;charset=utf-8]
FAILED tests/test_views_search.py::test_json_result_serializer - AttributeErr...
FAILED tests/test_views_search.py::test_page_size - AttributeError: '_AppCtxG...
FAILED tests/test_views_search.py::test_page_size_without_size_in_request - A...
FAILED tests/test_views_search.py::test_page_size_without_size_in_request_with_five_as_default
FAILED tests/test_views_search.py::test_pagination - AttributeError: '_AppCtx...
FAILED tests/test_views_search.py::test_page_links - AttributeError: '_AppCtx...
FAILED tests/test_views_search.py::test_query - AttributeError: '_AppCtxGloba...
FAILED tests/test_views_search.py::test_es_query_syntax[app0] - AttributeErro...
FAILED tests/test_views_search.py::test_sort - AttributeError: '_AppCtxGlobal...
FAILED tests/test_views_search.py::test_invalid_accept - AttributeError: '_Ap...
FAILED tests/test_views_search.py::test_aggregations_info - AttributeError: '...
FAILED tests/test_views_search.py::test_filters - AttributeError: '_AppCtxGlo...
FAILED tests/test_views_search.py::test_query_wrong - AttributeError: '_AppCt...
FAILED tests/test_views_search.py::test_elasticsearch_exception[app0] - Attri...
FAILED tests/test_views_search.py::test_dynamic_aggregation - AttributeError:...
FAILED tests/test_views_serializers.py::test_default_serializer[app0] - Attri...
FAILED tests/test_views_suggesters.py::test_valid_suggest[app0] - TypeError: ...
ERROR tests/test_examples_app.py::test_example_app - assert 1 == 0
======= 56 failed, 58 passed, 25 warnings, 1 error in 206.67s (0:03:26) ========
ERROR: InvocationError for command /code/modules/invenio-records-rest/.tox/c1/bin/pytest --cov=invenio_records_rest tests -v --cov-branch --cov-report=term --cov-report=xml --cov-config=tox.ini --basetemp=/code/modules/invenio-records-rest/.tox/c1/tmp (exited with code 1)
___________________________________ summary ____________________________________
ERROR:   c1: commands failed
