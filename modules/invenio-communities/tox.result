GLOB sdist-make: /code/modules/invenio-communities/setup.py
c1 create: /code/modules/invenio-communities/.tox/c1
c1 setuptools_version is setuptools==57.5.0
c1 installdeps: pytest>=3, pytest-cov, -rrequirements2.txt
c1 inst: /code/modules/invenio-communities/.tox/.tmp/package/1/invenio-communities-1.0.0a21.zip
c1 installed: alabaster==0.7.13,alembic==0.9.6,amqp==2.6.0,angular-gettext-babel==0.3,aniso8601==8.0.0,arrow==0.12.1,asn1crypto==0.23.0,atomicwrites==1.4.1,attrs==17.4.0,b2handle==1.1.2,Babel==2.5.1,bagit==1.7.0,beautifulsoup4==4.9.3,bibtexparser==1.0.1,billiard==3.6.3.0,binaryornot==0.4.4,bleach==3.1.0,blinker==1.4,boto3==1.7.84,botocore==1.10.84,cachelib==0.1,cachetools==4.2.4,cchardet==2.1.1,celery==4.4.4,certifi==2017.11.5,cffi==1.11.2,chardet==3.0.4,citeproc-py==0.5.1,citeproc-py-styles==0.1.2,click==6.7,cookiecutter==1.6.0,counter-robots==2018.6,coverage==6.2,cryptography==2.1.4,datacite==1.0.1,DateTime==4.9,decorator==4.1.2,defusedxml==0.5.0,dictdiffer==0.7.0,distlib==0.3.6,dnspython==2.2.1,docutils==0.18.1,dojson==1.3.2,elasticsearch==6.1.1,elasticsearch-dsl==6.4.0,elementpath==1.0.6,email-validator==1.0.5,entrypoints==0.2.3,feedgen==0.7.0,filelock==3.4.1,Flask==1.1.0,Flask-Admin==1.5.3,Flask-Alembic==2.0.1,Flask-Assets==0.12,Flask-BabelEx==0.9.4,Flask-Breadcrumbs==0.5.0,Flask-Caching==1.10.1,Flask-CeleryExt==0.3.4,Flask-Collect==1.2.2,Flask-Cors==3.0.3,Flask-DebugToolbar==0.13.1,Flask-IIIF==0.6.1,Flask-KVSession==0.6.2,Flask-Limiter==1.1.0,Flask-Login==0.4.1,Flask-Mail==0.9.1,flask-marshmallow==0.14.0,Flask-Menu==0.6.0,-e git+https://github.com/RCOSDP/flask-oauthlib.git@98eb36e1dfc66256fa7ea62237e9879acb906e9d#egg=Flask_OAuthlib,Flask-Plugins==1.6.1,Flask-Principal==0.4.0,Flask-RESTful==0.3.8,Flask-Security==3.0.0,flask-shell-ipython==0.4.1,Flask-Sitemap==0.4.0,Flask-SQLAlchemy==2.3.2,flask-talisman==0.4.1,Flask-WTF==0.14.3,-e git+https://github.com/RCOSDP/pyfpdf.git@f9b032148283d535cabc7789858081c80de36fef#egg=fpdf,frozendict==2.3.8,fs==0.5.4,ftfy==4.4.3,future==0.16.0,github3.py==1.1.0,html5lib==1.0.1,idna==2.6,iiif-prezi==0.3.0,imagesize==1.4.1,importlib-metadata==4.8.3,importlib-resources==5.4.0,infinity==1.4,intervals==0.8.0,invenio-access==1.1.0,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_accounts&subdirectory=modules/invenio-accounts,invenio-admin==1.1.2,invenio-app==1.1.0,invenio-assets==1.0.0,invenio-base==1.0.2,invenio-cache==1.0.0,invenio-celery==1.1.3,invenio-communities @ file:///code/modules/invenio-communities/.tox/.tmp/package/1/invenio-communities-1.0.0a21.zip,invenio-config==1.0.0,invenio-csl-rest==1.0.0a1,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_db&subdirectory=modules/invenio-db,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_deposit&subdirectory=modules/invenio-deposit,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_files_rest&subdirectory=modules/invenio-files-rest,invenio-formatter==1.0.0b3,invenio-i18n==1.0.0,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_iiif&subdirectory=modules/invenio-iiif,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_indexer&subdirectory=modules/invenio-indexer,invenio-jsonschemas==1.0.0,invenio-logging==1.0.0b3,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_mail&subdirectory=modules/invenio-mail,invenio-marc21==1.0.0a8,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_oaiharvester&subdirectory=modules/invenio-oaiharvester,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_oaiserver&subdirectory=modules/invenio-oaiserver,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_oauth2server&subdirectory=modules/invenio-oauth2server,invenio-oauthclient==1.0.0,invenio-pidrelations==1.0.0a4,invenio-pidstore==1.0.0,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_previewer&subdirectory=modules/invenio-previewer,invenio-query-parser==0.6.0,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_queues&subdirectory=modules/invenio-queues,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_records&subdirectory=modules/invenio-records,invenio-records-files==1.0.0a10,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_records_rest&subdirectory=modules/invenio-records-rest,invenio-records-ui==1.0.0,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_resourcesyncclient&subdirectory=modules/invenio-resourcesyncclient,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_resourcesyncserver&subdirectory=modules/invenio-resourcesyncserver,invenio-rest==1.1.2,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_s3&subdirectory=modules/invenio-s3,-e git+https://github.com/RCOSDP/invenio-search.git@cff9744c5dc651893a9c51672c5b8da9adc21e16#egg=invenio_search,-e git+https://github.com/RCOSDP/invenio-search-ui.git@74bd3b2990ff27b39e01b6b31be9a0b5fda3dd0f#egg=invenio_search_ui,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=invenio_stats&subdirectory=modules/invenio-stats,invenio-theme==1.0.0b4,ipaddress==1.0.19,ipython==6.2.1,ipython-genutils==0.2.0,itsdangerous==0.24,jedi==0.11.0,Jinja2==2.10.1,jinja2-cli==0.6.0,jinja2-time==0.2.0,jmespath==0.10.0,jsmin==2.2.2,jsonpatch==1.21,jsonpath-ng==1.5.2,jsonpointer==1.14,jsonref==0.1,jsonresolver==0.2.1,jsonschema==2.6.0,jupyter-client==5.2.2,jupyter-core==4.4.0,-e git+https://github.com/RCOSDP/kombu.git@f204fdf078d5e94393c86693f545e2d011f620f5#egg=kombu,limits==1.2.1,lxml==4.1.1,Mako==1.0.7,MarkupSafe==1.1.1,marshmallow==2.20.1,marshmallow-sqlalchemy==0.23.1,maxminddb==1.5.2,maxminddb-geolite2==2017.803,mistune==0.8.3,mock==5.0.2,more-itertools==8.10.0,msgpack==0.6.2,nbconvert==5.3.1,nbformat==4.4.0,netaddr==0.8.0,node-semver==0.1.1,numpy==1.16.1,oauthlib==2.1.0,ordereddict==1.1,packaging==21.3,pandocfilters==1.4.2,parso==0.1.0,passlib==1.7.1,pbr==5.11.1,pexpect==4.3.0,pickleshare==0.7.4,Pillow==5.4.1,platformdirs==2.4.0,pluggy==0.13.1,ply==3.11,poyo==0.4.1,prompt-toolkit==1.0.15,psycopg2==2.7.3.2,ptyprocess==0.5.2,py==1.11.0,pycparser==2.18,Pygments==2.2.0,PyJWT==1.5.3,PyLD==2.0.3,pyparsing==3.1.0,-e git+https://github.com/RCOSDP/PyPDF2.git@fefc684a3a74aff6f99e5dff24f9b4dd1c95169d#egg=PyPDF2,pyPEG2==2.15.2,pytest==4.2.0,pytest-cov==2.9.0,pytest-mock==3.2.0,python-dateutil==2.6.1,python-editor==1.0.3,python-geoip==1.2,pytz==2017.3,pyzmq==17.0.0,redis==2.10.6,requests==2.18.4,requests-oauthlib==1.1.0,resync==1.0.9,s3fs==0.1.6,s3transfer==0.1.13,selenium==3.141.0,Sickle==0.6.4,simplegeneric==0.8.1,simplejson==3.12.0,simplekv==0.11.2,six==1.16.0,snowballstemmer==2.2.0,soupsieve==2.3.2.post1,speaklater==1.3,Sphinx==1.8.4,sphinxcontrib-serializinghtml==1.1.5,sphinxcontrib-websupport==1.2.4,SQLAlchemy==1.2.19,SQLAlchemy-Continuum==1.3.6,SQLAlchemy-Utils==0.35.0,stevedore==3.5.2,sword3common==0.1.1,testpath==0.3.1,tika==2.6.0,toml==0.10.2,tornado==4.5.3,tox==3.28.0,traitlets==4.3.2,typing_extensions==4.1.1,ua-parser==0.7.3,uritemplate==4.1.1,uritools==2.1.0,urllib3==1.22,uWSGI==2.0.21,uwsgitop==0.11,validators==0.12.0,vine==1.3.0,virtualenv==20.17.1,virtualenv-clone==0.5.7,virtualenvwrapper==4.8.4,Wand==0.6.1,wcwidth==0.1.7,webargs==5.5.2,webassets==0.12.1,webencodings==0.5.1,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_accounts&subdirectory=modules/weko-accounts,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_admin&subdirectory=modules/weko-admin,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_authors&subdirectory=modules/weko-authors,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_bulkupdate&subdirectory=modules/weko-bulkupdate,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_deposit&subdirectory=modules/weko-deposit,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_gridlayout&subdirectory=modules/weko-gridlayout,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_groups&subdirectory=modules/weko-groups,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_handle&subdirectory=modules/weko-handle,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_index_tree&subdirectory=modules/weko-index-tree,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_indextree_journal&subdirectory=modules/weko-indextree-journal,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_items_autofill&subdirectory=modules/weko-items-autofill,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_items_ui&subdirectory=modules/weko-items-ui,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_itemtypes_ui&subdirectory=modules/weko-itemtypes-ui,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_logging&subdirectory=modules/weko-logging,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_records&subdirectory=modules/weko-records,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_records_ui&subdirectory=modules/weko-records-ui,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_redis&subdirectory=modules/weko-redis,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_schema_ui&subdirectory=modules/weko-schema-ui,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_search_ui&subdirectory=modules/weko-search-ui,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_sitemap&subdirectory=modules/weko-sitemap,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_swordserver&subdirectory=modules/weko-swordserver,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_theme&subdirectory=modules/weko-theme,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_user_profiles&subdirectory=modules/weko-user-profiles,-e git+https://github.com/RCOSDP/weko.git@a80ea63a516765e4fa4b2461552c9b20c76d07cd#egg=weko_workflow&subdirectory=modules/weko-workflow,Werkzeug==0.15.2,whichcraft==0.4.1,WTForms==2.1,WTForms-Alchemy==0.16.5,WTForms-Components==0.10.3,xmlschema==0.9.30,xmltodict==0.12.0,zipp==3.6.0,zope.interface==5.5.2
c1 run-test-pre: PYTHONHASHSEED='3864517180'
c1 run-test: commands[0] | pytest --cov=invenio_communities tests -v -vv -s --cov-branch --cov-report=term --cov-report=html --basetemp=/code/modules/invenio-communities/.tox/c1/tmp
============================= test session starts ==============================
platform linux -- Python 3.6.15, pytest-4.2.0, py-1.11.0, pluggy-0.13.1 -- /code/modules/invenio-communities/.tox/c1/bin/python
cachedir: .tox/c1/.pytest_cache
rootdir: /code/modules/invenio-communities, inifile:
plugins: celery-4.4.4, mock-3.2.0, cov-2.9.0
collecting ... collected 89 items

tests/test_admin.py::TestCommunityModelView::test_index_view_acl_guest FAILED
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[0-403] FAILED
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[1-200] PASSED
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[2-200] PASSED
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[3-200] PASSED
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[4-403] FAILED
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[5-403] FAILED
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[6-200] PASSED
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[7-403] FAILED
tests/test_admin.py::TestCommunityModelView::test_role_query_cond PASSED
tests/test_admin.py::TestCommunityModelView::test_get_query FAILED
tests/test_admin.py::TestCommunityModelView::test_get_count_query FAILED
tests/test_admin.py::TestCommunityModelView::test_edit PASSED
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl_guest FAILED
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[0-403] FAILED
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[1-200] PASSED
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[2-200] PASSED
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[3-200] PASSED
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[4-403] FAILED
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[5-403] FAILED
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[6-200] PASSED
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[7-403] FAILED
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl_guest FAILED
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[0-403] FAILED
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[1-200] PASSED
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[2-200] PASSED
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[3-200] PASSED
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[4-403] FAILED
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[5-403] FAILED
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[6-200] PASSED
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[7-403] FAILED
tests/test_cli.py::test_cli_init PASSED
tests/test_cli.py::test_addlogo PASSED
tests/test_cli.py::test_request FAILED
tests/test_cli.py::test_remove FAILED
tests/test_forms.py::test_validate_input_id PASSED
tests/test_forms.py::test_CommunityForm PASSED
tests/test_invenio_communities.py::test_version PASSED
tests/test_invenio_communities.py::test_init PASSED
tests/test_invenio_communities.py::test_alembic FAILED
tests/test_invenio_communities.py::test_model_init PASSED
tests/test_invenio_communities.py::test_email_notification Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Subject: A record was requested to be added to your community (Title1).
From: info@inveniosoftware.org
To: sysadmin@test.org
Date: Thu, 04 Apr 2024 10:48:27 +0000
Message-ID: <171222770729.99220.1336912032307705188@6646d8a79b78>

A new upload requests to be added to your community (Title1):


Requested by:  (sysadmin@test.org)

Record Title: Foobar
Record Description: Baz bar.

You can accept or reject this record in your community curation page:
https://inveniosoftware.org/communities/comm1/curate/
-------------------------------------------------------------------------------
PASSED
tests/test_invenio_communities.py::test_model_featured_community PASSED
tests/test_invenio_communities.py::test_oaipmh_sets PASSED
tests/test_invenio_communities.py::test_communities_rest_all_communities PASSED
tests/test_invenio_communities.py::test_community_delete PASSED
tests/test_invenio_communities.py::test_communities_rest_all_communities_query_and_sort PASSED
tests/test_invenio_communities.py::test_communities_rest_pagination PASSED
tests/test_invenio_communities.py::test_communities_rest_get_details PASSED
tests/test_invenio_communities.py::test_communities_rest_etag PASSED
tests/test_invenio_communities.py::test_add_remove_corner_cases PASSED
tests/test_models.py::test_filter_community[<lambda>0] PASSED
tests/test_models.py::test_filter_community[<lambda>1] PASSED
tests/test_models.py::test_filter_community[<lambda>2] PASSED
tests/test_models.py::TestInclusionRequest::test_get_record PASSED
tests/test_models.py::TestInclusionRequest::test_create PASSED
tests/test_models.py::TestCommunity::test_repr PASSED
tests/test_models.py::TestCommunity::test_save_logo PASSED
tests/test_models.py::TestCommunity::test_get_by_user PASSED
tests/test_models.py::TestCommunity::test_add_record PASSED
tests/test_models.py::TestCommunity::test_remove_record PASSED
tests/test_models.py::TestCommunity::test_upload_url PASSED
tests/test_models.py::TestCommunity::test_oaiset PASSED
tests/test_models.py::TestCommunity::test_oaiset_url PASSED
tests/test_receivers.py::test_inject_provisional_community PASSED
tests/test_receivers.py::test_destroy_oaipmh_set PASSED
tests/test_serializers_response.py::test_format_args PASSED
tests/test_serializers_schema_community.py::test_CommunitySchemaV1 PASSED
tests/test_tasks.py::test_community_delete_task PASSED
tests/test_tasks.py::test_delete_expired_requests PASSED
tests/test_utils.py::test_Pagination PASSED
tests/test_utils.py::test_template_formatting_from_string PASSED
tests/test_utils.py::test_save_and_validate_logo PASSED
tests/test_utils.py::test_initialize_communities_bucket PASSED
tests/test_utils.py::test_format_request_email_templ PASSED
tests/test_utils.py::test_send_community_request_email PASSED
tests/test_utils.py::test_get_user_role_ids PASSED
tests/test_utils.py::test_email_formatting Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Subject: A record was requested to be added to your community (Title1).
From: info@inveniosoftware.org
To: sysadmin@test.org
Date: Thu, 04 Apr 2024 10:52:15 +0000
Message-ID: <171222793566.99220.10159290961013525488@6646d8a79b78>

A new upload requests to be added to your community (Title1):


Requested by:  (sysadmin@test.org)

Record Title: Foobar and Bazbar
Record Description: On Foobar, Bazbar and more.

You can accept or reject this record in your community curation page:
https://inveniosoftware.org/communities/comm1/curate/
-------------------------------------------------------------------------------
PASSED
tests/test_views_api.py::TestCommunityDetailsResource::test_get PASSED
tests/test_views_api.py::test_dbsession_clean FAILED
tests/test_views_ui.py::test_sanitize_html PASSED
tests/test_views_ui.py::test_pass_community PASSED
tests/test_views_ui.py::test_permission_required PASSED
tests/test_views_ui.py::test_format_item PASSED
tests/test_views_ui.py::test_mycommunities_ctx PASSED
tests/test_views_ui.py::test_view PASSED
tests/test_views_ui.py::test_generic_item PASSED
tests/test_views_ui.py::test_community_list PASSED
tests/test_views_ui.py::test_dbsession_clean FAILED

=================================== FAILURES ===================================
_______________ TestCommunityModelView.test_index_view_acl_guest _______________

self = <tests.test_admin.TestCommunityModelView object at 0x7f1f28b23668>
app = <Flask 'testapp'>
setup_view_community = (<Flask 'testapp'>, <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>, <flask_admin.base.Admin object at 0x7f1f27c663c8>, <User 5>, <invenio_communities.admin.CommunityModelView object at 0x7f1f27c100b8>)
client = <FlaskClient <Flask 'testapp'>>

    def test_index_view_acl_guest(self,app,setup_view_community,client):
        url = url_for('community.index_view')
>       res = client.get(url)

tests/test_admin.py:49: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
.tox/c1/lib/python3.6/site-packages/flask/testing.py:227: in open
    follow_redirects=follow_redirects,
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
.tox/c1/lib/python3.6/site-packages/flask/app.py:2463: in __call__
    return self.wsgi_app(environ, start_response)
.tox/c1/lib/python3.6/site-packages/flask/app.py:2449: in wsgi_app
    response = self.handle_exception(e)
.tox/c1/lib/python3.6/site-packages/flask/app.py:1866: in handle_exception
    reraise(exc_type, exc_value, tb)
.tox/c1/lib/python3.6/site-packages/flask/_compat.py:39: in reraise
    raise value
.tox/c1/lib/python3.6/site-packages/flask/app.py:2446: in wsgi_app
    response = self.full_dispatch_request()
.tox/c1/lib/python3.6/site-packages/flask/app.py:1951: in full_dispatch_request
    rv = self.handle_user_exception(e)
.tox/c1/lib/python3.6/site-packages/flask/app.py:1820: in handle_user_exception
    reraise(exc_type, exc_value, tb)
.tox/c1/lib/python3.6/site-packages/flask/_compat.py:39: in reraise
    raise value
.tox/c1/lib/python3.6/site-packages/flask/app.py:1949: in full_dispatch_request
    rv = self.dispatch_request()
.tox/c1/lib/python3.6/site-packages/flask/app.py:1935: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
.tox/c1/lib/python3.6/site-packages/flask_admin/base.py:69: in inner
    return self._run_view(f, *args, **kwargs)
.tox/c1/lib/python3.6/site-packages/flask_admin/base.py:368: in _run_view
    return fn(self, *args, **kwargs)
.tox/c1/lib/python3.6/site-packages/flask_admin/model/base.py:1960: in index_view
    view_args.search, view_args.filters, page_size=page_size)
.tox/c1/lib/python3.6/site-packages/flask_admin/contrib/sqla/view.py:1029: in get_list
    query = self.get_query()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.admin.CommunityModelView object at 0x7f1f27c100b8>

    def get_query(self):
        """Return a query for the model type.
    
        This method can be used to set a "persistent filter" on an index_view.
        If you override this method, don't forget to also override
        `get_count_query`,
        for displaying the correct
        item count in the list view, and `get_one`,
        which is used when retrieving records for the edit view.
        """
        role_ids = get_user_role_ids()
    
>       if min(role_ids) <= \
                current_app.config['COMMUNITIES_LIMITED_ROLE_ACCESS_PERMIT']:
E               ValueError: min() arg is an empty sequence

invenio_communities/admin.py:148: ValueError
______________ TestCommunityModelView.test_index_view_acl[0-403] _______________

self = <tests.test_admin.TestCommunityModelView object at 0x7f1f279d8160>
app = <Flask 'testapp'>, client = <FlaskClient <Flask 'testapp'>>
setup_view_community = (<Flask 'testapp'>, <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>, <flask_admin.base.Admin object at 0x7f1f27772320>, <User 5>, <invenio_communities.admin.CommunityModelView object at 0x7f1f27772278>)
users = [{'email': 'contributor@test.org', 'id': 2, 'obj': <User 2>}, {'email': 'repoadmin@test.org', 'id': 4, 'obj': <User 4>...eneraluser@test.org', 'id': 6, 'obj': <User 5>}, {'email': 'originalroleuser@test.org', 'id': 7, 'obj': <User 7>}, ...]
id = 0, status_code = 403

    @pytest.mark.parametrize(
        "id, status_code",
        [
        (0, 403), # contributor
        (1, 200), # repoadmin
        (2, 200), # sysadmin
        (3, 200), # comadmin
        (4, 403), # generaluser
        (5, 403), # original role
        (6, 200), # original role + repoadmin
        (7, 403), # no role
    ],
    )
    def test_index_view_acl(self,app,client,setup_view_community,users,id,status_code):
        url = url_for('community.index_view')
        with patch("flask_login.utils._get_user", return_value=users[id]["obj"]):
            # login_user_via_session(client,email=users[id]["email"])
            res = client.get(url)
>           assert res.status_code == status_code
E           assert 200 == 403
E             -200
E             +403

tests/test_admin.py:71: AssertionError
______________ TestCommunityModelView.test_index_view_acl[4-403] _______________

self = <tests.test_admin.TestCommunityModelView object at 0x7f1f2737f390>
app = <Flask 'testapp'>, client = <FlaskClient <Flask 'testapp'>>
setup_view_community = (<Flask 'testapp'>, <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>, <flask_admin.base.Admin object at 0x7f1f27284978>, <User 5>, <invenio_communities.admin.CommunityModelView object at 0x7f1f272906d8>)
users = [{'email': 'contributor@test.org', 'id': 2, 'obj': <User 2>}, {'email': 'repoadmin@test.org', 'id': 4, 'obj': <User 4>...eneraluser@test.org', 'id': 6, 'obj': <User 5>}, {'email': 'originalroleuser@test.org', 'id': 7, 'obj': <User 7>}, ...]
id = 4, status_code = 403

    @pytest.mark.parametrize(
        "id, status_code",
        [
        (0, 403), # contributor
        (1, 200), # repoadmin
        (2, 200), # sysadmin
        (3, 200), # comadmin
        (4, 403), # generaluser
        (5, 403), # original role
        (6, 200), # original role + repoadmin
        (7, 403), # no role
    ],
    )
    def test_index_view_acl(self,app,client,setup_view_community,users,id,status_code):
        url = url_for('community.index_view')
        with patch("flask_login.utils._get_user", return_value=users[id]["obj"]):
            # login_user_via_session(client,email=users[id]["email"])
            res = client.get(url)
>           assert res.status_code == status_code
E           assert 200 == 403
E             -200
E             +403

tests/test_admin.py:71: AssertionError
______________ TestCommunityModelView.test_index_view_acl[5-403] _______________

self = <tests.test_admin.TestCommunityModelView object at 0x7f1f274d54e0>
app = <Flask 'testapp'>, client = <FlaskClient <Flask 'testapp'>>
setup_view_community = (<Flask 'testapp'>, <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>, <flask_admin.base.Admin object at 0x7f1f271afe10>, <User 5>, <invenio_communities.admin.CommunityModelView object at 0x7f1f27175588>)
users = [{'email': 'contributor@test.org', 'id': 2, 'obj': <User 2>}, {'email': 'repoadmin@test.org', 'id': 4, 'obj': <User 4>...eneraluser@test.org', 'id': 6, 'obj': <User 5>}, {'email': 'originalroleuser@test.org', 'id': 7, 'obj': <User 7>}, ...]
id = 5, status_code = 403

    @pytest.mark.parametrize(
        "id, status_code",
        [
        (0, 403), # contributor
        (1, 200), # repoadmin
        (2, 200), # sysadmin
        (3, 200), # comadmin
        (4, 403), # generaluser
        (5, 403), # original role
        (6, 200), # original role + repoadmin
        (7, 403), # no role
    ],
    )
    def test_index_view_acl(self,app,client,setup_view_community,users,id,status_code):
        url = url_for('community.index_view')
        with patch("flask_login.utils._get_user", return_value=users[id]["obj"]):
            # login_user_via_session(client,email=users[id]["email"])
            res = client.get(url)
>           assert res.status_code == status_code
E           assert 200 == 403
E             -200
E             +403

tests/test_admin.py:71: AssertionError
______________ TestCommunityModelView.test_index_view_acl[7-403] _______________

self = <tests.test_admin.TestCommunityModelView object at 0x7f1f2705b1d0>
app = <Flask 'testapp'>, client = <FlaskClient <Flask 'testapp'>>
setup_view_community = (<Flask 'testapp'>, <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>, <flask_admin.base.Admin object at 0x7f1f27071240>, <User 5>, <invenio_communities.admin.CommunityModelView object at 0x7f1f27071048>)
users = [{'email': 'contributor@test.org', 'id': 2, 'obj': <User 2>}, {'email': 'repoadmin@test.org', 'id': 4, 'obj': <User 4>...eneraluser@test.org', 'id': 6, 'obj': <User 5>}, {'email': 'originalroleuser@test.org', 'id': 7, 'obj': <User 7>}, ...]
id = 7, status_code = 403

    @pytest.mark.parametrize(
        "id, status_code",
        [
        (0, 403), # contributor
        (1, 200), # repoadmin
        (2, 200), # sysadmin
        (3, 200), # comadmin
        (4, 403), # generaluser
        (5, 403), # original role
        (6, 200), # original role + repoadmin
        (7, 403), # no role
    ],
    )
    def test_index_view_acl(self,app,client,setup_view_community,users,id,status_code):
        url = url_for('community.index_view')
        with patch("flask_login.utils._get_user", return_value=users[id]["obj"]):
            # login_user_via_session(client,email=users[id]["email"])
>           res = client.get(url)

tests/test_admin.py:70: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
.tox/c1/lib/python3.6/site-packages/flask/testing.py:227: in open
    follow_redirects=follow_redirects,
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
.tox/c1/lib/python3.6/site-packages/flask/app.py:2463: in __call__
    return self.wsgi_app(environ, start_response)
.tox/c1/lib/python3.6/site-packages/flask/app.py:2449: in wsgi_app
    response = self.handle_exception(e)
.tox/c1/lib/python3.6/site-packages/flask/app.py:1866: in handle_exception
    reraise(exc_type, exc_value, tb)
.tox/c1/lib/python3.6/site-packages/flask/_compat.py:39: in reraise
    raise value
.tox/c1/lib/python3.6/site-packages/flask/app.py:2446: in wsgi_app
    response = self.full_dispatch_request()
.tox/c1/lib/python3.6/site-packages/flask/app.py:1951: in full_dispatch_request
    rv = self.handle_user_exception(e)
.tox/c1/lib/python3.6/site-packages/flask/app.py:1820: in handle_user_exception
    reraise(exc_type, exc_value, tb)
.tox/c1/lib/python3.6/site-packages/flask/_compat.py:39: in reraise
    raise value
.tox/c1/lib/python3.6/site-packages/flask/app.py:1949: in full_dispatch_request
    rv = self.dispatch_request()
.tox/c1/lib/python3.6/site-packages/flask/app.py:1935: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
.tox/c1/lib/python3.6/site-packages/flask_admin/base.py:69: in inner
    return self._run_view(f, *args, **kwargs)
.tox/c1/lib/python3.6/site-packages/flask_admin/base.py:368: in _run_view
    return fn(self, *args, **kwargs)
.tox/c1/lib/python3.6/site-packages/flask_admin/model/base.py:1960: in index_view
    view_args.search, view_args.filters, page_size=page_size)
.tox/c1/lib/python3.6/site-packages/flask_admin/contrib/sqla/view.py:1029: in get_list
    query = self.get_query()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.admin.CommunityModelView object at 0x7f1f27071048>

    def get_query(self):
        """Return a query for the model type.
    
        This method can be used to set a "persistent filter" on an index_view.
        If you override this method, don't forget to also override
        `get_count_query`,
        for displaying the correct
        item count in the list view, and `get_one`,
        which is used when retrieving records for the edit view.
        """
        role_ids = get_user_role_ids()
    
>       if min(role_ids) <= \
                current_app.config['COMMUNITIES_LIMITED_ROLE_ACCESS_PERMIT']:
E               ValueError: min() arg is an empty sequence

invenio_communities/admin.py:148: ValueError
____________________ TestCommunityModelView.test_get_query _____________________

self = <tests.test_admin.TestCommunityModelView object at 0x7f1f27336d68>
setup_view_community = (<Flask 'testapp'>, <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>, <flask_admin.base.Admin object at 0x7f1f271d6e48>, <User 5>, <invenio_communities.admin.CommunityModelView object at 0x7f1f270433c8>)
users = [{'email': 'contributor@test.org', 'id': 2, 'obj': <User 2>}, {'email': 'repoadmin@test.org', 'id': 4, 'obj': <User 4>...eneraluser@test.org', 'id': 6, 'obj': <User 5>}, {'email': 'originalroleuser@test.org', 'id': 7, 'obj': <User 7>}, ...]

    def test_get_query(self,setup_view_community,users):
        _, _, _, user, view = setup_view_community
        # min(role_ids) <= 2
        with patch("flask_login.utils._get_user", return_value=user):
            result = view.get_query()
            assert "WHERE" not in str(result)
    
        # min(role_ids) > 2
        with patch("flask_login.utils._get_user", return_value=users[0]["obj"]):
            result = view.get_query()
>           assert "WHERE communities_community.id_role IN (?) OR communities_community.id_user = ?" in str(result)
E           AssertionError: assert 'WHERE communities_community.id_role IN (?) OR communities_community.id_user = ?' in 'SELECT communities_community.created AS communities_community_created, communities_community.updated AS communities_c...es_community \nWHERE communities_community.id_role IN (%(id_role_1)s) OR communities_community.id_user = %(id_user_1)s'
E            +  where 'SELECT communities_community.created AS communities_community_created, communities_community.updated AS communities_c...es_community \nWHERE communities_community.id_role IN (%(id_role_1)s) OR communities_community.id_user = %(id_user_1)s' = str(<flask_sqlalchemy.BaseQuery object at 0x7f1f2717e3c8>)

tests/test_admin.py:100: AssertionError
_________________ TestCommunityModelView.test_get_count_query __________________

self = <tests.test_admin.TestCommunityModelView object at 0x7f1f2742d278>
setup_view_community = (<Flask 'testapp'>, <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>, <flask_admin.base.Admin object at 0x7f1f26ed73c8>, <User 5>, <invenio_communities.admin.CommunityModelView object at 0x7f1f26ed76a0>)
users = [{'email': 'contributor@test.org', 'id': 2, 'obj': <User 2>}, {'email': 'repoadmin@test.org', 'id': 4, 'obj': <User 4>...eneraluser@test.org', 'id': 6, 'obj': <User 5>}, {'email': 'originalroleuser@test.org', 'id': 7, 'obj': <User 7>}, ...]

    def test_get_count_query(self,setup_view_community,users):
        app, _, _, user, view = setup_view_community
        # min(role_ids) <= 2
        with patch("flask_login.utils._get_user", return_value=user):
            result = view.get_count_query()
            assert "WHERE" not in str(result)
    
        # min(role_ids) > 2
        with patch("flask_login.utils._get_user", return_value=users[0]["obj"]):
            result = view.get_count_query()
>           assert "WHERE communities_community.id_role IN (?) OR communities_community.id_user = ?" in str(result)
E           AssertionError: assert 'WHERE communities_community.id_role IN (?) OR communities_community.id_user = ?' in 'SELECT count(%(count_2)s) AS count_1 \nFROM communities_community \nWHERE communities_community.id_role IN (%(id_role_1)s) OR communities_community.id_user = %(id_user_1)s'
E            +  where 'SELECT count(%(count_2)s) AS count_1 \nFROM communities_community \nWHERE communities_community.id_role IN (%(id_role_1)s) OR communities_community.id_user = %(id_user_1)s' = str(<flask_sqlalchemy.BaseQuery object at 0x7f1f26ea8eb8>)

tests/test_admin.py:114: AssertionError
___________ TestFeaturedCommunityModelView.test_index_view_acl_guest ___________

self = <tests.test_admin.TestFeaturedCommunityModelView object at 0x7f1f26e27208>
app = <Flask 'testapp'>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>
client = <FlaskClient <Flask 'testapp'>>

    def test_index_view_acl_guest(self,app,db,client):
        admin = Admin(app)
        featured_adminview_copy = dict(featured_adminview)
        featured_model = featured_adminview_copy.pop("model")
        featured_view = featured_adminview_copy.pop("modelview")
        view = featured_view(featured_model,db.session,**featured_adminview_copy)
        admin.add_view(view)
    
        url = url_for('featuredcommunity.index_view')
        res = client.get(url)
>       assert res.status_code == 302
E       assert 200 == 302
E         -200
E         +302

tests/test_admin.py:202: AssertionError
__________ TestFeaturedCommunityModelView.test_index_view_acl[0-403] ___________

self = <tests.test_admin.TestFeaturedCommunityModelView object at 0x7f1f26f9b198>
app = <Flask 'testapp'>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>
client = <FlaskClient <Flask 'testapp'>>
users = [{'email': 'contributor@test.org', 'id': 2, 'obj': <User 2>}, {'email': 'repoadmin@test.org', 'id': 4, 'obj': <User 4>...eneraluser@test.org', 'id': 6, 'obj': <User 5>}, {'email': 'originalroleuser@test.org', 'id': 7, 'obj': <User 7>}, ...]
id = 0, status_code = 403

    @pytest.mark.parametrize(
        "id, status_code",
        [
        (0, 403), # contributor
        (1, 200), # repoadmin
        (2, 200), # sysadmin
        (3, 200), # comadmin
        (4, 403), # generaluser
        (5, 403), # original role
        (6, 200), # original role + repoadmin
        (7, 403), # no role
    ],
    )
    def test_index_view_acl(self,app,db,client,users,id,status_code):
        admin = Admin(app)
        featured_adminview_copy = dict(featured_adminview)
        featured_model = featured_adminview_copy.pop("model")
        featured_view = featured_adminview_copy.pop("modelview")
        view = featured_view(featured_model,db.session,**featured_adminview_copy)
        admin.add_view(view)
        url = url_for('featuredcommunity.index_view')
        login_user_via_session(client,email=users[id]["email"])
        res = client.get(url)
>       assert res.status_code == status_code
E       assert 200 == 403
E         -200
E         +403

tests/test_admin.py:228: AssertionError
__________ TestFeaturedCommunityModelView.test_index_view_acl[4-403] ___________

self = <tests.test_admin.TestFeaturedCommunityModelView object at 0x7f1f26b2a630>
app = <Flask 'testapp'>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>
client = <FlaskClient <Flask 'testapp'>>
users = [{'email': 'contributor@test.org', 'id': 2, 'obj': <User 2>}, {'email': 'repoadmin@test.org', 'id': 4, 'obj': <User 4>...eneraluser@test.org', 'id': 6, 'obj': <User 5>}, {'email': 'originalroleuser@test.org', 'id': 7, 'obj': <User 7>}, ...]
id = 4, status_code = 403

    @pytest.mark.parametrize(
        "id, status_code",
        [
        (0, 403), # contributor
        (1, 200), # repoadmin
        (2, 200), # sysadmin
        (3, 200), # comadmin
        (4, 403), # generaluser
        (5, 403), # original role
        (6, 200), # original role + repoadmin
        (7, 403), # no role
    ],
    )
    def test_index_view_acl(self,app,db,client,users,id,status_code):
        admin = Admin(app)
        featured_adminview_copy = dict(featured_adminview)
        featured_model = featured_adminview_copy.pop("model")
        featured_view = featured_adminview_copy.pop("modelview")
        view = featured_view(featured_model,db.session,**featured_adminview_copy)
        admin.add_view(view)
        url = url_for('featuredcommunity.index_view')
        login_user_via_session(client,email=users[id]["email"])
        res = client.get(url)
>       assert res.status_code == status_code
E       assert 200 == 403
E         -200
E         +403

tests/test_admin.py:228: AssertionError
__________ TestFeaturedCommunityModelView.test_index_view_acl[5-403] ___________

self = <tests.test_admin.TestFeaturedCommunityModelView object at 0x7f1f267ba780>
app = <Flask 'testapp'>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>
client = <FlaskClient <Flask 'testapp'>>
users = [{'email': 'contributor@test.org', 'id': 2, 'obj': <User 2>}, {'email': 'repoadmin@test.org', 'id': 4, 'obj': <User 4>...eneraluser@test.org', 'id': 6, 'obj': <User 5>}, {'email': 'originalroleuser@test.org', 'id': 7, 'obj': <User 7>}, ...]
id = 5, status_code = 403

    @pytest.mark.parametrize(
        "id, status_code",
        [
        (0, 403), # contributor
        (1, 200), # repoadmin
        (2, 200), # sysadmin
        (3, 200), # comadmin
        (4, 403), # generaluser
        (5, 403), # original role
        (6, 200), # original role + repoadmin
        (7, 403), # no role
    ],
    )
    def test_index_view_acl(self,app,db,client,users,id,status_code):
        admin = Admin(app)
        featured_adminview_copy = dict(featured_adminview)
        featured_model = featured_adminview_copy.pop("model")
        featured_view = featured_adminview_copy.pop("modelview")
        view = featured_view(featured_model,db.session,**featured_adminview_copy)
        admin.add_view(view)
        url = url_for('featuredcommunity.index_view')
        login_user_via_session(client,email=users[id]["email"])
        res = client.get(url)
>       assert res.status_code == status_code
E       assert 200 == 403
E         -200
E         +403

tests/test_admin.py:228: AssertionError
__________ TestFeaturedCommunityModelView.test_index_view_acl[7-403] ___________

self = <tests.test_admin.TestFeaturedCommunityModelView object at 0x7f1f2694bcf8>
app = <Flask 'testapp'>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>
client = <FlaskClient <Flask 'testapp'>>
users = [{'email': 'contributor@test.org', 'id': 2, 'obj': <User 2>}, {'email': 'repoadmin@test.org', 'id': 4, 'obj': <User 4>...eneraluser@test.org', 'id': 6, 'obj': <User 5>}, {'email': 'originalroleuser@test.org', 'id': 7, 'obj': <User 7>}, ...]
id = 7, status_code = 403

    @pytest.mark.parametrize(
        "id, status_code",
        [
        (0, 403), # contributor
        (1, 200), # repoadmin
        (2, 200), # sysadmin
        (3, 200), # comadmin
        (4, 403), # generaluser
        (5, 403), # original role
        (6, 200), # original role + repoadmin
        (7, 403), # no role
    ],
    )
    def test_index_view_acl(self,app,db,client,users,id,status_code):
        admin = Admin(app)
        featured_adminview_copy = dict(featured_adminview)
        featured_model = featured_adminview_copy.pop("model")
        featured_view = featured_adminview_copy.pop("modelview")
        view = featured_view(featured_model,db.session,**featured_adminview_copy)
        admin.add_view(view)
        url = url_for('featuredcommunity.index_view')
        login_user_via_session(client,email=users[id]["email"])
        res = client.get(url)
>       assert res.status_code == status_code
E       assert 200 == 403
E         -200
E         +403

tests/test_admin.py:228: AssertionError
___________ TestInclusionRequestModelView.test_index_view_acl_guest ____________

self = <tests.test_admin.TestInclusionRequestModelView object at 0x7f1f26d151d0>
app = <Flask 'testapp'>, client = <FlaskClient <Flask 'testapp'>>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>

    def test_index_view_acl_guest(self,app,client,db):
        admin = Admin(app)
        request_adminview_copy = dict(request_adminview)
        request_model = request_adminview_copy.pop("model")
        request_view = request_adminview_copy.pop("modelview")
        view = request_view(request_model,db.session,**request_adminview_copy)
        admin.add_view(view)
        url = url_for('inclusionrequest.index_view')
        res = client.get(url)
>       assert res.status_code == 302
E       assert 200 == 302
E         -200
E         +302

tests/test_admin.py:243: AssertionError
___________ TestInclusionRequestModelView.test_index_view_acl[0-403] ___________

self = <tests.test_admin.TestInclusionRequestModelView object at 0x7f1f277e93c8>
app = <Flask 'testapp'>, client = <FlaskClient <Flask 'testapp'>>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>
users = [{'email': 'contributor@test.org', 'id': 2, 'obj': <User 2>}, {'email': 'repoadmin@test.org', 'id': 4, 'obj': <User 4>...eneraluser@test.org', 'id': 6, 'obj': <User 5>}, {'email': 'originalroleuser@test.org', 'id': 7, 'obj': <User 7>}, ...]
id = 0, status_code = 403

    @pytest.mark.parametrize(
        "id, status_code",
        [
        (0, 403), # contributor
        (1, 200), # repoadmin
        (2, 200), # sysadmin
        (3, 200), # comadmin
        (4, 403), # generaluser
        (5, 403), # original role
        (6, 200), # original role + repoadmin
        (7, 403), # no role
    ],
    )
    def test_index_view_acl(self,app,client,db,users,id,status_code):
        admin = Admin(app)
        request_adminview_copy = dict(request_adminview)
        request_model = request_adminview_copy.pop("model")
        request_view = request_adminview_copy.pop("modelview")
        view = request_view(request_model,db.session,**request_adminview_copy)
        admin.add_view(view)
    
        url = url_for('inclusionrequest.index_view')
        login_user_via_session(client,email=users[id]["email"])
        res = client.get(url)
>       assert res.status_code == status_code
E       assert 200 == 403
E         -200
E         +403

tests/test_admin.py:270: AssertionError
___________ TestInclusionRequestModelView.test_index_view_acl[4-403] ___________

self = <tests.test_admin.TestInclusionRequestModelView object at 0x7f1f26370048>
app = <Flask 'testapp'>, client = <FlaskClient <Flask 'testapp'>>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>
users = [{'email': 'contributor@test.org', 'id': 2, 'obj': <User 2>}, {'email': 'repoadmin@test.org', 'id': 4, 'obj': <User 4>...eneraluser@test.org', 'id': 6, 'obj': <User 5>}, {'email': 'originalroleuser@test.org', 'id': 7, 'obj': <User 7>}, ...]
id = 4, status_code = 403

    @pytest.mark.parametrize(
        "id, status_code",
        [
        (0, 403), # contributor
        (1, 200), # repoadmin
        (2, 200), # sysadmin
        (3, 200), # comadmin
        (4, 403), # generaluser
        (5, 403), # original role
        (6, 200), # original role + repoadmin
        (7, 403), # no role
    ],
    )
    def test_index_view_acl(self,app,client,db,users,id,status_code):
        admin = Admin(app)
        request_adminview_copy = dict(request_adminview)
        request_model = request_adminview_copy.pop("model")
        request_view = request_adminview_copy.pop("modelview")
        view = request_view(request_model,db.session,**request_adminview_copy)
        admin.add_view(view)
    
        url = url_for('inclusionrequest.index_view')
        login_user_via_session(client,email=users[id]["email"])
        res = client.get(url)
>       assert res.status_code == status_code
E       assert 200 == 403
E         -200
E         +403

tests/test_admin.py:270: AssertionError
___________ TestInclusionRequestModelView.test_index_view_acl[5-403] ___________

self = <tests.test_admin.TestInclusionRequestModelView object at 0x7f1f26272a20>
app = <Flask 'testapp'>, client = <FlaskClient <Flask 'testapp'>>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>
users = [{'email': 'contributor@test.org', 'id': 2, 'obj': <User 2>}, {'email': 'repoadmin@test.org', 'id': 4, 'obj': <User 4>...eneraluser@test.org', 'id': 6, 'obj': <User 5>}, {'email': 'originalroleuser@test.org', 'id': 7, 'obj': <User 7>}, ...]
id = 5, status_code = 403

    @pytest.mark.parametrize(
        "id, status_code",
        [
        (0, 403), # contributor
        (1, 200), # repoadmin
        (2, 200), # sysadmin
        (3, 200), # comadmin
        (4, 403), # generaluser
        (5, 403), # original role
        (6, 200), # original role + repoadmin
        (7, 403), # no role
    ],
    )
    def test_index_view_acl(self,app,client,db,users,id,status_code):
        admin = Admin(app)
        request_adminview_copy = dict(request_adminview)
        request_model = request_adminview_copy.pop("model")
        request_view = request_adminview_copy.pop("modelview")
        view = request_view(request_model,db.session,**request_adminview_copy)
        admin.add_view(view)
    
        url = url_for('inclusionrequest.index_view')
        login_user_via_session(client,email=users[id]["email"])
        res = client.get(url)
>       assert res.status_code == status_code
E       assert 200 == 403
E         -200
E         +403

tests/test_admin.py:270: AssertionError
___________ TestInclusionRequestModelView.test_index_view_acl[7-403] ___________

self = <tests.test_admin.TestInclusionRequestModelView object at 0x7f1f262fab00>
app = <Flask 'testapp'>, client = <FlaskClient <Flask 'testapp'>>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>
users = [{'email': 'contributor@test.org', 'id': 2, 'obj': <User 2>}, {'email': 'repoadmin@test.org', 'id': 4, 'obj': <User 4>...eneraluser@test.org', 'id': 6, 'obj': <User 5>}, {'email': 'originalroleuser@test.org', 'id': 7, 'obj': <User 7>}, ...]
id = 7, status_code = 403

    @pytest.mark.parametrize(
        "id, status_code",
        [
        (0, 403), # contributor
        (1, 200), # repoadmin
        (2, 200), # sysadmin
        (3, 200), # comadmin
        (4, 403), # generaluser
        (5, 403), # original role
        (6, 200), # original role + repoadmin
        (7, 403), # no role
    ],
    )
    def test_index_view_acl(self,app,client,db,users,id,status_code):
        admin = Admin(app)
        request_adminview_copy = dict(request_adminview)
        request_model = request_adminview_copy.pop("model")
        request_view = request_adminview_copy.pop("modelview")
        view = request_view(request_model,db.session,**request_adminview_copy)
        admin.add_view(view)
    
        url = url_for('inclusionrequest.index_view')
        login_user_via_session(client,email=users[id]["email"])
        res = client.get(url)
>       assert res.status_code == status_code
E       assert 200 == 403
E         -200
E         +403

tests/test_admin.py:270: AssertionError
_________________________________ test_request _________________________________

script_info = <flask.cli.ScriptInfo object at 0x7f1f2719d9e8>
db_records = (<[DetachedInstanceError("Instance <PersistentIdentifier at 0x7f1f26501320> is not bound to a Session; attribute refre...his error at: http://sqlalche.me/e/bhk3)") raised in repr()] PersistentIdentifier object at 0x7f1f2683de48>, None, ...)
communities = (<[DetachedInstanceError("Instance <Community at 0x7f1f265089b0> is not bound to a Session; attribute refresh operatio...oceed (Background on this error at: http://sqlalche.me/e/bhk3)") raised in repr()] Community object at 0x7f1f2681dd30>)
mocker = <pytest_mock.plugin.MockFixture object at 0x7f1f262d5eb8>

    def test_request(script_info,db_records,communities,mocker):
        mocker.patch("invenio_records.api.before_record_update.send")
        mocker.patch("invenio_records.api.after_record_update.send")
        mocker.patch("invenio_communities.models.inclusion_request_created.send")
    
        community_id = str(communities[0].id)
        record_id = str(db_records[2].id)
    
        # accept is true
        runner = CliRunner()
        mock_index = mocker.patch("invenio_communities.cli.RecordIndexer.index_by_id")
        result = runner.invoke(
            request,
            [community_id,record_id,"--accept"],
            obj=script_info
        )
        args,_=mock_index.call_args
        assert str(args[0]) == record_id
        from invenio_records.models import RecordMetadata
        metadata =RecordMetadata.query.filter_by(id=record_id).one().json
        assert metadata["communities"] == ["comm1"]
    
        # accept is false
        with patch("invenio_communities.cli.db.session.commit", side_effect=Exception('')):
            community_id = "comm2"
            mock_index = patch("invenio_communities.cli.RecordIndexer.index_by_id")
            result = runner.invoke(
                request,
                [community_id,record_id],
                obj=script_info
            )
>           args,_=mock_index.call_args
E           AttributeError: '_patch' object has no attribute 'call_args'

tests/test_cli.py:130: AttributeError
------------------------------ Captured log call -------------------------------
base.py                     97 WARNING  DELETE http://localhost:9200/test-weko-item-v1.0.0/record-v1.0.0/44c8fac4-3468-464c-871d-4749b7402da6 [status:N/A request:0.007s]
Traceback (most recent call last):
  File "/code/modules/invenio-communities/invenio_communities/cli.py", line 97, in request
    db.session.commit()
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/mock/mock.py", line 1149, in __call__
    return _mock_self._mock_call(*args, **kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/mock/mock.py", line 1153, in _mock_call
    return _mock_self._execute_mock_call(*args, **kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/mock/mock.py", line 1210, in _execute_mock_call
    raise effect
Exception

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connection.py", line 141, in _new_conn
    (self.host, self.port), self.timeout, **extra_kw)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/util/connection.py", line 83, in create_connection
    raise err
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/util/connection.py", line 73, in create_connection
    sock.connect(sa)
ConnectionRefusedError: [Errno 111] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connectionpool.py", line 601, in urlopen
    chunked=chunked)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connectionpool.py", line 357, in _make_request
    conn.request(method, url, **httplib_request_kw)
  File "/usr/local/lib/python3.6/http/client.py", line 1291, in request
    self._send_request(method, url, body, headers, encode_chunked)
  File "/usr/local/lib/python3.6/http/client.py", line 1337, in _send_request
    self.endheaders(body, encode_chunked=encode_chunked)
  File "/usr/local/lib/python3.6/http/client.py", line 1286, in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
  File "/usr/local/lib/python3.6/http/client.py", line 1046, in _send_output
    self.send(msg)
  File "/usr/local/lib/python3.6/http/client.py", line 984, in send
    self.connect()
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connection.py", line 166, in connect
    conn = self._new_conn()
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connection.py", line 150, in _new_conn
    self, "Failed to establish a new connection: %s" % e)
urllib3.exceptions.NewConnectionError: <urllib3.connection.HTTPConnection object at 0x7f1f27122358>: Failed to establish a new connection: [Errno 111] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/requests/adapters.py", line 440, in send
    timeout=timeout
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connectionpool.py", line 639, in urlopen
    _stacktrace=sys.exc_info()[2])
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/util/retry.py", line 388, in increment
    raise MaxRetryError(_pool, url, error or ResponseError(cause))
urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=9200): Max retries exceeded with url: /test-weko-item-v1.0.0/record-v1.0.0/44c8fac4-3468-464c-871d-4749b7402da6 (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f1f27122358>: Failed to establish a new connection: [Errno 111] Connection refused',))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/http_requests.py", line 76, in perform_request
    response = self.session.send(prepared_request, **send_kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/requests/sessions.py", line 618, in send
    r = adapter.send(request, **kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/requests/adapters.py", line 508, in send
    raise ConnectionError(e, request=request)
requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=9200): Max retries exceeded with url: /test-weko-item-v1.0.0/record-v1.0.0/44c8fac4-3468-464c-871d-4749b7402da6 (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f1f27122358>: Failed to establish a new connection: [Errno 111] Connection refused',))
base.py                     97 WARNING  DELETE http://localhost:9200/test-weko-item-v1.0.0/record-v1.0.0/44c8fac4-3468-464c-871d-4749b7402da6 [status:N/A request:0.002s]
Traceback (most recent call last):
  File "/code/modules/invenio-communities/invenio_communities/cli.py", line 97, in request
    db.session.commit()
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/mock/mock.py", line 1149, in __call__
    return _mock_self._mock_call(*args, **kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/mock/mock.py", line 1153, in _mock_call
    return _mock_self._execute_mock_call(*args, **kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/mock/mock.py", line 1210, in _execute_mock_call
    raise effect
Exception

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connection.py", line 141, in _new_conn
    (self.host, self.port), self.timeout, **extra_kw)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/util/connection.py", line 83, in create_connection
    raise err
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/util/connection.py", line 73, in create_connection
    sock.connect(sa)
ConnectionRefusedError: [Errno 111] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connectionpool.py", line 601, in urlopen
    chunked=chunked)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connectionpool.py", line 357, in _make_request
    conn.request(method, url, **httplib_request_kw)
  File "/usr/local/lib/python3.6/http/client.py", line 1291, in request
    self._send_request(method, url, body, headers, encode_chunked)
  File "/usr/local/lib/python3.6/http/client.py", line 1337, in _send_request
    self.endheaders(body, encode_chunked=encode_chunked)
  File "/usr/local/lib/python3.6/http/client.py", line 1286, in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
  File "/usr/local/lib/python3.6/http/client.py", line 1046, in _send_output
    self.send(msg)
  File "/usr/local/lib/python3.6/http/client.py", line 984, in send
    self.connect()
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connection.py", line 166, in connect
    conn = self._new_conn()
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connection.py", line 150, in _new_conn
    self, "Failed to establish a new connection: %s" % e)
urllib3.exceptions.NewConnectionError: <urllib3.connection.HTTPConnection object at 0x7f1f26f59240>: Failed to establish a new connection: [Errno 111] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/requests/adapters.py", line 440, in send
    timeout=timeout
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connectionpool.py", line 639, in urlopen
    _stacktrace=sys.exc_info()[2])
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/util/retry.py", line 388, in increment
    raise MaxRetryError(_pool, url, error or ResponseError(cause))
urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=9200): Max retries exceeded with url: /test-weko-item-v1.0.0/record-v1.0.0/44c8fac4-3468-464c-871d-4749b7402da6 (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f1f26f59240>: Failed to establish a new connection: [Errno 111] Connection refused',))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/http_requests.py", line 76, in perform_request
    response = self.session.send(prepared_request, **send_kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/requests/sessions.py", line 618, in send
    r = adapter.send(request, **kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/requests/adapters.py", line 508, in send
    raise ConnectionError(e, request=request)
requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=9200): Max retries exceeded with url: /test-weko-item-v1.0.0/record-v1.0.0/44c8fac4-3468-464c-871d-4749b7402da6 (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f1f26f59240>: Failed to establish a new connection: [Errno 111] Connection refused',))
base.py                     97 WARNING  DELETE http://localhost:9200/test-weko-item-v1.0.0/record-v1.0.0/44c8fac4-3468-464c-871d-4749b7402da6 [status:N/A request:0.002s]
Traceback (most recent call last):
  File "/code/modules/invenio-communities/invenio_communities/cli.py", line 97, in request
    db.session.commit()
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/mock/mock.py", line 1149, in __call__
    return _mock_self._mock_call(*args, **kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/mock/mock.py", line 1153, in _mock_call
    return _mock_self._execute_mock_call(*args, **kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/mock/mock.py", line 1210, in _execute_mock_call
    raise effect
Exception

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connection.py", line 141, in _new_conn
    (self.host, self.port), self.timeout, **extra_kw)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/util/connection.py", line 83, in create_connection
    raise err
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/util/connection.py", line 73, in create_connection
    sock.connect(sa)
ConnectionRefusedError: [Errno 111] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connectionpool.py", line 601, in urlopen
    chunked=chunked)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connectionpool.py", line 357, in _make_request
    conn.request(method, url, **httplib_request_kw)
  File "/usr/local/lib/python3.6/http/client.py", line 1291, in request
    self._send_request(method, url, body, headers, encode_chunked)
  File "/usr/local/lib/python3.6/http/client.py", line 1337, in _send_request
    self.endheaders(body, encode_chunked=encode_chunked)
  File "/usr/local/lib/python3.6/http/client.py", line 1286, in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
  File "/usr/local/lib/python3.6/http/client.py", line 1046, in _send_output
    self.send(msg)
  File "/usr/local/lib/python3.6/http/client.py", line 984, in send
    self.connect()
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connection.py", line 166, in connect
    conn = self._new_conn()
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connection.py", line 150, in _new_conn
    self, "Failed to establish a new connection: %s" % e)
urllib3.exceptions.NewConnectionError: <urllib3.connection.HTTPConnection object at 0x7f1f2732d048>: Failed to establish a new connection: [Errno 111] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/requests/adapters.py", line 440, in send
    timeout=timeout
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connectionpool.py", line 639, in urlopen
    _stacktrace=sys.exc_info()[2])
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/util/retry.py", line 388, in increment
    raise MaxRetryError(_pool, url, error or ResponseError(cause))
urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=9200): Max retries exceeded with url: /test-weko-item-v1.0.0/record-v1.0.0/44c8fac4-3468-464c-871d-4749b7402da6 (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f1f2732d048>: Failed to establish a new connection: [Errno 111] Connection refused',))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/http_requests.py", line 76, in perform_request
    response = self.session.send(prepared_request, **send_kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/requests/sessions.py", line 618, in send
    r = adapter.send(request, **kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/requests/adapters.py", line 508, in send
    raise ConnectionError(e, request=request)
requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=9200): Max retries exceeded with url: /test-weko-item-v1.0.0/record-v1.0.0/44c8fac4-3468-464c-871d-4749b7402da6 (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f1f2732d048>: Failed to establish a new connection: [Errno 111] Connection refused',))
base.py                     97 WARNING  DELETE http://localhost:9200/test-weko-item-v1.0.0/record-v1.0.0/44c8fac4-3468-464c-871d-4749b7402da6 [status:N/A request:0.002s]
Traceback (most recent call last):
  File "/code/modules/invenio-communities/invenio_communities/cli.py", line 97, in request
    db.session.commit()
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/mock/mock.py", line 1149, in __call__
    return _mock_self._mock_call(*args, **kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/mock/mock.py", line 1153, in _mock_call
    return _mock_self._execute_mock_call(*args, **kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/mock/mock.py", line 1210, in _execute_mock_call
    raise effect
Exception

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connection.py", line 141, in _new_conn
    (self.host, self.port), self.timeout, **extra_kw)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/util/connection.py", line 83, in create_connection
    raise err
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/util/connection.py", line 73, in create_connection
    sock.connect(sa)
ConnectionRefusedError: [Errno 111] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connectionpool.py", line 601, in urlopen
    chunked=chunked)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connectionpool.py", line 357, in _make_request
    conn.request(method, url, **httplib_request_kw)
  File "/usr/local/lib/python3.6/http/client.py", line 1291, in request
    self._send_request(method, url, body, headers, encode_chunked)
  File "/usr/local/lib/python3.6/http/client.py", line 1337, in _send_request
    self.endheaders(body, encode_chunked=encode_chunked)
  File "/usr/local/lib/python3.6/http/client.py", line 1286, in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
  File "/usr/local/lib/python3.6/http/client.py", line 1046, in _send_output
    self.send(msg)
  File "/usr/local/lib/python3.6/http/client.py", line 984, in send
    self.connect()
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connection.py", line 166, in connect
    conn = self._new_conn()
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connection.py", line 150, in _new_conn
    self, "Failed to establish a new connection: %s" % e)
urllib3.exceptions.NewConnectionError: <urllib3.connection.HTTPConnection object at 0x7f1f277fcf28>: Failed to establish a new connection: [Errno 111] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/requests/adapters.py", line 440, in send
    timeout=timeout
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/connectionpool.py", line 639, in urlopen
    _stacktrace=sys.exc_info()[2])
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/urllib3/util/retry.py", line 388, in increment
    raise MaxRetryError(_pool, url, error or ResponseError(cause))
urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=9200): Max retries exceeded with url: /test-weko-item-v1.0.0/record-v1.0.0/44c8fac4-3468-464c-871d-4749b7402da6 (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f1f277fcf28>: Failed to establish a new connection: [Errno 111] Connection refused',))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/http_requests.py", line 76, in perform_request
    response = self.session.send(prepared_request, **send_kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/requests/sessions.py", line 618, in send
    r = adapter.send(request, **kwargs)
  File "/code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/requests/adapters.py", line 508, in send
    raise ConnectionError(e, request=request)
requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=9200): Max retries exceeded with url: /test-weko-item-v1.0.0/record-v1.0.0/44c8fac4-3468-464c-871d-4749b7402da6 (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f1f277fcf28>: Failed to establish a new connection: [Errno 111] Connection refused',))
_________________________________ test_remove __________________________________

script_info = <flask.cli.ScriptInfo object at 0x7f1f2683dbe0>
communities = (<Community, ID: comm1>, <Community, ID: comm2>, <Community, ID: oth3>)
db_records = (<PersistentIdentifier recid:1 / rec:8da6160a-da48-4841-bc96-7e25f99ef057 (R)>, <PersistentIdentifier depid:1 / rec:8d...'conference paper'}}, <PersistentIdentifier parent:parent:1 / rec:8da6160a-da48-4841-bc96-7e25f99ef057 (R)>, None, ...)
mocker = <pytest_mock.plugin.MockFixture object at 0x7f1f268be6d8>

    def test_remove(script_info,communities,db_records,mocker):
        mocker.patch("invenio_records.api.before_record_update.send")
        mocker.patch("invenio_records.api.after_record_update.send")
        mocker.patch("invenio_communities.models.inclusion_request_created.send")
    
        record_id = str(db_records[2].id)
        comm = Community.query.filter_by(id="comm1").one()
        record = Record.get_record(record_id)
        comm.add_record(record)
        record.commit()
        runner = CliRunner()
        with patch("invenio_communities.cli.db.session.commit", side_effect=Exception('')):
            result = runner.invoke(
                remove,
                [comm.id,record_id],
                obj=script_info
            )
>           assert Record.get_record(record_id)

tests/test_cli.py:164: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../invenio-records/invenio_records/api.py:206: in get_record
    obj = query.one()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask_sqlalchemy.BaseQuery object at 0x7f1f260019b0>

    def one(self):
        """Return exactly one result or raise an exception.
    
        Raises ``sqlalchemy.orm.exc.NoResultFound`` if the query selects
        no rows.  Raises ``sqlalchemy.orm.exc.MultipleResultsFound``
        if multiple object identities are returned, or if multiple
        rows are returned for a query that returns only scalar values
        as opposed to full identity-mapped entities.
    
        Calling :meth:`.one` results in an execution of the underlying query.
    
        .. seealso::
    
            :meth:`.Query.first`
    
            :meth:`.Query.one_or_none`
    
        """
        try:
            ret = self.one_or_none()
        except orm_exc.MultipleResultsFound:
            raise orm_exc.MultipleResultsFound(
                "Multiple rows were found for one()"
            )
        else:
            if ret is None:
>               raise orm_exc.NoResultFound("No row was found for one()")
E               sqlalchemy.orm.exc.NoResultFound: No row was found for one()

.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3046: NoResultFound
_________________________________ test_alembic _________________________________

self = <sqlalchemy.engine.base.Connection object at 0x7f1f25dd2860>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7f1f25efc630>
constructor = <bound method DefaultExecutionContext._init_ddl of <class 'sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2'>>
statement = 'ALTER TABLE admin_lang_settings ADD CONSTRAINT uq_admin_lang_settings_lang_code UNIQUE (lang_code)'
parameters = {}
args = (<sqlalchemy.dialects.postgresql.base.PGDDLCompiler object at 0x7f1f25a3ec50>,)
conn = <sqlalchemy.pool._ConnectionFairy object at 0x7f1f25db0a58>
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f1f25a3e278>

    def _execute_context(
        self, dialect, constructor, statement, parameters, *args
    ):
        """Create an :class:`.ExecutionContext` and execute, returning
        a :class:`.ResultProxy`."""
    
        try:
            try:
                conn = self.__connection
            except AttributeError:
                # escape "except AttributeError" before revalidating
                # to prevent misleading stacktraces in Py3K
                conn = None
            if conn is None:
                conn = self._revalidate_connection()
    
            context = constructor(dialect, self, conn, *args)
        except BaseException as e:
            self._handle_dbapi_exception(
                e, util.text_type(statement), parameters, None, None
            )
    
        if context.compiled:
            context.pre_exec()
    
        cursor, statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        if not context.executemany:
            parameters = parameters[0]
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                statement, parameters = fn(
                    self,
                    cursor,
                    statement,
                    parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self.engine.logger.info(statement)
            self.engine.logger.info(
                "%r", sql_util._repr_params(parameters, batches=10)
            )
    
        evt_handled = False
        try:
            if context.executemany:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(cursor, statement, parameters, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor, statement, parameters, context
                    )
            elif not parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, statement, context
                    )
            else:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(cursor, statement, parameters, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute(
>                       cursor, statement, parameters, context
                    )

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1236: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7f1f25efc630>
cursor = <cursor object at 0x7f1f27605330; closed: -1>
statement = 'ALTER TABLE admin_lang_settings ADD CONSTRAINT uq_admin_lang_settings_lang_code UNIQUE (lang_code)'
parameters = {}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f1f25a3e278>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       psycopg2.ProgrammingError: relation "admin_lang_settings" does not exist

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:536: ProgrammingError

The above exception was the direct cause of the following exception:

app = <Flask 'testapp'>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>

    def test_alembic(app, db):
        """Test alembic recipes."""
        ext = app.extensions['invenio-db']
    
        if db.engine.name == 'sqlite':
            raise pytest.skip('Upgrades are not supported on SQLite.')
    
        assert ext.alembic.compare_metadata()
        db.drop_all()
>       ext.alembic.upgrade()

tests/test_invenio_communities.py:113: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.tox/c1/lib/python3.6/site-packages/flask_alembic/extension.py:327: in upgrade
    self.run_migrations(do_upgrade)
.tox/c1/lib/python3.6/site-packages/flask_alembic/extension.py:236: in run_migrations
    env.run_migrations(**kwargs)
.tox/c1/lib/python3.6/site-packages/alembic/runtime/environment.py:836: in run_migrations
    self.get_context().run_migrations(**kw)
.tox/c1/lib/python3.6/site-packages/alembic/runtime/migration.py:330: in run_migrations
    step.migration_fn(**kw)
../weko-admin/weko_admin/alembic/b4d2f3c0734b_update.py:23: in upgrade
    op.create_unique_constraint(op.f('uq_admin_lang_settings_lang_code'), 'admin_lang_settings', ['lang_code'])
<string>:8: in create_unique_constraint
    ???
<string>:3: in create_unique_constraint
    ???
.tox/c1/lib/python3.6/site-packages/alembic/operations/ops.py:399: in create_unique_constraint
    return operations.invoke(op)
.tox/c1/lib/python3.6/site-packages/alembic/operations/base.py:319: in invoke
    return fn(self, operation)
.tox/c1/lib/python3.6/site-packages/alembic/operations/toimpl.py:135: in create_constraint
    operation.to_constraint(operations.migration_context)
.tox/c1/lib/python3.6/site-packages/alembic/ddl/impl.py:180: in add_constraint
    self._exec(schema.AddConstraint(const))
.tox/c1/lib/python3.6/site-packages/alembic/ddl/impl.py:118: in _exec
    return conn.execute(construct, *multiparams, **params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:980: in execute
    return meth(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/sql/ddl.py:72: in _execute_on_connection
    return connection._execute_ddl(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1042: in _execute_ddl
    compiled,
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1240: in _execute_context
    e, statement, parameters, cursor, context
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1458: in _handle_dbapi_exception
    util.raise_from_cause(sqlalchemy_exception, exc_info)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:296: in raise_from_cause
    reraise(type(exception), exception, tb=exc_tb, cause=cause)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:276: in reraise
    raise value.with_traceback(tb)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1236: in _execute_context
    cursor, statement, parameters, context
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7f1f25efc630>
cursor = <cursor object at 0x7f1f27605330; closed: -1>
statement = 'ALTER TABLE admin_lang_settings ADD CONSTRAINT uq_admin_lang_settings_lang_code UNIQUE (lang_code)'
parameters = {}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f1f25a3e278>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.ProgrammingError: (psycopg2.ProgrammingError) relation "admin_lang_settings" does not exist
E        [SQL: 'ALTER TABLE admin_lang_settings ADD CONSTRAINT uq_admin_lang_settings_lang_code UNIQUE (lang_code)'] (Background on this error at: http://sqlalche.me/e/f405)

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:536: ProgrammingError
_____________________________ test_dbsession_clean _____________________________

self = <sqlalchemy.engine.base.Connection object at 0x7f1f245355c0>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7f1f245c91d0>
constructor = <bound method DefaultExecutionContext._init_compiled of <class 'sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2'>>
statement = 'SELECT communities_community.created AS communities_community_created, communities_community.updated AS communities_c...s_community_root_node_id \nFROM communities_community \nWHERE communities_community.id = %(id_1)s \n LIMIT %(param_1)s'
parameters = {'id_1': 1, 'param_1': 1}
args = (<sqlalchemy.dialects.postgresql.psycopg2.PGCompiler_psycopg2 object at 0x7f1f24535d30>, [immutabledict({})])
conn = <sqlalchemy.pool._ConnectionFairy object at 0x7f1f24535d68>
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f1f24529ba8>

    def _execute_context(
        self, dialect, constructor, statement, parameters, *args
    ):
        """Create an :class:`.ExecutionContext` and execute, returning
        a :class:`.ResultProxy`."""
    
        try:
            try:
                conn = self.__connection
            except AttributeError:
                # escape "except AttributeError" before revalidating
                # to prevent misleading stacktraces in Py3K
                conn = None
            if conn is None:
                conn = self._revalidate_connection()
    
            context = constructor(dialect, self, conn, *args)
        except BaseException as e:
            self._handle_dbapi_exception(
                e, util.text_type(statement), parameters, None, None
            )
    
        if context.compiled:
            context.pre_exec()
    
        cursor, statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        if not context.executemany:
            parameters = parameters[0]
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                statement, parameters = fn(
                    self,
                    cursor,
                    statement,
                    parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self.engine.logger.info(statement)
            self.engine.logger.info(
                "%r", sql_util._repr_params(parameters, batches=10)
            )
    
        evt_handled = False
        try:
            if context.executemany:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(cursor, statement, parameters, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor, statement, parameters, context
                    )
            elif not parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, statement, context
                    )
            else:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(cursor, statement, parameters, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute(
>                       cursor, statement, parameters, context
                    )

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1236: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7f1f245c91d0>
cursor = <cursor object at 0x7f1f27605ed0; closed: -1>
statement = 'SELECT communities_community.created AS communities_community_created, communities_community.updated AS communities_c...s_community_root_node_id \nFROM communities_community \nWHERE communities_community.id = %(id_1)s \n LIMIT %(param_1)s'
parameters = {'id_1': 1, 'param_1': 1}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f1f24529ba8>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       psycopg2.ProgrammingError: operator does not exist: character varying = integer
E       LINE 3: WHERE communities_community.id = 1 
E                                              ^
E       HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:536: ProgrammingError

The above exception was the direct cause of the following exception:

app = <Flask 'testapp'>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>

    def test_dbsession_clean(app, db):
        user = create_test_user(email='test@test.org')
        user1 = db.session.merge(user)
        ds = app.extensions['invenio-accounts'].datastore
        r = ds.create_role(name='superuser', description='1234')
        ds.add_role_to_user(user1, r)
        ds.commit()
        index = Index()
        db.session.add(index)
        db.session.commit()
        # exist exception
        com1 = Community(id=1,id_role=1,id_user=1,root_node_id=1,title="com1")
        db.session.add(com1)
        dbsession_clean(None)
>       assert Community.query.filter_by(id=1).first().title =="com1"

tests/test_views_api.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:2979: in first
    ret = list(self[0:1])
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:2771: in __getitem__
    return list(res)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3081: in __iter__
    return self._execute_and_instances(context)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3106: in _execute_and_instances
    result = conn.execute(querycontext.statement, self._params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:980: in execute
    return meth(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/sql/elements.py:273: in _execute_on_connection
    return connection._execute_clauseelement(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1099: in _execute_clauseelement
    distilled_params,
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1240: in _execute_context
    e, statement, parameters, cursor, context
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1458: in _handle_dbapi_exception
    util.raise_from_cause(sqlalchemy_exception, exc_info)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:296: in raise_from_cause
    reraise(type(exception), exception, tb=exc_tb, cause=cause)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:276: in reraise
    raise value.with_traceback(tb)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1236: in _execute_context
    cursor, statement, parameters, context
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7f1f245c91d0>
cursor = <cursor object at 0x7f1f27605ed0; closed: -1>
statement = 'SELECT communities_community.created AS communities_community_created, communities_community.updated AS communities_c...s_community_root_node_id \nFROM communities_community \nWHERE communities_community.id = %(id_1)s \n LIMIT %(param_1)s'
parameters = {'id_1': 1, 'param_1': 1}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f1f24529ba8>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.ProgrammingError: (psycopg2.ProgrammingError) operator does not exist: character varying = integer
E       LINE 3: WHERE communities_community.id = 1 
E                                              ^
E       HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
E        [SQL: 'SELECT communities_community.created AS communities_community_created, communities_community.updated AS communities_community_updated, communities_community.id AS communities_community_id, communities_community.id_role AS communities_community_id_role, communities_community.id_user AS communities_community_id_user, communities_community.title AS communities_community_title, communities_community.description AS communities_community_description, communities_community.page AS communities_community_page, communities_community.curation_policy AS communities_community_curation_policy, communities_community.community_header AS communities_community_community_header, communities_community.community_footer AS communities_community_community_footer, communities_community.last_record_accepted AS communities_community_last_record_accepted, communities_community.logo_ext AS communities_community_logo_ext, communities_community.ranking AS communities_community_ranking, communities_community.fixed_points AS communities_community_fixed_points, communities_community.deleted_at AS communities_community_deleted_at, communities_community.root_node_id AS communities_community_root_node_id \nFROM communities_community \nWHERE communities_community.id = %(id_1)s \n LIMIT %(param_1)s'] [parameters: {'id_1': 1, 'param_1': 1}] (Background on this error at: http://sqlalche.me/e/f405)

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:536: ProgrammingError
_____________________________ test_dbsession_clean _____________________________

self = <sqlalchemy.engine.base.Connection object at 0x7f1f23f2f4a8>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7f1f23fc0908>
constructor = <bound method DefaultExecutionContext._init_compiled of <class 'sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2'>>
statement = 'SELECT communities_community.created AS communities_community_created, communities_community.updated AS communities_c...s_community_root_node_id \nFROM communities_community \nWHERE communities_community.id = %(id_1)s \n LIMIT %(param_1)s'
parameters = {'id_1': 1, 'param_1': 1}
args = (<sqlalchemy.dialects.postgresql.psycopg2.PGCompiler_psycopg2 object at 0x7f1f23f2f208>, [immutabledict({})])
conn = <sqlalchemy.pool._ConnectionFairy object at 0x7f1f23f2f1d0>
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f1f23f3b128>

    def _execute_context(
        self, dialect, constructor, statement, parameters, *args
    ):
        """Create an :class:`.ExecutionContext` and execute, returning
        a :class:`.ResultProxy`."""
    
        try:
            try:
                conn = self.__connection
            except AttributeError:
                # escape "except AttributeError" before revalidating
                # to prevent misleading stacktraces in Py3K
                conn = None
            if conn is None:
                conn = self._revalidate_connection()
    
            context = constructor(dialect, self, conn, *args)
        except BaseException as e:
            self._handle_dbapi_exception(
                e, util.text_type(statement), parameters, None, None
            )
    
        if context.compiled:
            context.pre_exec()
    
        cursor, statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        if not context.executemany:
            parameters = parameters[0]
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                statement, parameters = fn(
                    self,
                    cursor,
                    statement,
                    parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self.engine.logger.info(statement)
            self.engine.logger.info(
                "%r", sql_util._repr_params(parameters, batches=10)
            )
    
        evt_handled = False
        try:
            if context.executemany:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(cursor, statement, parameters, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor, statement, parameters, context
                    )
            elif not parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, statement, context
                    )
            else:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(cursor, statement, parameters, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute(
>                       cursor, statement, parameters, context
                    )

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1236: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7f1f23fc0908>
cursor = <cursor object at 0x7f1f27605af0; closed: -1>
statement = 'SELECT communities_community.created AS communities_community_created, communities_community.updated AS communities_c...s_community_root_node_id \nFROM communities_community \nWHERE communities_community.id = %(id_1)s \n LIMIT %(param_1)s'
parameters = {'id_1': 1, 'param_1': 1}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f1f23f3b128>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       psycopg2.ProgrammingError: operator does not exist: character varying = integer
E       LINE 3: WHERE communities_community.id = 1 
E                                              ^
E       HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:536: ProgrammingError

The above exception was the direct cause of the following exception:

app = <Flask 'testapp'>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>

    def test_dbsession_clean(app, db):
        user = create_test_user(email='test@test.org')
        user1 = db.session.merge(user)
        ds = app.extensions['invenio-accounts'].datastore
        r = ds.create_role(name='superuser', description='1234')
        ds.add_role_to_user(user1, r)
        ds.commit()
        index = Index()
        db.session.add(index)
        db.session.commit()
        # exist exception
        com1 = Community(id=1,id_role=1,id_user=1,root_node_id=1,title="com1")
        db.session.add(com1)
        dbsession_clean(None)
>       assert Community.query.filter_by(id=1).first().title =="com1"

tests/test_views_ui.py:228: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:2979: in first
    ret = list(self[0:1])
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:2771: in __getitem__
    return list(res)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3081: in __iter__
    return self._execute_and_instances(context)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3106: in _execute_and_instances
    result = conn.execute(querycontext.statement, self._params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:980: in execute
    return meth(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/sql/elements.py:273: in _execute_on_connection
    return connection._execute_clauseelement(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1099: in _execute_clauseelement
    distilled_params,
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1240: in _execute_context
    e, statement, parameters, cursor, context
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1458: in _handle_dbapi_exception
    util.raise_from_cause(sqlalchemy_exception, exc_info)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:296: in raise_from_cause
    reraise(type(exception), exception, tb=exc_tb, cause=cause)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:276: in reraise
    raise value.with_traceback(tb)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1236: in _execute_context
    cursor, statement, parameters, context
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7f1f23fc0908>
cursor = <cursor object at 0x7f1f27605af0; closed: -1>
statement = 'SELECT communities_community.created AS communities_community_created, communities_community.updated AS communities_c...s_community_root_node_id \nFROM communities_community \nWHERE communities_community.id = %(id_1)s \n LIMIT %(param_1)s'
parameters = {'id_1': 1, 'param_1': 1}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f1f23f3b128>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.ProgrammingError: (psycopg2.ProgrammingError) operator does not exist: character varying = integer
E       LINE 3: WHERE communities_community.id = 1 
E                                              ^
E       HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
E        [SQL: 'SELECT communities_community.created AS communities_community_created, communities_community.updated AS communities_community_updated, communities_community.id AS communities_community_id, communities_community.id_role AS communities_community_id_role, communities_community.id_user AS communities_community_id_user, communities_community.title AS communities_community_title, communities_community.description AS communities_community_description, communities_community.page AS communities_community_page, communities_community.curation_policy AS communities_community_curation_policy, communities_community.community_header AS communities_community_community_header, communities_community.community_footer AS communities_community_community_footer, communities_community.last_record_accepted AS communities_community_last_record_accepted, communities_community.logo_ext AS communities_community_logo_ext, communities_community.ranking AS communities_community_ranking, communities_community.fixed_points AS communities_community_fixed_points, communities_community.deleted_at AS communities_community_deleted_at, communities_community.root_node_id AS communities_community_root_node_id \nFROM communities_community \nWHERE communities_community.id = %(id_1)s \n LIMIT %(param_1)s'] [parameters: {'id_1': 1, 'param_1': 1}] (Background on this error at: http://sqlalche.me/e/f405)

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:536: ProgrammingError
=============================== warnings summary ===============================
tests/test_admin.py::TestCommunityModelView::test_index_view_acl_guest
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[0-403]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[1-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[2-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[3-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[4-403]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[5-403]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[6-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[7-403]
tests/test_admin.py::TestCommunityModelView::test_role_query_cond
tests/test_admin.py::TestCommunityModelView::test_get_query
tests/test_admin.py::TestCommunityModelView::test_get_count_query
tests/test_admin.py::TestCommunityModelView::test_edit
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl_guest
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[0-403]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[1-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[2-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[3-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[4-403]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[5-403]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[6-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[7-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl_guest
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[0-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[1-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[2-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[3-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[4-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[5-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[6-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[7-403]
tests/test_cli.py::test_cli_init
tests/test_cli.py::test_addlogo
tests/test_cli.py::test_request
tests/test_cli.py::test_remove
tests/test_forms.py::test_validate_input_id
tests/test_forms.py::test_CommunityForm
tests/test_invenio_communities.py::test_alembic
tests/test_invenio_communities.py::test_model_init
tests/test_invenio_communities.py::test_email_notification
tests/test_invenio_communities.py::test_model_featured_community
tests/test_invenio_communities.py::test_oaipmh_sets
tests/test_invenio_communities.py::test_communities_rest_all_communities
tests/test_invenio_communities.py::test_community_delete
tests/test_invenio_communities.py::test_communities_rest_all_communities_query_and_sort
tests/test_invenio_communities.py::test_communities_rest_pagination
tests/test_invenio_communities.py::test_communities_rest_get_details
tests/test_invenio_communities.py::test_communities_rest_etag
tests/test_invenio_communities.py::test_add_remove_corner_cases
tests/test_models.py::test_filter_community[<lambda>0]
tests/test_models.py::test_filter_community[<lambda>1]
tests/test_models.py::test_filter_community[<lambda>2]
tests/test_models.py::TestInclusionRequest::test_get_record
tests/test_models.py::TestInclusionRequest::test_create
tests/test_models.py::TestCommunity::test_repr
tests/test_models.py::TestCommunity::test_save_logo
tests/test_models.py::TestCommunity::test_get_by_user
tests/test_models.py::TestCommunity::test_add_record
tests/test_models.py::TestCommunity::test_remove_record
tests/test_models.py::TestCommunity::test_upload_url
tests/test_models.py::TestCommunity::test_oaiset
tests/test_models.py::TestCommunity::test_oaiset_url
tests/test_receivers.py::test_inject_provisional_community
tests/test_receivers.py::test_destroy_oaipmh_set
tests/test_serializers_schema_community.py::test_CommunitySchemaV1
tests/test_tasks.py::test_community_delete_task
tests/test_tasks.py::test_delete_expired_requests
tests/test_utils.py::test_template_formatting_from_string
tests/test_utils.py::test_save_and_validate_logo
tests/test_utils.py::test_initialize_communities_bucket
tests/test_utils.py::test_format_request_email_templ
tests/test_utils.py::test_send_community_request_email
tests/test_utils.py::test_get_user_role_ids
tests/test_utils.py::test_email_formatting
tests/test_views_api.py::TestCommunityDetailsResource::test_get
tests/test_views_api.py::test_dbsession_clean
tests/test_views_ui.py::test_sanitize_html
tests/test_views_ui.py::test_pass_community
tests/test_views_ui.py::test_permission_required
tests/test_views_ui.py::test_format_item
tests/test_views_ui.py::test_mycommunities_ctx
tests/test_views_ui.py::test_view
tests/test_views_ui.py::test_generic_item
tests/test_views_ui.py::test_community_list
tests/test_views_ui.py::test_dbsession_clean
  /code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/flask_celeryext/app.py:36: UserWarning: Celery v4 installed, but detected Celery v3 configuration CELERY_ALWAYS_EAGER (use CELERY_TASK_ALWAYS_EAGER instead).
    UserWarning

tests/test_admin.py::TestCommunityModelView::test_index_view_acl_guest
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[0-403]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[1-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[2-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[3-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[4-403]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[5-403]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[6-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[7-403]
tests/test_admin.py::TestCommunityModelView::test_role_query_cond
tests/test_admin.py::TestCommunityModelView::test_get_query
tests/test_admin.py::TestCommunityModelView::test_get_count_query
tests/test_admin.py::TestCommunityModelView::test_edit
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl_guest
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[0-403]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[1-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[2-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[3-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[4-403]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[5-403]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[6-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[7-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl_guest
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[0-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[1-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[2-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[3-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[4-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[5-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[6-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[7-403]
tests/test_cli.py::test_cli_init
tests/test_cli.py::test_addlogo
tests/test_cli.py::test_request
tests/test_cli.py::test_remove
tests/test_forms.py::test_validate_input_id
tests/test_forms.py::test_CommunityForm
tests/test_invenio_communities.py::test_alembic
tests/test_invenio_communities.py::test_model_init
tests/test_invenio_communities.py::test_email_notification
tests/test_invenio_communities.py::test_model_featured_community
tests/test_invenio_communities.py::test_oaipmh_sets
tests/test_invenio_communities.py::test_communities_rest_all_communities
tests/test_invenio_communities.py::test_community_delete
tests/test_invenio_communities.py::test_communities_rest_all_communities_query_and_sort
tests/test_invenio_communities.py::test_communities_rest_pagination
tests/test_invenio_communities.py::test_communities_rest_get_details
tests/test_invenio_communities.py::test_communities_rest_etag
tests/test_invenio_communities.py::test_add_remove_corner_cases
tests/test_models.py::test_filter_community[<lambda>0]
tests/test_models.py::test_filter_community[<lambda>1]
tests/test_models.py::test_filter_community[<lambda>2]
tests/test_models.py::TestInclusionRequest::test_get_record
tests/test_models.py::TestInclusionRequest::test_create
tests/test_models.py::TestCommunity::test_repr
tests/test_models.py::TestCommunity::test_save_logo
tests/test_models.py::TestCommunity::test_get_by_user
tests/test_models.py::TestCommunity::test_add_record
tests/test_models.py::TestCommunity::test_remove_record
tests/test_models.py::TestCommunity::test_upload_url
tests/test_models.py::TestCommunity::test_oaiset
tests/test_models.py::TestCommunity::test_oaiset_url
tests/test_receivers.py::test_inject_provisional_community
tests/test_receivers.py::test_destroy_oaipmh_set
tests/test_serializers_schema_community.py::test_CommunitySchemaV1
tests/test_tasks.py::test_community_delete_task
tests/test_tasks.py::test_delete_expired_requests
tests/test_utils.py::test_template_formatting_from_string
tests/test_utils.py::test_save_and_validate_logo
tests/test_utils.py::test_initialize_communities_bucket
tests/test_utils.py::test_format_request_email_templ
tests/test_utils.py::test_send_community_request_email
tests/test_utils.py::test_get_user_role_ids
tests/test_utils.py::test_email_formatting
tests/test_views_api.py::TestCommunityDetailsResource::test_get
tests/test_views_api.py::test_dbsession_clean
tests/test_views_ui.py::test_sanitize_html
tests/test_views_ui.py::test_pass_community
tests/test_views_ui.py::test_permission_required
tests/test_views_ui.py::test_format_item
tests/test_views_ui.py::test_mycommunities_ctx
tests/test_views_ui.py::test_view
tests/test_views_ui.py::test_generic_item
tests/test_views_ui.py::test_community_list
tests/test_views_ui.py::test_dbsession_clean
  /code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/flask_celeryext/app.py:36: UserWarning: Celery v4 installed, but detected Celery v3 configuration CELERY_EAGER_PROPAGATES_EXCEPTIONS (use CELERY_TASK_EAGER_PROPAGATES instead).
    UserWarning

tests/test_admin.py::TestCommunityModelView::test_index_view_acl_guest
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[0-403]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[1-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[2-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[3-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[4-403]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[5-403]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[6-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[7-403]
tests/test_admin.py::TestCommunityModelView::test_role_query_cond
tests/test_admin.py::TestCommunityModelView::test_get_query
tests/test_admin.py::TestCommunityModelView::test_get_count_query
tests/test_admin.py::TestCommunityModelView::test_edit
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl_guest
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[0-403]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[1-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[2-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[3-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[4-403]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[5-403]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[6-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[7-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl_guest
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[0-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[1-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[2-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[3-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[4-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[5-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[6-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[7-403]
tests/test_cli.py::test_cli_init
tests/test_cli.py::test_addlogo
tests/test_cli.py::test_request
tests/test_cli.py::test_remove
tests/test_forms.py::test_validate_input_id
tests/test_forms.py::test_CommunityForm
tests/test_invenio_communities.py::test_alembic
tests/test_invenio_communities.py::test_model_init
tests/test_invenio_communities.py::test_email_notification
tests/test_invenio_communities.py::test_model_featured_community
tests/test_invenio_communities.py::test_oaipmh_sets
tests/test_invenio_communities.py::test_communities_rest_all_communities
tests/test_invenio_communities.py::test_community_delete
tests/test_invenio_communities.py::test_communities_rest_all_communities_query_and_sort
tests/test_invenio_communities.py::test_communities_rest_pagination
tests/test_invenio_communities.py::test_communities_rest_get_details
tests/test_invenio_communities.py::test_communities_rest_etag
tests/test_invenio_communities.py::test_add_remove_corner_cases
tests/test_models.py::test_filter_community[<lambda>0]
tests/test_models.py::test_filter_community[<lambda>1]
tests/test_models.py::test_filter_community[<lambda>2]
tests/test_models.py::TestInclusionRequest::test_get_record
tests/test_models.py::TestInclusionRequest::test_create
tests/test_models.py::TestCommunity::test_repr
tests/test_models.py::TestCommunity::test_save_logo
tests/test_models.py::TestCommunity::test_get_by_user
tests/test_models.py::TestCommunity::test_add_record
tests/test_models.py::TestCommunity::test_remove_record
tests/test_models.py::TestCommunity::test_upload_url
tests/test_models.py::TestCommunity::test_oaiset
tests/test_models.py::TestCommunity::test_oaiset_url
tests/test_receivers.py::test_inject_provisional_community
tests/test_receivers.py::test_destroy_oaipmh_set
tests/test_serializers_schema_community.py::test_CommunitySchemaV1
tests/test_tasks.py::test_community_delete_task
tests/test_tasks.py::test_delete_expired_requests
tests/test_utils.py::test_template_formatting_from_string
tests/test_utils.py::test_save_and_validate_logo
tests/test_utils.py::test_initialize_communities_bucket
tests/test_utils.py::test_format_request_email_templ
tests/test_utils.py::test_send_community_request_email
tests/test_utils.py::test_get_user_role_ids
tests/test_utils.py::test_email_formatting
tests/test_views_api.py::TestCommunityDetailsResource::test_get
tests/test_views_api.py::test_dbsession_clean
tests/test_views_ui.py::test_sanitize_html
tests/test_views_ui.py::test_pass_community
tests/test_views_ui.py::test_permission_required
tests/test_views_ui.py::test_format_item
tests/test_views_ui.py::test_mycommunities_ctx
tests/test_views_ui.py::test_view
tests/test_views_ui.py::test_generic_item
tests/test_views_ui.py::test_community_list
tests/test_views_ui.py::test_dbsession_clean
  /code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/flask_caching/__init__.py:241: DeprecationWarning: Using the initialization functions in flask_caching.backend is deprecated.  Use the a full path to backend classes directly.
    category=DeprecationWarning,

tests/test_admin.py::TestCommunityModelView::test_index_view_acl_guest
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[0-403]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[1-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[2-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[3-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[4-403]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[5-403]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[6-200]
tests/test_admin.py::TestCommunityModelView::test_index_view_acl[7-403]
tests/test_admin.py::TestCommunityModelView::test_role_query_cond
tests/test_admin.py::TestCommunityModelView::test_get_query
tests/test_admin.py::TestCommunityModelView::test_get_count_query
tests/test_admin.py::TestCommunityModelView::test_edit
tests/test_cli.py::test_addlogo
tests/test_cli.py::test_request
tests/test_cli.py::test_remove
tests/test_forms.py::test_CommunityForm
tests/test_invenio_communities.py::test_model_init
tests/test_invenio_communities.py::test_email_notification
tests/test_invenio_communities.py::test_model_featured_community
tests/test_invenio_communities.py::test_oaipmh_sets
tests/test_invenio_communities.py::test_communities_rest_all_communities
tests/test_invenio_communities.py::test_community_delete
tests/test_invenio_communities.py::test_communities_rest_all_communities_query_and_sort
tests/test_invenio_communities.py::test_communities_rest_pagination
tests/test_invenio_communities.py::test_communities_rest_get_details
tests/test_invenio_communities.py::test_communities_rest_etag
tests/test_invenio_communities.py::test_add_remove_corner_cases
tests/test_models.py::test_filter_community[<lambda>0]
tests/test_models.py::test_filter_community[<lambda>1]
tests/test_models.py::test_filter_community[<lambda>2]
tests/test_models.py::TestInclusionRequest::test_get_record
tests/test_models.py::TestInclusionRequest::test_create
tests/test_models.py::TestCommunity::test_repr
tests/test_models.py::TestCommunity::test_save_logo
tests/test_models.py::TestCommunity::test_get_by_user
tests/test_models.py::TestCommunity::test_add_record
tests/test_models.py::TestCommunity::test_remove_record
tests/test_models.py::TestCommunity::test_upload_url
tests/test_models.py::TestCommunity::test_oaiset
tests/test_models.py::TestCommunity::test_oaiset_url
tests/test_receivers.py::test_inject_provisional_community
tests/test_receivers.py::test_destroy_oaipmh_set
tests/test_serializers_schema_community.py::test_CommunitySchemaV1
tests/test_tasks.py::test_community_delete_task
tests/test_tasks.py::test_delete_expired_requests
tests/test_utils.py::test_save_and_validate_logo
tests/test_utils.py::test_format_request_email_templ
tests/test_utils.py::test_send_community_request_email
tests/test_utils.py::test_get_user_role_ids
tests/test_utils.py::test_email_formatting
tests/test_views_api.py::TestCommunityDetailsResource::test_get
tests/test_views_api.py::test_dbsession_clean
tests/test_views_ui.py::test_pass_community
tests/test_views_ui.py::test_permission_required
tests/test_views_ui.py::test_mycommunities_ctx
tests/test_views_ui.py::test_view
tests/test_views_ui.py::test_generic_item
tests/test_views_ui.py::test_community_list
tests/test_views_ui.py::test_dbsession_clean
  /code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:2455: SAWarning: Usage of the 'Session.add()' operation is not currently supported within the execution stage of the flush process. Results may not be consistent.  Consider using alternative event listeners or connection-level operations instead.
    "event listeners or connection-level operations instead." % method

tests/test_admin.py::TestCommunityModelView::test_edit
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[0-403]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[1-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[2-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[3-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[4-403]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[5-403]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[6-200]
tests/test_admin.py::TestFeaturedCommunityModelView::test_index_view_acl[7-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[0-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[1-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[2-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[3-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[4-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[5-403]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[6-200]
tests/test_admin.py::TestInclusionRequestModelView::test_index_view_acl[7-403]
tests/test_views_ui.py::test_community_list
  /code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/flask/sessions.py:211: UserWarning: "test_server" is not a valid cookie domain, it must contain a ".". Add an entry to your hosts file, for example "test_server.localdomain", and use that instead.
    ' "{rv}.localdomain", and use that instead.'.format(rv=rv)

tests/test_forms.py::test_validate_input_id
  /code/modules/invenio-communities/tests/test_forms.py:20: FlaskWTFDeprecationWarning: "flask_wtf.Form" has been renamed to "FlaskForm" and will be removed in 1.0.
    form = TestForm()

tests/test_forms.py::test_validate_input_id
  /code/modules/invenio-communities/tests/test_forms.py:29: FlaskWTFDeprecationWarning: "flask_wtf.Form" has been renamed to "FlaskForm" and will be removed in 1.0.
    form = TestForm()

tests/test_forms.py::test_validate_input_id
  /code/modules/invenio-communities/tests/test_forms.py:38: FlaskWTFDeprecationWarning: "flask_wtf.Form" has been renamed to "FlaskForm" and will be removed in 1.0.
    form = TestForm()

tests/test_forms.py::test_validate_input_id
  /code/modules/invenio-communities/tests/test_forms.py:47: FlaskWTFDeprecationWarning: "flask_wtf.Form" has been renamed to "FlaskForm" and will be removed in 1.0.
    form = TestForm()

tests/test_forms.py::test_CommunityForm
  /code/modules/invenio-communities/tests/test_forms.py:74: FlaskWTFDeprecationWarning: "flask_wtf.Form" has been renamed to "FlaskForm" and will be removed in 1.0.
    form = CommunityForm()

tests/test_forms.py::test_CommunityForm
  /code/modules/invenio-communities/tests/test_forms.py:88: FlaskWTFDeprecationWarning: "flask_wtf.Form" has been renamed to "FlaskForm" and will be removed in 1.0.
    form = CommunityForm()

tests/test_invenio_communities.py::test_alembic
  /code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/sqlalchemy/dialects/postgresql/base.py:3258: SAWarning: Predicate of partial index uq_item_type_name_name ignored during reflection
    % idx_name

tests/test_invenio_communities.py::test_oaipmh_sets
  /code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:2455: SAWarning: Usage of the 'Session.delete()' operation is not currently supported within the execution stage of the flush process. Results may not be consistent.  Consider using alternative event listeners or connection-level operations instead.
    "event listeners or connection-level operations instead." % method

tests/test_serializers_response.py::test_format_args
  /code/modules/invenio-communities/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: DeprecationWarning: 'Request.is_xhr' is deprecated as of version 0.13 and will be removed in version 1.0. The 'X-Requested-With' header is not standard and is unreliable. You may be able to use 'accept_mimetypes' instead.
    return getattr(self._get_current_object(), name)

tests/test_views_ui.py::test_community_list
  /code/modules/invenio-communities/invenio_communities/views/ui.py:674: FlaskWTFDeprecationWarning: "flask_wtf.Form" has been renamed to "FlaskForm" and will be removed in 1.0.
    form = SearchForm(p=p)

-- Docs: https://docs.pytest.org/en/latest/warnings.html

---------- coverage: platform linux, python 3.6.15-final-0 -----------
Name                                                                    Stmts   Miss Branch BrPart  Cover
---------------------------------------------------------------------------------------------------------
invenio_communities/__init__.py                                             5      0      0      0   100%
invenio_communities/admin.py                                               87      0     22      0   100%
invenio_communities/alembic/2d9884d0e3fa_create_community_tables.py        16      6      0      0    62%
invenio_communities/alembic/21e13cb1eff2_create_communities_branch.py       9      0      0      0   100%
invenio_communities/bundles.py                                             11      0      0      0   100%
invenio_communities/cli.py                                                 67      3      4      0    96%
invenio_communities/config.py                                              40      0      0      0   100%
invenio_communities/errors.py                                              14      0     12      0   100%
invenio_communities/ext.py                                                 34      0     10      0   100%
invenio_communities/forms.py                                               64      0     16      0   100%
invenio_communities/links.py                                               13      0      4      0   100%
invenio_communities/models.py                                             176      0     46      0   100%
invenio_communities/permissions.py                                         15      0      2      0   100%
invenio_communities/proxies.py                                              5      0      2      0   100%
invenio_communities/receivers.py                                           25      0      8      0   100%
invenio_communities/serializers/__init__.py                                 5      0      0      0   100%
invenio_communities/serializers/response.py                                28      0      8      0   100%
invenio_communities/serializers/schemas/__init__.py                         2      0      0      0   100%
invenio_communities/serializers/schemas/community.py                       33      0      8      0   100%
invenio_communities/signals.py                                              6      0      0      0   100%
invenio_communities/tasks.py                                               12      0      0      0   100%
invenio_communities/utils.py                                               92      0     24      0   100%
invenio_communities/version.py                                              3      0      0      0   100%
invenio_communities/views/__init__.py                                       2      0      0      0   100%
invenio_communities/views/api.py                                           45      2     10      1    95%
invenio_communities/views/ui.py                                            96      2      8      1    97%
---------------------------------------------------------------------------------------------------------
TOTAL                                                                     905     13    184      2    99%
Coverage HTML written to dir htmlcov

============= 22 failed, 67 passed, 343 warnings in 570.39 seconds =============
ERROR: InvocationError for command /code/modules/invenio-communities/.tox/c1/bin/pytest --cov=invenio_communities tests -v -vv -s --cov-branch --cov-report=term --cov-report=html --basetemp=/code/modules/invenio-communities/.tox/c1/tmp (exited with code 1)
___________________________________ summary ____________________________________
ERROR:   c1: commands failed
