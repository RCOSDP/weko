GLOB sdist-make: /code/modules/weko-search-ui/setup.py
c1 inst-nodeps: /code/modules/weko-search-ui/.tox/.tmp/package/1/weko-search-ui-0.1.0.dev20170000.zip
c1 installed: alabaster==0.7.13,alembic==0.9.6,amqp==2.6.1,angular-gettext-babel==0.3,aniso8601==8.0.0,arrow==0.12.1,asn1crypto==0.23.0,attrs==17.4.0,b2handle==1.1.2,Babel==2.5.1,bagit==1.7.0,beautifulsoup4==4.9.3,bibtexparser==1.0.1,billiard==3.6.3.0,binaryornot==0.4.4,bleach==3.1.0,blinker==1.4,boto3==1.7.84,botocore==1.10.84,cachelib==0.1,cachetools==4.2.4,cchardet==2.1.1,celery==4.4.7,certifi==2017.11.5,cffi==1.11.2,chardet==3.0.4,citeproc-py==0.5.1,citeproc-py-styles==0.1.2,click==8.0.4,cookiecutter==1.6.0,counter-robots==2018.6,coverage==6.2,cryptography==2.1.4,datacite==1.0.1,DateTime==4.9,decorator==4.1.2,defusedxml==0.5.0,dictdiffer==0.7.0,dnspython==2.2.1,docutils==0.18.1,dojson==1.3.2,elasticsearch==6.1.1,elasticsearch-dsl==6.4.0,elementpath==1.0.6,email-validator==1.0.5,entrypoints==0.2.3,feedgen==0.7.0,Flask==1.0.4,Flask-Admin==1.5.3,Flask-Alembic==2.0.1,Flask-Assets==0.12,Flask-BabelEx==0.9.4,Flask-Breadcrumbs==0.5.0,Flask-Caching==1.3.3,Flask-CeleryExt==0.3.4,Flask-Collect==1.2.2,Flask-Cors==3.0.3,Flask-DebugToolbar==0.11.0,Flask-IIIF==0.6.1,Flask-KVSession==0.6.2,Flask-Limiter==1.1.0,Flask-Login==0.4.1,Flask-Mail==0.9.1,flask-marshmallow==0.14.0,Flask-Menu==0.6.0,Flask-OAuthlib==0.9.5,Flask-Plugins==1.6.1,Flask-Principal==0.4.0,Flask-RESTful==0.3.8,Flask-Security==3.0.0,flask-shell-ipython==0.4.1,Flask-Sitemap==0.1.0,Flask-SQLAlchemy==2.3.2,flask-talisman==0.4.1,Flask-WTF==0.14.3,-e git+https://github.com/RCOSDP/pyfpdf.git@f9b032148283d535cabc7789858081c80de36fef#egg=fpdf,frozendict==2.3.8,fs==0.5.4,ftfy==4.4.3,future==0.16.0,github3.py==1.1.0,html5lib==1.0.1,idna==2.6,iiif-prezi==0.3.0,imagesize==1.4.1,importlib-metadata==4.8.3,importlib-resources==5.4.0,infinity==1.4,iniconfig==1.1.1,intervals==0.8.0,invenio-access==1.1.0,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_accounts&subdirectory=modules/invenio-accounts,invenio-admin==1.1.2,invenio-app==1.1.0,invenio-assets==1.0.0,invenio-base==1.0.2,invenio-cache==1.0.0,invenio-celery==1.1.3,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_communities&subdirectory=modules/invenio-communities,invenio-config==1.0.0,invenio-csl-rest==1.0.0a1,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_db&subdirectory=modules/invenio-db,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_deposit&subdirectory=modules/invenio-deposit,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_files_rest&subdirectory=modules/invenio-files-rest,invenio-formatter==1.0.0b3,invenio-i18n==1.0.0,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_iiif&subdirectory=modules/invenio-iiif,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_indexer&subdirectory=modules/invenio-indexer,invenio-jsonschemas==1.0.0,invenio-logging==1.0.0b3,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_mail&subdirectory=modules/invenio-mail,invenio-marc21==1.0.0a8,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_oaiharvester&subdirectory=modules/invenio-oaiharvester,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_oaiserver&subdirectory=modules/invenio-oaiserver,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_oauth2server&subdirectory=modules/invenio-oauth2server,invenio-oauthclient==1.0.0,invenio-pidrelations==1.0.0a4,invenio-pidstore==1.0.0,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_previewer&subdirectory=modules/invenio-previewer,invenio-query-parser==0.6.0,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_queues&subdirectory=modules/invenio-queues,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_records&subdirectory=modules/invenio-records,invenio-records-files==1.0.0a10,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_records_rest&subdirectory=modules/invenio-records-rest,invenio-records-ui==1.0.0,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_resourcesyncclient&subdirectory=modules/invenio-resourcesyncclient,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_resourcesyncserver&subdirectory=modules/invenio-resourcesyncserver,invenio-rest==1.1.2,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_s3&subdirectory=modules/invenio-s3,invenio-search==1.1.0,invenio-search-ui==1.0.0a9,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=invenio_stats&subdirectory=modules/invenio-stats,invenio-theme==1.0.0b4,ipaddress==1.0.19,ipython==6.2.1,ipython-genutils==0.2.0,itsdangerous==0.24,jedi==0.11.0,Jinja2==2.10,jinja2-cli==0.6.0,jinja2-time==0.2.0,jmespath==0.10.0,jsmin==2.2.2,jsonpatch==1.21,jsonpath-ng==1.5.2,jsonpointer==1.14,jsonref==0.1,jsonresolver==0.2.1,jsonschema==2.6.0,jupyter-client==5.2.2,jupyter-core==4.4.0,-e git+https://github.com/RCOSDP/kombu.git@f204fdf078d5e94393c86693f545e2d011f620f5#egg=kombu,limits==1.2.1,lxml==4.1.1,Mako==1.0.7,MarkupSafe==1.1.1,marshmallow==2.20.1,marshmallow-sqlalchemy==0.23.1,maxminddb==1.5.2,maxminddb-geolite2==2017.803,mistune==0.8.3,mock==3.0.5,more-itertools==8.10.0,msgpack==0.6.2,nbconvert==5.3.1,nbformat==4.4.0,netaddr==0.8.0,node-semver==0.1.1,numpy==1.16.1,oauthlib==2.1.0,ordereddict==1.1,packaging==21.3,pandocfilters==1.4.2,parso==0.1.0,passlib==1.7.1,pexpect==4.3.0,pickleshare==0.7.4,Pillow==5.4.1,pluggy==0.13.1,ply==3.11,poyo==0.4.1,prompt-toolkit==1.0.15,psycopg2==2.7.3.2,ptyprocess==0.5.2,py==1.11.0,pycparser==2.18,Pygments==2.2.0,PyJWT==1.5.3,PyLD==2.0.3,pyparsing==3.1.0,-e git+https://github.com/RCOSDP/PyPDF2.git@fefc684a3a74aff6f99e5dff24f9b4dd1c95169d#egg=PyPDF2,pyPEG2==2.15.2,pytest==6.1.2,pytest-cov==4.0.0,pytest-mock==3.6.1,python-dateutil==2.6.1,python-editor==1.0.3,python-geoip==1.2,pytz==2017.3,pyzmq==17.0.0,redis==2.10.6,requests==2.18.4,requests-oauthlib==1.1.0,resync==1.0.9,s3fs==0.1.6,s3transfer==0.1.13,Sickle==0.6.4,simplegeneric==0.8.1,simplejson==3.12.0,simplekv==0.11.2,six==1.12.0,snowballstemmer==2.2.0,soupsieve==2.3.2.post1,speaklater==1.3,Sphinx==1.8.4,sphinxcontrib-serializinghtml==1.1.5,sphinxcontrib-websupport==1.2.4,SQLAlchemy==1.2.19,SQLAlchemy-Continuum==1.3.6,SQLAlchemy-Utils==0.35.0,testpath==0.3.1,toml==0.10.2,tomli==1.2.3,tornado==4.5.3,traitlets==4.3.2,typing_extensions==4.1.1,ua-parser==0.7.3,uritemplate==4.1.1,uritools==2.1.0,urllib3==1.22,validators==0.12.0,vine==1.3.0,Wand==0.6.1,wcwidth==0.1.7,webargs==5.5.2,webassets==0.12.1,webencodings==0.5.1,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_accounts&subdirectory=modules/weko-accounts,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_admin&subdirectory=modules/weko-admin,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_authors&subdirectory=modules/weko-authors,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_bulkupdate&subdirectory=modules/weko-bulkupdate,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_deposit&subdirectory=modules/weko-deposit,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_gridlayout&subdirectory=modules/weko-gridlayout,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_groups&subdirectory=modules/weko-groups,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_handle&subdirectory=modules/weko-handle,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_index_tree&subdirectory=modules/weko-index-tree,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_indextree_journal&subdirectory=modules/weko-indextree-journal,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_items_autofill&subdirectory=modules/weko-items-autofill,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_items_ui&subdirectory=modules/weko-items-ui,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_itemtypes_ui&subdirectory=modules/weko-itemtypes-ui,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_logging&subdirectory=modules/weko-logging,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_records&subdirectory=modules/weko-records,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_records_ui&subdirectory=modules/weko-records-ui,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_redis&subdirectory=modules/weko-redis,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_schema_ui&subdirectory=modules/weko-schema-ui,weko-search-ui @ file:///code/modules/weko-search-ui/.tox/.tmp/package/1/weko-search-ui-0.1.0.dev20170000.zip,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_sitemap&subdirectory=modules/weko-sitemap,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_theme&subdirectory=modules/weko-theme,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_user_profiles&subdirectory=modules/weko-user-profiles,-e git+https://mhaya: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@github.com/RCOSDP/weko.git@1ea2ab266aece30a5e18ebcb3c03bc86ad2c2d60#egg=weko_workflow&subdirectory=modules/weko-workflow,Werkzeug==0.15.2,whichcraft==0.4.1,WTForms==2.1,WTForms-Alchemy==0.16.5,WTForms-Components==0.10.3,xmlschema==0.9.30,xmltodict==0.12.0,zipp==3.6.0,zope.interface==5.5.2
c1 run-test-pre: PYTHONHASHSEED='2763082693'
c1 run-test: commands[0] | pytest --cov=weko_search_ui tests -v --cov-branch --cov-report=term --cov-report=xml --cov-report=html --cov-config=tox.ini --basetemp=/code/modules/weko-search-ui/.tox/c1/tmp
============================= test session starts ==============================
platform linux -- Python 3.6.15, pytest-6.1.2, py-1.11.0, pluggy-0.13.1 -- /code/modules/weko-search-ui/.tox/c1/bin/python
cachedir: .tox/c1/.pytest_cache
rootdir: /code/modules/weko-search-ui
plugins: celery-4.4.7, mock-3.6.1, cov-4.0.0
collecting ... collected 376 items

tests/test_admin.py::test_ItemManagementBulkDelete_index PASSED          [  0%]
tests/test_admin.py::test_ItemManagementBulkDelete_check PASSED          [  0%]
tests/test_admin.py::TestItemManagementCustomSort::test_index_acl PASSED [  0%]
tests/test_admin.py::test_ItemManagementCustomSort_save_sort PASSED      [  1%]
tests/test_admin.py::TestItemManagementBulkSearch::test_index_acl FAILED [  1%]
tests/test_admin.py::test_ItemManagementBulkSearch_is_visible PASSED     [  1%]
tests/test_admin.py::TestItemImportView::test_index_acl PASSED           [  1%]
tests/test_admin.py::test_ItemImportView_check FAILED                    [  2%]
tests/test_admin.py::test_ItemImportView_get_check_status PASSED         [  2%]
tests/test_admin.py::test_ItemImportView_download_check PASSED           [  2%]
tests/test_admin.py::test_ItemImportView_import_items PASSED             [  2%]
tests/test_admin.py::test_ItemImportView_get_status PASSED               [  3%]
tests/test_admin.py::test_ItemImportView_download_import PASSED          [  3%]
tests/test_admin.py::test_ItemImportView_get_disclaimer_text PASSED      [  3%]
tests/test_admin.py::test_ItemImportView_export_template PASSED          [  3%]
tests/test_admin.py::test_ItemBulkExport_index PASSED                    [  4%]
tests/test_admin.py::TestItemBulkExport::test_check_export_status FAILED [  4%]
tests/test_admin.py::TestItemBulkExport::test_cancel_export PASSED       [  4%]
tests/test_admin.py::test_export_template PASSED                         [  5%]
tests/test_api.py::test_get_results_setting PASSED                       [  5%]
tests/test_api.py::test_get_default_sort PASSED                          [  5%]
tests/test_api.py::test_get_sort_key PASSED                              [  5%]
tests/test_api.py::test_get_custom_sort PASSED                           [  6%]
tests/test_api.py::test_get_nested_sorting PASSED                        [  6%]
tests/test_api.py::test_get_search_detail_keyword PASSED                 [  6%]
tests/test_api.py::test_get_childinfo PASSED                             [  6%]
tests/test_api.py::test_escape_str PASSED                                [  7%]
tests/test_bundles.py::test_catalog PASSED                               [  7%]
tests/test_ext.py::test_WekoSearchUI PASSED                              [  7%]
tests/test_ext.py::test_WekoSearchUI_2 PASSED                            [  7%]
tests/test_ext.py::test_WekoSearchREST PASSED                            [  8%]
tests/test_links.py::test_default_links_factory PASSED                   [  8%]
tests/test_query.py::test_get_item_type_aggs PASSED                      [  8%]
tests/test_query.py::test_get_permission_filter FAILED                   [  9%]
tests/test_query.py::test_default_search_factory PASSED                  [  9%]
tests/test_query.py::test_item_path_search_factory PASSED                [  9%]
tests/test_query.py::test_check_permission_user PASSED                   [  9%]
tests/test_query.py::test_opensearch_factory PASSED                      [ 10%]
tests/test_query.py::test_item_search_factory PASSED                     [ 10%]
tests/test_query.py::test_feedback_email_search_factory PASSED           [ 10%]
tests/test_query.py::test_function_issue35902 FAILED                     [ 10%]
tests/test_rest.py::test_IndexSearchResource_get_Exception FAILED        [ 11%]
tests/test_rest.py::test_IndexSearchResource_get_MaxResultWindowRESTError PASSED [ 11%]
tests/test_rest.py::test_create_blueprint PASSED                         [ 11%]
tests/test_rest.py::test_IndexSearchResource_get PASSED                  [ 11%]
tests/test_rest.py::test_get_heading_info PASSED                         [ 12%]
tests/test_tasks.py::test_check_import_items_task PASSED                 [ 12%]
tests/test_tasks.py::test_import_item PASSED                             [ 12%]
tests/test_tasks.py::test_remove_temp_dir_task PASSED                    [ 13%]
tests/test_tasks.py::test_delete_task_id_cache PASSED                    [ 13%]
tests/test_tasks.py::test_export_all_task PASSED                         [ 13%]
tests/test_tasks.py::test_delete_exported_task PASSED                    [ 13%]
tests/test_tasks.py::test_is_import_running PASSED                       [ 14%]
tests/test_tasks.py::test_check_celery_is_run PASSED                     [ 14%]
tests/test_utils.py::test_DefaultOrderDict_deepcopy PASSED               [ 14%]
tests/test_utils.py::test_get_tree_items PASSED                          [ 14%]
tests/test_utils.py::test_delete_records FAILED                          [ 15%]
tests/test_utils.py::test_get_journal_info PASSED                        [ 15%]
tests/test_utils.py::test_get_feedback_mail_list FAILED                  [ 15%]
tests/test_utils.py::test_check_permission PASSED                        [ 15%]
tests/test_utils.py::test_get_content_workflow PASSED                    [ 16%]
tests/test_utils.py::test_set_nested_item PASSED                         [ 16%]
tests/test_utils.py::test_define_default_dict PASSED                     [ 16%]
tests/test_utils.py::test_defaultify PASSED                              [ 17%]
tests/test_utils.py::test_handle_generate_key_path PASSED                [ 17%]
tests/test_utils.py::test_parse_to_json_form PASSED                      [ 17%]
tests/test_utils.py::test_check_import_items PASSED                      [ 17%]
tests/test_utils.py::test_unpackage_import_file FAILED                   [ 18%]
tests/test_utils.py::test_getEncode PASSED                               [ 18%]
tests/test_utils.py::test_read_stats_file FAILED                         [ 18%]
tests/test_utils.py::test_handle_convert_validate_msg_to_jp PASSED       [ 18%]
tests/test_utils.py::test_handle_validate_item_import PASSED             [ 19%]
tests/test_utils.py::test_represents_int PASSED                          [ 19%]
tests/test_utils.py::test_get_item_type PASSED                           [ 19%]
tests/test_utils.py::test_handle_check_exist_record PASSED               [ 19%]
tests/test_utils.py::test_make_file_by_line PASSED                       [ 20%]
tests/test_utils.py::test_make_stats_file PASSED                         [ 20%]
tests/test_utils.py::test_create_deposit PASSED                          [ 20%]
tests/test_utils.py::test_clean_thumbnail_file PASSED                    [ 21%]
tests/test_utils.py::test_up_load_file PASSED                            [ 21%]
tests/test_utils.py::test_get_file_name PASSED                           [ 21%]
tests/test_utils.py::test_register_item_metadata FAILED                  [ 21%]
tests/test_utils.py::test_update_publish_status PASSED                   [ 22%]
tests/test_utils.py::test_handle_workflow PASSED                         [ 22%]
tests/test_utils.py::test_create_work_flow PASSED                        [ 22%]
tests/test_utils.py::test_create_flow_define PASSED                      [ 22%]
tests/test_utils.py::test_send_item_created_event_to_es FAILED           [ 23%]
tests/test_utils.py::test_import_items_to_system FAILED                  [ 23%]
tests/test_utils.py::test_handle_item_title PASSED                       [ 23%]
tests/test_utils.py::test_handle_check_and_prepare_publish_status PASSED [ 23%]
tests/test_utils.py::test_handle_check_and_prepare_index_tree FAILED     [ 24%]
tests/test_utils.py::test_handle_check_and_prepare_feedback_mail FAILED  [ 24%]
tests/test_utils.py::test_handle_set_change_identifier_flag PASSED       [ 24%]
tests/test_utils.py::test_handle_check_cnri FAILED                       [ 25%]
tests/test_utils.py::test_handle_check_cnri_2 PASSED                     [ 25%]
tests/test_utils.py::test_handle_check_doi_indexes PASSED                [ 25%]
tests/test_utils.py::test_handle_check_doi_ra PASSED                     [ 25%]
tests/test_utils.py::test_handle_check_doi FAILED                        [ 26%]
tests/test_utils.py::test_register_item_handle PASSED                    [ 26%]
tests/test_utils.py::test_prepare_doi_setting PASSED                     [ 26%]
tests/test_utils.py::test_get_doi_prefix[JaLC] PASSED                    [ 26%]
tests/test_utils.py::test_get_doi_prefix[Crossref] PASSED                [ 27%]
tests/test_utils.py::test_get_doi_prefix[DataCite] PASSED                [ 27%]
tests/test_utils.py::test_get_doi_prefix[NDL JaLC] PASSED                [ 27%]
tests/test_utils.py::test_get_doi_link PASSED                            [ 27%]
tests/test_utils.py::test_prepare_doi_link PASSED                        [ 28%]
tests/test_utils.py::test_register_item_doi PASSED                       [ 28%]
tests/test_utils.py::test_register_item_update_publish_status PASSED     [ 28%]
tests/test_utils.py::test_handle_doi_required_check ERROR                [ 28%]
tests/test_utils.py::test_handle_check_date PASSED                       [ 29%]
tests/test_utils.py::test_handle_check_id PASSED                         [ 29%]
tests/test_utils.py::test_get_data_in_deep_dict PASSED                   [ 29%]
tests/test_utils.py::test_validation_file_open_date PASSED               [ 30%]
tests/test_utils.py::test_validation_date_property PASSED                [ 30%]
tests/test_utils.py::test_get_list_key_of_iso_date PASSED                [ 30%]
tests/test_utils.py::test_get_current_language PASSED                    [ 30%]
tests/test_utils.py::test_get_change_identifier_mode_content PASSED      [ 31%]
tests/test_utils.py::test_get_root_item_option PASSED                    [ 31%]
tests/test_utils.py::test_get_sub_item_option PASSED                     [ 31%]
tests/test_utils.py::test_check_sub_item_is_system PASSED                [ 31%]
tests/test_utils.py::test_get_lifetime PASSED                            [ 32%]
tests/test_utils.py::test_get_system_data_uri PASSED                     [ 32%]
tests/test_utils.py::test_handle_fill_system_item FAILED                 [ 32%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi0-after_doi0-warnings0-errors0-False-False] PASSED [ 32%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi1-after_doi1-warnings1-errors1-False-False] PASSED [ 33%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi2-after_doi2-warnings2-errors2-False-False] PASSED [ 33%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi3-after_doi3-warnings3-errors3-False-False] PASSED [ 33%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi4-after_doi4-warnings4-errors4-False-False] PASSED [ 34%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi5-after_doi5-warnings5-errors5-False-False] PASSED [ 34%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi6-after_doi6-warnings6-errors6-False-False] PASSED [ 34%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi7-after_doi7-warnings7-errors7-False-False] PASSED [ 34%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi8-after_doi8-warnings8-errors8-False-False] PASSED [ 35%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi9-after_doi9-warnings9-errors9-False-False] PASSED [ 35%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi10-after_doi10-warnings10-errors10-False-False] PASSED [ 35%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi11-after_doi11-warnings11-errors11-False-False] PASSED [ 35%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi12-after_doi12-warnings12-errors12-False-False] PASSED [ 36%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi13-after_doi13-warnings13-errors13-False-False] PASSED [ 36%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi14-after_doi14-warnings14-errors14-False-False] PASSED [ 36%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi15-after_doi15-warnings15-errors15-False-False] PASSED [ 36%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi16-after_doi16-warnings16-errors16-False-False] PASSED [ 37%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi17-after_doi17-warnings17-errors17-True-False] PASSED [ 37%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi18-after_doi18-warnings18-errors18-True-False] PASSED [ 37%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi19-after_doi19-warnings19-errors19-True-False] PASSED [ 38%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi20-after_doi20-warnings20-errors20-True-False] PASSED [ 38%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi21-after_doi21-warnings21-errors21-True-False] PASSED [ 38%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi22-after_doi22-warnings22-errors22-True-False] PASSED [ 38%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi23-after_doi23-warnings23-errors23-True-False] PASSED [ 39%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi24-after_doi24-warnings24-errors24-True-False] PASSED [ 39%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi25-after_doi25-warnings25-errors25-True-False] PASSED [ 39%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi26-after_doi26-warnings26-errors26-True-False] PASSED [ 39%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi27-after_doi27-warnings27-errors27-True-False] PASSED [ 40%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi28-after_doi28-warnings28-errors28-True-False] PASSED [ 40%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi29-after_doi29-warnings29-errors29-True-False] PASSED [ 40%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi30-after_doi30-warnings30-errors30-True-False] PASSED [ 40%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi31-after_doi31-warnings31-errors31-True-False] PASSED [ 41%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi32-after_doi32-warnings32-errors32-True-False] PASSED [ 41%]
tests/test_utils.py::test_handle_fill_system_item3[1-before_doi33-after_doi33-warnings33-errors33-True-False] PASSED [ 41%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi34-after_doi34-warnings34-errors34-False-False] PASSED [ 42%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi35-after_doi35-warnings35-errors35-False-False] PASSED [ 42%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi36-after_doi36-warnings36-errors36-False-False] PASSED [ 42%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi37-after_doi37-warnings37-errors37-False-False] PASSED [ 42%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi38-after_doi38-warnings38-errors38-False-False] PASSED [ 43%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi39-after_doi39-warnings39-errors39-False-False] PASSED [ 43%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi40-after_doi40-warnings40-errors40-False-False] PASSED [ 43%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi41-after_doi41-warnings41-errors41-False-False] PASSED [ 43%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi42-after_doi42-warnings42-errors42-False-False] PASSED [ 44%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi43-after_doi43-warnings43-errors43-False-False] PASSED [ 44%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi44-after_doi44-warnings44-errors44-False-False] PASSED [ 44%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi45-after_doi45-warnings45-errors45-False-False] PASSED [ 44%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi46-after_doi46-warnings46-errors46-False-False] PASSED [ 45%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi47-after_doi47-warnings47-errors47-False-False] PASSED [ 45%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi48-after_doi48-warnings48-errors48-False-False] PASSED [ 45%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi49-after_doi49-warnings49-errors49-False-False] PASSED [ 46%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi50-after_doi50-warnings50-errors50-False-False] PASSED [ 46%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi51-after_doi51-warnings51-errors51-True-False] PASSED [ 46%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi52-after_doi52-warnings52-errors52-True-False] PASSED [ 46%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi53-after_doi53-warnings53-errors53-True-False] PASSED [ 47%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi54-after_doi54-warnings54-errors54-True-False] PASSED [ 47%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi55-after_doi55-warnings55-errors55-True-False] PASSED [ 47%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi56-after_doi56-warnings56-errors56-True-False] PASSED [ 47%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi57-after_doi57-warnings57-errors57-True-False] PASSED [ 48%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi58-after_doi58-warnings58-errors58-True-False] PASSED [ 48%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi59-after_doi59-warnings59-errors59-True-False] PASSED [ 48%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi60-after_doi60-warnings60-errors60-True-False] PASSED [ 48%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi61-after_doi61-warnings61-errors61-True-False] PASSED [ 49%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi62-after_doi62-warnings62-errors62-True-False] PASSED [ 49%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi63-after_doi63-warnings63-errors63-True-False] PASSED [ 49%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi64-after_doi64-warnings64-errors64-True-False] PASSED [ 50%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi65-after_doi65-warnings65-errors65-True-False] PASSED [ 50%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi66-after_doi66-warnings66-errors66-True-False] PASSED [ 50%]
tests/test_utils.py::test_handle_fill_system_item3[2-before_doi67-after_doi67-warnings67-errors67-True-False] PASSED [ 50%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi68-after_doi68-warnings68-errors68-False-False] PASSED [ 51%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi69-after_doi69-warnings69-errors69-False-False] PASSED [ 51%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi70-after_doi70-warnings70-errors70-False-False] PASSED [ 51%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi71-after_doi71-warnings71-errors71-False-False] PASSED [ 51%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi72-after_doi72-warnings72-errors72-False-False] PASSED [ 52%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi73-after_doi73-warnings73-errors73-False-False] PASSED [ 52%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi74-after_doi74-warnings74-errors74-False-False] PASSED [ 52%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi75-after_doi75-warnings75-errors75-False-False] PASSED [ 52%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi76-after_doi76-warnings76-errors76-False-False] PASSED [ 53%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi77-after_doi77-warnings77-errors77-False-False] PASSED [ 53%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi78-after_doi78-warnings78-errors78-False-False] PASSED [ 53%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi79-after_doi79-warnings79-errors79-False-False] PASSED [ 53%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi80-after_doi80-warnings80-errors80-False-False] PASSED [ 54%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi81-after_doi81-warnings81-errors81-False-False] PASSED [ 54%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi82-after_doi82-warnings82-errors82-False-False] PASSED [ 54%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi83-after_doi83-warnings83-errors83-False-False] PASSED [ 55%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi84-after_doi84-warnings84-errors84-False-False] PASSED [ 55%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi85-after_doi85-warnings85-errors85-True-False] PASSED [ 55%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi86-after_doi86-warnings86-errors86-True-False] PASSED [ 55%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi87-after_doi87-warnings87-errors87-True-False] PASSED [ 56%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi88-after_doi88-warnings88-errors88-True-False] PASSED [ 56%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi89-after_doi89-warnings89-errors89-True-False] PASSED [ 56%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi90-after_doi90-warnings90-errors90-True-False] PASSED [ 56%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi91-after_doi91-warnings91-errors91-True-False] PASSED [ 57%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi92-after_doi92-warnings92-errors92-True-False] PASSED [ 57%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi93-after_doi93-warnings93-errors93-True-False] PASSED [ 57%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi94-after_doi94-warnings94-errors94-True-False] PASSED [ 57%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi95-after_doi95-warnings95-errors95-True-False] PASSED [ 58%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi96-after_doi96-warnings96-errors96-True-False] PASSED [ 58%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi97-after_doi97-warnings97-errors97-True-False] PASSED [ 58%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi98-after_doi98-warnings98-errors98-True-False] PASSED [ 59%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi99-after_doi99-warnings99-errors99-True-False] PASSED [ 59%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi100-after_doi100-warnings100-errors100-True-False] PASSED [ 59%]
tests/test_utils.py::test_handle_fill_system_item3[3-before_doi101-after_doi101-warnings101-errors101-True-False] PASSED [ 59%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi102-after_doi102-warnings102-errors102-False-False] PASSED [ 60%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi103-after_doi103-warnings103-errors103-False-False] PASSED [ 60%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi104-after_doi104-warnings104-errors104-False-False] PASSED [ 60%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi105-after_doi105-warnings105-errors105-False-False] PASSED [ 60%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi106-after_doi106-warnings106-errors106-False-False] PASSED [ 61%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi107-after_doi107-warnings107-errors107-False-False] PASSED [ 61%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi108-after_doi108-warnings108-errors108-False-False] PASSED [ 61%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi109-after_doi109-warnings109-errors109-False-False] PASSED [ 61%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi110-after_doi110-warnings110-errors110-False-False] PASSED [ 62%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi111-after_doi111-warnings111-errors111-False-False] PASSED [ 62%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi112-after_doi112-warnings112-errors112-False-False] PASSED [ 62%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi113-after_doi113-warnings113-errors113-False-False] PASSED [ 63%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi114-after_doi114-warnings114-errors114-False-False] PASSED [ 63%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi115-after_doi115-warnings115-errors115-False-False] PASSED [ 63%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi116-after_doi116-warnings116-errors116-False-False] PASSED [ 63%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi117-after_doi117-warnings117-errors117-False-False] PASSED [ 64%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi118-after_doi118-warnings118-errors118-False-False] PASSED [ 64%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi119-after_doi119-warnings119-errors119-True-False] PASSED [ 64%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi120-after_doi120-warnings120-errors120-True-False] PASSED [ 64%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi121-after_doi121-warnings121-errors121-True-False] PASSED [ 65%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi122-after_doi122-warnings122-errors122-True-False] PASSED [ 65%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi123-after_doi123-warnings123-errors123-True-False] PASSED [ 65%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi124-after_doi124-warnings124-errors124-True-False] PASSED [ 65%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi125-after_doi125-warnings125-errors125-True-False] PASSED [ 66%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi126-after_doi126-warnings126-errors126-True-False] PASSED [ 66%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi127-after_doi127-warnings127-errors127-True-False] PASSED [ 66%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi128-after_doi128-warnings128-errors128-True-False] PASSED [ 67%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi129-after_doi129-warnings129-errors129-True-False] PASSED [ 67%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi130-after_doi130-warnings130-errors130-True-False] PASSED [ 67%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi131-after_doi131-warnings131-errors131-True-False] PASSED [ 67%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi132-after_doi132-warnings132-errors132-True-False] PASSED [ 68%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi133-after_doi133-warnings133-errors133-True-False] PASSED [ 68%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi134-after_doi134-warnings134-errors134-True-False] PASSED [ 68%]
tests/test_utils.py::test_handle_fill_system_item3[4-before_doi135-after_doi135-warnings135-errors135-True-False] PASSED [ 68%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi136-after_doi136-warnings136-errors136-False-False] PASSED [ 69%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi137-after_doi137-warnings137-errors137-False-False] PASSED [ 69%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi138-after_doi138-warnings138-errors138-False-False] PASSED [ 69%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi139-after_doi139-warnings139-errors139-False-False] PASSED [ 69%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi140-after_doi140-warnings140-errors140-False-False] PASSED [ 70%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi141-after_doi141-warnings141-errors141-False-False] PASSED [ 70%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi142-after_doi142-warnings142-errors142-False-False] PASSED [ 70%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi143-after_doi143-warnings143-errors143-False-False] PASSED [ 71%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi144-after_doi144-warnings144-errors144-False-False] PASSED [ 71%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi145-after_doi145-warnings145-errors145-False-False] PASSED [ 71%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi146-after_doi146-warnings146-errors146-False-False] PASSED [ 71%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi147-after_doi147-warnings147-errors147-False-False] PASSED [ 72%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi148-after_doi148-warnings148-errors148-False-False] PASSED [ 72%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi149-after_doi149-warnings149-errors149-False-False] PASSED [ 72%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi150-after_doi150-warnings150-errors150-False-False] PASSED [ 72%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi151-after_doi151-warnings151-errors151-False-False] PASSED [ 73%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi152-after_doi152-warnings152-errors152-False-False] PASSED [ 73%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi153-after_doi153-warnings153-errors153-False-False] PASSED [ 73%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi154-after_doi154-warnings154-errors154-False-False] PASSED [ 73%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi155-after_doi155-warnings155-errors155-False-False] PASSED [ 74%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi156-after_doi156-warnings156-errors156-False-False] PASSED [ 74%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi157-after_doi157-warnings157-errors157-False-False] PASSED [ 74%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi158-after_doi158-warnings158-errors158-False-False] PASSED [ 75%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi159-after_doi159-warnings159-errors159-True-False] PASSED [ 75%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi160-after_doi160-warnings160-errors160-True-False] PASSED [ 75%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi161-after_doi161-warnings161-errors161-True-False] PASSED [ 75%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi162-after_doi162-warnings162-errors162-True-False] PASSED [ 76%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi163-after_doi163-warnings163-errors163-True-False] PASSED [ 76%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi164-after_doi164-warnings164-errors164-True-False] PASSED [ 76%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi165-after_doi165-warnings165-errors165-True-False] PASSED [ 76%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi166-after_doi166-warnings166-errors166-True-False] PASSED [ 77%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi167-after_doi167-warnings167-errors167-True-False] PASSED [ 77%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi168-after_doi168-warnings168-errors168-True-False] PASSED [ 77%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi169-after_doi169-warnings169-errors169-True-False] PASSED [ 77%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi170-after_doi170-warnings170-errors170-True-False] PASSED [ 78%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi171-after_doi171-warnings171-errors171-True-False] PASSED [ 78%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi172-after_doi172-warnings172-errors172-True-False] PASSED [ 78%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi173-after_doi173-warnings173-errors173-True-False] PASSED [ 78%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi174-after_doi174-warnings174-errors174-True-False] PASSED [ 79%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi175-after_doi175-warnings175-errors175-True-False] PASSED [ 79%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi176-after_doi176-warnings176-errors176-True-False] PASSED [ 79%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi177-after_doi177-warnings177-errors177-True-False] PASSED [ 80%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi178-after_doi178-warnings178-errors178-True-False] PASSED [ 80%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi179-after_doi179-warnings179-errors179-True-False] PASSED [ 80%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi180-after_doi180-warnings180-errors180-True-False] PASSED [ 80%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi181-after_doi181-warnings181-errors181-True-False] PASSED [ 81%]
tests/test_utils.py::test_handle_fill_system_item3[5-before_doi182-after_doi182-warnings182-errors182-True-False] PASSED [ 81%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi183-after_doi183-warnings183-errors183-False-False] PASSED [ 81%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi184-after_doi184-warnings184-errors184-False-False] PASSED [ 81%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi185-after_doi185-warnings185-errors185-False-False] PASSED [ 82%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi186-after_doi186-warnings186-errors186-False-False] PASSED [ 82%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi187-after_doi187-warnings187-errors187-False-False] PASSED [ 82%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi188-after_doi188-warnings188-errors188-False-False] PASSED [ 82%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi189-after_doi189-warnings189-errors189-False-False] PASSED [ 83%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi190-after_doi190-warnings190-errors190-False-False] PASSED [ 83%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi191-after_doi191-warnings191-errors191-True-False] PASSED [ 83%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi192-after_doi192-warnings192-errors192-True-False] PASSED [ 84%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi193-after_doi193-warnings193-errors193-True-False] PASSED [ 84%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi194-after_doi194-warnings194-errors194-True-False] PASSED [ 84%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi195-after_doi195-warnings195-errors195-True-False] PASSED [ 84%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi196-after_doi196-warnings196-errors196-True-False] PASSED [ 85%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi197-after_doi197-warnings197-errors197-True-False] PASSED [ 85%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi198-after_doi198-warnings198-errors198-True-False] PASSED [ 85%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi199-after_doi199-warnings199-errors199-True-True] PASSED [ 85%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi200-after_doi200-warnings200-errors200-True-True] PASSED [ 86%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi201-after_doi201-warnings201-errors201-True-True] PASSED [ 86%]
tests/test_utils.py::test_handle_fill_system_item3[None-before_doi202-after_doi202-warnings202-errors202-True-True] PASSED [ 86%]
tests/test_utils.py::test_get_thumbnail_key PASSED                       [ 86%]
tests/test_utils.py::test_handle_check_thumbnail_file_type PASSED        [ 87%]
tests/test_utils.py::test_handle_check_metadata_not_existed PASSED       [ 87%]
tests/test_utils.py::test_handle_get_all_sub_id_and_name[items0-.metadata.item_1657196790737[0]-text[0]-form0-ids0-names0] PASSED [ 87%]
tests/test_utils.py::test_handle_get_all_sub_id_and_name[items1-.metadata.item_1657204077414[0]-list[0]-form1-ids1-names1] PASSED [ 88%]
tests/test_utils.py::test_handle_get_all_sub_id_and_name[items2-.metadata.item_1657204070640-list-form2-ids2-names2] PASSED [ 88%]
tests/test_utils.py::test_handle_get_all_sub_id_and_name[items3-.metadata.item_1657204026946-check-form3-ids3-names3] PASSED [ 88%]
tests/test_utils.py::test_handle_get_all_sub_id_and_name[items4-.metadata.item_1657204036771[0]-check[0]-form4-ids4-names4] PASSED [ 88%]
tests/test_utils.py::test_handle_get_all_sub_id_and_name[items5-.metadata.item_1657204043063-rad-form5-ids5-names5] PASSED [ 89%]
tests/test_utils.py::test_handle_get_all_sub_id_and_name[items6-.metadata.item_1657204049138[0]-rd[0]-form6-ids6-names6] PASSED [ 89%]
tests/test_utils.py::test_handle_get_all_id_in_item_type PASSED          [ 89%]
tests/test_utils.py::test_handle_check_consistence_with_mapping PASSED   [ 89%]
tests/test_utils.py::test_handle_check_duplication_item_id PASSED        [ 90%]
tests/test_utils.py::test_export_all ERROR                               [ 90%]
tests/test_utils.py::test_delete_exported PASSED                         [ 90%]
tests/test_utils.py::test_cancel_export_all PASSED                       [ 90%]
tests/test_utils.py::test_get_export_status PASSED                       [ 91%]
tests/test_utils.py::test_handle_check_item_is_locked PASSED             [ 91%]
tests/test_utils.py::test_handle_remove_es_metadata PASSED               [ 91%]
tests/test_utils.py::test_check_index_access_permissions PASSED          [ 92%]
tests/test_utils.py::test_handle_check_file_metadata PASSED              [ 92%]
tests/test_utils.py::test_handle_check_file_path PASSED                  [ 92%]
tests/test_utils.py::test_handle_check_file_content PASSED               [ 92%]
tests/test_utils.py::test_handle_check_thumbnail PASSED                  [ 93%]
tests/test_utils.py::test_get_key_by_property PASSED                     [ 93%]
tests/test_utils.py::test_get_data_by_property PASSED                    [ 93%]
tests/test_utils.py::test_get_filenames_from_metadata PASSED             [ 93%]
tests/test_utils.py::test_handle_check_filename_consistence PASSED       [ 94%]
tests/test_utils.py::test_function_issue34520[1-before_doi0-after_doi0-warnings0-errors0-True] PASSED [ 94%]
tests/test_utils.py::test_function_issue34535 FAILED                     [ 94%]
tests/test_utils.py::test_function_issue34958 PASSED                     [ 94%]
tests/test_utils.py::test_handle_fill_system_item_issue34520[1-before_doi0-after_doi0-warnings0-errors0-True] PASSED [ 95%]
tests/test_utils.py::test_handle_fill_system_item_issue34520[1000-before_doi1-after_doi1-warnings1-errors1-True] PASSED [ 95%]
tests/test_utils.py::test_handle_check_exist_record_issue35315[1-http://TEST_SERVER/records/1-warnings0-errors0-keep] PASSED [ 95%]
tests/test_utils.py::test_handle_check_exist_record_issue35315[1000-http://TEST_SERVER/records/1-warnings1-errors1-None] PASSED [ 96%]
tests/test_utils.py::test_handle_check_exist_record_issue35315[1000-http://TEST_SERVER/records/1000-warnings2-errors2-None] PASSED [ 96%]
tests/test_utils.py::test_handle_check_exist_record_issue35315[None-None-warnings3-errors3-new] PASSED [ 96%]
tests/test_views.py::test_search PASSED                                  [ 96%]
tests/test_views.py::test_search_acl_guest PASSED                        [ 97%]
tests/test_views.py::test_search_acl[3-200] FAILED                       [ 97%]
tests/test_views.py::test_opensearch_description PASSED                  [ 97%]
tests/test_views.py::test_opensearch_description_acl_guest PASSED        [ 97%]
tests/test_views.py::test_journal_detail PASSED                          [ 98%]
tests/test_views.py::test_search_feedback_mail_list FAILED               [ 98%]
tests/test_views.py::test_get_child_list PASSED                          [ 98%]
tests/test_views.py::test_get_path_name_dict PASSED                      [ 98%]
tests/test_views.py::test_gettitlefacet PASSED                           [ 99%]
tests/test_views.py::test_get_last_item_id PASSED                        [ 99%]
tests/test_weko_search_ui.py::test_version PASSED                        [ 99%]
tests/test_weko_search_ui.py::test_init PASSED                           [100%]

==================================== ERRORS ====================================
_______________ ERROR at setup of test_handle_doi_required_check _______________

self = <sqlalchemy.engine.base.Connection object at 0x7ff2f3d35978>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff2f41a3160>
constructor = <bound method DefaultExecutionContext._init_compiled of <class 'sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2'>>
statement = 'INSERT INTO item_type_name (created, updated, name, has_site_license, is_active) VALUES (%(created)s, %(updated)s, %(name)s, %(has_site_license)s, %(is_active)s) RETURNING item_type_name.id'
parameters = {'created': datetime.datetime(2023, 7, 25, 8, 29, 31, 430363), 'has_site_license': True, 'is_active': True, 'name': 'test', ...}
args = (<sqlalchemy.dialects.postgresql.psycopg2.PGCompiler_psycopg2 object at 0x7ff2f3d359b0>, [{'name': 'test'}])
conn = <sqlalchemy.pool._ConnectionFairy object at 0x7ff2f417d860>
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7ff2f3d3e1d0>

    def _execute_context(
        self, dialect, constructor, statement, parameters, *args
    ):
        """Create an :class:`.ExecutionContext` and execute, returning
        a :class:`.ResultProxy`."""
    
        try:
            try:
                conn = self.__connection
            except AttributeError:
                # escape "except AttributeError" before revalidating
                # to prevent misleading stacktraces in Py3K
                conn = None
            if conn is None:
                conn = self._revalidate_connection()
    
            context = constructor(dialect, self, conn, *args)
        except BaseException as e:
            self._handle_dbapi_exception(
                e, util.text_type(statement), parameters, None, None
            )
    
        if context.compiled:
            context.pre_exec()
    
        cursor, statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        if not context.executemany:
            parameters = parameters[0]
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                statement, parameters = fn(
                    self,
                    cursor,
                    statement,
                    parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self.engine.logger.info(statement)
            self.engine.logger.info(
                "%r", sql_util._repr_params(parameters, batches=10)
            )
    
        evt_handled = False
        try:
            if context.executemany:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(cursor, statement, parameters, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor, statement, parameters, context
                    )
            elif not parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, statement, context
                    )
            else:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(cursor, statement, parameters, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute(
>                       cursor, statement, parameters, context
                    )

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1236: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff2f41a3160>
cursor = <cursor object at 0x7ff2fe3b6710; closed: -1>
statement = 'INSERT INTO item_type_name (created, updated, name, has_site_license, is_active) VALUES (%(created)s, %(updated)s, %(name)s, %(has_site_license)s, %(is_active)s) RETURNING item_type_name.id'
parameters = {'created': datetime.datetime(2023, 7, 25, 8, 29, 31, 430363), 'has_site_license': True, 'is_active': True, 'name': 'test', ...}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7ff2f3d3e1d0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       psycopg2.IntegrityError: duplicate key value violates unique constraint "pk_item_type_name"
E       DETAIL:  Key (id)=(1) already exists.

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:536: IntegrityError

The above exception was the direct cause of the following exception:

app = <Flask 'testapp'>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>

    @pytest.fixture()
    def item_type(app, db):
        _item_type_name = ItemTypeName(name="test")
        _item_type_name2 = ItemTypeName(name="test2")
        _item_type_name3 = ItemTypeName(name="test3")
    
        _render = {
            "meta_list": {
                "file": {
                    "title": "",
                    "title_i18n": {"ja": "", "en": "File"},
                    "input_type": "cus_1",
                    "input_value": "",
                    "option": {
                        "required": False,
                        "multiple": True,
                        "hidden": False,
                        "showlist": False,
                        "crtf": False,
                        "oneline": False,
                    },
                },
                "thumbnail": {
                    "title": "",
                    "title_i18n": {"ja": "", "en": "Thumbnail"},
                    "input_type": "cus_2",
                    "input_value": "",
                    "option": {
                        "required": False,
                        "multiple": True,
                        "hidden": False,
                        "showlist": False,
                        "crtf": False,
                        "oneline": False,
                    },
                },
            },
            "meta_fix": {
                "pubdate": {
                    "title": "",
                    "title_i18n": {"ja": "", "en": "PubDate"},
                    "input_type": "datetime",
                    "input_value": "",
                    "option": {
                        "required": True,
                        "multiple": False,
                        "hidden": False,
                        "showlist": False,
                        "crtf": False,
                    },
                }
            },
            "table_row_map": {
                "schema": {
                    "properties": {
                        "item_1": {},
                        "pubdate": {"type": "string", "title": "", "format": "datetime"},
                        "file": {
                            "type": "array",
                            "format": "array",
                            "title": "URI",
                            "items": {
                                "type": "object",
                                "format": "object",
                                "properties": {
                                    "url": {
                                        "type": "object",
                                        "format": "object",
                                        "properties": {
                                            "label": {
                                                "format": "text",
                                                "title": "",
                                                "type": "string",
                                            },
                                            "url": {
                                                "format": "text",
                                                "title": "URL",
                                                "type": "string",
                                            },
                                        },
                                        "title": "URL",
                                    },
                                    "filename": {
                                        "type": ["null", "string"],
                                        "format": "text",
                                        "enum": [],
                                        "title": "",
                                    },
                                },
                            },
                        },
                        "thumbnail": {
                            "type": "array",
                            "format": "array",
                            "title": "URI",
                            "items": {
                                "type": "object",
                                "format": "object",
                                "properties": {
                                    "thumbnail_label": {
                                        "format": "text",
                                        "title": "",
                                        "type": "string",
                                    },
                                    "thumbnail_url": {
                                        "format": "text",
                                        "title": "URI",
                                        "type": "string",
                                    },
                                },
                            },
                        },
                    }
                }
            },
            "table_row": ["pubdate", "file", "thumbnail"],
        }
    
        with open("tests/data/itemtype_schema.json", "r") as f:
            item_type_schema = json.load(f)
    
        sample1 = ItemTypes.create(
            name="test",
            item_type_name=_item_type_name,
            schema=item_type_schema,
            render=_render,
>           tag=1,
        )

tests/conftest.py:1455: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../weko-records/weko_records/api.py:326: in create
    db.session.add(item_type_name)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:597: in __exit__
    self.rollback()
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/langhelpers.py:67: in __exit__
    compat.reraise(exc_type, exc_value, exc_tb)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:277: in reraise
    raise value
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:594: in __exit__
    self.commit()
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:487: in commit
    self._prepare_impl()
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:466: in _prepare_impl
    self.session.flush()
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:2446: in flush
    self._flush(objects)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:2584: in _flush
    transaction.rollback(_capture_exception=True)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/langhelpers.py:67: in __exit__
    compat.reraise(exc_type, exc_value, exc_tb)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:277: in reraise
    raise value
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:2544: in _flush
    flush_context.execute()
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/unitofwork.py:416: in execute
    rec.execute(self)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/unitofwork.py:583: in execute
    uow,
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/persistence.py:245: in save_obj
    insert,
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/persistence.py:1116: in _emit_insert_statements
    statement, params
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:980: in execute
    return meth(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/sql/elements.py:273: in _execute_on_connection
    return connection._execute_clauseelement(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1099: in _execute_clauseelement
    distilled_params,
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1240: in _execute_context
    e, statement, parameters, cursor, context
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1458: in _handle_dbapi_exception
    util.raise_from_cause(sqlalchemy_exception, exc_info)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:296: in raise_from_cause
    reraise(type(exception), exception, tb=exc_tb, cause=cause)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:276: in reraise
    raise value.with_traceback(tb)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1236: in _execute_context
    cursor, statement, parameters, context
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff2f41a3160>
cursor = <cursor object at 0x7ff2fe3b6710; closed: -1>
statement = 'INSERT INTO item_type_name (created, updated, name, has_site_license, is_active) VALUES (%(created)s, %(updated)s, %(name)s, %(has_site_license)s, %(is_active)s) RETURNING item_type_name.id'
parameters = {'created': datetime.datetime(2023, 7, 25, 8, 29, 31, 430363), 'has_site_license': True, 'is_active': True, 'name': 'test', ...}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7ff2f3d3e1d0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.IntegrityError: (psycopg2.IntegrityError) duplicate key value violates unique constraint "pk_item_type_name"
E       DETAIL:  Key (id)=(1) already exists.
E        [SQL: 'INSERT INTO item_type_name (created, updated, name, has_site_license, is_active) VALUES (%(created)s, %(updated)s, %(name)s, %(has_site_license)s, %(is_active)s) RETURNING item_type_name.id'] [parameters: {'created': datetime.datetime(2023, 7, 25, 8, 29, 31, 430363), 'updated': datetime.datetime(2023, 7, 25, 8, 29, 31, 430377), 'name': 'test', 'has_site_license': True, 'is_active': True}] (Background on this error at: http://sqlalche.me/e/gkpj)

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:536: IntegrityError
------------------------------ Captured log setup ------------------------------
WARNING  elasticsearch:base.py:97 PUT http://elasticsearch:9200/test-weko-item-v1.0.0/_alias/test-weko [status:400 request:0.006s]
______________________ ERROR at setup of test_export_all _______________________

self = <sqlalchemy.engine.base.Connection object at 0x7ff2785a7630>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff27942ae10>
constructor = <bound method DefaultExecutionContext._init_compiled of <class 'sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2'>>
statement = 'INSERT INTO item_type_name (created, updated, name, has_site_license, is_active) VALUES (%(created)s, %(updated)s, %(name)s, %(has_site_license)s, %(is_active)s) RETURNING item_type_name.id'
parameters = {'created': datetime.datetime(2023, 7, 25, 16, 32, 43, 436628), 'has_site_license': True, 'is_active': True, 'name': 'test', ...}
args = (<sqlalchemy.dialects.postgresql.psycopg2.PGCompiler_psycopg2 object at 0x7ff2785a7550>, [{'name': 'test'}])
conn = <sqlalchemy.pool._ConnectionFairy object at 0x7ff278bc1470>
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7ff2785a7668>

    def _execute_context(
        self, dialect, constructor, statement, parameters, *args
    ):
        """Create an :class:`.ExecutionContext` and execute, returning
        a :class:`.ResultProxy`."""
    
        try:
            try:
                conn = self.__connection
            except AttributeError:
                # escape "except AttributeError" before revalidating
                # to prevent misleading stacktraces in Py3K
                conn = None
            if conn is None:
                conn = self._revalidate_connection()
    
            context = constructor(dialect, self, conn, *args)
        except BaseException as e:
            self._handle_dbapi_exception(
                e, util.text_type(statement), parameters, None, None
            )
    
        if context.compiled:
            context.pre_exec()
    
        cursor, statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        if not context.executemany:
            parameters = parameters[0]
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                statement, parameters = fn(
                    self,
                    cursor,
                    statement,
                    parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self.engine.logger.info(statement)
            self.engine.logger.info(
                "%r", sql_util._repr_params(parameters, batches=10)
            )
    
        evt_handled = False
        try:
            if context.executemany:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(cursor, statement, parameters, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor, statement, parameters, context
                    )
            elif not parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, statement, context
                    )
            else:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(cursor, statement, parameters, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute(
>                       cursor, statement, parameters, context
                    )

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1236: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff27942ae10>
cursor = <cursor object at 0x7ff279b57808; closed: -1>
statement = 'INSERT INTO item_type_name (created, updated, name, has_site_license, is_active) VALUES (%(created)s, %(updated)s, %(name)s, %(has_site_license)s, %(is_active)s) RETURNING item_type_name.id'
parameters = {'created': datetime.datetime(2023, 7, 25, 16, 32, 43, 436628), 'has_site_license': True, 'is_active': True, 'name': 'test', ...}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7ff2785a7668>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       psycopg2.IntegrityError: duplicate key value violates unique constraint "pk_item_type_name"
E       DETAIL:  Key (id)=(1) already exists.

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:536: IntegrityError

The above exception was the direct cause of the following exception:

app = <Flask 'testapp'>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>

    @pytest.fixture()
    def item_type(app, db):
        _item_type_name = ItemTypeName(name="test")
        _item_type_name2 = ItemTypeName(name="test2")
        _item_type_name3 = ItemTypeName(name="test3")
    
        _render = {
            "meta_list": {
                "file": {
                    "title": "",
                    "title_i18n": {"ja": "", "en": "File"},
                    "input_type": "cus_1",
                    "input_value": "",
                    "option": {
                        "required": False,
                        "multiple": True,
                        "hidden": False,
                        "showlist": False,
                        "crtf": False,
                        "oneline": False,
                    },
                },
                "thumbnail": {
                    "title": "",
                    "title_i18n": {"ja": "", "en": "Thumbnail"},
                    "input_type": "cus_2",
                    "input_value": "",
                    "option": {
                        "required": False,
                        "multiple": True,
                        "hidden": False,
                        "showlist": False,
                        "crtf": False,
                        "oneline": False,
                    },
                },
            },
            "meta_fix": {
                "pubdate": {
                    "title": "",
                    "title_i18n": {"ja": "", "en": "PubDate"},
                    "input_type": "datetime",
                    "input_value": "",
                    "option": {
                        "required": True,
                        "multiple": False,
                        "hidden": False,
                        "showlist": False,
                        "crtf": False,
                    },
                }
            },
            "table_row_map": {
                "schema": {
                    "properties": {
                        "item_1": {},
                        "pubdate": {"type": "string", "title": "", "format": "datetime"},
                        "file": {
                            "type": "array",
                            "format": "array",
                            "title": "URI",
                            "items": {
                                "type": "object",
                                "format": "object",
                                "properties": {
                                    "url": {
                                        "type": "object",
                                        "format": "object",
                                        "properties": {
                                            "label": {
                                                "format": "text",
                                                "title": "",
                                                "type": "string",
                                            },
                                            "url": {
                                                "format": "text",
                                                "title": "URL",
                                                "type": "string",
                                            },
                                        },
                                        "title": "URL",
                                    },
                                    "filename": {
                                        "type": ["null", "string"],
                                        "format": "text",
                                        "enum": [],
                                        "title": "",
                                    },
                                },
                            },
                        },
                        "thumbnail": {
                            "type": "array",
                            "format": "array",
                            "title": "URI",
                            "items": {
                                "type": "object",
                                "format": "object",
                                "properties": {
                                    "thumbnail_label": {
                                        "format": "text",
                                        "title": "",
                                        "type": "string",
                                    },
                                    "thumbnail_url": {
                                        "format": "text",
                                        "title": "URI",
                                        "type": "string",
                                    },
                                },
                            },
                        },
                    }
                }
            },
            "table_row": ["pubdate", "file", "thumbnail"],
        }
    
        with open("tests/data/itemtype_schema.json", "r") as f:
            item_type_schema = json.load(f)
    
        sample1 = ItemTypes.create(
            name="test",
            item_type_name=_item_type_name,
            schema=item_type_schema,
            render=_render,
>           tag=1,
        )

tests/conftest.py:1455: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../weko-records/weko_records/api.py:326: in create
    db.session.add(item_type_name)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:597: in __exit__
    self.rollback()
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/langhelpers.py:67: in __exit__
    compat.reraise(exc_type, exc_value, exc_tb)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:277: in reraise
    raise value
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:594: in __exit__
    self.commit()
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:487: in commit
    self._prepare_impl()
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:466: in _prepare_impl
    self.session.flush()
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:2446: in flush
    self._flush(objects)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:2584: in _flush
    transaction.rollback(_capture_exception=True)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/langhelpers.py:67: in __exit__
    compat.reraise(exc_type, exc_value, exc_tb)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:277: in reraise
    raise value
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/session.py:2544: in _flush
    flush_context.execute()
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/unitofwork.py:416: in execute
    rec.execute(self)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/unitofwork.py:583: in execute
    uow,
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/persistence.py:245: in save_obj
    insert,
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/persistence.py:1116: in _emit_insert_statements
    statement, params
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:980: in execute
    return meth(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/sql/elements.py:273: in _execute_on_connection
    return connection._execute_clauseelement(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1099: in _execute_clauseelement
    distilled_params,
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1240: in _execute_context
    e, statement, parameters, cursor, context
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1458: in _handle_dbapi_exception
    util.raise_from_cause(sqlalchemy_exception, exc_info)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:296: in raise_from_cause
    reraise(type(exception), exception, tb=exc_tb, cause=cause)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:276: in reraise
    raise value.with_traceback(tb)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1236: in _execute_context
    cursor, statement, parameters, context
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff27942ae10>
cursor = <cursor object at 0x7ff279b57808; closed: -1>
statement = 'INSERT INTO item_type_name (created, updated, name, has_site_license, is_active) VALUES (%(created)s, %(updated)s, %(name)s, %(has_site_license)s, %(is_active)s) RETURNING item_type_name.id'
parameters = {'created': datetime.datetime(2023, 7, 25, 16, 32, 43, 436628), 'has_site_license': True, 'is_active': True, 'name': 'test', ...}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7ff2785a7668>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.IntegrityError: (psycopg2.IntegrityError) duplicate key value violates unique constraint "pk_item_type_name"
E       DETAIL:  Key (id)=(1) already exists.
E        [SQL: 'INSERT INTO item_type_name (created, updated, name, has_site_license, is_active) VALUES (%(created)s, %(updated)s, %(name)s, %(has_site_license)s, %(is_active)s) RETURNING item_type_name.id'] [parameters: {'created': datetime.datetime(2023, 7, 25, 16, 32, 43, 436628), 'updated': datetime.datetime(2023, 7, 25, 16, 32, 43, 436637), 'name': 'test', 'has_site_license': True, 'is_active': True}] (Background on this error at: http://sqlalche.me/e/gkpj)

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:536: IntegrityError
=================================== FAILURES ===================================
_________________ TestItemManagementBulkSearch.test_index_acl __________________

self = <tests.test_admin.TestItemManagementBulkSearch object at 0x7ff30a9603c8>
client = <FlaskClient <Flask 'testapp'>>
users = [{'email': 'noroleuser@test.org', 'id': 9, 'obj': <User 9>}, {'email': 'contributor@test.org', 'id': 2, 'obj': <User 2...ail': 'comadmin@test.org', 'id': 3, 'obj': <User 3>}, {'email': 'generaluser@test.org', 'id': 6, 'obj': <User 5>}, ...]
db_records2 = [(<PersistentIdentifier depid:1 / rec:e3ce8ad1-ffeb-4a8e-ba96-4d3f00d74417 (R)>, <PersistentIdentifier recid:1 / rec:e...617258105262': {'resourceuri': 'http://purl.org/coar/resource_type/c_5794', 'resourcetype': 'conference paper'}}), ...]

    def test_index_acl(self,client, users, db_records2):
        user = users[3]['obj']
        assert user.roles[0].name=='System Administrator'
    
        url = url_for("items/search.index", _external=True)
        with patch("flask.templating._render", return_value=""):
            res = client.get(url)
            assert res.status == '302 FOUND'
    
        with patch("flask_login.utils._get_user", return_value=user):
            with patch("flask.templating._render", return_value=""):
                res = client.get(url)
>               assert res.status == '200 OK'
E               AssertionError: assert '500 INTERNAL SERVER ERROR' == '200 OK'
E                 - 200 OK
E                 + 500 INTERNAL SERVER ERROR

tests/test_admin.py:113: AssertionError
__________________________ test_ItemImportView_check ___________________________

request = <Request 'http://TEST_SERVER/' [POST]>, csrf_header = 'X-CSRFToken'

    def validate_csrf_header(request,csrf_header="X-CSRFToken"):
        """Validate CSRF header
    
        Args:
            csrf_header (str, optional): CSRF Token Header. Defaults to "X-CSRFToken".
    
        Raises:
            CSRFError: _description_
            CSRFError: _description_
            CSRFError: _description_
        """
        try:
            csrf_token = request.headers.get(csrf_header)
>           validate_csrf(csrf_token)

../weko-admin/weko_admin/api.py:229: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

data = None, secret_key = 'SECRET_KEY', time_limit = 3600, token_key = None

    def validate_csrf(data, secret_key=None, time_limit=None, token_key=None):
        """Check if the given data is a valid CSRF token. This compares the given
        signed token to the one stored in the session.
    
        :param data: The signed CSRF token to be checked.
        :param secret_key: Used to securely sign the token. Default is
            ``WTF_CSRF_SECRET_KEY`` or ``SECRET_KEY``.
        :param time_limit: Number of seconds that the token is valid. Default is
            ``WTF_CSRF_TIME_LIMIT`` or 3600 seconds (60 minutes).
        :param token_key: Key where token is stored in session for comparision.
            Default is ``WTF_CSRF_FIELD_NAME`` or ``'csrf_token'``.
    
        :raises ValidationError: Contains the reason that validation failed.
    
        .. versionchanged:: 0.14
            Raises ``ValidationError`` with a specific error message rather than
            returning ``True`` or ``False``.
        """
    
        secret_key = _get_config(
            secret_key, 'WTF_CSRF_SECRET_KEY', current_app.secret_key,
            message='A secret key is required to use CSRF.'
        )
        field_name = _get_config(
            token_key, 'WTF_CSRF_FIELD_NAME', 'csrf_token',
            message='A field name is required to use CSRF.'
        )
        time_limit = _get_config(
            time_limit, 'WTF_CSRF_TIME_LIMIT', 3600, required=False
        )
    
        if not data:
>           raise ValidationError('The CSRF token is missing.')
E           wtforms.validators.ValidationError: The CSRF token is missing.

.tox/c1/lib/python3.6/site-packages/flask_wtf/csrf.py:91: ValidationError

During handling of the above exception, another exception occurred:

i18n_app = <Flask 'testapp'>
users = [{'email': 'noroleuser@test.org', 'id': 9, 'obj': <User 9>}, {'email': 'contributor@test.org', 'id': 2, 'obj': <User 2...ail': 'comadmin@test.org', 'id': 3, 'obj': <User 3>}, {'email': 'generaluser@test.org', 'id': 6, 'obj': <User 5>}, ...]
client = <FlaskClient <Flask 'testapp'>>
client_request_args = <Response streamed [200 OK]>

    def test_ItemImportView_check(i18n_app, users, client,client_request_args):
        file_path = os.path.join(
            os.path.dirname(os.path.abspath(__file__)),
            'data',
            'sample_file',
            'sample_csv.csv'
        )
    
        csv_data = open(file_path, "rb")
        data = {"file": (csv_data, "sample_csv.csv")}
    
        client.post(
            "/",
            data=data,
            buffered=True,
            content_type="multipart/form-data",
        )
    
        rf = request.form.to_dict()
        rf['username'] = "test_user"
    
        # mimetype = 'application/json'
        # headers = {
        #     'Content-Type': mimetype,
        #     'Accept': mimetype
        # }
        # data = {
        #     'Data': [20.0, 30.0, 401.0, 50.0],
        #     'Date': ['2017-08-11', '2017-08-12', '2017-08-13', '2017-08-14'],
        #     'Day': 4
        # }
    
        # client.post(
        #     '/',
        #     data=json.dumps(data),
        #     headers=headers
        # )
    
        with patch("flask_login.utils._get_user", return_value=users[3]['obj']):
            test = ItemImportView()
            task = MagicMock()
            task.task_id = 1
            with patch("weko_search_ui.tasks.check_import_items_task.apply_async",return_Value=task):
>               assert test.check()

tests/test_admin.py:185: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.tox/c1/lib/python3.6/site-packages/flask_admin/base.py:69: in inner
    return self._run_view(f, *args, **kwargs)
.tox/c1/lib/python3.6/site-packages/flask_admin/base.py:368: in _run_view
    return fn(self, *args, **kwargs)
weko_search_ui/admin.py:338: in check
    validate_csrf_header(request)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

request = <Request 'http://TEST_SERVER/' [POST]>, csrf_header = 'X-CSRFToken'

    def validate_csrf_header(request,csrf_header="X-CSRFToken"):
        """Validate CSRF header
    
        Args:
            csrf_header (str, optional): CSRF Token Header. Defaults to "X-CSRFToken".
    
        Raises:
            CSRFError: _description_
            CSRFError: _description_
            CSRFError: _description_
        """
        try:
            csrf_token = request.headers.get(csrf_header)
            validate_csrf(csrf_token)
        except ValidationError as e:
>           raise CSRFError(e.args[0])
E           flask_wtf.csrf.CSRFError: 400 Bad Request: The CSRF token is missing.

../weko-admin/weko_admin/api.py:231: CSRFError
------------------------------ Captured log setup ------------------------------
ERROR    flask.app:receivers.py:39 Error building event
Traceback (most recent call last):
  File "/code/modules/invenio-stats/invenio_stats/receivers.py", line 31, in __call__
    if self.name in current_stats.events:
  File "/code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py", line 348, in __getattr__
    return getattr(self._get_current_object(), name)
  File "/code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/werkzeug/utils.py", line 91, in __get__
    value = self.func(obj)
  File "/code/modules/invenio-stats/invenio_stats/ext.py", line 79, in events
    queue = current_queues.queues[
  File "/code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py", line 348, in __getattr__
    return getattr(self._get_current_object(), name)
AttributeError: 'int' object has no attribute 'queues'
_________________ TestItemBulkExport.test_check_export_status __________________

self = <tests.test_admin.TestItemBulkExport object at 0x7ff30936ea90>
app = <Flask 'testapp'>, client = <FlaskClient <Flask 'testapp'>>
users = [{'email': 'noroleuser@test.org', 'id': 9, 'obj': <User 9>}, {'email': 'contributor@test.org', 'id': 2, 'obj': <User 2...ail': 'comadmin@test.org', 'id': 3, 'obj': <User 3>}, {'email': 'generaluser@test.org', 'id': 6, 'obj': <User 5>}, ...]
redis_connect = <simplekv.memory.redisstore.RedisStore object at 0x7ff308135b38>
mocker = <pytest_mock.plugin.MockerFixture object at 0x7ff308135ac8>

    def test_check_export_status(self,app,client,users, redis_connect,mocker):
    
        mocker.patch("weko_search_ui.utils.AsyncResult",side_effect=MockAsyncResult)
        mocker.patch("weko_search_ui.admin.check_celery_is_run",return_value=True)
        with patch("flask_login.utils._get_user", return_value=users[3]["obj"]):
            cache_key = app.config["WEKO_ADMIN_CACHE_PREFIX"].format(
                name="KEY_EXPORT_ALL", user_id=current_user.get_id()
            )
            datastore = redis_connect
            datastore.put(cache_key, "SUCCESS_task".encode("utf-8"), ttl_secs=30)
    
            url = url_for("items/bulk-export.check_export_status")
    
            res = client.get(url)
>           assert json.loads(res.data) == {'data': {
                'celery_is_run': True,
                'error_message': None,
                'export_run_msg': None,
                'export_status': False,
                'status': 'SUCCESS',
                'uri_status': False}}
E           AssertionError: assert {'data': {'ce...: False, ...}} == {'data': {'ce...: False, ...}}
E             Differing items:
E             {'data': {'celery_is_run': True, 'error_message': '', 'export_run_msg': None, 'export_status': False, ...}} != {'data': {'celery_is_run': True, 'error_message': None, 'export_run_msg': None, 'export_status': False, ...}}
E             Full diff:
E               {
E                'data': {'celery_is_run': True,
E             -           'error_message': None,
E             ?                            ^^^^...
E             
E             ...Full output truncated (8 lines hidden), use '-vv' to show

tests/test_admin.py:306: AssertionError
__________________________ test_get_permission_filter __________________________

i18n_app = <Flask 'testapp'>
users = [{'email': 'noroleuser@test.org', 'id': 9, 'obj': <User 9>}, {'email': 'contributor@test.org', 'id': 2, 'obj': <User 2...ail': 'comadmin@test.org', 'id': 3, 'obj': <User 3>}, {'email': 'generaluser@test.org', 'id': 6, 'obj': <User 5>}, ...]
client_request_args = <Response streamed [200 OK]>
indices = {'index_dict': {'biblio_flag': False, 'browsing_group': '', 'browsing_role': 'Contributor', 'comment': '', ...}, 'index_non_dict': <Index 33>, 'index_non_dict_child': <Index 44>}

    def test_get_permission_filter(i18n_app, users, client_request_args, indices):
        with patch("flask_login.utils._get_user", return_value=users[3]['obj']):
            res = get_permission_filter(33)
>           assert res==([Match(publish_status='0'), Range(publish_date={'lte': 'now/d','time_zone':'UTC'}), Terms(path=['33']), Bool(must=[Match(publish_status='0'), Match(relation_version_is_last='true')])], ['33','33/44'])
E           AssertionError: assert ([Terms(publi...33', '33/44']) == ([Match(publi...33', '33/44'])
E             At index 0 diff: [Terms(publish_status=['0', '1']), Range(publish_date={'lte': 'now/d', 'time_zone': 'UTC'}), Terms(path=['33']), Bool(must=[Terms(publish_status=['0', '1']), Match(relation_version_is_last='true')])] != [Match(publish_status='0'), Range(publish_date={'lte': 'now/d', 'time_zone': 'UTC'}), Terms(path=['33']), Bool(must=[Match(publish_status='0'), Match(relation_version_is_last='true')])]
E             Full diff:
E               (
E             -  [Match(publish_status='0'),
E             +  [Terms(publish_status=['0', '1']),
E                 Range(publish_date={'lte': 'now/d', 'time_zone': 'UTC'}),
E                 Terms(path=['33']),...
E             
E             ...Full output truncated (7 lines hidden), use '-vv' to show

tests/test_query.py:46: AssertionError
------------------------------ Captured log setup ------------------------------
ERROR    flask.app:receivers.py:39 Error building event
Traceback (most recent call last):
  File "/code/modules/invenio-stats/invenio_stats/receivers.py", line 31, in __call__
    if self.name in current_stats.events:
  File "/code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py", line 348, in __getattr__
    return getattr(self._get_current_object(), name)
  File "/code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/werkzeug/utils.py", line 91, in __get__
    value = self.func(obj)
  File "/code/modules/invenio-stats/invenio_stats/ext.py", line 79, in events
    queue = current_queues.queues[
  File "/code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py", line 348, in __getattr__
    return getattr(self._get_current_object(), name)
AttributeError: 'int' object has no attribute 'queues'
___________________________ test_function_issue35902 ___________________________

app = <Flask 'testapp'>
users = [{'email': 'noroleuser@test.org', 'id': 9, 'obj': <User 9>}, {'email': 'contributor@test.org', 'id': 2, 'obj': <User 2...ail': 'comadmin@test.org', 'id': 3, 'obj': <User 3>}, {'email': 'generaluser@test.org', 'id': 6, 'obj': <User 5>}, ...]
communities = <Community, ID: comm1>
mocker = <pytest_mock.plugin.MockerFixture object at 0x7ff30420f0b8>

    def test_function_issue35902(app, users, communities, mocker):
        with app.test_client() as client:
            login_user_via_session(client, email=users[3]["email"])
            search = RecordsSearch()
            app.config['WEKO_SEARCH_KEYWORDS_DICT'] = WEKO_SEARCH_KEYWORDS_DICT
            app.config['WEKO_ADMIN_MANAGEMENT_OPTIONS'] = WEKO_ADMIN_MANAGEMENT_OPTIONS
            mocker.patch("weko_search_ui.query.search_permission",side_effect=MockSearchPerm)
            mocker.patch("weko_search_ui.permissions.search_permission",side_effect=MockSearchPerm)
            test = [
                {"bool":{"should":[{"match":{"weko_creator_id":None}},{"match":{"weko_shared_id":None}},{"bool":{"must":[{"match":{"publish_status":"0"}},{"range":{"publish_date":{"lte":"now/d","time_zone":"UTC"}}}]}}],"must":[{"terms":{"path":[]}}]}},
                {"bool":{"must":[{"match":{"relation_version_is_last":"true"}}]}},
            ]
            # not exist community
            # full text, detail search
            data = {
                "page":"1","size":"20","sort":"-createdate","creator":"","subject":"","sbjscheme":"","id":"","id_attr":"","type":"","itemtype":"","lang":"",
                "search_type":"0",
                "q":"test_data",
                "title":"aaa",
            }
            with app.test_request_context(headers=[("Accept-Language","en")],data=data):
                app.extensions['invenio-oauth2server'] = 1
                app.extensions['invenio-queues'] = 1
                test1 = copy.deepcopy(test)
                test1.append(
                    {"multi_match":{"query":"aaa","type":"most_fields","minimum_should_match":"75%","operator":"and","fields":["search_title","search_title.ja"]}}
                )
                test1.append(
                    {"bool":{"should":[
                        {"nested":{"query":{"multi_match":{"query":"test_data","operator":"and","fields":["content.attachment.content"]}},"path":"content"}},
                        {"query_string":{"query":"test_data","default_operator":"and","fields":["search_*","search_*.ja"]}}
                    ]}}
                )
                res,urlkwargs = default_search_factory(self=None, search=search)
                result = (res.query()).to_dict()
                result = result["query"]["bool"]["filter"][0]["bool"]["must"]
>               assert result == test1
E               AssertionError: assert [{'bool': {'m...st_data'}}]}}] == [{'bool': {'m...st_data'}}]}}]
E                 At index 0 diff: {'bool': {'should': [{'bool': {'must': [{'terms': {'publish_status': ['0', '1']}}, {'match': {'weko_creator_id': None}}]}}, {'bool': {'must': [{'terms': {'publish_status': ['0', '1']}}, {'match': {'weko_shared_id': None}}]}}, {'bool': {'must': [{'terms': {'publish_status': ['0']}}, {'range': {'publish_date': {'lte': 'now/d', 'time_zone': 'UTC'}}}]}}], 'must': [{'terms': {'path': []}}]}} != {'bool': {'should': [{'match': {'weko_creator_id': None}}, {'match': {'weko_shared_id': None}}, {'bool': {'must': [{'match': {'publish_status': '0'}}, {'range': {'pub...
E                 
E                 ...Full output truncated (35 lines hidden), use '-vv' to show

tests/test_query.py:213: AssertionError
____________________ test_IndexSearchResource_get_Exception ____________________

client_rest = <FlaskClient <Flask 'testapp'>>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>
users = [{'email': 'noroleuser@test.org', 'id': 9, 'obj': <User 9>}, {'email': 'contributor@test.org', 'id': 2, 'obj': <User 2...ail': 'comadmin@test.org', 'id': 3, 'obj': <User 3>}, {'email': 'generaluser@test.org', 'id': 6, 'obj': <User 5>}, ...]
item_type = [{'type': 'object', '$schema': 'http://json-schema.org/draft-04/schema#', 'required': ['pubdate', 'item_1617186331708'...type': 'string', 'title': 'SYSTEMIDT Identifier Type', 'format': 'select'}}, 'system_prop': True}}, 'description': ''}]
db_records = [(<PersistentIdentifier depid:1 / rec:bc90e01d-f0dd-4c4f-89f3-4be899d6e1e2 (R)>, <PersistentIdentifier recid:1 / rec:b...617258105262': {'resourceuri': 'http://purl.org/coar/resource_type/c_5794', 'resourcetype': 'conference paper'}}), ...]
facet_search_setting = None

    def test_IndexSearchResource_get_Exception(client_rest, db, users, item_type, db_records, facet_search_setting):
        sname = current_app.config["SERVER_NAME"]
        #from weko_index_tree.models import Index
        #datas = json_data("data/index.json")
        #indexes = list()
        #for index in datas:
        #    indexes.append(Index(**datas[index]))
        #with db.session.begin_nested():
        #    db.session.add_all(indexes)
        #db.session.commit()
    
        def dummy_response(data):
            if isinstance(data, str):
                data = json_data(data)
            dummy=response.Response(Search(), data)
            return dummy
        facet = json_data("data/search/facet.json")
        links = {"self":"?page=1&size=20"}
        for l in links:
            links[l]="http://"+sname+"/index/"+links[l]
        with patch("weko_admin.utils.get_facet_search_query", return_value=facet):
            with patch("weko_search_ui.rest.Indexes.get_self_list",side_effect=mock_path(**path1)):
                with patch("invenio_search.api.RecordsSearch.execute", return_value=dummy_response("data/search/execute_result01_02_03.json")):
                    with patch("weko_search_ui.rest.get_heading_info", side_effect=Exception):
>                       res = client_rest.get(url("/index/",{"self":"?page=1&size=20"}))

tests/test_rest.py:132: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
.tox/c1/lib/python3.6/site-packages/flask/app.py:1838: in full_dispatch_request
    rv = self.dispatch_request()
.tox/c1/lib/python3.6/site-packages/flask/app.py:1824: in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
.tox/c1/lib/python3.6/site-packages/flask/views.py:88: in view
    return self.dispatch_request(*args, **kwargs)
.tox/c1/lib/python3.6/site-packages/invenio_rest/views.py:240: in dispatch_request
    *args, **kwargs
.tox/c1/lib/python3.6/site-packages/flask/views.py:158: in dispatch_request
    return meth(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <weko_search_ui.rest.IndexSearchResource object at 0x7ff30396e7b8>
kwargs = {}, FacetSearchSetting = <class 'weko_admin.models.FacetSearchSetting'>
get_facet_search_query = <MagicMock name='get_facet_search_query' id='140681714535392'>
page = 1, size = 20, is_search = 0, community_id = None, params = {}

    def get(self, **kwargs):
        """Search records.
    
        :returns: the search result containing hits and aggregations as
        returned by invenio-search.
        """
        from weko_admin.models import FacetSearchSetting
        from weko_admin.utils import get_facet_search_query
    
        page = request.values.get("page", 1, type=int)
        size = request.values.get("size", 20, type=int)
        is_search = request.values.get("is_search", 0 ,type=int ) #toppage and search_page is 1
        community_id = request.values.get("community")
        params = {}
        facets = get_facet_search_query()
        search_index = current_app.config["SEARCH_UI_SEARCH_INDEX"]
>       if facets and search_index and "post_filters" in facets[search_index]:
E       KeyError: 'test-weko'

weko_search_ui/rest.py:205: KeyError
_____________________________ test_delete_records ______________________________

i18n_app = <Flask 'testapp'>
db_activity = {'activity': <Activity 2>, 'item': {'id': '1', 'pid': {'type': 'depid', 'value': '1', 'revision_id': 0}, 'lang': 'ja',... 'http://purl.org/coar/resource_type/c_5794', 'resourcetype': 'conference paper'}]}, 'relation_version_is_last': True}}

    def test_delete_records(i18n_app, db_activity):
        with open("tests/data/search_result_2.json", "r") as json_file:
            search_result = json.load(json_file)
    
            with patch("weko_search_ui.utils.get_tree_items", return_value=[search_result]):
                with patch(
                    "invenio_records.api.Record.get_record",
                    return_value=db_activity["record"],
                ):
                    with patch(
                        "weko_deposit.api.WekoIndexer.update_es_data",
                        return_value=db_activity["record"],
                    ):
                        with patch(
                            "weko_deposit.api.WekoDeposit.delete_by_index_tree_id",
                            return_value="",
                        ):
                            with patch(
                                "invenio_records.api.Record.delete", return_value=""
                            ):
                                assert delete_records(33, ignore_items=[])
>                               assert delete_records(1, ignore_items=[])

tests/test_utils.py:228: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
weko_search_ui/utils.py:257: in delete_records
    soft_delete(pid)
../weko-records-ui/weko_records_ui/utils.py:290: in soft_delete
    raise ex
../weko-records-ui/weko_records_ui/utils.py:271: in soft_delete
    dep.remove_feedback_mail()
../weko-deposit/weko_deposit/api.py:1653: in remove_feedback_mail
    self.indexer.update_feedback_mail_list(feedback_mail)
../weko-deposit/weko_deposit/api.py:391: in update_feedback_mail_list
    body=body
.tox/c1/lib/python3.6/site-packages/elasticsearch/client/utils.py:76: in _wrapped
    return func(*args, params=params, **kwargs)
.tox/c1/lib/python3.6/site-packages/elasticsearch/client/__init__.py:528: in update
    doc_type, id, '_update'), params=params, body=body)
.tox/c1/lib/python3.6/site-packages/elasticsearch/transport.py:314: in perform_request
    status, headers_response, data = connection.perform_request(method, url, params, body, headers=headers, ignore=ignore, timeout=timeout)
.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/http_requests.py:90: in perform_request
    self._raise_error(response.status_code, raw_data)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <RequestsHttpConnection: http://elasticsearch:9200>, status_code = 404
raw_data = '{"error":{"root_cause":[{"type":"document_missing_exception","reason":"[item-v1.0.0][e296a25b-e919-41c3-b01c-9d8137b3...-9d8137b3560b]: document missing","index_uuid":"WNrREJpUQj2d2lk3QtnTfg","shard":"4","index":"test-weko"},"status":404}'

    def _raise_error(self, status_code, raw_data):
        """ Locate appropriate exception and raise it. """
        error_message = raw_data
        additional_info = None
        try:
            if raw_data:
                additional_info = json.loads(raw_data)
                error_message = additional_info.get('error', error_message)
                if isinstance(error_message, dict) and 'type' in error_message:
                    error_message = error_message['type']
        except (ValueError, TypeError) as err:
            logger.warning('Undecodable raw error response from server: %s', err)
    
>       raise HTTP_EXCEPTIONS.get(status_code, TransportError)(status_code, error_message, additional_info)
E       elasticsearch.exceptions.NotFoundError: TransportError(404, 'document_missing_exception', '[item-v1.0.0][e296a25b-e919-41c3-b01c-9d8137b3560b]: document missing')

.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/base.py:125: NotFoundError
------------------------------ Captured log call -------------------------------
WARNING  elasticsearch:base.py:97 POST http://elasticsearch:9200/test-weko/item-v1.0.0/e296a25b-e919-41c3-b01c-9d8137b3560b/_update [status:404 request:0.124s]
_________________________ test_get_feedback_mail_list __________________________

i18n_app = <Flask 'testapp'>
db_records2 = [(<PersistentIdentifier depid:1 / rec:ab59f21e-9ada-44f5-a949-9ecb23373bdf (R)>, <PersistentIdentifier recid:1 / rec:a...617258105262': {'resourceuri': 'http://purl.org/coar/resource_type/c_5794', 'resourcetype': 'conference paper'}}), ...]
es = <Elasticsearch([{'host': 'elasticsearch'}])>

    def test_get_feedback_mail_list(i18n_app, db_records2, es):
        search_instance = '{"size": 1, "query": {"bool": {"filter": [{"bool": {"must": [{"match": {"publish_status": "0"}}, {"range": {"publish_date": {"lte": "now/d"}}}, {"terms": {"path": ["1031", "1029", "1025", "952", "953", "943", "940", "1017", "1015", "1011", "881", "893", "872", "869", "758", "753", "742", "530", "533", "502", "494", "710", "702", "691", "315", "351", "288", "281", "759", "754", "744", "531", "534", "503", "495", "711", "704", "692", "316", "352", "289", "282", "773", "771", "767", "538", "539", "519", "510", "756", "745", "733", "337", "377", "308", "299", "2063", "2061", "2057", "1984", "1985", "1975", "1972", "2049", "2047", "2043", "1913", "1925", "1904", "1901", "1790", "1785", "1774", "1562", "1565", "1534", "1526", "1742", "1734", "1723", "1347", "1383", "1320", "1313", "1791", "1786", "1776", "1563", "1566", "1535", "1527", "1743", "1736", "1724", "1348", "1384", "1321", "1314", "1805", "1803", "1799", "1570", "1571", "1551", "1542", "1788", "1777", "1765", "1369", "1409", "1340", "1331", "4127", "4125", "4121", "4048", "4049", "4039", "4036", "4113", "4111", "4107", "3977", "3989", "3968", "3965", "3854", "3849", "3838", "3626", "3629", "3598", "3590", "3806", "3798", "3787", "3411", "3447", "3384", "3377", "3855", "3850", "3840", "3627", "3630", "3599", "3591", "3807", "3800", "3788", "3412", "3448", "3385", "3378", "3869", "3867", "3863", "3634", "3635", "3615", "3606", "3852", "3841", "3829", "3433", "3473", "3404", "3395", "1631495207665", "1631495247023", "1631495289664", "1631495340640", "1631510190230", "1631510251689", "1631510324260", "1631510380602", "1631510415574", "1631511387362", "1631511432362", "1631511521954", "1631511525655", "1631511606115", "1631511735866", "1631511740808", "1631511841882", "1631511874428", "1631511843164", "1631511845163", "1631512253601", "1633380618401", "1638171727119", "1638171753803", "1634120530242", "1636010714174", "1636010749240", "1638512895916", "1638512971664"]}}, {"bool": {"must": [{"match": {"publish_status": "0"}}, {"match": {"relation_version_is_last": "true"}}]}}, {"bool": {"should": [{"nested": {"query": {"multi_match": {"query": "simple", "operator": "and", "fields": ["content.attachment.content"]}}, "path": "content"}}, {"query_string": {"query": "simple", "default_operator": "and", "fields": ["search_*", "search_*.ja"]}}]}}]}}], "must": [{"match_all": {}}]}}, "aggs": {"Data Language": {"filter": {"bool": {"must": [{"term": {"publish_status": "0"}}]}}, "aggs": {"Data Language": {"terms": {"field": "language", "size": 1000}}}}, "Access": {"filter": {"bool": {"must": [{"term": {"publish_status": "0"}}]}}, "aggs": {"Access": {"terms": {"field": "accessRights", "size": 1000}}}}, "Location": {"filter": {"bool": {"must": [{"term": {"publish_status": "0"}}]}}, "aggs": {"Location": {"terms": {"field": "geoLocation.geoLocationPlace", "size": 1000}}}}, "Temporal": {"filter": {"bool": {"must": [{"term": {"publish_status": "0"}}]}}, "aggs": {"Temporal": {"terms": {"field": "temporal", "size": 1000}}}}, "Topic": {"filter": {"bool": {"must": [{"term": {"publish_status": "0"}}]}}, "aggs": {"Topic": {"terms": {"field": "subject.value", "size": 1000}}}}, "Distributor": {"filter": {"bool": {"must": [{"term": {"contributor.@attributes.contributorType": "Distributor"}}, {"term": {"publish_status": "0"}}]}}, "aggs": {"Distributor": {"terms": {"field": "contributor.contributorName", "size": 1000}}}}, "Data Type": {"filter": {"bool": {"must": [{"term": {"description.descriptionType": "Other"}}, {"term": {"publish_status": "0"}}]}}, "aggs": {"Data Type": {"terms": {"field": "description.value", "size": 1000}}}}}, "sort": [{"_id": {"order": "desc", "unmapped_type": "long"}}], "_source": {"excludes": ["content"]}}'
        execute_result = {
            "aggregations": {"doc_count": 1, "key": 2},
            "feedback_mail_list": {},
            "email_list": {},
            "buckets": [],
        }
        # mock_recordssearch = MagicMock(side_effect=MockRecordsSearch)
        # side_effect=mock_recordssearch
        with patch(
            "weko_search_ui.query.feedback_email_search_factory",
            return_value=search_instance,
        ):
>           assert get_feedback_mail_list() == {}

tests/test_utils.py:270: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
weko_search_ui/utils.py:320: in get_feedback_mail_list
    search_instance.execute()
.tox/c1/lib/python3.6/site-packages/elasticsearch_dsl/search.py:706: in execute
    **self._params
.tox/c1/lib/python3.6/site-packages/elasticsearch/client/utils.py:76: in _wrapped
    return func(*args, params=params, **kwargs)
.tox/c1/lib/python3.6/site-packages/elasticsearch/client/__init__.py:636: in search
    doc_type, '_search'), params=params, body=body)
.tox/c1/lib/python3.6/site-packages/elasticsearch/transport.py:314: in perform_request
    status, headers_response, data = connection.perform_request(method, url, params, body, headers=headers, ignore=ignore, timeout=timeout)
.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/http_requests.py:90: in perform_request
    self._raise_error(response.status_code, raw_data)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <RequestsHttpConnection: http://elasticsearch:9200>, status_code = 400
raw_data = '{"error":{"root_cause":[{"type":"query_shard_exception","reason":"failed to create query: {\\n  \\"bool\\" : {\\n    ...l_state_exception","reason":"[nested] failed to find nested object under path [feedback_mail_list]"}}}]},"status":400}'

    def _raise_error(self, status_code, raw_data):
        """ Locate appropriate exception and raise it. """
        error_message = raw_data
        additional_info = None
        try:
            if raw_data:
                additional_info = json.loads(raw_data)
                error_message = additional_info.get('error', error_message)
                if isinstance(error_message, dict) and 'type' in error_message:
                    error_message = error_message['type']
        except (ValueError, TypeError) as err:
            logger.warning('Undecodable raw error response from server: %s', err)
    
>       raise HTTP_EXCEPTIONS.get(status_code, TransportError)(status_code, error_message, additional_info)
E       elasticsearch.exceptions.RequestError: TransportError(400, 'search_phase_execution_exception', 'failed to create query: {\n  "bool" : {\n    "must" : [\n      {\n        "nested" : {\n          "query" : {\n            "bool" : {\n              "must" : [\n                {\n                  "exists" : {\n                    "field" : "feedback_mail_list.email",\n                    "boost" : 1.0\n                  }\n                }\n              ],\n              "adjust_pure_negative" : true,\n              "boost" : 1.0\n            }\n          },\n          "path" : "feedback_mail_list",\n          "ignore_unmapped" : false,\n          "score_mode" : "avg",\n          "boost" : 1.0\n        }\n      },\n      {\n        "query_string" : {\n          "query" : "_type:record-v1.0.0 AND relation_version_is_last:true ",\n          "fields" : [ ],\n          "type" : "best_fields",\n          "default_operator" : "or",\n          "max_determinized_states" : 10000,\n          "enable_position_increments" : true,\n          "fuzziness" : "AUTO",\n          "fuzzy_prefix_length" : 0,\n          "fuzzy_max_expansions" : 50,\n          "phrase_slop" : 0,\n          "escape" : false,\n          "auto_generate_synonyms_phrase_query" : true,\n          "fuzzy_transpositions" : true,\n          "boost" : 1.0\n        }\n      }\n    ],\n    "adjust_pure_negative" : true,\n    "boost" : 1.0\n  }\n}')

.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/base.py:125: RequestError
------------------------------ Captured log setup ------------------------------
WARNING  elasticsearch:base.py:97 PUT http://elasticsearch:9200/test-weko-item-v1.0.0/_alias/test-weko [status:400 request:0.006s]
------------------------------ Captured log call -------------------------------
WARNING  elasticsearch:base.py:97 GET http://elasticsearch:9200/test-weko/_search?preference=4a4d20d732cd9f789541e54dd9eb6af8&version=false [status:400 request:0.011s]
__________________________ test_unpackage_import_file __________________________

app = <Flask 'testapp'>
db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>
mocker = <pytest_mock.plugin.MockerFixture object at 0x7ff2ffe467f0>
mocker_itemtype = None

    def test_unpackage_import_file(app, db,mocker, mocker_itemtype):
        filepath = os.path.join(
            os.path.dirname(os.path.realpath(__file__)), "data", "item_map.json"
        )
        with open(filepath, encoding="utf-8") as f:
            item_map = json.load(f)
        filepath = os.path.join(
            os.path.dirname(os.path.realpath(__file__)), "data", "item_type_mapping.json"
        )
        with open(filepath, encoding="utf-8") as f:
            item_type_mapping = json.load(f)
        mocker.patch("weko_records.serializers.utils.get_mapping", return_value=item_map)
        mocker.patch("weko_records.api.Mapping.get_record", return_value=item_type_mapping)
    
        filepath = os.path.join(
            os.path.dirname(os.path.realpath(__file__)),
            "data",
            "unpackage_import_file/result.json",
        )
        with open(filepath, encoding="utf-8") as f:
            result = json.load(f)
    
        filepath = os.path.join(
            os.path.dirname(os.path.realpath(__file__)),
            "data",
            "unpackage_import_file/result_force_new.json",
        )
        with open(filepath, encoding="utf-8") as f:
            result_force_new = json.load(f)
    
        path = os.path.join(
            os.path.dirname(os.path.realpath(__file__)), "data", "unpackage_import_file"
        )
        with app.test_request_context():
            with set_locale("en"):
>               assert unpackage_import_file(path, "items.csv", "csv", False) == result
E               AssertionError: assert [{'$schema': ...ac.jp'], ...}] == [{'$schema': ...ac.jp'], ...}]
E                 At index 0 diff: {'pos_index': ['Index A'], 'publish_status': 'public', 'feedback_mail': ['wekosoftware@nii.ac.jp'], 'edit_mode': 'Keep', 'metadata': {'pubdate': '2021-03-19', 'item_1617186331708': [{'subitem_1551255647225': 'ja_conference paperITEM00000001(public_open_access_open_access_simple)', 'subitem_1551255648112': 'ja'}, {'subitem_1551255647225': 'en_conference paperITEM00000001(public_open_access_simple)', 'subitem_1551255648112': 'en'}], 'item_1617186385884': [{'subitem_1551255720400': 'Alternative Title', 'subitem_1551255721061': 'en'}, {'subitem_155125572040...
E                 
E                 ...Full output truncated (569 lines hidden), use '-vv' to show

tests/test_utils.py:379: AssertionError
_____________________________ test_read_stats_file _____________________________

self = <sqlalchemy.engine.base.Connection object at 0x7ff2ff5e66a0>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff2ff756278>
constructor = <bound method DefaultExecutionContext._init_compiled of <class 'sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2'>>
statement = 'SELECT item_type.created AS item_type_created, item_type.updated AS item_type_updated, item_type.id AS item_type_id, ...AS item_type_version_id, item_type.is_deleted AS item_type_is_deleted \nFROM item_type \nWHERE item_type.id = %(id_1)s'
parameters = {'id_1': 'test'}
args = (<sqlalchemy.dialects.postgresql.psycopg2.PGCompiler_psycopg2 object at 0x7ff2ff705630>, [immutabledict({})])
conn = <sqlalchemy.pool._ConnectionFairy object at 0x7ff2ff5e67f0>
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7ff2ff7052b0>

    def _execute_context(
        self, dialect, constructor, statement, parameters, *args
    ):
        """Create an :class:`.ExecutionContext` and execute, returning
        a :class:`.ResultProxy`."""
    
        try:
            try:
                conn = self.__connection
            except AttributeError:
                # escape "except AttributeError" before revalidating
                # to prevent misleading stacktraces in Py3K
                conn = None
            if conn is None:
                conn = self._revalidate_connection()
    
            context = constructor(dialect, self, conn, *args)
        except BaseException as e:
            self._handle_dbapi_exception(
                e, util.text_type(statement), parameters, None, None
            )
    
        if context.compiled:
            context.pre_exec()
    
        cursor, statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        if not context.executemany:
            parameters = parameters[0]
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                statement, parameters = fn(
                    self,
                    cursor,
                    statement,
                    parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self.engine.logger.info(statement)
            self.engine.logger.info(
                "%r", sql_util._repr_params(parameters, batches=10)
            )
    
        evt_handled = False
        try:
            if context.executemany:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(cursor, statement, parameters, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor, statement, parameters, context
                    )
            elif not parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, statement, context
                    )
            else:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(cursor, statement, parameters, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute(
>                       cursor, statement, parameters, context
                    )

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1236: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff2ff756278>
cursor = <cursor object at 0x7ff302abd710; closed: -1>
statement = 'SELECT item_type.created AS item_type_created, item_type.updated AS item_type_updated, item_type.id AS item_type_id, ...AS item_type_version_id, item_type.is_deleted AS item_type_is_deleted \nFROM item_type \nWHERE item_type.id = %(id_1)s'
parameters = {'id_1': 'test'}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7ff2ff7052b0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       psycopg2.DataError: invalid input syntax for type integer: "test"
E       LINE 3: WHERE item_type.id = 'test'
E                                    ^

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:536: DataError

The above exception was the direct cause of the following exception:

i18n_app = <Flask 'testapp'>
db_itemtype = {'item_type': <ItemType 1>, 'item_type_mapping': <ItemTypeMapping 1>, 'item_type_name': <ItemTypeName 1>}
users = [{'email': 'noroleuser@test.org', 'id': 9, 'obj': <User 9>}, {'email': 'contributor@test.org', 'id': 2, 'obj': <User 2...ail': 'comadmin@test.org', 'id': 3, 'obj': <User 3>}, {'email': 'generaluser@test.org', 'id': 6, 'obj': <User 5>}, ...]

    def test_read_stats_file(i18n_app, db_itemtype, users):
        current_path = os.path.dirname(os.path.abspath(__file__))
        file_name_tsv = "sample_tsv.tsv"
        file_path_tsv = os.path.join(current_path, "data", "sample_file", file_name_tsv)
    
        file_name_csv = "sample_csv.csv"
        file_path_csv = os.path.join(current_path, "data", "sample_file", file_name_csv)
    
        file_name_tsv_2 = "sample_tsv_2.tsv"
        file_path_tsv_2 = os.path.join(current_path, "data", "sample_file", file_name_tsv_2)
    
        check_item_type = {
            "schema": "test",
            "is_lastest": "test",
            "name": "test",
            "item_type_id": "test",
        }
    
        with patch("flask_login.utils._get_user", return_value=users[3]["obj"]):
            with patch("weko_search_ui.utils.get_item_type", return_value=check_item_type):
>               assert read_stats_file(file_path_tsv, file_name_tsv, "tsv")

tests/test_utils.py:432: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
weko_search_ui/utils.py:867: in read_stats_file
    raise ex
weko_search_ui/utils.py:790: in read_stats_file
    check_item_type.get("item_type_id")
weko_search_ui/utils.py:3171: in handle_get_all_id_in_item_type
    item_type = ItemTypes.get_by_id(id_=item_type_id, with_deleted=True)
../weko-records/weko_records/api.py:640: in get_by_id
    return query.one_or_none()
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3008: in one_or_none
    ret = list(self)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3081: in __iter__
    return self._execute_and_instances(context)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3106: in _execute_and_instances
    result = conn.execute(querycontext.statement, self._params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:980: in execute
    return meth(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/sql/elements.py:273: in _execute_on_connection
    return connection._execute_clauseelement(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1099: in _execute_clauseelement
    distilled_params,
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1240: in _execute_context
    e, statement, parameters, cursor, context
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1458: in _handle_dbapi_exception
    util.raise_from_cause(sqlalchemy_exception, exc_info)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:296: in raise_from_cause
    reraise(type(exception), exception, tb=exc_tb, cause=cause)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:276: in reraise
    raise value.with_traceback(tb)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1236: in _execute_context
    cursor, statement, parameters, context
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff2ff756278>
cursor = <cursor object at 0x7ff302abd710; closed: -1>
statement = 'SELECT item_type.created AS item_type_created, item_type.updated AS item_type_updated, item_type.id AS item_type_id, ...AS item_type_version_id, item_type.is_deleted AS item_type_is_deleted \nFROM item_type \nWHERE item_type.id = %(id_1)s'
parameters = {'id_1': 'test'}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7ff2ff7052b0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.DataError: (psycopg2.DataError) invalid input syntax for type integer: "test"
E       LINE 3: WHERE item_type.id = 'test'
E                                    ^
E        [SQL: 'SELECT item_type.created AS item_type_created, item_type.updated AS item_type_updated, item_type.id AS item_type_id, item_type.name_id AS item_type_name_id, item_type.harvesting_type AS item_type_harvesting_type, item_type.schema AS item_type_schema, item_type.form AS item_type_form, item_type.render AS item_type_render, item_type.tag AS item_type_tag, item_type.version_id AS item_type_version_id, item_type.is_deleted AS item_type_is_deleted \nFROM item_type \nWHERE item_type.id = %(id_1)s'] [parameters: {'id_1': 'test'}] (Background on this error at: http://sqlalche.me/e/9h9h)

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:536: DataError
_________________________ test_register_item_metadata __________________________

i18n_app = <Flask 'testapp'>, es_item_file_pipeline = None
deposit = {'title': 'fuu', '$schema': 'https://inveniosoftware.org/schemas/deposits/deposit-v1.0.0.json', '_deposit': {'id': '696e456fe8784420890658df66bc1f28', 'status': 'draft', 'owners': [9], 'created_by': 9}}
es_records = {'indexer': <weko_deposit.api.WekoIndexer object at 0x7ff3030c0550>, 'results': [{'depid': <PersistentIdentifier depid...stentIdentifier hdl:https://hdl.handle.net/0000/0000000005 / rec:ba2d01dd-9337-4f12-a578-08ffe3e3af06 (R)>, ...}, ...]}

    def test_register_item_metadata(i18n_app, es_item_file_pipeline, deposit, es_records):
        item = es_records["results"][0]["item"]
        root_path = os.path.dirname(os.path.abspath(__file__))
    
        with patch("invenio_files_rest.utils.find_and_update_location_size"):
>           assert register_item_metadata(item, root_path, is_gakuninrdm=False)
E           TypeError: register_item_metadata() missing 1 required positional argument: 'owner'

tests/test_utils.py:684: TypeError
------------------------------ Captured log setup ------------------------------
WARNING  elasticsearch:base.py:97 PUT http://elasticsearch:9200/test-weko-item-v1.0.0/_alias/test-weko [status:400 request:0.006s]
______________________ test_send_item_created_event_to_es ______________________

i18n_app = <Flask 'testapp'>, es_item_file_pipeline = None
es_records = {'indexer': <weko_deposit.api.WekoIndexer object at 0x7ff300fc1780>, 'results': [{'depid': <PersistentIdentifier depid...stentIdentifier hdl:https://hdl.handle.net/0000/0000000005 / rec:0269f103-0bef-4b9c-be5c-d7ed4fb207e0 (R)>, ...}, ...]}
client_request_args = <Response streamed [200 OK]>
users = [{'email': 'noroleuser@test.org', 'id': 9, 'obj': <User 9>}, {'email': 'contributor@test.org', 'id': 2, 'obj': <User 2...ail': 'comadmin@test.org', 'id': 3, 'obj': <User 3>}, {'email': 'generaluser@test.org', 'id': 6, 'obj': <User 5>}, ...]
es = <Elasticsearch([{'host': 'elasticsearch'}])>

    def test_send_item_created_event_to_es(
        i18n_app, es_item_file_pipeline, es_records, client_request_args, users, es
    ):
        # with patch("weko_search_ui.utils.send_item_created_event_to_es._push_item_to_elasticsearch", return_value=""):
        # with patch("weko_search_ui.utils._push_item_to_elasticsearch", return_value=""):
        item = es_records["results"][0]["item"]
        request_info = {
            "remote_addr": request.remote_addr,
            "referrer": request.referrer,
            "hostname": request.host,
            "user_id": 1,
        }
    
>       send_item_created_event_to_es(item, request_info)

tests/test_utils.py:747: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
weko_search_ui/utils.py:1500: in send_item_created_event_to_es
    _push_item_to_elasticsearch(id, index, doc_type, data)
weko_search_ui/utils.py:1491: in _push_item_to_elasticsearch
    indexer.client.index(index=index, doc_type=doc_type, id=id, body=data)
.tox/c1/lib/python3.6/site-packages/elasticsearch/client/utils.py:76: in _wrapped
    return func(*args, params=params, **kwargs)
.tox/c1/lib/python3.6/site-packages/elasticsearch/client/__init__.py:300: in index
    _make_path(index, doc_type, id), params=params, body=body)
.tox/c1/lib/python3.6/site-packages/elasticsearch/transport.py:314: in perform_request
    status, headers_response, data = connection.perform_request(method, url, params, body, headers=headers, ignore=ignore, timeout=timeout)
.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/http_requests.py:90: in perform_request
    self._raise_error(response.status_code, raw_data)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <RequestsHttpConnection: http://elasticsearch:9200>, status_code = 400
raw_data = '{"error":{"root_cause":[{"type":"invalid_index_name_exception","reason":"Invalid index name [-events-stats-item-creat...e], must not start with \'_\', \'-\', or \'+\'","index_uuid":"_na_","index":"-events-stats-item-create"},"status":400}'

    def _raise_error(self, status_code, raw_data):
        """ Locate appropriate exception and raise it. """
        error_message = raw_data
        additional_info = None
        try:
            if raw_data:
                additional_info = json.loads(raw_data)
                error_message = additional_info.get('error', error_message)
                if isinstance(error_message, dict) and 'type' in error_message:
                    error_message = error_message['type']
        except (ValueError, TypeError) as err:
            logger.warning('Undecodable raw error response from server: %s', err)
    
>       raise HTTP_EXCEPTIONS.get(status_code, TransportError)(status_code, error_message, additional_info)
E       elasticsearch.exceptions.RequestError: TransportError(400, 'invalid_index_name_exception', "Invalid index name [-events-stats-item-create], must not start with '_', '-', or '+'")

.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/base.py:125: RequestError
------------------------------ Captured log setup ------------------------------
WARNING  elasticsearch:base.py:97 PUT http://elasticsearch:9200/test-weko-item-v1.0.0/_alias/test-weko [status:400 request:0.006s]
ERROR    flask.app:receivers.py:39 Error building event
Traceback (most recent call last):
  File "/code/modules/invenio-stats/invenio_stats/receivers.py", line 31, in __call__
    if self.name in current_stats.events:
  File "/code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py", line 348, in __getattr__
    return getattr(self._get_current_object(), name)
  File "/code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/werkzeug/utils.py", line 91, in __get__
    value = self.func(obj)
  File "/code/modules/invenio-stats/invenio_stats/ext.py", line 79, in events
    queue = current_queues.queues[
  File "/code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/werkzeug/local.py", line 348, in __getattr__
    return getattr(self._get_current_object(), name)
AttributeError: 'int' object has no attribute 'queues'
------------------------------ Captured log call -------------------------------
WARNING  elasticsearch:base.py:97 PUT http://elasticsearch:9200/-events-stats-item-create/stats-item-create/2023-07-25+08%3A12%3A14-552e9043c7efd979f1b28d90f33c2bc4478c14cf [status:400 request:0.004s]
_________________________ test_import_items_to_system __________________________

item = {'id': '1', 'cnri': 'cnricnricnri', 'cnri_suffix_not_existed': 'cnri_suffix_not_existed', 'is_change_identifier': 'is_...'item_1617258105262': {'resourceuri': 'http://purl.org/coar/resource_type/c_5794', 'resourcetype': 'conference paper'}}
request_info = {'hostname': 'TEST_SERVER', 'referrer': None, 'remote_addr': None, 'user_id': 1}
is_gakuninrdm = False

    def import_items_to_system(item: dict, request_info=None, is_gakuninrdm=False):
        """Validation importing zip file.
    
        :argument
            item        -- Items Metadata.
            request_info -- Information from request.
            is_gakuninrdm - Is call by gakuninrdm api.
        :return
            return      -- Json response.
    
        """
    
        owner = 1
        if request_info and 'user_id' in request_info:
            owner = request_info['user_id']
        if not request_info and request:
            request_info = {
                "remote_addr": request.remote_addr,
                "referrer": request.referrer,
                "hostname": request.host,
                "user_id": owner
            }
    
        if not item:
            return None
        else:
            bef_metadata = None
            bef_last_ver_metadata = None
            try:
                # current_app.logger.debug("item: {0}".format(item))
                status = item.get("status")
                root_path = item.get("root_path", "")
                if status == "new":
                    item_id = create_deposit(item.get("id"))
                    item["id"] = item_id
                else:
                    handle_check_item_is_locked(item)
                    # cache ES data for rollback
                    pid = PersistentIdentifier.query.filter_by(
                        pid_type="recid", pid_value=item["id"]
                    ).first()
                    bef_metadata = WekoIndexer().get_metadata_by_item_id(pid.object_uuid)
                    bef_last_ver_metadata = WekoIndexer().get_metadata_by_item_id(
                        PIDVersioning(child=pid).last_child.object_uuid
                    )
    
                register_item_metadata(item, root_path, owner, is_gakuninrdm)
                if not is_gakuninrdm:
                    if current_app.config.get("WEKO_HANDLE_ALLOW_REGISTER_CNRI"):
                        register_item_handle(item)
                    register_item_doi(item)
    
                    status_number = WEKO_IMPORT_PUBLISH_STATUS.index(
                        item.get("publish_status")
                    )
                    register_item_update_publish_status(item, str(status_number))
                    if item.get("status") == "new":
                        # Send item_created event to ES.
>                       send_item_created_event_to_es(item, request_info)

weko_search_ui/utils.py:1561: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

item = {'id': '1', 'cnri': 'cnricnricnri', 'cnri_suffix_not_existed': 'cnri_suffix_not_existed', 'is_change_identifier': 'is_...'item_1617258105262': {'resourceuri': 'http://purl.org/coar/resource_type/c_5794', 'resourcetype': 'conference paper'}}
request_info = {'hostname': 'TEST_SERVER', 'referrer': None, 'remote_addr': None, 'user_id': 1}

    def send_item_created_event_to_es(item, request_info):
        """Send item_created event to ES."""
        def _prepare_stored_data(item, request_info):
            """Prepare stored data."""
            # TODO: consider to use "weko_deposit.signals.item_created."
            timestamp = datetime.utcnow().replace(microsecond=0)
            doc = {
                "ip_address": request_info.get("remote_addr"),
                "timestamp": timestamp.isoformat(),
            }
            doc = anonymize_user(doc)
            doc = flag_restricted(doc)
            doc = flag_robots(doc)
            item_id = item.get("id") if 'id' in item else item.get("recid", -1)
            data = {
                "remote_addr": request_info.get("remote_addr"),
                "country": doc.get("country"),
                "record_name": item.get("item_title"),
                "referrer": request_info.get("referrer"),
                "is_robot": doc.get("is_robot"),
                "cur_user_id": request_info.get("user_id"),
                "is_restricted": doc.get("is_restricted"),
                "unique_session_id": doc.get("unique_session_id"),
                "hostname": request_info.get("hostname"),
                "pid_value": item_id,
                "unique_id": "item_create_{}".format(item_id),
                "pid_type": "depid",
                "timestamp": doc.get("timestamp"),
                "visitor_id": doc.get("visitor_id"),
            }
            return data
    
        def _push_item_to_elasticsearch(id, index, doc_type, data):
            """Push item to elasticsearch in order to count report."""
            indexer = RecordIndexer()
            indexer.client.index(index=index, doc_type=doc_type, id=id, body=data)
    
        timestamp = datetime.utcnow().replace(microsecond=0)
        # Prepare stored data.
        data = _prepare_stored_data(item, request_info)
        doc_type = "stats-item-create"
        index = "{}-events-{}".format(index_prefix, doc_type)
        id = hash_id(timestamp, data)
        # Save item to stats events.
>       _push_item_to_elasticsearch(id, index, doc_type, data)

weko_search_ui/utils.py:1500: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

id = '2023-07-25 08:14:09-552e9043c7efd979f1b28d90f33c2bc4478c14cf'
index = '-events-stats-item-create', doc_type = 'stats-item-create'
data = {'country': None, 'cur_user_id': 1, 'hostname': 'TEST_SERVER', 'is_restricted': False, ...}

    def _push_item_to_elasticsearch(id, index, doc_type, data):
        """Push item to elasticsearch in order to count report."""
        indexer = RecordIndexer()
>       indexer.client.index(index=index, doc_type=doc_type, id=id, body=data)

weko_search_ui/utils.py:1491: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

args = (<Elasticsearch([{'host': 'elasticsearch'}])>,)
kwargs = {'body': {'country': None, 'cur_user_id': 1, 'hostname': 'TEST_SERVER', 'is_restricted': False, ...}, 'doc_type': 'sta...em-create', 'id': '2023-07-25 08:14:09-552e9043c7efd979f1b28d90f33c2bc4478c14cf', 'index': '-events-stats-item-create'}
params = {}, p = 'request_timeout'

    @wraps(func)
    def _wrapped(*args, **kwargs):
        params = {}
        if 'params' in kwargs:
            params = kwargs.pop('params').copy()
        for p in es_query_params + GLOBAL_PARAMS:
            if p in kwargs:
                v = kwargs.pop(p)
                if v is not None:
                    params[p] = _escape(v)
    
        # don't treat ignore and request_timeout as other params to avoid escaping
        for p in ('ignore', 'request_timeout'):
            if p in kwargs:
                params[p] = kwargs.pop(p)
>       return func(*args, params=params, **kwargs)

.tox/c1/lib/python3.6/site-packages/elasticsearch/client/utils.py:76: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Elasticsearch([{'host': 'elasticsearch'}])>
index = '-events-stats-item-create', doc_type = 'stats-item-create'
body = {'country': None, 'cur_user_id': 1, 'hostname': 'TEST_SERVER', 'is_restricted': False, ...}
id = '2023-07-25 08:14:09-552e9043c7efd979f1b28d90f33c2bc4478c14cf', params = {}

    @query_params('op_type', 'parent', 'pipeline', 'refresh', 'routing',
        'timeout', 'timestamp', 'ttl', 'version', 'version_type',
        'wait_for_active_shards')
    def index(self, index, doc_type, body, id=None, params=None):
        """
        Adds or updates a typed JSON document in a specific index, making it searchable.
        `<http://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html>`_
    
        :arg index: The name of the index
        :arg doc_type: The type of the document
        :arg body: The document
        :arg id: Document ID
        :arg op_type: Explicit operation type, default 'index', valid choices
            are: 'index', 'create'
        :arg parent: ID of the parent document
        :arg pipeline: The pipeline id to preprocess incoming documents with
        :arg refresh: If `true` then refresh the affected shards to make this
            operation visible to search, if `wait_for` then wait for a refresh
            to make this operation visible to search, if `false` (the default)
            then do nothing with refreshes., valid choices are: 'true', 'false',
            'wait_for'
        :arg routing: Specific routing value
        :arg timeout: Explicit operation timeout
        :arg timestamp: Explicit timestamp for the document
        :arg ttl: Expiration time for the document
        :arg version: Explicit version number for concurrency control
        :arg version_type: Specific version type, valid choices are: 'internal',
            'external', 'external_gte', 'force'
        :arg wait_for_active_shards: Sets the number of shard copies that must
            be active before proceeding with the index operation. Defaults to 1,
            meaning the primary shard only. Set to `all` for all shard copies,
            otherwise set to any non-negative value less than or equal to the
            total number of copies for the shard (number of replicas + 1)
        """
        for param in (index, doc_type, body):
            if param in SKIP_IN_PATH:
                raise ValueError("Empty value passed for a required argument.")
        return self.transport.perform_request('POST' if id in SKIP_IN_PATH else 'PUT',
>           _make_path(index, doc_type, id), params=params, body=body)

.tox/c1/lib/python3.6/site-packages/elasticsearch/client/__init__.py:300: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <elasticsearch.transport.Transport object at 0x7ff2fcc6bb70>
method = 'PUT'
url = '/-events-stats-item-create/stats-item-create/2023-07-25+08%3A14%3A09-552e9043c7efd979f1b28d90f33c2bc4478c14cf'
headers = None, params = {}
body = b'{"remote_addr":null,"country":null,"record_name":"item_title","referrer":null,"is_robot":false,"cur_user_id":1,"is_r...pe":"depid","timestamp":"2023-07-25T08:14:09","visitor_id":"8f870350ab4f36757e351abeff18afd4d0e319eb62ee9eb01a0f3b77"}'

    def perform_request(self, method, url, headers=None, params=None, body=None):
        """
        Perform the actual request. Retrieve a connection from the connection
        pool, pass all the information to it's perform_request method and
        return the data.
    
        If an exception was raised, mark the connection as failed and retry (up
        to `max_retries` times).
    
        If the operation was succesful and the connection used was previously
        marked as dead, mark it as live, resetting it's failure count.
    
        :arg method: HTTP method to use
        :arg url: absolute url (without host) to target
        :arg headers: dictionary of headers, will be handed over to the
            underlying :class:`~elasticsearch.Connection` class
        :arg params: dictionary of query parameters, will be handed over to the
            underlying :class:`~elasticsearch.Connection` class for serialization
        :arg body: body of the request, will be serializes using serializer and
            passed to the connection
        """
        if body is not None:
            body = self.serializer.dumps(body)
    
            # some clients or environments don't support sending GET with body
            if method in ('HEAD', 'GET') and self.send_get_body_as != 'GET':
                # send it as post instead
                if self.send_get_body_as == 'POST':
                    method = 'POST'
    
                # or as source parameter
                elif self.send_get_body_as == 'source':
                    if params is None:
                        params = {}
                    params['source'] = body
                    body = None
    
        if body is not None:
            try:
                body = body.encode('utf-8', 'surrogatepass')
            except (UnicodeDecodeError, AttributeError):
                # bytes/str - no need to re-encode
                pass
    
        ignore = ()
        timeout = None
        if params:
            timeout = params.pop('request_timeout', None)
            ignore = params.pop('ignore', ())
            if isinstance(ignore, int):
                ignore = (ignore, )
    
        for attempt in range(self.max_retries + 1):
            connection = self.get_connection()
    
            try:
>               status, headers_response, data = connection.perform_request(method, url, params, body, headers=headers, ignore=ignore, timeout=timeout)

.tox/c1/lib/python3.6/site-packages/elasticsearch/transport.py:314: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <RequestsHttpConnection: http://elasticsearch:9200>, method = 'PUT'
url = 'http://elasticsearch:9200/-events-stats-item-create/stats-item-create/2023-07-25+08%3A14%3A09-552e9043c7efd979f1b28d90f33c2bc4478c14cf'
params = {}
body = b'{"remote_addr":null,"country":null,"record_name":"item_title","referrer":null,"is_robot":false,"cur_user_id":1,"is_r...pe":"depid","timestamp":"2023-07-25T08:14:09","visitor_id":"8f870350ab4f36757e351abeff18afd4d0e319eb62ee9eb01a0f3b77"}'
timeout = None, ignore = (), headers = None

    def perform_request(self, method, url, params=None, body=None, timeout=None, ignore=(), headers=None):
        url = self.base_url + url
        if params:
            url = '%s?%s' % (url, urlencode(params or {}))
    
        start = time.time()
        request = requests.Request(method=method, headers=headers, url=url, data=body)
        prepared_request = self.session.prepare_request(request)
        settings = self.session.merge_environment_settings(prepared_request.url, {}, None, None, None)
        send_kwargs = {'timeout': timeout or self.timeout}
        send_kwargs.update(settings)
        try:
            response = self.session.send(prepared_request, **send_kwargs)
            duration = time.time() - start
            raw_data = response.text
        except Exception as e:
            self.log_request_fail(method, url, prepared_request.path_url, body, time.time() - start, exception=e)
            if isinstance(e, requests.exceptions.SSLError):
                raise SSLError('N/A', str(e), e)
            if isinstance(e, requests.Timeout):
                raise ConnectionTimeout('TIMEOUT', str(e), e)
            raise ConnectionError('N/A', str(e), e)
    
        # raise errors based on http status codes, let the client handle those if needed
        if not (200 <= response.status_code < 300) and response.status_code not in ignore:
            self.log_request_fail(method, url, response.request.path_url, body, duration, response.status_code, raw_data)
>           self._raise_error(response.status_code, raw_data)

.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/http_requests.py:90: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <RequestsHttpConnection: http://elasticsearch:9200>, status_code = 400
raw_data = '{"error":{"root_cause":[{"type":"invalid_index_name_exception","reason":"Invalid index name [-events-stats-item-creat...e], must not start with \'_\', \'-\', or \'+\'","index_uuid":"_na_","index":"-events-stats-item-create"},"status":400}'

    def _raise_error(self, status_code, raw_data):
        """ Locate appropriate exception and raise it. """
        error_message = raw_data
        additional_info = None
        try:
            if raw_data:
                additional_info = json.loads(raw_data)
                error_message = additional_info.get('error', error_message)
                if isinstance(error_message, dict) and 'type' in error_message:
                    error_message = error_message['type']
        except (ValueError, TypeError) as err:
            logger.warning('Undecodable raw error response from server: %s', err)
    
>       raise HTTP_EXCEPTIONS.get(status_code, TransportError)(status_code, error_message, additional_info)
E       elasticsearch.exceptions.RequestError: TransportError(400, 'invalid_index_name_exception', "Invalid index name [-events-stats-item-create], must not start with '_', '-', or '+'")

.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/base.py:125: RequestError

During handling of the above exception, another exception occurred:

i18n_app = <Flask 'testapp'>, es_item_file_pipeline = None
es_records = {'indexer': <weko_deposit.api.WekoIndexer object at 0x7ff2feb7c0f0>, 'results': [{'depid': <PersistentIdentifier depid...stentIdentifier hdl:https://hdl.handle.net/0000/0000000005 / rec:cd05cf22-3ad3-48f7-8eef-c423251d5c11 (R)>, ...}, ...]}

    def test_import_items_to_system(i18n_app, es_item_file_pipeline, es_records):
        # item = dict(db_activity['item'])
        item = es_records["results"][0]["item"]
    
        with patch("weko_search_ui.utils.register_item_metadata", return_value={}):
            with patch("weko_search_ui.utils.register_item_doi", return_value={}):
                with patch(
                    "weko_search_ui.utils.register_item_update_publish_status",
                    return_value={},
                ):
                    with patch(
                        "weko_search_ui.utils.create_deposit", return_value=item["id"]
                    ):
                        with patch(
                            "weko_search_ui.utils.send_item_created_event_to_es",
                            return_value=item["id"],
                        ):
                            with patch(
                                "weko_workflow.utils.get_cache_data", return_value=True
                            ):
                                assert import_items_to_system(item)
                                item["status"] = "new"
                                assert import_items_to_system(item)
    
>                       assert import_items_to_system(
                            item
                        )  # Will result in error but will cover exception part

tests/test_utils.py:775: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
weko_search_ui/utils.py:1602: in import_items_to_system
    current_app.logger.error("elasticsearch  error: ", ex)
/usr/local/lib/python3.6/logging/__init__.py:1337: in error
    self._log(ERROR, msg, args, **kwargs)
/usr/local/lib/python3.6/logging/__init__.py:1444: in _log
    self.handle(record)
/usr/local/lib/python3.6/logging/__init__.py:1454: in handle
    self.callHandlers(record)
/usr/local/lib/python3.6/logging/__init__.py:1516: in callHandlers
    hdlr.handle(record)
/usr/local/lib/python3.6/logging/__init__.py:865: in handle
    self.emit(record)
.tox/c1/lib/python3.6/site-packages/_pytest/logging.py:328: in emit
    super().emit(record)
/usr/local/lib/python3.6/logging/__init__.py:1000: in emit
    self.handleError(record)
/usr/local/lib/python3.6/logging/__init__.py:994: in emit
    msg = self.format(record)
/usr/local/lib/python3.6/logging/__init__.py:840: in format
    return fmt.format(record)
.tox/c1/lib/python3.6/site-packages/_pytest/logging.py:89: in format
    return super().format(record)
/usr/local/lib/python3.6/logging/__init__.py:577: in format
    record.message = record.getMessage()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <LogRecord: flask.app, 40, /code/modules/weko-search-ui/weko_search_ui/utils.py, 1602, "elasticsearch  error: ">

    def getMessage(self):
        """
        Return the message for this LogRecord.
    
        Return the message for this LogRecord after merging any user-supplied
        arguments with the message.
        """
        msg = str(self.msg)
        if self.args:
>           msg = msg % self.args
E           TypeError: not all arguments converted during string formatting

/usr/local/lib/python3.6/logging/__init__.py:338: TypeError
------------------------------ Captured log setup ------------------------------
WARNING  elasticsearch:base.py:97 PUT http://elasticsearch:9200/test-weko-item-v1.0.0/_alias/test-weko [status:400 request:0.004s]
------------------------------ Captured log call -------------------------------
ERROR    flask.app:api.py:91 Traceback (most recent call last):
  File "/code/modules/weko-handle/weko_handle/api.py", line 62, in register_handle
    self.credential_path)
  File "/code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/b2handle/clientcredentials.py", line 54, in load_from_JSON
    jsonfilecontent = json.loads(open(json_filename, 'r').read())
TypeError: expected str, bytes or os.PathLike object, not NoneType

ERROR    flask.app:api.py:92 expected str, bytes or os.PathLike object, not NoneType
ERROR    flask.app:api.py:91 Traceback (most recent call last):
  File "/code/modules/weko-handle/weko_handle/api.py", line 62, in register_handle
    self.credential_path)
  File "/code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/b2handle/clientcredentials.py", line 54, in load_from_JSON
    jsonfilecontent = json.loads(open(json_filename, 'r').read())
TypeError: expected str, bytes or os.PathLike object, not NoneType

ERROR    flask.app:api.py:92 expected str, bytes or os.PathLike object, not NoneType
ERROR    flask.app:api.py:91 Traceback (most recent call last):
  File "/code/modules/weko-handle/weko_handle/api.py", line 62, in register_handle
    self.credential_path)
  File "/code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/b2handle/clientcredentials.py", line 54, in load_from_JSON
    jsonfilecontent = json.loads(open(json_filename, 'r').read())
TypeError: expected str, bytes or os.PathLike object, not NoneType

ERROR    flask.app:api.py:92 expected str, bytes or os.PathLike object, not NoneType
WARNING  elasticsearch:base.py:97 PUT http://elasticsearch:9200/-events-stats-item-create/stats-item-create/2023-07-25+08%3A14%3A09-552e9043c7efd979f1b28d90f33c2bc4478c14cf [status:400 request:0.007s]
___________________ test_handle_check_and_prepare_index_tree ___________________

i18n_app = <Flask 'testapp'>
record_with_metadata = [{'$schema': 'https://localhost:8443/items/jsonschema/15', 'doi_ra': 'JaLC', 'edit_mode': 'Keep', 'errors': None, ...}...chema': 'https://localhost:8443/items/jsonschema/15', 'doi_ra': 'JaLC', 'edit_mode': 'Keep', 'errors': None, ...}, ...]
indices = {'index_dict': {'biblio_flag': False, 'browsing_group': '', 'browsing_role': 'Contributor', 'comment': '', ...}, 'index_non_dict': <Index 33>, 'index_non_dict_child': <Index 44>}

    def test_handle_check_and_prepare_index_tree(i18n_app, record_with_metadata, indices):
        list_record = [record_with_metadata[0]]
        can_edit_indexes = [indices["index_dict"]]
        item_2 = record_with_metadata[0]
    
        all_index_permission = False
>       assert not handle_check_and_prepare_index_tree(
            list_record, all_index_permission, can_edit_indexes
        )

tests/test_utils.py:808: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
weko_search_ui/utils.py:1836: in handle_check_and_prepare_index_tree
    _index_ids = check(index_id, index_name_path)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

index_id = 1658883231990, index_name_path = 'IndexA'

    def check(index_id, index_name_path):
        """Check index_id/index_name.
    
        Args:
            index_id (str): Index id.
            index_name_path (str): Index name path.
    
        Returns:
            [bool]: Check result.
    
        """
        temp_res = []
        index_info = None
        try:
            index_info = Indexes.get_path_list([index_id])
        except Exception:
            db.session.rollback()
            current_app.logger.warning("Specified IndexID is invalid!")
    
        msg_not_exist = _("The specified {} does not exist in system.")
        if index_info and len(index_info) == 1:     # index exists by index id
            if index_name_path and index_name_path not in [
                index_info[0].name.replace(
                    '-/-', current_app.config['WEKO_ITEMS_UI_INDEX_PATH_SPLIT']),
                index_info[0].name_en.replace(
                    '-/-', current_app.config['WEKO_ITEMS_UI_INDEX_PATH_SPLIT']),
            ]:
                warnings.append(
                    _("Specified {} does not match with existing index.").format(
                        "POS_INDEX"
                    )
                )
            temp_res = [index_info[0].cid]
        elif index_name_path:          # has pos_index info
            index_path_list = index_name_path.split(
>               current_app.config['WEKO_ITEMS_UI_INDEX_PATH_SPLIT'])
E           KeyError: 'WEKO_ITEMS_UI_INDEX_PATH_SPLIT'

weko_search_ui/utils.py:1774: KeyError
_________________ test_handle_check_and_prepare_feedback_mail __________________

i18n_app = <Flask 'testapp'>
record_with_metadata = [{'$schema': 'https://localhost:8443/items/jsonschema/15', 'doi_ra': 'JaLC', 'edit_mode': 'Keep', 'errors': None, ...}...chema': 'https://localhost:8443/items/jsonschema/15', 'doi_ra': 'JaLC', 'edit_mode': 'Keep', 'errors': None, ...}, ...]

    def test_handle_check_and_prepare_feedback_mail(i18n_app, record_with_metadata):
        list_record = [record_with_metadata[0]]
    
        # Doesn't return any value
>       assert not handle_check_and_prepare_feedback_mail(list_record)

tests/test_utils.py:837: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
weko_search_ui/utils.py:1873: in handle_check_and_prepare_feedback_mail
    email_checked = check_email_existed(mail)
../weko-authors/weko_authors/utils.py:90: in check_email_existed
    body=body
.tox/c1/lib/python3.6/site-packages/elasticsearch/client/utils.py:76: in _wrapped
    return func(*args, params=params, **kwargs)
.tox/c1/lib/python3.6/site-packages/elasticsearch/client/__init__.py:636: in search
    doc_type, '_search'), params=params, body=body)
.tox/c1/lib/python3.6/site-packages/elasticsearch/transport.py:314: in perform_request
    status, headers_response, data = connection.perform_request(method, url, params, body, headers=headers, ignore=ignore, timeout=timeout)
.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/http_requests.py:90: in perform_request
    self._raise_error(response.status_code, raw_data)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <RequestsHttpConnection: http://elasticsearch:9200>, status_code = 404
raw_data = '{"error":{"root_cause":[{"type":"index_not_found_exception","reason":"no such index","resource.type":"index_or_alias"...index","resource.type":"index_or_alias","resource.id":"-authors","index_uuid":"_na_","index":"-authors"},"status":404}'

    def _raise_error(self, status_code, raw_data):
        """ Locate appropriate exception and raise it. """
        error_message = raw_data
        additional_info = None
        try:
            if raw_data:
                additional_info = json.loads(raw_data)
                error_message = additional_info.get('error', error_message)
                if isinstance(error_message, dict) and 'type' in error_message:
                    error_message = error_message['type']
        except (ValueError, TypeError) as err:
            logger.warning('Undecodable raw error response from server: %s', err)
    
>       raise HTTP_EXCEPTIONS.get(status_code, TransportError)(status_code, error_message, additional_info)
E       elasticsearch.exceptions.NotFoundError: TransportError(404, 'index_not_found_exception', 'no such index')

.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/base.py:125: NotFoundError
------------------------------ Captured log call -------------------------------
WARNING  elasticsearch:base.py:97 GET http://elasticsearch:9200/-authors/author-v1.0.0/_search [status:404 request:0.005s]
____________________________ test_handle_check_cnri ____________________________

i18n_app = <Flask 'testapp'>

    def test_handle_check_cnri(i18n_app):
        item = MagicMock()
        # item = {
        #     "id": 1,
        #     "cnri": None,
        #     "is_change_identifier": True
        # }
        # Doesn't return any value
>       assert not handle_check_cnri([item])

tests/test_utils.py:871: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
weko_search_ui/utils.py:1931: in handle_check_cnri
    if prefix != Handle().get_prefix():
../weko-handle/weko_handle/api.py:97: in get_prefix
    return PIDClientCredentials.load_from_JSON(self.credential_path).get_prefix()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

json_filename = None

    @staticmethod
    def load_from_JSON(json_filename):
        '''
        Create a new instance of a PIDClientCredentials with information read
        from a local JSON file.
    
        :param json_filename: The path to the json credentials file. The json
            file should have the following format:
    
                .. code:: json
    
                    {
                        "handle_server_url": "https://url.to.your.handle.server",
                        "username": "index:prefix/suffix",
                        "password": "ZZZZZZZ",
                        "prefix": "prefix_to_use_for_writing_handles",
                        "handleowner": "username_to_own_handles"
                    }
    
            Any additional key-value-pairs are stored in the instance as
            config.
        :raises: :exc:`~b2handle.handleexceptions.CredentialsFormatError`
        :raises: :exc:`~b2handle.handleexceptions.HandleSyntaxError`
        :return: An instance.
        '''
        try:
>           jsonfilecontent = json.loads(open(json_filename, 'r').read())
E           TypeError: expected str, bytes or os.PathLike object, not NoneType

.tox/c1/lib/python3.6/site-packages/b2handle/clientcredentials.py:54: TypeError
____________________________ test_handle_check_doi _____________________________

value = <MagicMock name='mock.pid_recid.object_uuid' id='140681526843656'>

    @staticmethod
    def _coerce(value):
        if value and not isinstance(value, uuid.UUID):
            try:
>               value = uuid.UUID(value)

.tox/c1/lib/python3.6/site-packages/sqlalchemy_utils/types/uuid.py:56: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <[AttributeError("'UUID' object has no attribute 'int'",) raised in repr()] UUID object at 0x7ff2f86ea2e8>
hex = <MagicMock name='mock.pid_recid.object_uuid.replace().replace().strip().replace()' id='140681529542528'>
bytes = None, bytes_le = None, fields = None, int = None, version = None

    def __init__(self, hex=None, bytes=None, bytes_le=None, fields=None,
                       int=None, version=None):
        r"""Create a UUID from either a string of 32 hexadecimal digits,
        a string of 16 bytes as the 'bytes' argument, a string of 16 bytes
        in little-endian order as the 'bytes_le' argument, a tuple of six
        integers (32-bit time_low, 16-bit time_mid, 16-bit time_hi_version,
        8-bit clock_seq_hi_variant, 8-bit clock_seq_low, 48-bit node) as
        the 'fields' argument, or a single 128-bit integer as the 'int'
        argument.  When a string of hex digits is given, curly braces,
        hyphens, and a URN prefix are all optional.  For example, these
        expressions all yield the same UUID:
    
        UUID('{12345678-1234-5678-1234-567812345678}')
        UUID('12345678123456781234567812345678')
        UUID('urn:uuid:12345678-1234-5678-1234-567812345678')
        UUID(bytes='\x12\x34\x56\x78'*4)
        UUID(bytes_le='\x78\x56\x34\x12\x34\x12\x78\x56' +
                      '\x12\x34\x56\x78\x12\x34\x56\x78')
        UUID(fields=(0x12345678, 0x1234, 0x5678, 0x12, 0x34, 0x567812345678))
        UUID(int=0x12345678123456781234567812345678)
    
        Exactly one of 'hex', 'bytes', 'bytes_le', 'fields', or 'int' must
        be given.  The 'version' argument is optional; if given, the resulting
        UUID will have its variant and version set according to RFC 4122,
        overriding the given 'hex', 'bytes', 'bytes_le', 'fields', or 'int'.
        """
    
        if [hex, bytes, bytes_le, fields, int].count(None) != 4:
            raise TypeError('one of the hex, bytes, bytes_le, fields, '
                            'or int arguments must be given')
        if hex is not None:
            hex = hex.replace('urn:', '').replace('uuid:', '')
            hex = hex.strip('{}').replace('-', '')
            if len(hex) != 32:
>               raise ValueError('badly formed hexadecimal UUID string')
E               ValueError: badly formed hexadecimal UUID string

/usr/local/lib/python3.6/uuid.py:140: ValueError

During handling of the above exception, another exception occurred:

self = <sqlalchemy.engine.base.Connection object at 0x7ff2f8b55400>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff2f8bc1da0>
constructor = <bound method DefaultExecutionContext._init_compiled of <class 'sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2'>>
statement = <sqlalchemy.dialects.postgresql.psycopg2.PGCompiler_psycopg2 object at 0x7ff2f8b55198>
parameters = [immutabledict({})]
args = (<sqlalchemy.dialects.postgresql.psycopg2.PGCompiler_psycopg2 object at 0x7ff2f8b55198>, [immutabledict({})])
conn = <sqlalchemy.pool._ConnectionFairy object at 0x7ff2f86ce860>

    def _execute_context(
        self, dialect, constructor, statement, parameters, *args
    ):
        """Create an :class:`.ExecutionContext` and execute, returning
        a :class:`.ResultProxy`."""
    
        try:
            try:
                conn = self.__connection
            except AttributeError:
                # escape "except AttributeError" before revalidating
                # to prevent misleading stacktraces in Py3K
                conn = None
            if conn is None:
                conn = self._revalidate_connection()
    
>           context = constructor(dialect, self, conn, *args)

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1171: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cls = <class 'sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2'>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff2f8bc1da0>
connection = <sqlalchemy.engine.base.Connection object at 0x7ff2f8b55400>
dbapi_connection = <sqlalchemy.pool._ConnectionFairy object at 0x7ff2f86ce860>
compiled = <sqlalchemy.dialects.postgresql.psycopg2.PGCompiler_psycopg2 object at 0x7ff2f8b55198>
parameters = []

    @classmethod
    def _init_compiled(
        cls, dialect, connection, dbapi_connection, compiled, parameters
    ):
        """Initialize execution context for a Compiled construct."""
    
        self = cls.__new__(cls)
        self.root_connection = connection
        self._dbapi_connection = dbapi_connection
        self.dialect = connection.dialect
    
        self.compiled = compiled
    
        # this should be caught in the engine before
        # we get here
        assert compiled.can_execute
    
        self.execution_options = compiled.execution_options.union(
            connection._execution_options
        )
    
        self.result_column_struct = (
            compiled._result_columns,
            compiled._ordered_columns,
            compiled._textual_ordered_columns,
        )
    
        self.unicode_statement = util.text_type(compiled)
        if not dialect.supports_unicode_statements:
            self.statement = self.unicode_statement.encode(
                self.dialect.encoding
            )
        else:
            self.statement = self.unicode_statement
    
        self.isinsert = compiled.isinsert
        self.isupdate = compiled.isupdate
        self.isdelete = compiled.isdelete
        self.is_text = compiled.isplaintext
    
        if not parameters:
            self.compiled_parameters = [compiled.construct_params()]
        else:
            self.compiled_parameters = [
                compiled.construct_params(m, _group_number=grp)
                for grp, m in enumerate(parameters)
            ]
    
            self.executemany = len(parameters) > 1
    
        self.cursor = self.create_cursor()
    
        if self.isinsert or self.isupdate or self.isdelete:
            self.is_crud = True
            self._is_explicit_returning = bool(compiled.statement._returning)
            self._is_implicit_returning = bool(
                compiled.returning and not compiled.statement._returning
            )
    
        if self.compiled.insert_prefetch or self.compiled.update_prefetch:
            if self.executemany:
                self._process_executemany_defaults()
            else:
                self._process_executesingle_defaults()
    
        processors = compiled._bind_processors
    
        if compiled.contains_expanding_parameters:
            positiontup = self._expand_in_parameters(compiled, processors)
        elif compiled.positional:
            positiontup = self.compiled.positiontup
    
        # Convert the dictionary of bind parameter values
        # into a dict or list to be sent to the DBAPI's
        # execute() or executemany() method.
        parameters = []
        if compiled.positional:
            for compiled_params in self.compiled_parameters:
                param = []
                for key in positiontup:
                    if key in processors:
                        param.append(processors[key](compiled_params[key]))
                    else:
                        param.append(compiled_params[key])
                parameters.append(dialect.execute_sequence_format(param))
        else:
            encode = not dialect.supports_unicode_statements
            for compiled_params in self.compiled_parameters:
    
                if encode:
                    param = dict(
                        (
                            dialect._encoder(key)[0],
                            processors[key](compiled_params[key])
                            if key in processors
                            else compiled_params[key],
                        )
                        for key in compiled_params
                    )
                else:
                    param = dict(
                        (
                            key,
                            processors[key](compiled_params[key])
                            if key in processors
                            else compiled_params[key],
                        )
>                       for key in compiled_params
                    )

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:729: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

.0 = <dict_keyiterator object at 0x7ff2f80b5d68>

        (
            key,
            processors[key](compiled_params[key])
            if key in processors
            else compiled_params[key],
        )
>       for key in compiled_params
    )

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:729: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

value = <MagicMock name='mock.pid_recid.object_uuid' id='140681526843656'>

    def process(value):
>       return impl_processor(process_param(value, dialect))

.tox/c1/lib/python3.6/site-packages/sqlalchemy/sql/type_api.py:1189: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = UUIDType()
value = <MagicMock name='mock.pid_recid.object_uuid' id='140681526843656'>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff2f8bc1da0>

    def process_bind_param(self, value, dialect):
        if value is None:
            return value
    
        if not isinstance(value, uuid.UUID):
>           value = self._coerce(value)

.tox/c1/lib/python3.6/site-packages/sqlalchemy_utils/types/uuid.py:68: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

value = <MagicMock name='mock.pid_recid.object_uuid' id='140681526843656'>

    @staticmethod
    def _coerce(value):
        if value and not isinstance(value, uuid.UUID):
            try:
                value = uuid.UUID(value)
    
            except (TypeError, ValueError):
>               value = uuid.UUID(bytes=value)

.tox/c1/lib/python3.6/site-packages/sqlalchemy_utils/types/uuid.py:59: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <[AttributeError("'UUID' object has no attribute 'int'",) raised in repr()] UUID object at 0x7ff2f8441828>
hex = None
bytes = <MagicMock name='mock.pid_recid.object_uuid' id='140681526843656'>
bytes_le = None, fields = None, int = None, version = None

    def __init__(self, hex=None, bytes=None, bytes_le=None, fields=None,
                       int=None, version=None):
        r"""Create a UUID from either a string of 32 hexadecimal digits,
        a string of 16 bytes as the 'bytes' argument, a string of 16 bytes
        in little-endian order as the 'bytes_le' argument, a tuple of six
        integers (32-bit time_low, 16-bit time_mid, 16-bit time_hi_version,
        8-bit clock_seq_hi_variant, 8-bit clock_seq_low, 48-bit node) as
        the 'fields' argument, or a single 128-bit integer as the 'int'
        argument.  When a string of hex digits is given, curly braces,
        hyphens, and a URN prefix are all optional.  For example, these
        expressions all yield the same UUID:
    
        UUID('{12345678-1234-5678-1234-567812345678}')
        UUID('12345678123456781234567812345678')
        UUID('urn:uuid:12345678-1234-5678-1234-567812345678')
        UUID(bytes='\x12\x34\x56\x78'*4)
        UUID(bytes_le='\x78\x56\x34\x12\x34\x12\x78\x56' +
                      '\x12\x34\x56\x78\x12\x34\x56\x78')
        UUID(fields=(0x12345678, 0x1234, 0x5678, 0x12, 0x34, 0x567812345678))
        UUID(int=0x12345678123456781234567812345678)
    
        Exactly one of 'hex', 'bytes', 'bytes_le', 'fields', or 'int' must
        be given.  The 'version' argument is optional; if given, the resulting
        UUID will have its variant and version set according to RFC 4122,
        overriding the given 'hex', 'bytes', 'bytes_le', 'fields', or 'int'.
        """
    
        if [hex, bytes, bytes_le, fields, int].count(None) != 4:
            raise TypeError('one of the hex, bytes, bytes_le, fields, '
                            'or int arguments must be given')
        if hex is not None:
            hex = hex.replace('urn:', '').replace('uuid:', '')
            hex = hex.strip('{}').replace('-', '')
            if len(hex) != 32:
                raise ValueError('badly formed hexadecimal UUID string')
            int = int_(hex, 16)
        if bytes_le is not None:
            if len(bytes_le) != 16:
                raise ValueError('bytes_le is not a 16-char string')
            bytes = (bytes_le[4-1::-1] + bytes_le[6-1:4-1:-1] +
                     bytes_le[8-1:6-1:-1] + bytes_le[8:])
        if bytes is not None:
            if len(bytes) != 16:
>               raise ValueError('bytes is not a 16-char string')
E               ValueError: bytes is not a 16-char string

/usr/local/lib/python3.6/uuid.py:149: ValueError

The above exception was the direct cause of the following exception:

app = <Flask 'testapp'>

    def test_handle_check_doi(app):
        filepath = os.path.join(
            os.path.dirname(os.path.realpath(__file__)),
            "data",
            "list_records",
            "list_records.json",
        )
        with open(filepath, encoding="utf-8") as f:
            list_record = json.load(f)
        assert handle_check_doi(list_record) == None
    
        # case new items with doi_ra
        filepath = os.path.join(
            os.path.dirname(os.path.realpath(__file__)),
            "data",
            "list_records",
            "b4_handle_check_doi.json",
        )
        with open(filepath, encoding="utf-8") as f:
            list_record = json.load(f)
        assert handle_check_doi(list_record) == None
    
        # item = {
        #     "doi_ra": "JaLC",
        #     "is_change_identifier": True,
        #     "status": "new"
        # }
        item = MagicMock()
        with patch("weko_deposit.api.WekoRecord.get_record_by_pid", return_value="1"):
            assert not handle_check_doi([item])
    
        item2 = {"doi_ra": "JaLC", "is_change_identifier": False, "status": "keep"}
        mock = MagicMock()
        mock2 = MagicMock()
        mock3 = MagicMock()
        mock2.object_uuid = mock3
        mock.pid_recid = mock2
    
        # def myfunc():
        #     return 1,2
        # mock.get_idt_registration_data = myfunc
    
        with patch("weko_deposit.api.WekoRecord.get_record_by_pid", return_value=mock):
            # with patch("weko_workflow.utils.IdentifierHandle", return_value=mock):
>           assert not handle_check_doi([item2])

tests/test_utils.py:951: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
weko_search_ui/utils.py:2132: in handle_check_doi
    identifier = IdentifierHandle(pid.object_uuid)
../weko-workflow/weko_workflow/utils.py:985: in __init__
    self.metadata_mapping = MappingData(item_id)
../weko-workflow/weko_workflow/utils.py:860: in __init__
    self.record = WekoRecord.get_record(item_id) if item_id else record
../invenio-records/invenio_records/api.py:206: in get_record
    obj = query.one()
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3039: in one
    ret = self.one_or_none()
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3008: in one_or_none
    ret = list(self)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3081: in __iter__
    return self._execute_and_instances(context)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3106: in _execute_and_instances
    result = conn.execute(querycontext.statement, self._params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:980: in execute
    return meth(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/sql/elements.py:273: in _execute_on_connection
    return connection._execute_clauseelement(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1099: in _execute_clauseelement
    distilled_params,
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1174: in _execute_context
    e, util.text_type(statement), parameters, None, None
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1458: in _handle_dbapi_exception
    util.raise_from_cause(sqlalchemy_exception, exc_info)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:296: in raise_from_cause
    reraise(type(exception), exception, tb=exc_tb, cause=cause)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:276: in reraise
    raise value.with_traceback(tb)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1171: in _execute_context
    context = constructor(dialect, self, conn, *args)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:729: in _init_compiled
    for key in compiled_params
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:729: in <genexpr>
    for key in compiled_params
.tox/c1/lib/python3.6/site-packages/sqlalchemy/sql/type_api.py:1189: in process
    return impl_processor(process_param(value, dialect))
.tox/c1/lib/python3.6/site-packages/sqlalchemy_utils/types/uuid.py:68: in process_bind_param
    value = self._coerce(value)
.tox/c1/lib/python3.6/site-packages/sqlalchemy_utils/types/uuid.py:59: in _coerce
    value = uuid.UUID(bytes=value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <[AttributeError("'UUID' object has no attribute 'int'",) raised in repr()] UUID object at 0x7ff2f8441828>
hex = None
bytes = <MagicMock name='mock.pid_recid.object_uuid' id='140681526843656'>
bytes_le = None, fields = None, int = None, version = None

    def __init__(self, hex=None, bytes=None, bytes_le=None, fields=None,
                       int=None, version=None):
        r"""Create a UUID from either a string of 32 hexadecimal digits,
        a string of 16 bytes as the 'bytes' argument, a string of 16 bytes
        in little-endian order as the 'bytes_le' argument, a tuple of six
        integers (32-bit time_low, 16-bit time_mid, 16-bit time_hi_version,
        8-bit clock_seq_hi_variant, 8-bit clock_seq_low, 48-bit node) as
        the 'fields' argument, or a single 128-bit integer as the 'int'
        argument.  When a string of hex digits is given, curly braces,
        hyphens, and a URN prefix are all optional.  For example, these
        expressions all yield the same UUID:
    
        UUID('{12345678-1234-5678-1234-567812345678}')
        UUID('12345678123456781234567812345678')
        UUID('urn:uuid:12345678-1234-5678-1234-567812345678')
        UUID(bytes='\x12\x34\x56\x78'*4)
        UUID(bytes_le='\x78\x56\x34\x12\x34\x12\x78\x56' +
                      '\x12\x34\x56\x78\x12\x34\x56\x78')
        UUID(fields=(0x12345678, 0x1234, 0x5678, 0x12, 0x34, 0x567812345678))
        UUID(int=0x12345678123456781234567812345678)
    
        Exactly one of 'hex', 'bytes', 'bytes_le', 'fields', or 'int' must
        be given.  The 'version' argument is optional; if given, the resulting
        UUID will have its variant and version set according to RFC 4122,
        overriding the given 'hex', 'bytes', 'bytes_le', 'fields', or 'int'.
        """
    
        if [hex, bytes, bytes_le, fields, int].count(None) != 4:
            raise TypeError('one of the hex, bytes, bytes_le, fields, '
                            'or int arguments must be given')
        if hex is not None:
            hex = hex.replace('urn:', '').replace('uuid:', '')
            hex = hex.strip('{}').replace('-', '')
            if len(hex) != 32:
                raise ValueError('badly formed hexadecimal UUID string')
            int = int_(hex, 16)
        if bytes_le is not None:
            if len(bytes_le) != 16:
                raise ValueError('bytes_le is not a 16-char string')
            bytes = (bytes_le[4-1::-1] + bytes_le[6-1:4-1:-1] +
                     bytes_le[8-1:6-1:-1] + bytes_le[8:])
        if bytes is not None:
            if len(bytes) != 16:
>               raise ValueError('bytes is not a 16-char string')
E               sqlalchemy.exc.StatementError: (builtins.ValueError) bytes is not a 16-char string [SQL: 'SELECT records_metadata.created AS records_metadata_created, records_metadata.updated AS records_metadata_updated, records_metadata.id AS records_metadata_id, records_metadata.json AS records_metadata_json, records_metadata.version_id AS records_metadata_version_id \nFROM records_metadata \nWHERE records_metadata.id = %(id_1)s AND records_metadata.json IS NOT NULL'] [parameters: [{}]]

/usr/local/lib/python3.6/uuid.py:149: StatementError
_________________________ test_handle_fill_system_item _________________________

self = <sqlalchemy.engine.base.Connection object at 0x7ff2f14afa20>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff2f19c9940>
constructor = <bound method DefaultExecutionContext._init_compiled of <class 'sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2'>>
statement = 'SELECT doi_identifier.id AS doi_identifier_id, doi_identifier.repository AS doi_identifier_repository, doi_identifier...updated_date AS doi_identifier_updated_date \nFROM doi_identifier \nWHERE doi_identifier.repository = %(repository_1)s'
parameters = {'repository_1': 'Root Index'}
args = (<sqlalchemy.dialects.postgresql.psycopg2.PGCompiler_psycopg2 object at 0x7ff2f14af9b0>, [immutabledict({})])
conn = <sqlalchemy.pool._ConnectionFairy object at 0x7ff2f19b3588>
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7ff2f14afbe0>

    def _execute_context(
        self, dialect, constructor, statement, parameters, *args
    ):
        """Create an :class:`.ExecutionContext` and execute, returning
        a :class:`.ResultProxy`."""
    
        try:
            try:
                conn = self.__connection
            except AttributeError:
                # escape "except AttributeError" before revalidating
                # to prevent misleading stacktraces in Py3K
                conn = None
            if conn is None:
                conn = self._revalidate_connection()
    
            context = constructor(dialect, self, conn, *args)
        except BaseException as e:
            self._handle_dbapi_exception(
                e, util.text_type(statement), parameters, None, None
            )
    
        if context.compiled:
            context.pre_exec()
    
        cursor, statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        if not context.executemany:
            parameters = parameters[0]
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                statement, parameters = fn(
                    self,
                    cursor,
                    statement,
                    parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self.engine.logger.info(statement)
            self.engine.logger.info(
                "%r", sql_util._repr_params(parameters, batches=10)
            )
    
        evt_handled = False
        try:
            if context.executemany:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(cursor, statement, parameters, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor, statement, parameters, context
                    )
            elif not parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, statement, context
                    )
            else:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(cursor, statement, parameters, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute(
>                       cursor, statement, parameters, context
                    )

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1236: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff2f19c9940>
cursor = <cursor object at 0x7ff2f28f5900; closed: -1>
statement = 'SELECT doi_identifier.id AS doi_identifier_id, doi_identifier.repository AS doi_identifier_repository, doi_identifier...updated_date AS doi_identifier_updated_date \nFROM doi_identifier \nWHERE doi_identifier.repository = %(repository_1)s'
parameters = {'repository_1': 'Root Index'}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7ff2f14afbe0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       psycopg2.ProgrammingError: relation "doi_identifier" does not exist
E       LINE 2: FROM doi_identifier 
E                    ^

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:536: ProgrammingError

The above exception was the direct cause of the following exception:

app = <Flask 'testapp'>
test_list_records = [{'input': [{'$schema': 'https://localhost:8443/items/jsonschema/15', 'edit_mode': 'Keep', 'errors': None, 'feedback_m...e': 'Keep', 'errors': ['Please specify PubDate with YYYY-MM-DD.'], 'feedback_mail': ['wekosoftware@nii.ac.jp'], ...}]}]
mocker = <pytest_mock.plugin.MockerFixture object at 0x7ff2f19fe080>

    def test_handle_fill_system_item(app, test_list_records, mocker):
    
        filepath = os.path.join(
            os.path.dirname(os.path.realpath(__file__)), "data", "item_map.json"
        )
        with open(filepath, encoding="utf-8") as f:
            item_map = json.load(f)
    
        filepath = os.path.join(
            os.path.dirname(os.path.realpath(__file__)), "data", "item_type_mapping.json"
        )
        with open(filepath, encoding="utf-8") as f:
            item_type_mapping = json.load(f)
        mocker.patch("weko_records.serializers.utils.get_mapping", return_value=item_map)
        mocker.patch("weko_records.api.Mapping.get_record", return_value=item_type_mapping)
    
        filepath = os.path.join(
            os.path.dirname(os.path.realpath(__file__)),
            "data",
            "list_records/list_records_fill_system.json",
        )
        with open(filepath, encoding="utf-8") as f:
            list_record = json.load(f)
    
        items = []
        items_result = []
    
        for a in VERSION_TYPE_URI:
            item = copy.deepcopy(list_record[0])
            item["metadata"]["item_1617265215918"]["subitem_1522305645492"] = a
            item["metadata"]["item_1617265215918"][
                "subitem_1600292170262"
            ] = VERSION_TYPE_URI[a]
            item["metadata"]["item_1617186476635"]["subitem_1522299639480"] = "open access"
            item["metadata"]["item_1617186476635"][
                "subitem_1600958577026"
            ] = ACCESS_RIGHT_TYPE_URI["open access"]
            item["metadata"]["item_1617258105262"]["resourcetype"] = "conference paper"
            item["metadata"]["item_1617258105262"]["resourceuri"] = RESOURCE_TYPE_URI[
                "conference paper"
            ]
            item["warnings"] = []
            item["errors"] = []
            items_result.append(item)
            item2 = copy.deepcopy(item)
            item2["metadata"]["item_1617265215918"]["subitem_1522305645492"] = a
            item2["metadata"]["item_1617265215918"]["subitem_1600292170262"] = ""
            items.append(item2)
    
        for a in ACCESS_RIGHT_TYPE_URI:
            item = copy.deepcopy(list_record[0])
            item["metadata"]["item_1617265215918"]["subitem_1522305645492"] = "VoR"
            item["metadata"]["item_1617265215918"][
                "subitem_1600292170262"
            ] = VERSION_TYPE_URI["VoR"]
            item["metadata"]["item_1617186476635"]["subitem_1522299639480"] = a
            item["metadata"]["item_1617186476635"][
                "subitem_1600958577026"
            ] = ACCESS_RIGHT_TYPE_URI[a]
            item["metadata"]["item_1617258105262"]["resourcetype"] = "conference paper"
            item["metadata"]["item_1617258105262"]["resourceuri"] = RESOURCE_TYPE_URI[
                "conference paper"
            ]
            item["warnings"] = []
            item["errors"] = []
            items_result.append(item)
            item2 = copy.deepcopy(item)
            item2["metadata"]["item_1617186476635"]["subitem_1522299639480"] = a
            item2["metadata"]["item_1617186476635"]["subitem_1600958577026"] = ""
            items.append(item2)
    
        for a in RESOURCE_TYPE_URI:
            item = copy.deepcopy(list_record[0])
            item["metadata"]["item_1617265215918"]["subitem_1522305645492"] = "VoR"
            item["metadata"]["item_1617265215918"][
                "subitem_1600292170262"
            ] = VERSION_TYPE_URI["VoR"]
            item["metadata"]["item_1617186476635"]["subitem_1522299639480"] = "open access"
            item["metadata"]["item_1617186476635"][
                "subitem_1600958577026"
            ] = ACCESS_RIGHT_TYPE_URI["open access"]
            item["metadata"]["item_1617258105262"]["resourcetype"] = a
            item["metadata"]["item_1617258105262"]["resourceuri"] = RESOURCE_TYPE_URI[a]
            item["warnings"] = []
            item["errors"] = []
            items_result.append(item)
            item2 = copy.deepcopy(item)
            item2["metadata"]["item_1617258105262"]["resourcetype"] = a
            item2["metadata"]["item_1617258105262"]["resourceuri"] = ""
            items.append(item2)
    
        # with open("items.json","w") as f:
        #     json.dump(items,f)
    
        # with open("items_result.json","w") as f:
        #     json.dump(items_result,f)
    
        # filepath = os.path.join(os.path.dirname(os.path.realpath(__file__)),"data/handle_fill_system_item/items.json")
        # with open(filepath,encoding="utf-8") as f:
        #     items = json.load(f)
    
        # filepath = os.path.join(os.path.dirname(os.path.realpath(__file__)),"data/handle_fill_system_item/items_result.json")
        # with open(filepath,encoding="utf-8") as f:
        #     items_result = json.load(f)
    
        with app.test_request_context():
            with set_locale("en"):
>               handle_fill_system_item(items)

tests/test_utils.py:1402: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
weko_search_ui/utils.py:2912: in handle_fill_system_item
    doi_setting = prepare_doi_setting()
weko_search_ui/utils.py:2212: in prepare_doi_setting
    identifier_setting = get_identifier_setting("Root Index")
../weko-workflow/weko_workflow/utils.py:130: in get_identifier_setting
    repository=community_id).one_or_none()
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3008: in one_or_none
    ret = list(self)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3081: in __iter__
    return self._execute_and_instances(context)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/query.py:3106: in _execute_and_instances
    result = conn.execute(querycontext.statement, self._params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:980: in execute
    return meth(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/sql/elements.py:273: in _execute_on_connection
    return connection._execute_clauseelement(self, multiparams, params)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1099: in _execute_clauseelement
    distilled_params,
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1240: in _execute_context
    e, statement, parameters, cursor, context
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1458: in _handle_dbapi_exception
    util.raise_from_cause(sqlalchemy_exception, exc_info)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:296: in raise_from_cause
    reraise(type(exception), exception, tb=exc_tb, cause=cause)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/util/compat.py:276: in reraise
    raise value.with_traceback(tb)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1236: in _execute_context
    cursor, statement, parameters, context
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7ff2f19c9940>
cursor = <cursor object at 0x7ff2f28f5900; closed: -1>
statement = 'SELECT doi_identifier.id AS doi_identifier_id, doi_identifier.repository AS doi_identifier_repository, doi_identifier...updated_date AS doi_identifier_updated_date \nFROM doi_identifier \nWHERE doi_identifier.repository = %(repository_1)s'
parameters = {'repository_1': 'Root Index'}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7ff2f14afbe0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.ProgrammingError: (psycopg2.ProgrammingError) relation "doi_identifier" does not exist
E       LINE 2: FROM doi_identifier 
E                    ^
E        [SQL: 'SELECT doi_identifier.id AS doi_identifier_id, doi_identifier.repository AS doi_identifier_repository, doi_identifier.jalc_flag AS doi_identifier_jalc_flag, doi_identifier.jalc_crossref_flag AS doi_identifier_jalc_crossref_flag, doi_identifier.jalc_datacite_flag AS doi_identifier_jalc_datacite_flag, doi_identifier.ndl_jalc_flag AS doi_identifier_ndl_jalc_flag, doi_identifier.jalc_doi AS doi_identifier_jalc_doi, doi_identifier.jalc_crossref_doi AS doi_identifier_jalc_crossref_doi, doi_identifier.jalc_datacite_doi AS doi_identifier_jalc_datacite_doi, doi_identifier.ndl_jalc_doi AS doi_identifier_ndl_jalc_doi, doi_identifier.suffix AS doi_identifier_suffix, doi_identifier."created_userId" AS "doi_identifier_created_userId", doi_identifier.created_date AS doi_identifier_created_date, doi_identifier."updated_userId" AS "doi_identifier_updated_userId", doi_identifier.updated_date AS doi_identifier_updated_date \nFROM doi_identifier \nWHERE doi_identifier.repository = %(repository_1)s'] [parameters: {'repository_1': 'Root Index'}] (Background on this error at: http://sqlalche.me/e/f405)

.tox/c1/lib/python3.6/site-packages/sqlalchemy/engine/default.py:536: ProgrammingError
___________________________ test_function_issue34535 ___________________________

db = <SQLAlchemy engine=postgresql+psycopg2://invenio:***@postgresql:5432/wekotest>
db_index = None
db_itemtype = {'item_type': <ItemType 1>, 'item_type_mapping': <ItemTypeMapping 1>, 'item_type_name': <ItemTypeName 1>}
location = <function location at 0x7ff30d0319d8>, db_oaischema = None
mocker = <pytest_mock.plugin.MockerFixture object at 0x7ff271647160>

    def test_function_issue34535(db,db_index,db_itemtype,location,db_oaischema,mocker):
        mocker.patch("weko_search_ui.utils.find_and_update_location_size")
        # register item
        indexer = WekoIndexer()
        indexer.get_es_index()
        record_data = {"_oai":{"id":"oai:weko3.example.org:00000004","sets":[]},"path":["1"],"owner":"1","recid":"4","title":["test item in br"],"pubdate":{"attribute_name":"PubDate","attribute_value":"2022-11-21"},"_buckets":{"deposit":"0796e490-6dcf-4e7d-b241-d7201c3de83a"},"_deposit":{"id":"4","pid":{"type":"depid","value":"4","revision_id":0},"owner":"1","owners":[1],"status":"published","created_by":1},"item_title":"test item in br","author_link":[],"item_type_id":"1","publish_date":"2022-11-21","publish_status":"0","weko_shared_id":-1,"item_1617186331708":{"attribute_name":"Title","attribute_value_mlt":[{"subitem_1551255647225":"test item in br","subitem_1551255648112":"ja"}]},"item_1617186626617":{"attribute_name":"Description","attribute_value_mlt":[{"subitem_description":"this is line1.\nthis is line2.","subitem_description_type":"Abstract","subitem_description_language":"en"}]},"item_1617258105262":{"attribute_name":"Resource Type","attribute_value_mlt":[{"resourceuri":"http://purl.org/coar/resource_type/c_5794","resourcetype":"conference paper"}]},"relation_version_is_last":True}
        item_data = {"id":"4","pid":{"type":"depid","value":"4","revision_id":0},"lang":"ja","path":[1],"owner":"1","title":"test item in br","owners":[1],"status":"published","$schema":"https://192.168.56.103/items/jsonschema/1","pubdate":"2022-11-21","edit_mode":"keep","created_by":1,"owners_ext":{"email":"wekosoftware@nii.ac.jp","username":"","displayname":""},"deleted_items":["item_1617605131499"],"shared_user_id":-1,"weko_shared_id":-1,"item_1617186331708":[{"subitem_1551255647225":"test item in br","subitem_1551255648112":"ja"}],"item_1617186626617":[{"subitem_description":"this is line1.\nthis is line2.","subitem_description_type":"Abstract","subitem_description_language":"en"}],"item_1617258105262":{"resourceuri":"http://purl.org/coar/resource_type/c_5794","resourcetype":"conference paper"}}
        rec_uuid = uuid.uuid4()
        recid = PersistentIdentifier.create(
            "recid",
            str(4),
            object_type="rec",
            object_uuid=rec_uuid,
            status=PIDStatus.REGISTERED,
        )
        depid = PersistentIdentifier.create(
            "depid",
            str(4),
            object_type="rec",
            object_uuid=rec_uuid,
            status=PIDStatus.REGISTERED,
        )
        rel = PIDRelation.create(recid, depid, 3)
        db.session.add(rel)
        record = WekoRecord.create(record_data, id_=rec_uuid)
        item = ItemsMetadata.create(item_data, id_=rec_uuid)
        deposit = WekoDeposit(record, record.model)
        deposit.commit()
        indexer.upload_metadata(record_data, rec_uuid, 1, False)
    
        # new item
        root_path = os.path.dirname(os.path.abspath(__file__))
        new_item = {'$schema': 'https://192.168.56.103/items/jsonschema/1', 'edit_mode': 'Keep', 'errors': None, 'file_path': [''], 'filenames': [{'filename': '', 'id': '.metadata.item_1617605131499[0].filename'}], 'id': '4', 'identifier_key': 'item_1617186819068', 'is_change_identifier': False, 'item_title': 'test item in br', 'item_type_id': 1, 'item_type_name': '', 'metadata': {'item_1617186331708': [{'subitem_1551255647225': 'test item in br', 'subitem_1551255648112': 'ja'}], 'item_1617186626617': [{'subitem_description': 'this is line1.<br/>this is line2.', 'subitem_description_language': 'en', 'subitem_description_type': 'Abstract'}], 'item_1617258105262': {'resourcetype': 'conference paper', 'resourceuri': 'http://purl.org/coar/resource_type/c_5794'}, 'path': [1], 'pubdate': '2022-11-21'}, 'pos_index': ['Faculty of Humanities and Social Sciences'], 'publish_status': 'public', 'status': 'keep', 'uri': 'https://192.168.56.103/records/4', 'warnings': [], 'root_path': root_path}
    
>       register_item_metadata(new_item,root_path,True)

tests/test_utils.py:2404: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
weko_search_ui/utils.py:1342: in register_item_metadata
    deposit.publish_without_commit()
../weko-deposit/weko_deposit/api.py:706: in publish_without_commit
    deposit = super(WekoDeposit, self).publish(pid, id_)
../invenio-deposit/invenio_deposit/api.py:101: in wrapper
    return method(self, *args, **kwargs)
../invenio-deposit/invenio_deposit/api.py:357: in publish
    record.commit()
../invenio-records/invenio_records/api.py:278: in commit
    record=self
.tox/c1/lib/python3.6/site-packages/blinker/base.py:267: in send
    for receiver in self.receivers_for(sender)]
.tox/c1/lib/python3.6/site-packages/blinker/base.py:267: in <listcomp>
    for receiver in self.receivers_for(sender)]
../invenio-oaiserver/invenio_oaiserver/receivers.py:28: in __call__
    new_sets = set(get_record_sets(record=record))
../invenio-oaiserver/invenio_oaiserver/percolator.py:133: in get_record_sets
    index, doc_type = RecordIndexer().record_to_index(record)
../invenio-indexer/invenio_indexer/api.py:80: in record_to_index
    return self._record_to_index(record)
.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:376: in <lambda>
    __call__ = lambda x, *a, **kw: x._get_current_object()(*a, **kw)
../invenio-indexer/invenio_indexer/utils.py:30: in default_record_to_index
    index, doc_type = schema_to_index(schema, index_names=index_names)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

schema = None
index_names = dict_keys(['test-marc21-authority-ad-v1.0.0', 'test-marc21-bibliographic-bd-v1.0.0', 'test-marc21-holdings-hd-v1.0.0', 'test-weko-item-v1.0.0', 'test-authors-author-v1.0.0', 'test-deposits-deposit-v1.0.0'])

    def schema_to_index(schema, index_names=None):
        """Get index/doc_type given a schema URL.
    
        :param schema: The schema name
        :param index_names: A list of index name.
        :returns: A tuple containing (index, doc_type).
        """
>       parts = schema.split('/')
E       AttributeError: 'NoneType' object has no attribute 'split'

.tox/c1/lib/python3.6/site-packages/invenio_search/utils.py:46: AttributeError
____________________________ test_search_acl[3-200] ____________________________

app = <Flask 'testapp'>, client = <FlaskClient <Flask 'testapp'>>
db_register2 = None, index_style = None
users = [{'email': 'noroleuser@test.org', 'id': 9, 'obj': <User 9>}, {'email': 'contributor@test.org', 'id': 2, 'obj': <User 2...ail': 'comadmin@test.org', 'id': 3, 'obj': <User 3>}, {'email': 'generaluser@test.org', 'id': 6, 'obj': <User 5>}, ...]
db_register = {'activity': <Activity 1>, 'flow_define': <FlowDefine 1>, 'indices': {'index': <Index 1>, 'index_private': <Index (transient 140679261490088)>}, 'item_type': <ItemType 1>, ...}
id = 3, status_code = 200

    @pytest.mark.parametrize(
        "id, status_code",
        [
            # (0, 200),
            # (1, 302),
            # (2, 302),
            (3, 200),
            # (4, 302),
            # (5, 302),
            # (6, 302),
            # (7, 302),
        ],
    )
    def test_search_acl(app,client,db_register2,index_style,users,db_register,id,status_code):
        url = url_for("weko_search_ui.search", _external=True)
        with patch("flask_login.utils._get_user", return_value=users[id]['obj']):
            with patch("flask.templating._render", return_value=""):
                ret = client.get(url)
                assert ret.status_code == status_code
    
        url = url_for("weko_search_ui.search", search_type=0,_external=True)
        with patch("flask_login.utils._get_user", return_value=users[id]['obj']):
            with patch("flask.templating._render", return_value=""):
>               ret = client.get(url)

tests/test_views.py:80: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1029: in get
    return self.open(*args, **kw)
.tox/c1/lib/python3.6/site-packages/flask/testing.py:196: in open
    follow_redirects=follow_redirects
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:993: in open
    response = self.run_wsgi_app(environ.copy(), buffered=buffered)
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:884: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
.tox/c1/lib/python3.6/site-packages/werkzeug/test.py:1119: in run_wsgi_app
    app_rv = app(environ, start_response)
.tox/c1/lib/python3.6/site-packages/flask/app.py:2334: in __call__
    return self.wsgi_app(environ, start_response)
.tox/c1/lib/python3.6/site-packages/flask/app.py:2320: in wsgi_app
    response = self.handle_exception(e)
.tox/c1/lib/python3.6/site-packages/flask/app.py:1766: in handle_exception
    reraise(exc_type, exc_value, tb)
.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
.tox/c1/lib/python3.6/site-packages/flask/app.py:2317: in wsgi_app
    response = self.full_dispatch_request()
.tox/c1/lib/python3.6/site-packages/flask/app.py:1840: in full_dispatch_request
    rv = self.handle_user_exception(e)
.tox/c1/lib/python3.6/site-packages/flask/app.py:1743: in handle_user_exception
    reraise(exc_type, exc_value, tb)
.tox/c1/lib/python3.6/site-packages/flask/_compat.py:36: in reraise
    raise value
.tox/c1/lib/python3.6/site-packages/flask/app.py:1836: in full_dispatch_request
    rv = self.preprocess_request()
.tox/c1/lib/python3.6/site-packages/flask/app.py:2112: in preprocess_request
    rv = func()
.tox/c1/lib/python3.6/site-packages/flask_principal.py:477: in _on_before_request
    identity = loader()
.tox/c1/lib/python3.6/site-packages/flask_security/core.py:246: in _identity_loader
    identity = Identity(current_user.id)
.tox/c1/lib/python3.6/site-packages/werkzeug/local.py:348: in __getattr__
    return getattr(self._get_current_object(), name)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/attributes.py:275: in __get__
    return self.impl.get(instance_state(instance), dict_)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/attributes.py:669: in get
    value = state._load_expired(state, passive)
.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/state.py:632: in _load_expired
    self.manager.deferred_scalar_loader(self, toload)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

mapper = <Mapper at 0x7ff33944dc50; User>
state = <sqlalchemy.orm.state.InstanceState object at 0x7ff2717726d8>
attribute_names = {'active', 'confirmed_at', 'current_login_at', 'current_login_ip', 'email', 'id', ...}

    def load_scalar_attributes(mapper, state, attribute_names):
        """initiate a column-based attribute refresh operation."""
    
        # assert mapper is _state_mapper(state)
        session = state.session
        if not session:
            raise orm_exc.DetachedInstanceError(
                "Instance %s is not bound to a Session; "
>               "attribute refresh operation cannot proceed" % (state_str(state))
            )
E           sqlalchemy.orm.exc.DetachedInstanceError: Instance <User at 0x7ff2718945c0> is not bound to a Session; attribute refresh operation cannot proceed (Background on this error at: http://sqlalche.me/e/bhk3)

.tox/c1/lib/python3.6/site-packages/sqlalchemy/orm/loading.py:913: DetachedInstanceError
________________________ test_search_feedback_mail_list ________________________

i18n_app = <Flask 'testapp'>
users = [{'email': 'noroleuser@test.org', 'id': 9, 'obj': <User 9>}, {'email': 'contributor@test.org', 'id': 2, 'obj': <User 2...ail': 'comadmin@test.org', 'id': 3, 'obj': <User 3>}, {'email': 'generaluser@test.org', 'id': 6, 'obj': <User 5>}, ...]

    def test_search_feedback_mail_list(i18n_app, users):
        with patch("flask_login.utils._get_user", return_value=users[3]['obj']):
>           assert search_feedback_mail_list()

tests/test_views.py:123: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.tox/c1/lib/python3.6/site-packages/flask_login/utils.py:261: in decorated_view
    return func(*args, **kwargs)
weko_search_ui/views.py:366: in search_feedback_mail_list
    result = get_feedback_mail_list()
weko_search_ui/utils.py:320: in get_feedback_mail_list
    search_instance.execute()
.tox/c1/lib/python3.6/site-packages/elasticsearch_dsl/search.py:706: in execute
    **self._params
.tox/c1/lib/python3.6/site-packages/elasticsearch/client/utils.py:76: in _wrapped
    return func(*args, params=params, **kwargs)
.tox/c1/lib/python3.6/site-packages/elasticsearch/client/__init__.py:636: in search
    doc_type, '_search'), params=params, body=body)
.tox/c1/lib/python3.6/site-packages/elasticsearch/transport.py:314: in perform_request
    status, headers_response, data = connection.perform_request(method, url, params, body, headers=headers, ignore=ignore, timeout=timeout)
.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/http_requests.py:90: in perform_request
    self._raise_error(response.status_code, raw_data)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <RequestsHttpConnection: http://elasticsearch:9200>, status_code = 400
raw_data = '{"error":{"root_cause":[{"type":"query_shard_exception","reason":"failed to create query: {\\n  \\"bool\\" : {\\n    ...l_state_exception","reason":"[nested] failed to find nested object under path [feedback_mail_list]"}}}]},"status":400}'

    def _raise_error(self, status_code, raw_data):
        """ Locate appropriate exception and raise it. """
        error_message = raw_data
        additional_info = None
        try:
            if raw_data:
                additional_info = json.loads(raw_data)
                error_message = additional_info.get('error', error_message)
                if isinstance(error_message, dict) and 'type' in error_message:
                    error_message = error_message['type']
        except (ValueError, TypeError) as err:
            logger.warning('Undecodable raw error response from server: %s', err)
    
>       raise HTTP_EXCEPTIONS.get(status_code, TransportError)(status_code, error_message, additional_info)
E       elasticsearch.exceptions.RequestError: TransportError(400, 'search_phase_execution_exception', 'failed to create query: {\n  "bool" : {\n    "must" : [\n      {\n        "nested" : {\n          "query" : {\n            "bool" : {\n              "must" : [\n                {\n                  "exists" : {\n                    "field" : "feedback_mail_list.email",\n                    "boost" : 1.0\n                  }\n                }\n              ],\n              "adjust_pure_negative" : true,\n              "boost" : 1.0\n            }\n          },\n          "path" : "feedback_mail_list",\n          "ignore_unmapped" : false,\n          "score_mode" : "avg",\n          "boost" : 1.0\n        }\n      },\n      {\n        "query_string" : {\n          "query" : "_type:record-v1.0.0 AND relation_version_is_last:true ",\n          "fields" : [ ],\n          "type" : "best_fields",\n          "default_operator" : "or",\n          "max_determinized_states" : 10000,\n          "enable_position_increments" : true,\n          "fuzziness" : "AUTO",\n          "fuzzy_prefix_length" : 0,\n          "fuzzy_max_expansions" : 50,\n          "phrase_slop" : 0,\n          "escape" : false,\n          "auto_generate_synonyms_phrase_query" : true,\n          "fuzzy_transpositions" : true,\n          "boost" : 1.0\n        }\n      }\n    ],\n    "adjust_pure_negative" : true,\n    "boost" : 1.0\n  }\n}')

.tox/c1/lib/python3.6/site-packages/elasticsearch/connection/base.py:125: RequestError
------------------------------ Captured log call -------------------------------
WARNING  elasticsearch:base.py:97 GET http://elasticsearch:9200/test-weko/_search?preference=4a4d20d732cd9f789541e54dd9eb6af8&version=false [status:400 request:0.012s]
=============================== warnings summary ===============================
../invenio-indexer/invenio_indexer/cli.py:162
  /code/modules/invenio-indexer/invenio_indexer/cli.py:162: DeprecationWarning: 'resultcallback' has been renamed to 'result_callback'. The old name will be removed in Click 8.1.
    @queue.resultcallback()

.tox/c1/lib/python3.6/site-packages/flask_oauthlib/contrib/cache.py:3
  /code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/flask_oauthlib/contrib/cache.py:3: DeprecationWarning: 'werkzeug.contrib.cache' is deprecated as of version 0.15 and will be removed in version 1.0. It has moved to https://github.com/pallets/cachelib.
    from werkzeug.contrib.cache import NullCache, SimpleCache, FileSystemCache

.tox/c1/lib/python3.6/site-packages/past/translation/__init__.py:35
  /code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/past/translation/__init__.py:35: DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses
    import imp

tests/test_admin.py: 494 warnings
tests/test_api.py: 208 warnings
tests/test_ext.py: 78 warnings
tests/test_links.py: 26 warnings
tests/test_query.py: 234 warnings
tests/test_rest.py: 130 warnings
tests/test_tasks.py: 208 warnings
tests/test_utils.py: 7774 warnings
tests/test_views.py: 286 warnings
tests/test_weko_search_ui.py: 26 warnings
  /code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/invenio_admin/ext.py:73: PendingDeprecationWarning: Usage of model and modelview kwargs are deprecated in favor of view_class, args and kwargs.
    PendingDeprecationWarning

tests/test_admin.py: 19 warnings
tests/test_api.py: 8 warnings
tests/test_ext.py: 3 warnings
tests/test_links.py: 1 warning
tests/test_query.py: 9 warnings
tests/test_rest.py: 5 warnings
tests/test_tasks.py: 8 warnings
tests/test_utils.py: 299 warnings
tests/test_views.py: 11 warnings
tests/test_weko_search_ui.py: 1 warning
  /code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/flask_admin/model/base.py:1416: UserWarning: Fields missing from ruleset: created_userId,created_date,updated_userId,updated_date
    warnings.warn(text)

tests/test_admin.py: 17 warnings
tests/test_query.py: 4 warnings
tests/test_rest.py: 2 warnings
tests/test_utils.py: 3 warnings
tests/test_views.py: 4 warnings
  /code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/flask/sessions.py:208: UserWarning: "TEST_SERVER" is not a valid cookie domain, it must contain a ".". Add an entry to your hosts file, for example "TEST_SERVER.localdomain", and use that instead.
    ' "{rv}.localdomain", and use that instead.'.format(rv=rv)

tests/test_admin.py: 2688 warnings
tests/test_query.py: 768 warnings
tests/test_rest.py: 984 warnings
tests/test_utils.py: 964329 warnings
tests/test_views.py: 8712 warnings
  /code/modules/invenio-oaiserver/invenio_oaiserver/receivers.py:28: DeprecationWarning: generator 'get_record_sets' raised StopIteration
    new_sets = set(get_record_sets(record=record))

tests/test_tasks.py::test_is_import_running
  /code/modules/weko-search-ui/.tox/c1/src/kombu/kombu/utils/compat.py:93: DeprecationWarning: SelectableGroups dict interface is deprecated. Use select.
    for ep in importlib_metadata.entry_points().get(namespace, [])

tests/test_utils.py::test_function_issue34958
  /code/modules/weko-search-ui/.tox/c1/lib/python3.6/site-packages/sqlalchemy/sql/compiler.py:763: SAWarning: Can't resolve label reference 'item_type.tag'; converting to text() (this warning may be suppressed after 10 occurrences)
    util.ellipses_string(element.element),

-- Docs: https://docs.pytest.org/en/stable/warnings.html

---------- coverage: platform linux, python 3.6.15-final-0 -----------
Name                            Stmts   Miss Branch BrPart  Cover
-----------------------------------------------------------------
weko_search_ui/__init__.py          4      0      0      0   100%
weko_search_ui/admin.py           363    124    134     17    61%
weko_search_ui/api.py             128      0     64      6    97%
weko_search_ui/bundles.py          19      0      0      0   100%
weko_search_ui/config.py          100      0      0      0   100%
weko_search_ui/ext.py              32      0     16      3    94%
weko_search_ui/links.py             5      0      0      0   100%
weko_search_ui/permissions.py       4      0      0      0   100%
weko_search_ui/query.py           605    142    296     66    71%
weko_search_ui/rest.py            267     53    122     28    74%
weko_search_ui/tasks.py            82     17     28      4    70%
weko_search_ui/utils.py          2050    542   1066    192    69%
weko_search_ui/version.py           2      0      0      0   100%
weko_search_ui/views.py           171     29     32      8    79%
-----------------------------------------------------------------
TOTAL                            3832    907   1758    324    71%
Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml

=========================== short test summary info ============================
FAILED tests/test_admin.py::TestItemManagementBulkSearch::test_index_acl - As...
FAILED tests/test_admin.py::test_ItemImportView_check - flask_wtf.csrf.CSRFEr...
FAILED tests/test_admin.py::TestItemBulkExport::test_check_export_status - As...
FAILED tests/test_query.py::test_get_permission_filter - AssertionError: asse...
FAILED tests/test_query.py::test_function_issue35902 - AssertionError: assert...
FAILED tests/test_rest.py::test_IndexSearchResource_get_Exception - KeyError:...
FAILED tests/test_utils.py::test_delete_records - elasticsearch.exceptions.No...
FAILED tests/test_utils.py::test_get_feedback_mail_list - elasticsearch.excep...
FAILED tests/test_utils.py::test_unpackage_import_file - AssertionError: asse...
FAILED tests/test_utils.py::test_read_stats_file - sqlalchemy.exc.DataError: ...
FAILED tests/test_utils.py::test_register_item_metadata - TypeError: register...
FAILED tests/test_utils.py::test_send_item_created_event_to_es - elasticsearc...
FAILED tests/test_utils.py::test_import_items_to_system - TypeError: not all ...
FAILED tests/test_utils.py::test_handle_check_and_prepare_index_tree - KeyErr...
FAILED tests/test_utils.py::test_handle_check_and_prepare_feedback_mail - ela...
FAILED tests/test_utils.py::test_handle_check_cnri - TypeError: expected str,...
FAILED tests/test_utils.py::test_handle_check_doi - sqlalchemy.exc.StatementE...
FAILED tests/test_utils.py::test_handle_fill_system_item - sqlalchemy.exc.Pro...
FAILED tests/test_utils.py::test_function_issue34535 - AttributeError: 'NoneT...
FAILED tests/test_views.py::test_search_acl[3-200] - sqlalchemy.orm.exc.Detac...
FAILED tests/test_views.py::test_search_feedback_mail_list - elasticsearch.ex...
ERROR tests/test_utils.py::test_handle_doi_required_check - sqlalchemy.exc.In...
ERROR tests/test_utils.py::test_export_all - sqlalchemy.exc.IntegrityError: (...
=== 21 failed, 353 passed, 987344 warnings, 2 errors in 33751.23s (9:22:31) ====
ERROR: InvocationError for command /code/modules/weko-search-ui/.tox/c1/bin/pytest --cov=weko_search_ui tests -v --cov-branch --cov-report=term --cov-report=xml --cov-report=html --cov-config=tox.ini --basetemp=/code/modules/weko-search-ui/.tox/c1/tmp (exited with code 1)
___________________________________ summary ____________________________________
ERROR:   c1: commands failed
