{#
# This file is part of WEKO3.
# Copyright (C) 2017 National Institute of Informatics.
#
# WEKO3 is free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 2 of the
# License, or (at your option) any later version.
#
# WEKO3 is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with WEKO3; if not, write to the
# Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston,
# MA 02111-1307, USA.
#}
{%- from "weko_workflow/helpers.html" import render_identifier_link with context -%}
<input type="hidden" id="item_id" value="{{pid.pid_value}}" />
<!-- Confirm Modal -->
{% from "weko_theme/macros/modal_page.html" import approval_modal %}


{% if index_is_private_state and is_public_state and not pubdate_is_future %}
    {% set restrict_doi_msg = _('When reserving a DOI to an item, Pubdate must be a future date.') %}
{% else %}
    {% if temporary_idf_grant >= 0 %}
        {% set restrict_doi_msg = _('When assigning a DOI to an item, it must be associated with an index whose index status is "Public" and Harvest Publishing is "Public".') %}
    {% else %}
        {% set restrict_doi_msg = _('Since the item has a DOI, it must be associated with an index whose index status is "Public" and whose Harvest Publishing is "Public".') %}
    {% endif %}
{% endif %}
{{ approval_modal(modal_id="restrict_doi_modal",
button_id="restrict_doi_button",
button_text="OK",
title=_('Confirmation'),
body=restrict_doi_msg)}}
<div class="panel panel-default">
    <div class="panel-heading">
        <span>{{_('Identifier Grant')}}</span>
    </div>
    <div class="panel-body" style="line-height: 1.6;">
        {% if not is_public_state and record['publish_status'] != '2' %}
            {% if index_is_private_state %}
                {% include 'weko_workflow/identifier_grant_private_index_doi_reservation.html' %}
            {% else %}
                {% include 'weko_workflow/identifier_grant_private_doi_reservation.html' %}
            {% endif %}
        {% elif is_public_state and index_is_private_state %}
            {% include 'weko_workflow/identifier_grant_private_index_doi_reservation.html' %}
        {% else %}
            {%- if temporary_idf_grant >= 0 %}
                {% if "." in record['_deposit']['id'] %}
                    {% if doi_information_key %}
                        {% if record[doi_information_key]["attribute_name"] == "Identifier Registration" %}
                        <div class="row h-100">
                            <p class="text-center">
                                <button class="btn btn-danger withdraw-button" id="doi_is_reserved" disabled>
                                    {{_('DOI is reserved')}}
                                </button>
                            </p>
                        </div>
                        {% endif %}
                    {% else %}
                        {% include 'weko_workflow/identifier_grant_form.html' %}
                    {% endif %}
                {% else %}
                    {% include 'weko_workflow/identifier_grant_form.html' %}
                {% endif %}
            {%- elif temporary_idf_grant == -1 %}
                {% include "weko_workflow/modal_withdraw_confirmation.html" %}
                <div class="row h-100">
                    <p class="text-center">
                        <button class="btn btn-danger withdraw-button" id="btn_withdraw">
                            {{_('Withdraw DOI')}}
                        </button>
                    </p>
                </div>
            {%- elif temporary_idf_grant == -2 %}
                <div class="row h-100">
                    <p class="text-center">
                        <span>{{_('DOI was withdrawn.')}}</span>
                    </p>
                </div>
            {%- else %}
                <div class="row h-100">
                    <p class="text-center">
                        <span>{{_('Items for which a DOI has been withdrawn can not be granted a DOI.')}}</span>
                    </p>
                </div>
            {%- endif %}
        {% endif %}
    </div>
</div>
<br>
<button type="button" class="btn btn-info action-button" id="btn-back">
    <span class="glyphicon glyphicon-chevron-left"></span> {{_('Back')}}
</button>
<button type="button" class="btn btn-primary save-button" id="btn-draft"
    style="width: 120px; height: 40px;font-size: 15px;">
    <span class="glyphicon glyphicon-saved"></span> {{_('Save')}}
</button>
<button type="button" class="btn btn-info next-button" id="btn-finish">
    {{_('Next')}} <span class="glyphicon glyphicon-chevron-right"></span>
</button>
<button ng-disabled="recordsVM.invenioRecordsLoading" class="btn btn-danger done-button pull-right" id="btn_quit">
    <i class="fa fa-sign-out"></i> {{_('Quit_identifier_grand')}}
</button>